<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fangtianq.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"changyan","storage":false,"lazyload":false,"nav":null,"activeClass":"changyan"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="有志者事竟成">
<meta property="og:type" content="website">
<meta property="og:title" content="越努力，越幸运！">
<meta property="og:url" content="https://fangtianq.github.io/page/16/index.html">
<meta property="og:site_name" content="越努力，越幸运！">
<meta property="og:description" content="有志者事竟成">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ftq">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://fangtianq.github.io/page/16/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/16/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>越努力，越幸运！</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">越努力，越幸运！</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Where there is a will, there is a way!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">55</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">21</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">319</span></a></li><li class="menu-item menu-item-留言版"><a href="/guestbook/" rel="section"><i class="comments fa-fw"></i>留言版</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-friendlink"><a href="/friendlink/" rel="section"><i class="link fa-fw"></i>友链</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ftq"
      src="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
  <p class="site-author-name" itemprop="name">ftq</p>
  <div class="site-description" itemprop="description">有志者事竟成</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">319</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/fangtianq" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;fangtianq" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://gitee.com/fangtianq" title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;fangtianq" rel="noopener" target="_blank"><i class="github fa-fw"></i>Gitee</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://fangtianq.github.io/" title="GitHub.io → https:&#x2F;&#x2F;fangtianq.github.io&#x2F;"><i class="github fa-fw"></i>GitHub.io</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://fangtianq.gitee.io/" title="Gitee.io → https:&#x2F;&#x2F;fangtianq.gitee.io&#x2F;" rel="noopener" target="_blank"><i class="github fa-fw"></i>Gitee.io</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://leetcode-cn.com/" title="https:&#x2F;&#x2F;leetcode-cn.com&#x2F;" rel="noopener" target="_blank">力扣网</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://rap2.taobao.org/" title="http:&#x2F;&#x2F;rap2.taobao.org&#x2F;" rel="noopener" target="_blank">RAP2接口管理平台</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2020/05/03/javascript/easyui%E5%8F%AF%E7%BC%96%E8%BE%91%E8%A1%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/03/javascript/easyui%E5%8F%AF%E7%BC%96%E8%BE%91%E8%A1%A8/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-03 10:17:54" itemprop="dateCreated datePublished" datetime="2020-05-03T10:17:54+08:00">2020-05-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/js/" itemprop="url" rel="index"><span itemprop="name">js</span></a>
        </span>
    </span>


  
    <span id="/2020/05/03/javascript/easyui%E5%8F%AF%E7%BC%96%E8%BE%91%E8%A1%A8/" class="post-meta-item leancloud_visitors" data-flag-title="" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="" href="/2020/05/03/javascript/easyui%E5%8F%AF%E7%BC%96%E8%BE%91%E8%A1%A8/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::f1e6689bea32ec69603ebaba2f8ddf76" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>描述</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/05/03/javascript/easyui%E5%8F%AF%E7%BC%96%E8%BE%91%E8%A1%A8/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2020/05/01/others/rxliuliBlog/Tool/Android/Android-%E4%B8%8A%E6%9C%80%E5%A5%BD%E7%9A%84%E6%B5%8F%E8%A7%88%E5%99%A8-Kiwi-browser/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/01/others/rxliuliBlog/Tool/Android/Android-%E4%B8%8A%E6%9C%80%E5%A5%BD%E7%9A%84%E6%B5%8F%E8%A7%88%E5%99%A8-Kiwi-browser/" class="post-title-link" itemprop="url">Android 上最好的浏览器 Kiwi browser</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-01 14:38:34" itemprop="dateCreated datePublished" datetime="2020-05-01T14:38:34+08:00">2020-05-01</time>
    </span>


  
    <span id="/2020/05/01/others/rxliuliBlog/Tool/Android/Android-%E4%B8%8A%E6%9C%80%E5%A5%BD%E7%9A%84%E6%B5%8F%E8%A7%88%E5%99%A8-Kiwi-browser/" class="post-meta-item leancloud_visitors" data-flag-title="Android 上最好的浏览器 Kiwi browser" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="Android 上最好的浏览器 Kiwi browser" href="/2020/05/01/others/rxliuliBlog/Tool/Android/Android-%E4%B8%8A%E6%9C%80%E5%A5%BD%E7%9A%84%E6%B5%8F%E8%A7%88%E5%99%A8-Kiwi-browser/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::a45f6aecefecdab3eb7cea315ce09f3c" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://kiwibrowser.com/">官网</a></p>
</blockquote>
<p>或许对于现在很多人来说，浏览器是一个很少使用的 App，因为所有功能都可以在 App 做，不需要使用浏览器。一方面，是由于国内的大环境就是把用户当成傻瓜（事实上，即便是吾辈目前所在的公司，在 UI&#x2F;UX 设计方面也倾向于将用户当成傻瓜），导致用户真的是越来越傻瓜，甚至遇到了除了微信其他的都不怎么会用的地步，更何况浏览器这种“<strong>高端</strong>”的 App 呢？<br>然而对于某些特定人群来说，尤其是不喜欢安装太多 App 的人来说，浏览器几乎是 App 上数一数二的应用了，甚至称之为互联网的入口都不为过（现在一般的傻瓜式用户大概认为微信才是吧，缅怀曾经互联网都是通过浏览器使用的时代）。<br>在使用过 <em>UC &#x3D;&gt; Chrome &#x3D;&gt; FireFox &#x3D;&gt; Kiwi browser</em> 之后，吾辈可以确定的说，Kiwi browser 是目前 Android 上最好的浏览器，其中尤以支持 Chrome PC 版的 Plugin 最为有名。</p>
<h2 id="使用过的浏览器"><a href="#使用过的浏览器" class="headerlink" title="使用过的浏览器"></a>使用过的浏览器</h2><h3 id="UC-浏览器（国内版）"><a href="#UC-浏览器（国内版）" class="headerlink" title="UC 浏览器（国内版）"></a>UC 浏览器（国内版）</h3><p>在早期吾辈使用的浏览器中，UC 绝对是当年（2016 年之前）使用体验非常好的浏览器，直到后来被阿里系收购，导致它逐渐充斥着各种广告，甚至首先开辟出了<a target="_blank" rel="noopener" href="http://kf.uc.cn/self_service/web/faqdetails-8311412_9210815_20559164_5.html">浏览器收费</a>这一跨世纪倒车壮举。</p>
<p><img src="https://img.rxliuli.com/20200501141319.jpg" alt="UC 国内版首页"><br><img src="https://img.rxliuli.com/20200501141320.png" alt="UC 国内版搜索"></p>
<blockquote>
<p>附：这里的跨世纪倒车壮举指的是自从浏览器始祖 Netscape 被 MS 的 IE 使用系统捆绑 + 免费的策略干掉以后，后来流行起来的浏览器还从未出现过收费的（或许是吾辈孤陋寡闻了？）<br>附：所有的国内浏览器都有内置的黑名单，例如 GitHub 上的 996 icu 就被国内浏览器屏蔽了，不仅仅是墙，就连浏览器都是墙的帮凶。参考：<a target="_blank" rel="noopener" href="http://kf.uc.cn/self_service/web/faqdetails-9212655_9212659_20389994_6.html">国外网站无法访问？</a></p>
</blockquote>
<h3 id="UC-浏览器（国际版）"><a href="#UC-浏览器（国际版）" class="headerlink" title="UC 浏览器（国际版）"></a>UC 浏览器（国际版）</h3><p>UC 国际版，这是一个比较有趣的版本，没有国内版那么多花俏无用的功能，但同时不支持简体中文（当然支持繁体中文），同时保留了 UC 的核心功能——怪不得手机上 UC 的使用占有率很高呢！<br>它默认支持的主要功能如下</p>
<ul>
<li>广告过滤</li>
<li>黑暗模式</li>
<li>手势方面几近完美</li>
<li>下载功能</li>
<li>自带 QR</li>
</ul>
<p><img src="https://img.rxliuli.com/20200501141317.png" alt="UC 国际版首页"><br><img src="https://img.rxliuli.com/20200501141318.png" alt="UC 国际版搜索"></p>
<p>看起来没什么太大的问题，然而，它却在隐私方面做的一如既往的烂，参考：<a target="_blank" rel="noopener" href="https://web.archive.org/web/20180228041423/http://news.163.com/16/0330/10/BJDBF3TT00014AEE.html">美媒:中国人上网须防泄露隐私 浏览器存安全隐患</a></p>
<h3 id="Chrome-for-Android"><a href="#Chrome-for-Android" class="headerlink" title="Chrome for Android"></a>Chrome for Android</h3><p>后来，吾辈在 PC 上先后遇到了 FireFox 和 Chrome，简直比国内的各种浏览器干净整洁了一百倍。在实际使用过相当长的一段时间后，吾辈最终在 PC 上选择了 Chrome，手机上也安装了 Chrome 进行网页浏览，它的速度非常理想，使用体验也还算不错，尤其是翻译功能更是被完整地保留了下来。唯有一点，插件功能被整个砍掉了。</p>
<p><img src="https://img.rxliuli.com/20200501141709.png" alt="Chrome 首页"><br><img src="https://img.rxliuli.com/20200501141404.png" alt="Chrome 搜索"><br><img src="https://img.rxliuli.com/20200501141403.png" alt="Google 翻译功能"></p>
<blockquote>
<p>为什么 Chrome For Android 不支持插件？虽然官方说是为了使之能够在较旧的浏览器上也能正常运行，但实际上应该有两个原因</p>
<ol>
<li>Android 是 Google 自己的，而 Google 对于 App 的控制力要超过网页，所以为了让用户使用 App，Google 不原因让用户更多的浏览网页。</li>
<li>大约 70％的 chrome 用户在 android 和 ios 端，只有 30％的 chrome 用户在台式机和 mac 上。谷歌知道，如果他们在智能手机上引入扩展功能，那么由于广告拦截器的存在，他们将损失很多钱，而且大多数互联网用户由于舒适性，大部分时间都倾向于将智能手机用于互联网。Google 在这里玩一个聪明的游戏。参考：<a target="_blank" rel="noopener" href="https://www.quora.com/Why-arent-there-any-extensions-for-Google-Chrome-on-Android">https://www.quora.com/Why-arent-there-any-extensions-for-Google-Chrome-on-Android</a></li>
</ol>
</blockquote>
<h3 id="FireFox-for-Android"><a href="#FireFox-for-Android" class="headerlink" title="FireFox for Android"></a>FireFox for Android</h3><p>所以，在知道 FireFox 在 Android 上亦支持插件后，吾辈感觉它就是吾辈理想中的手机浏览器，吾辈在手机上也开始尝试使用 FireFox 了。但事与愿违，它真的太慢了。。。在使用体验上和 Chrome 无法相提并论,而且翻译插件的支持不完善导致有时候想在移动端阅读大量英文网页时还需要切到 Chrome.</p>
<blockquote>
<p>注：FireFox 的桌面版插件支持存在一些问题，同时插件官方一直未曾修复，这也是吾辈放弃 FireFox 的重要原因之一。</p>
</blockquote>
<p><img src="https://img.rxliuli.com/20200501141432.png" alt="FireFox 首页"><br><img src="https://img.rxliuli.com/20200501141433.png" alt="FireFox 搜索"></p>
<h3 id="Kiwi-browser"><a href="#Kiwi-browser" class="headerlink" title="Kiwi browser"></a>Kiwi browser</h3><p>最终，吾辈遇到了 Kiwi browser，诚然，它也不是十全十美的，也有很多缺点。</p>
<ul>
<li>默认主页的新闻资讯很讨厌，而且还无法关闭。</li>
<li>翻译功能没有 Chrome 强大，没有<strong>就地</strong>全文翻译的功能</li>
<li>不是一个非常流行的浏览器，没有桌面版本，没有同步功能</li>
</ul>
<p>但有一个及其突出的优点，足以掩盖以上的所有缺点 – 支持 Chrome 桌面版插件。</p>
<p><img src="https://img.rxliuli.com/20200501141349.png" alt="Kiwi 首页"><br><img src="https://img.rxliuli.com/20200501141348.png" alt="Kiwi 翻译"></p>
<h3 id="微型浏览器"><a href="#微型浏览器" class="headerlink" title="微型浏览器"></a>微型浏览器</h3><p>事实上，吾辈也曾断断续续地使用过一些微型浏览器，在功能上做的比较简洁（但并不意味着不够用），但内核却薄弱不堪（其实就是用系统默认浏览器的内核）。<br>包括但不限于以下列表</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=mark.via.gp&hl=en_US">via 浏览器</a></li>
<li><a target="_blank" rel="noopener" href="https://www.coolapk.com/apk/org.noear.h5">h5 浏览器</a></li>
<li><a target="_blank" rel="noopener" href="https://www.xbext.com/">X 浏览器</a></li>
</ul>
<p>其他吾辈没有使用过的浏览器可以参考：<a target="_blank" rel="noopener" href="https://m.xianjichina.com/news/details_145337.html">手机浏览器有哪些？安卓平台良心浏览器推荐</a></p>
<p>虽然这些微型浏览器理念很好：<strong>少即是多，简单就是美！</strong>，但实际上，这些没有内核的浏览器很多地方，尤其是性能方面，仍然受限于系统默认浏览器。大多数自带的插件系统，往往只是实现了一套加载 <code>*.user.js</code> 的机制罢了，而且生态之小与 Chrome&#x2F;FireFox 这些主流其相比往往是天壤之别。</p>
<h2 id="Kiwi-browser-相关"><a href="#Kiwi-browser-相关" class="headerlink" title="Kiwi browser 相关"></a>Kiwi browser 相关</h2><h3 id="Kiwi-browser-推荐的插件"><a href="#Kiwi-browser-推荐的插件" class="headerlink" title="Kiwi browser 推荐的插件"></a>Kiwi browser 推荐的插件</h3><ul>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/ublock-origin/cjpalhdlnbpafiamejdnhcphjbkeiagm">uBlock Origin</a>：广告过滤</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/dark-reader/eimadpbcbfnmbkopoojfekhnkhdbieeh">Dark Reader</a>：为所有网站加上黑色主题，大部分情况下都还不错</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/tabliss-a-beautiful-new-t/hipekcciheckooncpjeljhnekcoolahp">Tabliss</a>：美丽的新标签页</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/lastpass-free-password-ma/hdokiejnpimakedhajhdlcegeplioahd">LastPass</a>：全平台密码管理器</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo?hl=zh-CN">Tampermonkey</a>：油猴脚本管理器</li>
</ul>
<blockquote>
<p>桌面的 Chrome 使用建议可以参考：<a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/54be2845/">优化 Google Chrome 的使用体验</a></p>
</blockquote>
<h3 id="二维码扫描"><a href="#二维码扫描" class="headerlink" title="二维码扫描"></a>二维码扫描</h3><p>有时候需要使用二维码扫描使用手机去打开某个网站，而 Kiwi 并没有自带这个功能，所以需要配合 App <a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=mark.qrcode">二维码扫描</a> 食用。</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2020/04/28/others/rxliuliBlog/JavaScript/%E5%81%B6%E9%81%87-HTML-%E4%B8%AD%E7%9A%84%E5%A5%87%E5%A6%99%E5%AD%97%E7%AC%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/04/28/others/rxliuliBlog/JavaScript/%E5%81%B6%E9%81%87-HTML-%E4%B8%AD%E7%9A%84%E5%A5%87%E5%A6%99%E5%AD%97%E7%AC%A6/" class="post-title-link" itemprop="url">偶遇 HTML 中的奇妙字符</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-04-28 23:48:27" itemprop="dateCreated datePublished" datetime="2020-04-28T23:48:27+08:00">2020-04-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2020-05-05 00:00:00" itemprop="dateModified" datetime="2020-05-05T00:00:00+08:00">2020-05-05</time>
    </span>


  
    <span id="/2020/04/28/others/rxliuliBlog/JavaScript/%E5%81%B6%E9%81%87-HTML-%E4%B8%AD%E7%9A%84%E5%A5%87%E5%A6%99%E5%AD%97%E7%AC%A6/" class="post-meta-item leancloud_visitors" data-flag-title="偶遇 HTML 中的奇妙字符" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="偶遇 HTML 中的奇妙字符" href="/2020/04/28/others/rxliuliBlog/JavaScript/%E5%81%B6%E9%81%87-HTML-%E4%B8%AD%E7%9A%84%E5%A5%87%E5%A6%99%E5%AD%97%E7%AC%A6/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::8c080e808f1b34cc6ae4fc6578076341" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>虽然名字听起来就像是<strong>一本正经的胡说八道</strong>，但吾辈确实遇到了一个奇怪的问题，于此分享给大家。</p>
<p>事情的起始如下</p>
<p><em>下班回家 &#x3D;&gt; 想要看动画 &#x3D;&gt; 去动漫花园下载 BT 种子 &#x3D;&gt; 动漫花园一片空白 &#x3D;&gt; Why？</em></p>
<p><img src="https://raw.githubusercontent.com/rxliuli/img-bed/master/20200429010151.png" alt="默认 uBlock 屏蔽页面"></p>
<p>于是吾辈<strong>偷偷的</strong>的打开了控制台看了一下，发现是页面中的内容元素不见了。经过深思熟虑（好吧其实也就是稍微想了一下）首先把 uBlock 禁用，毕竟这个最容易被网站检测出来并且<strong>对抗</strong>嘛！果不其然，页面恢复了正常，但。。。同时广告也出现在了页面上。</p>
<p><img src="https://img.rxliuli.com/20200429010420.png" alt="默认 uBlock 不屏蔽页面"></p>
<p>这可不行，重新启用了 uBlock 看了一下分析，很显然，内容不存在大概率是被 uBlock 的<strong>元素过滤</strong>功能隐藏掉了，查看被隐藏的内容元素，发现 id 为 <code>1280_adv</code>，但同时又包含了广告与主体内容，所以只要关掉 uBlock 的<strong>元素过滤</strong>就可以避免正常内容被误杀了。</p>
<blockquote>
<p>之所以不在该网站整个禁用掉 uBlock 的原因在于 uBlock 并不只有<strong>元素过滤</strong>，它还阻止了一些广告资源的加载，仅在动漫花园就包括但不限于 _baidu.com, bebi.com, histats.com_。显而易见，禁用它们还能提高加载速度。</p>
</blockquote>
<p><img src="https://img.rxliuli.com/20200429010547.png" alt="uBlock 屏蔽的脚本"></p>
<p>既然无法使用 uBlock 的元素屏蔽了，那么吾辈便需要使用一个新的方式去阻止广告了，幸运的是吾辈安装了 Stylus 和 Tampermonkey 插件。</p>
<blockquote>
<p>Stylus 能够使用被称为 <code>user.css</code> 的技术，能够在本地修改任意网站的样式 – 即自定义 UI 显示。<br>而 Tampermonkey 则更强大，支持 <code>user.js</code> – 可以在本地打开任意网站时载入自定义的 JavaScript 脚本，不再局限于修改 UI，几乎与插件无异（事实上它也确实被认为是更轻量的插件）。</p>
</blockquote>
<p>原以为就几句 css 的事情，找到了广告的 id，于是吾辈写下了下面这些 css</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*屏蔽动漫花园的广告*/</span></span><br><span class="line"><span class="selector-class">.ad</span>,</span><br><span class="line"><span class="selector-id">#1280_adv</span>,</span><br><span class="line"><span class="selector-id">#1280_ad</span> &gt; <span class="selector-tag">a</span>,</span><br><span class="line"><span class="selector-id">#bebiv3_ad</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但结果却是。。。只生效了一半！</p>
<p><img src="https://img.rxliuli.com/20200429010717.png" alt="屏蔽一半"></p>
<p>可以看到，上面两个广告确实被隐藏了，但下面一个却并没有，而且吾辈在控制台直接使用 <code>document.querySelector(&#39;#1280_adv&#39;)</code> 也获取 dom 会抛出错误 <code>SyntaxError: Document.querySelector: &#39;#1280_adv&#39; is not a valid selector</code>。吾辈是直接复制的 id，<strong>理论上</strong>来说不会有错才是。</p>
<p>仔细想想，吾辈或许是漏掉了什么。。。于是，吾辈使用 <strong>Copy &#x3D;&gt; Copy Selector</strong> 功能，有趣的东西出现了，复制出来的内容竟然是 <code>&#39;\31 280_adv&#39;</code>，wtf？</p>
<p>嗯，或许吾辈需要冷静一下，尝试使用 <code>document.querySelector(&quot;#\\31 280_adv&quot;)</code> 获取一下</p>
<blockquote>
<p>注意：这里 JS 里面去查询 DOM Selector 的字符串又进行了转义。</p>
</blockquote>
<p><img src="https://img.rxliuli.com/20200429010811.png" alt="Console 获取"></p>
<p>OK，确实能够正常拿到。由于这些奇怪的字符在 css 中存在语法错误，那么接下来便用 <code>user.js</code> 去屏蔽掉它们吧！</p>
<p>基本实现如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">;[</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#\\31 280_adv&#x27;</span>),</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.ad&#x27;</span>),</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#\\31 280_ad &gt; a&#x27;</span>),</span><br><span class="line">].<span class="title function_">forEach</span>(<span class="function">(<span class="params">ad</span>) =&gt;</span> ad.<span class="title function_">remove</span>())</span><br></pre></td></tr></table></figure>

<p>甚至吾辈都发到了 <a target="_blank" rel="noopener" href="https://github.com/rxliuli/userjs/tree/master/src/dmhy">GitHub</a> 与 <a target="_blank" rel="noopener" href="https://greasyfork.org/zh-CN/scripts/402206">GreasyFork</a> 上了。</p>
<p>然后，有个（万能的）网友就提出，可以转换思路，既然 <code>#\\31 280_adv</code> 在 css 中存在语法错误，那么使用属性选择器过滤 id 将值包裹在 <code>&#39;&#39;</code> 之中不就好了么？此话真是九言劝醒迷途仕，一语惊醒梦中人，吾辈瞬间 GET 到了这个点。</p>
<p>于是吾辈编写出了下面这段 <code>user.css</code> 样式</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*屏蔽动漫花园的广告*/</span></span><br><span class="line"><span class="selector-class">.ad</span>,</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[id=<span class="string">&#x27;\31 280_adv&#x27;</span>]</span>,</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[id=<span class="string">&#x27;\31 280_ad&#x27;</span>]</span> &gt; <span class="selector-tag">a</span>,</span><br><span class="line"><span class="selector-tag">div</span><span class="selector-attr">[id=<span class="string">&#x27;bebiv3_ad&#x27;</span>]</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: none;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用后效果如下</p>
<p><img src="https://img.rxliuli.com/20200429010852.png" alt="屏蔽后干净的网页"></p>
<p>现在，初始目的达成了，吾辈开始有点好奇它是怎么实现这个功能，于是下载了它的源码，id 那里并未发现什么奇怪的东西，但吾辈却也无法复现一个 demo！</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;test&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;load&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#test&#x27;</span>).<span class="title function_">setAttribute</span>(<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;\\31 280_adv&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>demo 效果</p>
<p><img src="https://img.rxliuli.com/20200429011004.png" alt="demo 效果"></p>
<p>如果有人知道原因的话，请务必不吝赐教！</p>
<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/ASCII">ASCII Wiki</a></p>
</blockquote>
<hr>
<blockquote>
<p>后续，万能的网友 <a target="_blank" rel="noopener" href="https://disqus.com/by/niamori/">NiaMori</a> 又来说明啦，实际上是 id 以数字开头的原因，具体问题参考：<br>是 id 以数字开头的原因，简单的 <code>&lt;div id=&quot;1&quot;&gt;test&lt;div&gt;</code> 就能复现这个效果。<br><code>document.getElementById(&#39;1&#39;)</code> 能够选中，但 <code>document.querySelector(&#39;#1&#39;)</code> 不能，因为 HTML5 允许 id 以数字开头而 CSS 不允许<br>0x31 是 ‘1’ 的 Unicode 编码值，Copy selector 的时候 Chrome 做了一个智能的 escape<br>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://disq.us/url?url=https://stackoverflow.com/questions/20306204/using-queryselector-with-ids-that-are-numbers:ywx_Ldt8DYLp36vWCEZDC-CT6pM&cuid=5534903">Using querySelector with IDs that are numbers</a></li>
<li><a target="_blank" rel="noopener" href="https://disq.us/url?url=https://www.w3.org/TR/CSS21/syndata.html%23characters:YR69gjoR28vxgXneZXGYH3k8gFM&cuid=5534903">Css Spec</a></li>
<li><a target="_blank" rel="noopener" href="https://disq.us/url?url=https://developer.mozilla.org/en-US/docs/Web/API/CSS/escape:5uLuEmiEmKi4BAwjvTU8OFFY6OQ&cuid=5534903">CSS.escape</a></li>
</ul>
</blockquote>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2020/04/27/others/rxliuliBlog/JavaScript/JavaScript-%E7%A6%81%E6%AD%A2%E7%94%A8%E6%88%B7%E4%BF%9D%E5%AD%98%E5%9B%BE%E7%89%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/04/27/others/rxliuliBlog/JavaScript/JavaScript-%E7%A6%81%E6%AD%A2%E7%94%A8%E6%88%B7%E4%BF%9D%E5%AD%98%E5%9B%BE%E7%89%87/" class="post-title-link" itemprop="url">JavaScript 禁止用户保存图片</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-04-27 23:41:38" itemprop="dateCreated datePublished" datetime="2020-04-27T23:41:38+08:00">2020-04-27</time>
    </span>


  
    <span id="/2020/04/27/others/rxliuliBlog/JavaScript/JavaScript-%E7%A6%81%E6%AD%A2%E7%94%A8%E6%88%B7%E4%BF%9D%E5%AD%98%E5%9B%BE%E7%89%87/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript 禁止用户保存图片" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript 禁止用户保存图片" href="/2020/04/27/others/rxliuliBlog/JavaScript/JavaScript-%E7%A6%81%E6%AD%A2%E7%94%A8%E6%88%B7%E4%BF%9D%E5%AD%98%E5%9B%BE%E7%89%87/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::f95e40a2ca8f5f0c3c7b89a2440a8018" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>在业务需求中不希望用户保存图片，因为是一些供内部使用的图片。</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul>
<li>添加事件禁止选择、拖拽、右键（简单的禁止用户保存图片，但无法阻止用户打开控制台查看，或是直接抓包）</li>
<li>将之转换为 canvas（让浏览器认为不是图片以此禁止用户对之进行图片的操作，但无法阻止抓包）</li>
<li>禁止用户使用控制台查看源码（阻止浏览器打开控制台，但无法阻止抓包）</li>
<li>传输图片使用自定义格式（可以阻止抓包，但需要后台配合）</li>
</ul>
<blockquote>
<p>注：以下内容使用 react+ts 实现</p>
</blockquote>
<h2 id="添加事件禁止选择、拖拽、右键"><a href="#添加事件禁止选择、拖拽、右键" class="headerlink" title="添加事件禁止选择、拖拽、右键"></a>添加事件禁止选择、拖拽、右键</h2><p>简而言之，这是一种简单有效的方式，能够在用户不打开控制台的情况下阻止用户保存图片。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">preventDefaultListener</span>(<span class="params">e: any</span>) &#123;</span><br><span class="line">  e.<span class="title function_">preventDefault</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">;<span class="language-xml"><span class="tag">&lt;<span class="name">img</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">  <span class="attr">src</span>=<span class="string">&#123;props.url&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">  <span class="attr">alt</span>=<span class="string">&quot;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">  <span class="attr">style</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    //禁止用户选择</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">userSelect:</span> &#x27;<span class="attr">none</span>&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    //禁止所有鼠标事件，过于强大，图片仅用于展示可用</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    // <span class="attr">pointerEvents:</span> &#x27;<span class="attr">none</span>&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">  &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">  <span class="attr">onTouchStart</span>=<span class="string">&#123;preventDefaultListener&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">  <span class="attr">onContextMenu</span>=<span class="string">&#123;preventDefaultListener&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">  <span class="attr">onDragStart</span>=<span class="string">&#123;preventDefaultListener&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">/&gt;</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/dxzg/p/9930559.html">https://www.cnblogs.com/dxzg/p/9930559.html</a></p>
</blockquote>
<h2 id="将之转换为-canvas"><a href="#将之转换为-canvas" class="headerlink" title="将之转换为 canvas"></a>将之转换为 canvas</h2><p>另一种思路是将图片转换为 canvas 避免用户使用 <code>img</code> 相关的操作。</p>
<ol>
<li><p>将图片转成 canvas</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">imageToCanvas</span>(<span class="params">url: <span class="built_in">string</span>, canvas: HTMLCanvasElement</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//新建Image对象，引入当前目录下的图片</span></span><br><span class="line">    <span class="keyword">const</span> img = <span class="keyword">new</span> <span class="title class_">Image</span>()</span><br><span class="line">    img.<span class="property">src</span> = url</span><br><span class="line">    <span class="keyword">const</span> c = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>)!</span><br><span class="line"></span><br><span class="line">    <span class="comment">//图片初始化完成后调用</span></span><br><span class="line">    img.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">//将canvas的宽高设置为图像的宽高</span></span><br><span class="line">      canvas.<span class="property">width</span> = img.<span class="property">width</span></span><br><span class="line">      canvas.<span class="property">height</span> = img.<span class="property">height</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">//canvas画图片</span></span><br><span class="line">      c.<span class="title function_">drawImage</span>(img, <span class="number">0</span>, <span class="number">0</span>, img.<span class="property">width</span>, img.<span class="property">height</span>)</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    img.<span class="title function_">addEventListener</span>(<span class="string">&#x27;error&#x27;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">reject</span>(e)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>禁用 canvas 事件</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">throwFn</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">    <span class="string">&quot;Uncaught DOMException: Failed to execute &#x27;toDataURL&#x27; on &#x27;HTMLCanvasElement&#x27;: Tainted canvases may not be exported.&quot;</span>,</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> $canvasRef = useRef&lt;<span class="title class_">HTMLCanvasElement</span>&gt;(<span class="literal">null</span>)</span><br><span class="line"> <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">     ;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">         <span class="keyword">await</span> <span class="title function_">imageToCanvas</span>(props.<span class="property">url</span>, $canvasRef.<span class="property">current</span>!)</span><br><span class="line">         $canvasRef.<span class="property">current</span>!.<span class="property">toBlob</span> = throwFn</span><br><span class="line">         $canvasRef.<span class="property">current</span>!.<span class="property">toDataURL</span> = throwFn</span><br><span class="line">     &#125;)()</span><br><span class="line"> &#125;, [])</span><br><span class="line"> <span class="keyword">return</span> (</span><br><span class="line">     <span class="language-xml"><span class="tag">&lt;<span class="name">canvas</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">ref</span>=<span class="string">&#123;$canvasRef&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">onTouchStart</span>=<span class="string">&#123;preventDefaultListener&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">onContextMenu</span>=<span class="string">&#123;preventDefaultListener&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">     /&gt;</span></span></span><br><span class="line"> )</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="禁止用户使用控制台查看源码"><a href="#禁止用户使用控制台查看源码" class="headerlink" title="禁止用户使用控制台查看源码"></a>禁止用户使用控制台查看源码</h2><p>如果能禁止用户操作控制台，那么自然能够避免用户查看源码了，下面是一个简单的实现。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 兼容异步函数的返回值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> res 返回值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> callback 同步/异步结果的回调函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@typeparam</span> T 处理参数的类型，如果是 Promise 类型，则取出其泛型类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@typeparam</span> Param 处理参数具体的类型，如果是 Promise 类型，则指定为原类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@typeparam</span> R 返回值具体的类型，如果是 Promise 类型，则指定为 Promise 类型，否则为原类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 处理后的结果，如果是同步的，则返回结果是同步的，否则为异步的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> compatibleAsync&lt;T = <span class="built_in">any</span>, <span class="title class_">Param</span> = T | <span class="title class_">Promise</span>&lt;T&gt;, R = T&gt;(</span><br><span class="line">  <span class="attr">res</span>: <span class="title class_">Param</span>,</span><br><span class="line">  <span class="attr">callback</span>: <span class="function">(<span class="params">r: T</span>) =&gt;</span> R,</span><br><span class="line">): <span class="title class_">Param</span> <span class="keyword">extends</span> <span class="title class_">Promise</span>&lt;T&gt; ? <span class="title class_">Promise</span>&lt;R&gt; : R &#123;</span><br><span class="line">  <span class="keyword">return</span> (res <span class="keyword">instanceof</span> <span class="title class_">Promise</span></span><br><span class="line">    ? res.<span class="title function_">then</span>(callback)</span><br><span class="line">    : <span class="title function_">callback</span>(res <span class="keyword">as</span> <span class="built_in">any</span>)) <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试函数的执行时间</span></span><br><span class="line"><span class="comment"> * 注：如果函数返回 Promise，则该函数也会返回 Promise，否则直接返回执行时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fn 需要测试的函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 执行的毫秒数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> timing&lt;R&gt;(</span><br><span class="line">  <span class="attr">fn</span>: <span class="function">(<span class="params">...args: <span class="built_in">any</span>[]</span>) =&gt;</span> R,</span><br><span class="line">  <span class="comment">// 函数返回类型是 Promise 的话，则返回 Promise&lt;number&gt;，否则返回 number</span></span><br><span class="line">): R <span class="keyword">extends</span> <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt; ? <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; : <span class="built_in">number</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> begin = performance.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">const</span> res = <span class="title function_">fn</span>()</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">compatibleAsync</span>(res, <span class="function">() =&gt;</span> performance.<span class="title function_">now</span>() - begin)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 禁止他人调试网站相关方法的集合对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AntiDebug</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 不停循环 debugger 防止有人调试代码</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> 取消函数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="title function_">cyclingDebugger</span>(): <span class="title class_">Function</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">debugger</span></span><br><span class="line">    &#125;, <span class="number">100</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(res)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 检查是否正在 debugger 并调用回调函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> fn 回调函数，默认为重载页面</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> 取消函数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="title function_">checkDebug</span>(</span><br><span class="line">    <span class="attr">fn</span>: <span class="title class_">Function</span> = <span class="function">() =&gt;</span> <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>(),</span><br><span class="line">  ): <span class="title class_">Function</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> diff = <span class="title function_">timing</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">debugger</span></span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">if</span> (diff &gt; <span class="number">500</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(diff)</span><br><span class="line">        <span class="title function_">fn</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(res)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> cancel1 = <span class="title class_">AntiDebug</span>.<span class="title function_">cyclingDebugger</span>() <span class="keyword">as</span> any</span><br><span class="line">  <span class="keyword">const</span> cancel2 = <span class="title class_">AntiDebug</span>.<span class="title function_">checkDebug</span>(<span class="function">() =&gt;</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;请不要打开调试&#x27;</span>),</span><br><span class="line">  ) <span class="keyword">as</span> any</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">cancel1</span>()</span><br><span class="line">    <span class="title function_">cancel2</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, [])</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;url&#125;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="传输图片使用自定义格式"><a href="#传输图片使用自定义格式" class="headerlink" title="传输图片使用自定义格式"></a>传输图片使用自定义格式</h2><p>该功能需要服务端配合，故而此处赞不实现，可以参考 <a target="_blank" rel="noopener" href="https://weread.qq.com/">微信读书</a>，就是将文本转为 canvas，数据传输也进行了加密，可以在很大程度上防止普通用户想要复制&#x2F;下载的行为了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>如同所有的前端限制用户的技术一样，这是一个没有终点的斗争。。。</p>
<blockquote>
<p>参考广告屏蔽和屏蔽复制粘贴的发展。。。</p>
</blockquote>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2020/04/18/others/rxliuliBlog/JavaScript/%E5%9C%A8%E7%8E%B0%E4%BB%A3%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8-Worker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/04/18/others/rxliuliBlog/JavaScript/%E5%9C%A8%E7%8E%B0%E4%BB%A3%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8-Worker/" class="post-title-link" itemprop="url">在现代前端项目中使用 Worker</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-04-18 22:19:57" itemprop="dateCreated datePublished" datetime="2020-04-18T22:19:57+08:00">2020-04-18</time>
    </span>


  
    <span id="/2020/04/18/others/rxliuliBlog/JavaScript/%E5%9C%A8%E7%8E%B0%E4%BB%A3%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8-Worker/" class="post-meta-item leancloud_visitors" data-flag-title="在现代前端项目中使用 Worker" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="在现代前端项目中使用 Worker" href="/2020/04/18/others/rxliuliBlog/JavaScript/%E5%9C%A8%E7%8E%B0%E4%BB%A3%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8-Worker/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::dcfea84e70c0b206e23078e1e2525825" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>由于需要在 Browser 进行大量的（音频转解码）计算，所以吾辈开始尝试使用 webworker 分离 CPU 密集型的计算操作，最终找到了 comlink 这个库，但之前在 vue 中使用时发生了错误，目前看起来已经得到了解决，所以在此记录一下。</p>
<h2 id="调研方案"><a href="#调研方案" class="headerlink" title="调研方案"></a>调研方案</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/satya164/web-worker-proxy">web-worker-proxy</a>：结合了 proxy&#x2F;promise&#x2F;webworker 的强大工具库，但如何在 ts 中使用却是个问题</li>
<li><a target="_blank" rel="noopener" href="https://github.com/miozzz/sandbox/tree/master/orc">Orc.js</a>：一个简单的 worker 封装</li>
<li><a target="_blank" rel="noopener" href="https://github.com/israelss/vue-worker">VueWorker</a>：结合 vue 的 worker 封装，无法理解，难道真的会有人在 vue 组件中进行大量计算么？</li>
<li>comlink：Chrome 的一个基于 proxy&#x2F;promise&#x2F;webworker 的封装库</li>
<li><a target="_blank" rel="noopener" href="https://github.com/GoogleChromeLabs/worker-plugin">worker-plugin</a>：和上面的同属 chrome 实验室的一个 webpack 插件</li>
</ul>
<p>最后决定使用 comlink 结合 worker-plugin 实现简单的 worker 使用。</p>
<h2 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h2><blockquote>
<p>在 GitHub 上有 <a target="_blank" rel="noopener" href="https://github.com/rxliuli/example/tree/master/react_worker_example">可运行示例 demo</a><br>相关问题：<a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000022359546">comlink-loader 工作不正常</a></p>
</blockquote>
<h3 id="添加相关依赖"><a href="#添加相关依赖" class="headerlink" title="添加相关依赖"></a>添加相关依赖</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn add comlink</span><br><span class="line">yarn add -D worker-plugin</span><br></pre></td></tr></table></figure>

<h3 id="在-webpack-配置中添加插件"><a href="#在-webpack-配置中添加插件" class="headerlink" title="在 webpack 配置中添加插件"></a>在 webpack 配置中添加插件</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="keyword">new</span> <span class="title class_">WorkerPlugin</span>()]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里一般不需要特殊参数配置，如果需要，可以参考：<a target="_blank" rel="noopener" href="https://github.com/GoogleChromeLabs/worker-plugin">worker-plugin</a></p>
</blockquote>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="基本示例"><a href="#基本示例" class="headerlink" title="基本示例"></a>基本示例</h3><p>添加一个简单的 <em>hello.worker.ts</em></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; expose &#125; <span class="keyword">from</span> <span class="string">&#x27;comlink&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">counter</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="title function_">inc</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">counter</span>++</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">expose</span>(obj)</span><br></pre></td></tr></table></figure>

<p>在 <code>main.ts</code> 中使用</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = <span class="title function_">wrap</span>(<span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;./hello.worker.ts&#x27;</span>, &#123; <span class="attr">type</span>: <span class="string">&#x27;module&#x27;</span> &#125;)) <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line"><span class="title function_">alert</span>(<span class="string">`Counter: <span class="subst">$&#123;<span class="keyword">await</span> obj.counter&#125;</span>`</span>)</span><br><span class="line"><span class="keyword">await</span> obj.<span class="title function_">inc</span>()</span><br><span class="line"><span class="title function_">alert</span>(<span class="string">`Counter: <span class="subst">$&#123;<span class="keyword">await</span> obj.counter&#125;</span>`</span>)</span><br></pre></td></tr></table></figure>

<p>但这里并不是类型安全的，所以我们可以实现正确的类型。</p>
<p>添加一个 <em>hello.worker.ts</em> 暴露出来的类型 <code>HelloWorkerType</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">HelloWorkerType</span> &#123;</span><br><span class="line">  <span class="attr">counter</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="title function_">inc</span>(): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时为了支持在 <em>main.ts</em> 中使用正确的类型，需要使用泛型</p>
<p><em>main.ts</em> 修改如下</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = wrap&lt;<span class="title class_">HelloWorkerType</span>&gt;(</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;./hello.worker.ts&#x27;</span>, &#123; <span class="attr">type</span>: <span class="string">&#x27;module&#x27;</span> &#125;),</span><br><span class="line">)</span><br><span class="line"><span class="title function_">alert</span>(<span class="string">`Counter: <span class="subst">$&#123;<span class="keyword">await</span> obj.counter&#125;</span>`</span>)</span><br><span class="line"><span class="keyword">await</span> obj.<span class="title function_">inc</span>()</span><br><span class="line"><span class="title function_">alert</span>(<span class="string">`Counter: <span class="subst">$&#123;<span class="keyword">await</span> obj.counter&#125;</span>`</span>)</span><br></pre></td></tr></table></figure>

<h3 id="纯函数"><a href="#纯函数" class="headerlink" title="纯函数"></a>纯函数</h3><p>声明函数的类型 <em>HelloCallback.worker.type.d.ts</em></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">ListItem</span>&lt;T <span class="keyword">extends</span> <span class="built_in">any</span>[]&gt; = T <span class="keyword">extends</span> (infer U)[] ? U : <span class="built_in">never</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">MapWorkerType</span> = &lt;<span class="title class_">List</span> <span class="keyword">extends</span> <span class="built_in">any</span>[], U&gt;<span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  arr: List,</span></span></span><br><span class="line"><span class="params"><span class="function">  cb: (val: ListItem&lt;List&gt;) =&gt; U | <span class="built_in">Promise</span>&lt;U&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> <span class="title class_">Promise</span>&lt;U[]&gt;</span><br></pre></td></tr></table></figure>

<p>声明一个纯函数 <em>HelloCallback.worker.ts</em></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">MapWorkerType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./HelloCallback.worker.type&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; expose &#125; <span class="keyword">from</span> <span class="string">&#x27;comlink&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">map</span>: <span class="title class_">MapWorkerType</span> = <span class="function">(<span class="params">arr, cb</span>) =&gt;</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(arr.<span class="title function_">map</span>(cb))</span><br><span class="line"></span><br><span class="line"><span class="title function_">expose</span>(map)</span><br></pre></td></tr></table></figure>

<p>注：此处最好使用变量的形式，主要是为了方便将函数类型剥离出去。</p>
<p>在 <em>main.ts</em> 中使用</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> map = wrap&lt;<span class="title class_">MapWorkerType</span>&gt;(</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;./HelloCallback.worker.ts&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;module&#x27;</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">)</span><br><span class="line"><span class="keyword">const</span> list = <span class="keyword">await</span> <span class="title function_">map</span>(</span><br><span class="line">  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">  <span class="title function_">proxy</span>(<span class="function">(<span class="params">i</span>) =&gt;</span> i * <span class="number">2</span>),</span><br><span class="line">)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;list: &#x27;</span>, list)</span><br></pre></td></tr></table></figure>

<h3 id="使用-class-的形式"><a href="#使用-class-的形式" class="headerlink" title="使用 class 的形式"></a>使用 class 的形式</h3><p>声明接口 <em>HelloClass.worker.type.d.ts</em></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">HelloClassWorker</span> &#123;</span><br><span class="line">  <span class="title function_">sum</span>(...<span class="attr">args</span>: <span class="built_in">number</span>[]): <span class="built_in">number</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>worker 文件 <em>HelloClass.worker.ts</em></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HelloClassWorker</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./HelloClass.worker.type&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; expose &#125; <span class="keyword">from</span> <span class="string">&#x27;comlink&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HelloClassWorkerImpl</span> <span class="keyword">implements</span> <span class="title class_">HelloClassWorker</span> &#123;</span><br><span class="line">  <span class="title function_">sum</span>(...<span class="attr">args</span>: <span class="built_in">number</span>[]): <span class="built_in">number</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> args.<span class="title function_">reduce</span>(<span class="function">(<span class="params">res, i</span>) =&gt;</span> res + i, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">expose</span>(<span class="title class_">HelloClassWorkerImpl</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>关于此处 <code>implements class</code> 的问题，吾辈偶然一试之下没报错也很奇怪，所以找到了相关问题 <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/26961710">Typescript: How to extend two classes?</a>，官方文档也同样说明了这个特性 <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/mixins.html">Mixins</a>。</p>
</blockquote>
<p>在 <em>main.ts</em> 中使用</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">HelloClassWorkerClazz</span> = wrap&lt;<span class="keyword">typeof</span> <span class="title class_">HelloClassWorker</span>&gt;(</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;./HelloClass.worker.ts&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;module&#x27;</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">)</span><br><span class="line"><span class="keyword">const</span> instance = <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">HelloClassWorkerClazz</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> instance.<span class="title function_">sum</span>(<span class="number">1</span>, <span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总的来说，使用 worker 的基本分三步</p>
<ol>
<li>编写需要放在 worker 里内容的类型定义</li>
<li>根据类型定义实现它</li>
<li>在主进程的代码中使用它</li>
</ol>
<blockquote>
<p>注：当然，如果是复杂的东西，可以直接在单独的文件中实现，然后声明一个 <em>.worker.ts</em> 暴露出去，不在 <em>.worker.ts</em> 中包含任何</p>
</blockquote>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.logrocket.com/integrating-web-workers-in-a-react-app-with-comlink/">Integrating web workers in a React app with Comlink</a></li>
<li><a target="_blank" rel="noopener" href="https://lorefnon.tech/2019/03/24/using-comlink-with-typescript-and-worker-loader/">Using comlink with typescript and worker-loader</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/lacolaco-blog/an-issue-around-angular-cli-comlink-workerplugin-585be1c8d087">An issue around Angular CLI + Comlink + WorkerPlugin</a></li>
</ul>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2020/04/02/others/rxliuliBlog/JavaScript/TypeScript-%E5%87%BD%E6%95%B0%E6%A0%B9%E6%8D%AE%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E6%8E%A8%E5%AF%BC%E5%90%8E%E9%9D%A2%E5%8F%82%E6%95%B0%E7%9A%84%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/04/02/others/rxliuliBlog/JavaScript/TypeScript-%E5%87%BD%E6%95%B0%E6%A0%B9%E6%8D%AE%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E6%8E%A8%E5%AF%BC%E5%90%8E%E9%9D%A2%E5%8F%82%E6%95%B0%E7%9A%84%E7%B1%BB%E5%9E%8B/" class="post-title-link" itemprop="url">TypeScript 函数根据第一个参数推导后面参数的类型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-04-02 18:53:44" itemprop="dateCreated datePublished" datetime="2020-04-02T18:53:44+08:00">2020-04-02</time>
    </span>


  
    <span id="/2020/04/02/others/rxliuliBlog/JavaScript/TypeScript-%E5%87%BD%E6%95%B0%E6%A0%B9%E6%8D%AE%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E6%8E%A8%E5%AF%BC%E5%90%8E%E9%9D%A2%E5%8F%82%E6%95%B0%E7%9A%84%E7%B1%BB%E5%9E%8B/" class="post-meta-item leancloud_visitors" data-flag-title="TypeScript 函数根据第一个参数推导后面参数的类型" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="TypeScript 函数根据第一个参数推导后面参数的类型" href="/2020/04/02/others/rxliuliBlog/JavaScript/TypeScript-%E5%87%BD%E6%95%B0%E6%A0%B9%E6%8D%AE%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E6%8E%A8%E5%AF%BC%E5%90%8E%E9%9D%A2%E5%8F%82%E6%95%B0%E7%9A%84%E7%B1%BB%E5%9E%8B/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::3c6847842e9b43b2a314cf601480b251" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>在编写一个重载函数时，吾辈发现了 ts 的方法签名问题。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">TypeEnum</span> &#123;</span><br><span class="line">  A,</span><br><span class="line">  B,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> A = &#123;</span><br><span class="line">  <span class="attr">a</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> B = &#123;</span><br><span class="line">  <span class="attr">b</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//region 普通参数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn1</span>(<span class="params"><span class="keyword">type</span>: TypeEnum.A, obj: A</span>): <span class="built_in">void</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn1</span>(<span class="params"><span class="keyword">type</span>: TypeEnum.B, obj: B</span>): <span class="built_in">void</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn1</span>(<span class="params"><span class="keyword">type</span>: TypeEnum, obj: A | B</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//endregion</span></span><br></pre></td></tr></table></figure>

<p>上面是一个简单的重载函数，吾辈希望在输入第一个参数 <code>type</code> 之后，ts 就能匹配到正确的参数，然而事实上，ts 并没能完全做到。</p>
<p><img src="https://img.rxliuli.com/20200402140820.png" alt="ts 类型提示"></p>
<p>当然，如果真的这样写 ts 的类型检查仍然能正确地抛出错误消息，然而未能推导终究是有点问题的。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TS2769: No overload matches this call.   Overload 1 of 2, &#x27;(type: TypeEnum.A, obj: A): void&#x27;, gave the following error.     Argument of type &#x27;&#123; a: string; b: number; &#125;&#x27; is not assignable to parameter of type &#x27;A&#x27;.       Object literal may only specify known properties, and &#x27;b&#x27; does not exist in type &#x27;A&#x27;.   Overload 2 of 2, &#x27;(type: TypeEnum.B, obj: B): void&#x27;, gave the following error.     Argument of type &#x27;TypeEnum.A&#x27; is not assignable to parameter of type &#x27;TypeEnum.B&#x27;</span></span><br><span class="line"><span class="title function_">fn1</span>(<span class="title class_">TypeEnum</span>.<span class="property">A</span>, &#123;</span><br><span class="line">  <span class="attr">a</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">b</span>: <span class="number">1</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>然后，吾辈想到了几种方式可以尝试解决。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>尝试使用继承限制字段的类型。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//region 对象参数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn2</span>(<span class="params">arg: &#123; <span class="keyword">type</span>: TypeEnum.A; obj: A &#125;</span>): <span class="built_in">void</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn2</span>(<span class="params">arg: &#123; <span class="keyword">type</span>: TypeEnum.B; obj: B &#125;</span>): <span class="built_in">void</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn2</span>(<span class="params">arg: &#123; <span class="keyword">type</span>: TypeEnum; obj: A | B &#125;</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">fn2</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="title class_">TypeEnum</span>.<span class="property">A</span>,</span><br><span class="line">  <span class="attr">obj</span>: &#123;</span><br><span class="line">    <span class="attr">a</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//endregion</span></span><br></pre></td></tr></table></figure>

<p>很遗憾的是，这是行不通的，即便是下面的这种变体，仍然是不可行的。</p>
<p><img src="https://img.rxliuli.com/20200402145908.png" alt="继承"></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Base</span>&lt;T <span class="keyword">extends</span> <span class="title class_">TypeEnum</span>&gt; &#123;</span><br><span class="line">  <span class="attr">type</span>: T</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> IA <span class="keyword">extends</span> <span class="title class_">Base</span>&lt;<span class="title class_">TypeEnum</span>.A&gt; &#123;</span><br><span class="line">  <span class="attr">obj</span>: A</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> IB <span class="keyword">extends</span> <span class="title class_">Base</span>&lt;<span class="title class_">TypeEnum</span>.B&gt; &#123;</span><br><span class="line">  <span class="attr">obj</span>: B</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn2</span>(<span class="params">arg: IA | IB</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h3><p>事实上，使用泛型确实可以做到让 ts 的类型更加 <strong>正确</strong>。</p>
<p><img src="https://img.rxliuli.com/20200402145745.png" alt="泛型"></p>
<p>缺点：</p>
<ul>
<li>不能使用 ts 的重载</li>
<li>需要函数的作者改变思维</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//region 泛型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">EnumTypeMapGen</span>&lt;T <span class="keyword">extends</span> <span class="built_in">string</span>[], M <span class="keyword">extends</span> &#123; [P <span class="keyword">in</span> <span class="title class_">TypeEnum</span>]: <span class="built_in">any</span> &#125;&gt; = []</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">TypeMap</span> = &#123;</span><br><span class="line">  [<span class="title class_">TypeEnum</span>.<span class="property">A</span>]: A</span><br><span class="line">  [<span class="title class_">TypeEnum</span>.<span class="property">B</span>]: B</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> fn3&lt;T <span class="keyword">extends</span> <span class="title class_">TypeEnum</span>, <span class="title class_">Arg</span> <span class="keyword">extends</span> <span class="title class_">TypeMap</span>[T]&gt;(<span class="attr">type</span>: T, <span class="attr">obj</span>: <span class="title class_">Arg</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">fn3</span>(<span class="title class_">TypeEnum</span>.<span class="property">A</span>, &#123;</span><br><span class="line">  <span class="attr">a</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//endregion</span></span><br></pre></td></tr></table></figure>

<h3 id="高阶函数"><a href="#高阶函数" class="headerlink" title="高阶函数"></a>高阶函数</h3><p>最后，高阶函数可以简单的解决这个问题，它将一次调用更改为两次调用，第一次调用返回的函数便已经确认了类型。</p>
<p><img src="https://img.rxliuli.com/20200402145633.png" alt="高阶函数"></p>
<p>缺点：</p>
<ul>
<li>需要使用者接收这种 <strong>函数式</strong> 的调用方式</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//region 高阶函数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn4</span>(<span class="params"><span class="keyword">type</span>: TypeEnum.A</span>): <span class="function">(<span class="params">obj: A</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn4</span>(<span class="params"><span class="keyword">type</span>: TypeEnum.B</span>): <span class="function">(<span class="params">obj: B</span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn4</span>(<span class="params"><span class="keyword">type</span>: TypeEnum</span>): <span class="built_in">any</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">fn4</span>(<span class="title class_">TypeEnum</span>.<span class="property">A</span>)(&#123;</span><br><span class="line">  <span class="attr">a</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//endregion</span></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总的而言，泛型和高阶函数都能解决这个问题，吾辈个人倾向于泛型，因为它并未改变调用者的使用方式，而是让作者去改变，避免改变函数的接口本身。</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2020/02/23/others/rxliuliBlog/JavaScript/liuli-cli-TS-JS-SDK-CLI-%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/23/others/rxliuliBlog/JavaScript/liuli-cli-TS-JS-SDK-CLI-%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">liuli-cli: TS/JS SDK CLI 工具</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-23 15:51:06" itemprop="dateCreated datePublished" datetime="2020-02-23T15:51:06+08:00">2020-02-23</time>
    </span>


  
    <span id="/2020/02/23/others/rxliuliBlog/JavaScript/liuli-cli-TS-JS-SDK-CLI-%E5%B7%A5%E5%85%B7/" class="post-meta-item leancloud_visitors" data-flag-title="liuli-cli: TS/JS SDK CLI 工具" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="liuli-cli: TS/JS SDK CLI 工具" href="/2020/02/23/others/rxliuliBlog/JavaScript/liuli-cli-TS-JS-SDK-CLI-%E5%B7%A5%E5%85%B7/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::a5dcb0f9e8934b84712503c8c4cd4219" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>吾辈最初尝试写 JS SDK 发布到 NPM 上，过程中遇到了很多问题，也因此消耗了大量的时间。<br>包括但不限于以下这些</p>
<ul>
<li>折腾 Rollup 打包</li>
<li>折腾 JS 的模块（umd&#x2F;esm）</li>
<li>折腾单元测试</li>
<li>折腾 ES6 怎么通过 Babel 编译</li>
<li>使用 JS 编写，没有提供类型定义</li>
<li>没有进行打包</li>
<li>没有编译成 ES5</li>
<li>没有单元测试</li>
<li>没有 API 文档</li>
<li>没有 Linter 和 Prettier 统一格式化</li>
</ul>
<blockquote>
<p>具体的过程可以参考 <a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/c30dd206/">使用 rollup 打包 JavaScript SDK</a></p>
</blockquote>
<p>吾辈在过程中遇到的一些问题</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000018386874/">使用 Rollup + Babel 打包出错</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000018914964">npm 发布后的包安装后无法引用？</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000019587945">为什么上传到 GitHub Pages 的静态资源会 404 了呢？有人遇到过么？</a></li>
</ul>
<p>吾辈目前所在的公司中的 NPM 库也存在这些问题，内部的 npm 库几乎不能称为一个合格的库，以上的问题基本都存在。所以为了重构公司的 npm 包（主要是为了提供类型定义），就想是否能够把这部分单独抽离成一个脚手架，因而便开发了 SDK cli 供公司的前端 dev 创建一个标准（包含打包、编译、测试、文档、发布）的 SDK，并希望以此抹平不同 NPM 库配置的不一致性。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>所以吾辈后来创造了 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/liuli-cli">liuli-cli</a>，用于简化和统一创建 JS&#x2F;TS SDK 的步骤。</p>
<p>目前实现的功能如下</p>
<ul>
<li><input checked="" disabled="" type="checkbox"> 基本打包支持</li>
<li><input checked="" disabled="" type="checkbox"> 模块化 umd&#x2F;es</li>
<li><input checked="" disabled="" type="checkbox"> jest 单元测试支持</li>
<li><input checked="" disabled="" type="checkbox"> 代码压缩支持</li>
<li><input checked="" disabled="" type="checkbox"> babel 支持</li>
<li><input checked="" disabled="" type="checkbox"> ts 支持</li>
<li><input checked="" disabled="" type="checkbox"> linter 支持</li>
<li><input checked="" disabled="" type="checkbox"> prettier 格式化支持</li>
<li><input checked="" disabled="" type="checkbox"> git 钩子支持</li>
<li><input checked="" disabled="" type="checkbox"> esdoc</li>
<li><input checked="" disabled="" type="checkbox"> typedoc</li>
<li><input checked="" disabled="" type="checkbox"> 许可证选择支持</li>
</ul>
<p>使用的话也很简单</p>
<p>全局安装 liuli-cli</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -g liuli-cli</span><br></pre></td></tr></table></figure>

<p>然后便可以使用命令 <code>li</code> 创建项目</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">li create &lt;project-name&gt;</span><br></pre></td></tr></table></figure>

<p>目前支持以下三种类型（强烈推荐库的作者使用 TypeScript）</p>
<ul>
<li><code>JavaScript 模板</code></li>
<li><code>TypeScript 模板</code></li>
<li><code>命令行工具模板</code></li>
</ul>
<p>之后根据引导即可创建一个开箱即用的项目了</p>
<h2 id="反例"><a href="#反例" class="headerlink" title="反例"></a>反例</h2><p>让我们看看那些大公司云服务的 JS SDK 是怎样的。</p>
<p>腾讯：提供的 SDK 大多是一个 JS 文件，需要在项目里手动引入，甚至有些是依赖了开源依赖，导致开源依赖使用 npm 管理，而私有服务的 SDK 仍然使用 JS 的方式引入。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/436">对象存储</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/266">腾讯云点播</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/269">即时通信 IM</a></li>
</ul>
<p>讯飞：web 版 demo 明明有 package.json 这种版本控制工具，但却仍然是在一个 HTML 里直接 script 脚本引入，而非使用 npm&#x2F;yarn 进行依赖管理，而 package.json 里面只是一个 http-server 用以开启一个静态服务器看 demo 罢了。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.xfyun.cn/doc/asr/voicedictation/API.html">语音听写</a></li>
<li><a target="_blank" rel="noopener" href="https://www.xfyun.cn/doc/asr/lfasr/API.html">语音转写</a></li>
<li><a target="_blank" rel="noopener" href="https://www.xfyun.cn/doc/asr/rtasr/API.html">实时语音转写</a></li>
</ul>
<p>或许在大公司的这些 SDK 的开发者看来，会使用他们这些服务的公司都是小公司，以及一些没有接触过现代前端的开发者，所以都以这种方式提供 SDK。更不要说文档与类型定义，这两项几乎是 JS SDK 标准的需求，他们都没有做好。而且，明明他们的 SDK 也有版本号，甚至给出的 JS SDK 本身便是 umd 的，但实际上却未发布在 npm 或是其他公开的仓库中（作为库的使用者吾辈没有找到）。这些开发者宁愿用户提工单询问，并浪费了大量的沟通时间解决问题也不愿意最开始就将这些做的好一点。</p>
<blockquote>
<p>Pass1：文档可能过时，但 Demo 一定是最新的。<br>Pass2：这行代码不知道做什么的，但没有了就会出错，先放在这里。</p>
</blockquote>
<p>当然，或许创建第三方组织可以解决部分这个问题，像是 <a target="_blank" rel="noopener" href="https://github.com/DefinitelyTyped/DefinitelyTyped">DefinitelyTyped</a> 那个 ts 的开源项目一样，但问题仍然很多</p>
<ol>
<li>目标对象不同：DefinitelyTyped 的目标是为了没有 types 的 js 库定义类型，它的目标对象也是开源（大多数时候也是）免费的库。而像是腾讯这些内部服务的 SDK 是收费、不开源的，很难让人免费为其做贡献。</li>
<li>各家都有类似的云服务：提供这种云服务的公司并不止一家，难道要为每一家都添加创建类似的组织么？</li>
<li>安全性问题：第三方组织不能保证每一行贡献的内容一定就和官方的一模一样，就算引入了恶意代码也很难立刻发现。</li>
<li>法律风险：这样做的话是否会被官方发律师函也是未知之数。</li>
</ol>
<p>当然，也有一些个人为某些云服务创建的 NPM 库</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/xunfeisdk">https://www.npmjs.com/package/xunfeisdk</a></li>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/xfy-node">https://www.npmjs.com/package/xfy-node</a></li>
</ul>
<p>但更多的服务是没有的，而且个人创建的这些库很难保证一直不过时（大多数都是某个项目用了一下罢了）。如果能简化项目的初始化流程，不知是否能让官方发布到 NPM 组织下。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>关于使用 CLI 会阻碍人接触更<strong>底层</strong>的知识这点，属于仁者见仁智者见智的事情。毕竟，CLI 能够简化重复的劳动自然是会受到欢迎，前端三大框架也都有自己的 CLI 用于快速创建项目，降低框架的使用门槛，避免接触到一些琐碎的细节而专注于自己的需求开发。</p>
<blockquote>
<p>webpack&#x2F;babel 真的不能说底层，尤其是 webpack，复杂性太高、知识的时效性太短导致现在它的风评并不好。。。</p>
</blockquote>
<p>最后，这个项目才写出来没多久，欢迎任何人使用、批评和建议！</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2020/02/01/others/rxliuliBlog/JavaScript/%E9%9D%A2%E7%9B%B8-vue-%E5%BC%80%E5%8F%91%E8%80%85%E7%9A%84-react-%E5%85%A5%E5%9D%91%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/01/others/rxliuliBlog/JavaScript/%E9%9D%A2%E7%9B%B8-vue-%E5%BC%80%E5%8F%91%E8%80%85%E7%9A%84-react-%E5%85%A5%E5%9D%91%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">面相 vue 开发者的 react 入坑指南</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-02 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-02T00:00:00+08:00">2020-02-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2020-03-14 00:00:00" itemprop="dateModified" datetime="2020-03-14T00:00:00+08:00">2020-03-14</time>
    </span>


  
    <span id="/2020/02/01/others/rxliuliBlog/JavaScript/%E9%9D%A2%E7%9B%B8-vue-%E5%BC%80%E5%8F%91%E8%80%85%E7%9A%84-react-%E5%85%A5%E5%9D%91%E6%8C%87%E5%8D%97/" class="post-meta-item leancloud_visitors" data-flag-title="面相 vue 开发者的 react 入坑指南" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="面相 vue 开发者的 react 入坑指南" href="/2020/02/01/others/rxliuliBlog/JavaScript/%E9%9D%A2%E7%9B%B8-vue-%E5%BC%80%E5%8F%91%E8%80%85%E7%9A%84-react-%E5%85%A5%E5%9D%91%E6%8C%87%E5%8D%97/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::626a653d67595b7459011220dbd00587" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><ul>
<li>问：为什么吾辈要使用 React？</li>
<li>答：React 拥有更加庞大的生态，以及对 TypeScript 的更好支持。<br>前者让需求实现变得更加简单，例如目前使用 Vue 做的后台管理系统使用了 Ant Design Vue 这个 UI 库，而它的上游 Ant Design 实际上官方维护的是 React 版本，而 Vue 并不是 <strong>亲儿子</strong>，导致一些问题并不像官方那么快解决。<br>后者强大的类型系统能降低维护成本，虽然开发时代码添加类型会稍加工作量，但可以降低维护成本，便于后续的修改、重构，同时 IDE 对其支持是 JavaScript 无法相提并论的。</li>
<li>问：那 React 相比于 Vue 而言有什么区别？</li>
<li>答：更强大、复杂、酷，对于没有现代前端开发经验的人而言可能非常困难，但一旦熟悉，则会非常喜欢它。组件化（<code>React Component/JSX</code>）、函数式（<code>React Hooks</code>）、不可变（<code>immutable</code>）都是非常有趣的思想，理解之后确实都能发现具体使用场景。<blockquote>
<p>Vue 作者说 <strong>React + Mobx 就是更复杂的 Vue</strong>，这句话确实有道理，下面在 <a href="#%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86">状态管理</a> 那里也进行了说明，但同时，相比于 <code>Vue + Vuex</code>，避免引入 Redux 的 <code>React + Mobx</code> 将是更简单的。</p>
</blockquote>
</li>
<li>问：有大公司在用么？</li>
<li>答：作为能够支撑 Facebook 这种级别公司的 Web 产品的基础，显然它拥有相当多的生产环境实践。</li>
</ul>
<h2 id="工程与周边生态"><a href="#工程与周边生态" class="headerlink" title="工程与周边生态"></a>工程与周边生态</h2><p>以下皆基于 <code>cra(create-react-app)</code> 创建的 <code>ts + react + mobx + react-router + immer</code> 技术栈进行说明，虽然完全不了解以上内容亦可，但最好了解一下它们是做什么的，下面第一次提及时也会简单说明一下。</p>
<h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>使用 create-react-app 创建 react 项目，但和 vue-cli 有一点明显区别：不提供很多配置，只是简单的项目生成。</p>
<h3 id="状态管理"><a href="#状态管理" class="headerlink" title="状态管理"></a>状态管理</h3><p>此处使用 mobx 对标，mobx 是一个状态管理库，以响应式、可变、简单方便为最大卖点。本质上可以认为为每个页面（页面内的所有组件）提供了一个全局对象，并实现了 vue 中的 <code>computed</code> 和 <code>watch</code>，所以 vue 的作者说 vue 是更简单的 react + mobx 确实有些道理，实际上这两个加起来能做到的事情不比原生 vue 多多少。</p>
<p>但它们之间也有几点不同</p>
<ul>
<li>vue 基于组件级别实现的 <code>computed</code> 和 <code>watch</code>，而 mobx 则是全局的</li>
<li>vue 是基于组件级别自动初始化和销毁，而 mobx 则是手动的</li>
<li>vue 基于组件但也受限于组件级别，全局状态仍要使用 vuex 这种 <strong>大炮</strong>，而 mobx 此时则是统一的</li>
<li>不使用 vuex 的情况下一些组件很难进行拆分，因为拆分后各组件的一些数据仍然需要共享和修改，这种时候单用 vue 的 <code>data/props</code> 就显得有些力不从心</li>
</ul>
<p>是否需要支持 es5？</p>
<ul>
<li>是：高阶函数</li>
<li>否：装饰器</li>
</ul>
<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><ul>
<li>递归菜单栏</li>
<li>使用高阶组件包装路由组件 <code>withRouter()</code></li>
<li>获取当前路由信息：<code>this.props.match</code></li>
<li>使用编程式的路由导航：<code>this.props.history</code><ul>
<li>注意 props 的类型变化</li>
</ul>
</li>
</ul>
<p>异步组件和 vue 稍微有点差别，虽然也是需要 <code>import()</code> 语法，但却需要使用高阶组件。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">AsyncRoute</span>(<span class="params"></span></span><br><span class="line"><span class="params">  importComponent: () =&gt; PromiseLike&lt;&#123; <span class="keyword">default</span>: any &#125;&gt; | &#123; <span class="keyword">default</span>: any &#125;,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">AsyncComponent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&lt;any, any&gt; &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props: any</span>) &#123;</span><br><span class="line">      <span class="variable language_">super</span>(props)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">        <span class="attr">component</span>: <span class="literal">null</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; <span class="attr">default</span>: component &#125; = <span class="keyword">await</span> <span class="title function_">importComponent</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">component</span>: component,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> C = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">component</span></span><br><span class="line">      <span class="keyword">return</span> C ? <span class="language-xml"><span class="tag">&lt;<span class="name">C</span> &#123;<span class="attr">...this.props</span>&#125; /&gt;</span></span> : <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">AsyncComponent</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">AsyncRoute</span></span><br></pre></td></tr></table></figure>

<p>然后使用高阶组件包装即可</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Route</span></span><br><span class="line">  path=&#123;<span class="string">&#x27;/system/task&#x27;</span>&#125;</span><br><span class="line">  component=&#123;<span class="title class_">AsyncRoute</span>(<span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;../../index/HelloWorld&#x27;</span>))&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：高阶组件和高阶函数类似，指的是接收一个组件&#x2F;返回一个组件的组件。</p>
</blockquote>
<h3 id="代码组织"><a href="#代码组织" class="headerlink" title="代码组织"></a>代码组织</h3><ul>
<li>导出：tsx&#x2F;jsx 使用默认导出，避免需要高阶函数包装的场景</li>
<li>优先使用函数式组件</li>
<li>src<ul>
<li>pages：页面级的组件<ul>
<li>component：页面级组件</li>
</ul>
</li>
<li>components：非页面相关的通用组件</li>
<li>assets：静态资源</li>
</ul>
</li>
</ul>
<h3 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h3><ul>
<li>React<ul>
<li>组件：必须使用大写驼峰，包括使用组件亦然</li>
<li>store<ul>
<li>必须使用 .store 后缀以区分普通 ts 文件</li>
<li>组件级 store 必须与组件名保持一致，例如 <code>Login</code> 组件对应的即为 <code>Login.store.ts</code></li>
</ul>
</li>
</ul>
</li>
<li>CSS<ul>
<li>css 中的 class 必须使用小写驼峰命名法，避免 css module 找不到（cra 不会自动处理转换）</li>
<li>优先使用 <code>.module.css</code> 而非 <code>.css</code>，避免全局样式污染</li>
<li>页面级 css 必须与组件名保持一致，例如 <code>Login</code> 组件对应的即为 <code>Login.module.css</code></li>
<li>非 css module 的代码必须使用 <code>&quot;&quot;</code> 而非 <code>&#123;&#39;&#39;&#125;</code></li>
</ul>
</li>
</ul>
<h3 id="修改默认配置"><a href="#修改默认配置" class="headerlink" title="修改默认配置"></a>修改默认配置</h3><p>cra 默认提供了脚本命令 <code>reject</code>，用于将 cra 封装的配置全部解压出来 – 当然，此操作是不可逆的！但除了这种破坏性的方式之外，也有人找到了和 vue-cli 中类似的方式，不过需要第三方包 <code>react-app-rewired</code> 的支持。</p>
<p>并在根目录添加配置文件 <code>config-overrides.js</code>，里面暴露出一个函数，即可修改 cra 的默认配置了。</p>
<p>下面是一个简单的示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">WorkerPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;worker-plugin&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* config-overrides.js */</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> <span class="title function_">override</span>(<span class="params">config, env</span>) &#123;</span><br><span class="line">  <span class="comment">//region WebWorker 配置</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//do stuff with the webpack config...</span></span><br><span class="line">  config.<span class="property">output</span>.<span class="property">globalObject</span> = <span class="string">&#x27;this&#x27;</span></span><br><span class="line">  <span class="keyword">if</span> (!config.<span class="property">plugins</span>) &#123;</span><br><span class="line">    config.<span class="property">plugins</span> = []</span><br><span class="line">  &#125;</span><br><span class="line">  config.<span class="property">plugins</span>.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">WorkerPlugin</span>())</span><br><span class="line"></span><br><span class="line">  <span class="comment">//endregion</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="重点"><a href="#重点" class="headerlink" title="重点"></a>重点</h2><h3 id="this-的值"><a href="#this-的值" class="headerlink" title="this 的值"></a>this 的值</h3><p>在 <code>class</code> 中使用箭头函数以直接绑定当前组件的实例，尽量不要使用 <code>function</code>，否则 <code>this</code> 可能是不明确的。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HelloWorld</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  logMsg = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;msg&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello world<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.logMsg&#125;</span>&gt;</span>打印<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">HelloWorld</span></span><br></pre></td></tr></table></figure>

<h3 id="CSS-样式隔离"><a href="#CSS-样式隔离" class="headerlink" title="CSS 样式隔离"></a>CSS 样式隔离</h3><p>cra 创建的项目默认支持 css module，是 react 项目流行的一种 CSS 隔离方案。</p>
<p>使用步骤</p>
<ol>
<li>为需要的 css 文件使用 <code>.module.css</code> 后缀名</li>
<li>通过 <code>import styles from &#39;*.module.css&#39;</code> 在 <code>tsx</code> 中引入</li>
<li>在 <code>className=&#123;styles.*&#125;</code> 使用 class 样式</li>
</ol>
<p>示例</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.helloWorld</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;HelloWorld.module.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">HelloWorld</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;styles.helloWorld&#125;</span>&gt;</span>hello world<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注：</p>
<ul>
<li>此处的 <code>import styles from &#39;*.module.css&#39;</code> 不支持命名导入</li>
<li>此处实现的逻辑和 Vue 是一致的，只要使用了其中一个样式 <code>class</code>，则整个文件都会引入</li>
<li>CSS 只要被引入了，就不会被删除，即便组件被销毁了亦然，所以页面内的 CSS 只会增加，不会减少</li>
</ul>
<p>如何添加多个，默认使用 cra 创建的项目支持使用模板字符串</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">className=&#123;<span class="string">`<span class="subst">$&#123;styles.className1&#125;</span> <span class="subst">$&#123;styles.className2&#125;</span>`</span>&#125;</span><br></pre></td></tr></table></figure>

<p>看起来很丑？可以试试 <a target="_blank" rel="noopener" href="https://github.com/JedWatson/classnames">classnames</a></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> classNames <span class="keyword">from</span> <span class="string">&#x27;classnames&#x27;</span></span><br><span class="line"></span><br><span class="line">className=&#123;<span class="title function_">classNames</span>(globalStyles.<span class="property">global</span>, globalStyles.<span class="property">margin</span>)&#125;</span><br></pre></td></tr></table></figure>

<p>但仍然很丑，正如 Sindre Sorhus 所说：<a target="_blank" rel="noopener" href="https://twitter.com/sindresorhus/status/1001355913930858502">React 把简单的事情变复杂，复杂的事情变简单</a></p>
<p>另一种个 API 是 <code>classNames.bind</code></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> classNames <span class="keyword">from</span> <span class="string">&#x27;classnames&#x27;</span></span><br><span class="line"><span class="keyword">const</span> cx=&#123;classNames.<span class="title function_">bind</span>(globalStyles)&#125;</span><br><span class="line">className=&#123;<span class="title function_">cx</span>(<span class="string">&#x27;global&#x27;</span>, <span class="string">&#x27;margin&#x27;</span>)&#125;</span><br></pre></td></tr></table></figure>

<p>但这会让 WebStorm 损失所有的 CSS 关联，影响了包括代码提示&#x2F;跳转&#x2F;重构等功能，考虑到维护成本实在得不偿失。</p>
<p>还有人提出了 typed css module，为所有的 <code>.module.css</code> 生成 <code>.d.ts</code> 类型定义，但这会和 css in js 一样丧失 css 预处理器的优势 —- 并且，所有的工具链都需要重新支持这种关联，将之认为是 css。</p>
<blockquote>
<p>参考</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.javascriptstuff.com/css-modules-by-example/">Css Modules by Example</a></li>
<li><a target="_blank" rel="noopener" href="https://create-react-app.dev/docs/adding-a-css-modules-stylesheet/">添加 CSS 模块样式表</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/gajus/babel-plugin-react-css-modules">babel-plugin-react-css-modules</a></li>
</ul>
</blockquote>
<h3 id="引入图片"><a href="#引入图片" class="headerlink" title="引入图片"></a>引入图片</h3><p>在任何一个项目中，都少不了引入图片的需求。而 React 中，并未像 Vue 对 <code>img, audio, video</code> 这些标签进行特殊处理，以支持直接使用路径即可将对应的媒体文件打包进来，React 需要使用 <code>import img from &#39;*&#39;</code> 的<strong>原始</strong>形式让 webpack <strong>知道</strong>这是一个需要打包的资源。</p>
<p>例如</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> img <span class="keyword">from</span> <span class="string">&#x27;img.png&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">reutrn</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;img&#125;</span> <span class="attr">alt</span>=<span class="string">&quot;img&quot;</span> /&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而对于 SVG 类型的图片，React 支持使用组件的形式引入。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ReactComponent</span> <span class="keyword">as</span> <span class="title class_">IconAudio</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../../assets/icon/icon-audio.svg&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">reutrn</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">IconAudio</span> /&gt;</span></span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="slot"><a href="#slot" class="headerlink" title="slot"></a>slot</h3><p>两种方案</p>
<ol>
<li>使用 <code>&#123;props.children&#125;</code>，和 vue 的 <code>slot:default</code> 几乎一样，只是不能通过子组件传递参数。</li>
<li>如果需要传递多个命名 <code>slot</code>，则可以直接为 <code>props</code> 属性赋值为组件。例如 <code>title=&#123;&lt;div&gt;hello world&lt;/div&gt;&#125;</code></li>
<li>如果需要使用子组件传参的话需要使用函数式组件的形式。例如 <code>title=&#123;value =&gt; &lt;div&gt;&#123;value&#125;&lt;/div&gt;&#125;</code></li>
</ol>
<blockquote>
<p>吐槽：函数式已经是政治正确了。</p>
</blockquote>
<p>使用函数式的 <code>slot</code> 时必须检查函数是否存在，如果不存在则不要调用，不像是 vue 中的 <code>slot</code> 是自动处理这一步的。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">tableOperate</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">tableOperate</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">innerValue</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="watch-监听-props"><a href="#watch-监听-props" class="headerlink" title="watch 监听 props"></a>watch 监听 props</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">componentDidUpdate</span>(<span class="params">prevProps: PropsType</span>) &#123;</span><br><span class="line">  <span class="comment">// 典型用法（不要忘记比较 props）：</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">value</span> !== prevProps.<span class="property">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">      <span class="attr">innerValue</span>: <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">value</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>相比于 Vue 的生命周期，React 显然更加<strong>复杂</strong>与<strong>混乱</strong>，而且，老实说有时候真的很难用。</p>
<p>例如非常常见的生命周期 <code>componentWillUpdate</code>，它承担的责任实在是太多了，不仅 <code>watch</code> <code>state/props</code> 中的数据要用这个，连 React Router 的路由变化同样依赖于此。</p>
<p>下面列出最常用的一些生命周期以及典型用例</p>
<ul>
<li><p><code>render</code>：只要 state 变化就会触发重新渲染，等价于 vue 中渲染模板 HTML 中的内容</p>
</li>
<li><p><code>shouldComponentUpdate</code>：state 或者 props <strong>变化前</strong>就会执行，时机上早于 <code>render</code>。等价于 vue <code>beforeUpdate</code>，但可以在这个方法内 <code>return false</code> 阻止视图更新。</p>
</li>
<li><p><code>componentDidUpdate</code>：state 或者 props <strong>变化后</strong>就会执行，时机上晚于 <code>render</code>。等价于 vue <code>updated</code>。<br>多用于监听一些数据变化执行一些副作用操作，但包含的种类可能会非常多。</p>
<blockquote>
<p>注：此处 vue 中将之分为 <code>updated/watch/beforeRouteUpdate</code>，而在 React 中，全部由 <code>componentDidMount</code> 承担这个责任。</p>
</blockquote>
</li>
<li><p><code>componentDidMount</code>：当组件渲染<strong>完成后</strong>就会执行，时机上晚于 <code>render</code>，等价于 vue <code>mounted</code>。<br>多用于执行一些初始化操作，除非逻辑特别简单，否则不要在这个函数里放具体执行逻辑代码，而是专门写初始化函数在这里调用。</p>
</li>
<li><p><code>UNSAFE_componentWillMount</code>：在组件渲染<strong>完成前</strong>就会执行，等价于 vue <code>beforeMount</code>，但被废弃了，替代解决方案参考 <a href="#%E6%80%8E%E4%B9%88%E5%9C%A8%E6%B2%A1%E6%9C%89-created-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E6%8D%AE%E5%B9%B6%E4%BF%9D%E8%AF%81%E7%94%A8%E6%88%B7%E7%9C%8B%E4%B8%8D%E5%88%B0%E9%BB%98%E8%AE%A4%E7%A9%BA%E6%95%B0%E6%8D%AE">怎么在没有 <code>created</code> 生命周期的情况下初始化数据并保证用户看不到默认空数据</a>。</p>
</li>
<li><p><code>componentWillUnmount</code>: 组件即将被销毁前调用，等价于 vue <code>beforeDestroy</code>。</p>
</li>
</ul>
<h3 id="简化-state-修改"><a href="#简化-state-修改" class="headerlink" title="简化 state 修改"></a>简化 state 修改</h3><p>使用 <code>setState</code> 很烦的一点是当你需要深度为某个属性赋值的时候，要为该属性上面所有的对象全部使用 <code>...</code> 或者其他方式拷贝一遍。</p>
<p>例如</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">  <span class="attr">user</span>: &#123;</span><br><span class="line">    ...<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">user</span>,</span><br><span class="line">    <span class="attr">address</span>: &#123;</span><br><span class="line">      ...<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">user</span>.<span class="property">address</span>,</span><br><span class="line">      <span class="attr">city</span>: newCity,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>当有多个属性需要赋值时就尤其的繁琐，而 <a target="_blank" rel="noopener" href="https://github.com/immerjs/immer">immerjs</a> 正好可以解决这种痛点</p>
<p>使用 immer 重构之后</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="title function_">produce</span>(<span class="variable language_">this</span>.<span class="property">state</span>, <span class="function"><span class="params">draft</span> =&gt;</span> &#123;</span><br><span class="line">  draft.<span class="property">user</span>.<span class="property">address</span>.<span class="property">city</span> = newCity</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>代码变得很简单了，虽然看起来是直接赋值，不过 immer 使用了 <code>Proxy</code> 和 <code>Object.freeze</code> 实现了对使用者友好的不可变数据修改，具体参考 。</p>
<h3 id="React-Hooks"><a href="#React-Hooks" class="headerlink" title="React Hooks"></a>React Hooks</h3><p>React Hooks 是在 React 16.8 之后添加的一项新特性，一如既往，很多人又是吹的天花乱坠。老实说最开始 React Hooks 流行并且在各个社群被大肆宣传时，吾辈非常讨厌它，因为它又向函数式靠近了一步—-函数式政治正确真的很讨厌！所以，自正式学习 React 以来，吾辈都没有接触过 React Hooks，都是用 Class Component 实现组件。<br>但现在，架不住好奇心和一些朋友的推荐，吾辈稍微看了一下这个新特性。</p>
<p>它提供了两个主要的 API：</p>
<ul>
<li><code>useState</code>：声明一些可变状态</li>
<li><code>useEffect</code>：声明一些副作用代码</li>
</ul>
<p>使用看起来很简单</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useEffect, useRef, useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HelloHooks</span>: <span class="title class_">React</span>.<span class="property">FC</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">//region 计数器</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">const</span> [list, setList] = useState&lt;string[]&gt;([])</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">countAdd</span> = (<span class="params"></span>) =&gt; <span class="title function_">setCount</span>(count + <span class="number">1</span>)</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;count changed: &#x27;</span>, count)</span><br><span class="line">    <span class="title function_">setList</span>(</span><br><span class="line">      <span class="title class_">Array</span>(count)</span><br><span class="line">        .<span class="title function_">fill</span>(<span class="number">0</span>)</span><br><span class="line">        .<span class="title function_">map</span>(<span class="function">(<span class="params">_, i</span>) =&gt;</span> <span class="string">`第 <span class="subst">$&#123;i + <span class="number">1</span>&#125;</span> 个元素`</span>),</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">//监听 count 变化</span></span><br><span class="line">  &#125;, [count])</span><br><span class="line"></span><br><span class="line">  <span class="comment">//endregion</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//region 自动聚焦输入框</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> inputRef = useRef&lt;<span class="title class_">HTMLInputElement</span>&gt;(<span class="literal">null</span> <span class="keyword">as</span> any)</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    inputRef.<span class="property">current</span>.<span class="title function_">focus</span>()</span><br><span class="line">    <span class="comment">//不监听任何值变化，只在第一次渲染运行</span></span><br><span class="line">  &#125;, [])</span><br><span class="line"></span><br><span class="line">  <span class="comment">//endregion</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">ref</span>=<span class="string">&#123;inputRef&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">value</span>=<span class="string">&#123;count&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">type</span>=<span class="string">&quot;number&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onChange</span>=<span class="string">&#123;e</span> =&gt;</span> setCount(parseInt(e.target.value))&#125;</span></span><br><span class="line"><span class="language-xml">        /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;countAdd&#125;</span>&gt;</span>增加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;list.map((v, i) =&gt; (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;i&#125;</span>&gt;</span>&#123;v&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        ))&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">HelloHooks</span></span><br></pre></td></tr></table></figure>

<p>可以看到，上面用 <code>useState/useEffect</code> 两个函数实现了一些常见的功能：<code>state, componentDidMount, componentDidUpdate</code>，<code>useEffect</code> 甚至默认支持类似 vue <code>watch</code> 的使用方式。</p>
<p>同时，使用 Hooks 可以轻易地封装出 <code>useModel</code>, vue 中的 <code>watch/computed</code> 甚至原生自带了！</p>
<ul>
<li><code>useMemo</code>：当依赖变化时计算属性</li>
<li><code>useCallback</code>：当依赖变化时执行回调</li>
</ul>
<p>然而，Hooks 终究不是万能。</p>
<ul>
<li>使用 Hooks 封装控制 DOM 相关的代码做不到，例如使用高阶组件实现的根据某些条件控制组件是否加载。</li>
<li>使用 Hooks 无法实现全部的生命周期，例如 <code>shouldComponentUpdate</code>。</li>
<li>Hooks <code>useEffect</code> 中调用的外部函数，无法即时获取到所有最新的 <code>state</code>，即便它们与 <code>useEffect</code> 同级，必须在 <code>useEffect</code> 声明正确的依赖才行，即便调用的函数在外部依赖的亦然如此（老实说这点并不简单）。示例：</li>
<li>Hooks 中 <code>useState/useReducer</code> 修改并不能即时反应出来。例如 <code>const [count, setCount] = useState(0)</code> 声明一个状态，使用 <code>setCount(count + 1)</code> 之后立刻取 <code>count</code> 的值仍然是 0，需要等到下次渲染才会生效。而 <code>useRef</code> 声明的可变状态，虽然是即时修改的，但组件却不会因为它的变化重新渲染。示例：<a target="_blank" rel="noopener" href="https://codesandbox.io/s/react-hooks-usestate-async-change-5hlz0">https://codesandbox.io/s/react-hooks-usestate-async-change-5hlz0</a></li>
<li>使用 Hooks 会让函数变得很大，对开发人员的要求比之前更高（与 vue 3 的函数式 API 一样，都是由开发者自己完全控制代码块的分割）</li>
</ul>
<blockquote>
<p>更多有关 React Hooks 的介绍，请参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/hooks-intro.html">Hooks 简介</a></li>
<li><a target="_blank" rel="noopener" href="https://zh-hans.reactjs.org/docs/hooks-faq.html#is-it-safe-to-omit-functions-from-the-list-of-dependencies">在依赖列表中省略函数是否安全？</a></li>
</ul>
</blockquote>
<!-- ### React Props

React props 基本上能传递任何东西，所以承担了 vue 中的多个特性。

- `props` 传递参数
- `$emit` 传递事件
- `slot` 传递组件

从这点来看，React 真是 **少即是多** 的范例。 -->

<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="React-有什么缺点"><a href="#React-有什么缺点" class="headerlink" title="React 有什么缺点"></a>React 有什么缺点</h3><ul>
<li>CSS 局部化有很多方案，但没有一统天下的</li>
<li>vue 在组件创建&#x2F;销毁时会自动初始化&#x2F;销毁状态及监听器，而 mobx 会一直保留需要手动初始化&#x2F;清理<ul>
<li>注: 这点还未找到解决方案</li>
<li>更新：可以使用 context 部分解决这个问题</li>
</ul>
</li>
<li>使用 AntD 时可能遇到样式覆盖不了的问题，需要混合使用 <code>className, style</code> 两个属性。</li>
<li>react 会在开发阶段报错比较多，主要是一些低级错误，尤其是加上 ts 之后尤其如此</li>
</ul>
<h3 id="怎么在没有-created-生命周期的情况下初始化数据并保证用户看不到默认空数据"><a href="#怎么在没有-created-生命周期的情况下初始化数据并保证用户看不到默认空数据" class="headerlink" title="怎么在没有 created 生命周期的情况下初始化数据并保证用户看不到默认空数据"></a>怎么在没有 <code>created</code> 生命周期的情况下初始化数据并保证用户看不到默认空数据</h3><p>在 vue 中，吾辈经常在 created 生命周期中加载数据，避免用户看到默认的空数据，然而，React 中却没有这个生命周期，所以需要额外的处理。</p>
<blockquote>
<p>注：其实 vue 中用户也有可能看到空数据，但因为 Ajax 请求数据的速度也比较快，所以默认可以不用处理。</p>
</blockquote>
<p>一个可能解决方案是在指定元素外面包一层，在页面数据未加载之前，在元素上方添加一个 Loading 遮罩层提示<strong>正在加载中</strong>，等到数据加载完成后删除浮层。</p>
<p>下面是一个简单的实现</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ComponentLoading.module.css */</span></span><br><span class="line"><span class="selector-class">.componentLoadingDialog</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">  <span class="attribute">align-items</span>: center;</span><br><span class="line">  <span class="attribute">z-index</span>: <span class="number">10</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#fff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ComponentLoading.tsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Spin</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;antd&#x27;</span></span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;./ComponentLoading.module.css&#x27;</span></span><br><span class="line"></span><br><span class="line">type <span class="title class_">PropsType</span> = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 是否显示 loading?</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">isLoading</span>: boolean</span><br><span class="line">  tip?: string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 控制 Ajax 请求未完成前某个区域不展示默认数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">props</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@constructor</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ComponentLoading</span>: <span class="title class_">React</span>.<span class="property">FC</span>&lt;<span class="title class_">PropsType</span>&gt; = <span class="keyword">function</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; isLoading, tip = <span class="string">&#x27;正在加载中。。。&#x27;</span> &#125; = props</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">position:</span> &#x27;<span class="attr">relative</span>&#x27; &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;isLoading &amp;&amp; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;styles.componentLoadingDialog&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Spin</span> <span class="attr">tip</span>=<span class="string">&#123;tip&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      &#123;/*注：默认会渲染 children 组件*/&#125;</span></span><br><span class="line"><span class="language-xml">      &#123;props.children&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">ComponentLoading</span></span><br></pre></td></tr></table></figure>

<h3 id="React-和-vue-3-的对比"><a href="#React-和-vue-3-的对比" class="headerlink" title="React 和 vue 3 的对比"></a>React 和 vue 3 的对比</h3><p>vue 3 新增了 <code>Function-base</code> 的组件，看起来很像 React Hooks，但目前仍然无法在生产中实用。</p>
<p>目前看来有以下缺点</p>
<ol>
<li>IDE 支持不好</li>
<li>TS 不能解决 Vue 中的一些问题，尤其是对于模板层面简直无能为力</li>
<li>Vue 3 函数式组件没有覆盖之前所有的功能</li>
<li>周边生态目前没有早期支持的迹象</li>
</ol>
<p>关于第二和第三点，吾辈认为这是 Vue 使用模板带来的一些天然的问题，几乎不可能解决。而 React 和 TS 结合比 Vue 要完善很多，包括类型校验完全使用 TS 而非自定义运行时校验机制。</p>
<p>下面是 vue 作者谈及 vue 3 与其他框架的对比</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/bOdfo5SmQc8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<blockquote>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://vue-composition-api-rfc.netlify.com/#comparison-with-react-hooks">Vue composition api comparison with React Hooks</a></li>
<li><a target="_blank" rel="noopener" href="https://aweiu.com/%E8%B0%81%E8%83%BD%E5%A4%A7%E8%87%B4%E8%AF%B4%E4%B8%8Bvue%E5%92%8Creact%E7%9A%84%E6%9C%80%E5%A4%A7%E5%8C%BA%E5%88%AB%E4%B9%8B%E5%A4%84%EF%BC%9F/">谁能大致说下 vue 和 react 的最大区别之处？</a></li>
</ul>
</blockquote>
<h3 id="开发环境代理"><a href="#开发环境代理" class="headerlink" title="开发环境代理"></a>开发环境代理</h3><p>开发环境配置代理几乎是必用功能，相比于 vue-cli 将全部配置统一在 <code>vue.config.js</code> 中，cra 看起来仍是分散式的。</p>
<p>步骤</p>
<ol>
<li><p>安装中间件 <code>yarn add -D http-proxy-middleware @types/</code></p>
</li>
<li><p>创建文件 <code>src/setupProxy.ts</code></p>
</li>
<li><p>编写配置</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> proxy <span class="keyword">from</span> <span class="string">&#x27;http-proxy-middleware&#x27;</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs-extra&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 开发环境代理</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">app</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">string|*</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span>(<span class="params">app: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">proxyConfig</span>: proxy.<span class="property">Config</span> = &#123;</span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;https://localhost:8000&#x27;</span>,</span><br><span class="line">    <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">secure</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">ws</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="title function_">pathRewrite</span>(<span class="params">api: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> mockApiList = fs.<span class="title function_">readJSONSync</span>(</span><br><span class="line">        path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./config/mockApiList.json&#x27;</span>),</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">        api +</span><br><span class="line">        (mockApiList.<span class="title function_">some</span>(<span class="function">(<span class="params">mockApi: <span class="built_in">string</span></span>) =&gt;</span> api.<span class="title function_">includes</span>(mockApi))</span><br><span class="line">          ? <span class="string">&#x27;?mock=default&amp;errCode=200&#x27;</span></span><br><span class="line">          : <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">      )</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  app.<span class="title function_">use</span>(<span class="title function_">proxy</span>(<span class="string">&#x27;/api&#x27;</span>, proxyConfig))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<blockquote>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://create-react-app.dev/docs/proxying-api-requests-in-development/">Proxying API Requests in Development</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/chimurai/http-proxy-middleware">http-proxy-middleware</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5bd13c5ce51d457a203cebf4">一篇读懂 http-proxy-middleware</a></li>
</ul>
</blockquote>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2020/01/04/others/rxliuliBlog/JavaScript/%E6%B5%85%E8%B0%88-Vue-SPA-%E7%BD%91%E7%AB%99-URL-%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/01/04/others/rxliuliBlog/JavaScript/%E6%B5%85%E8%B0%88-Vue-SPA-%E7%BD%91%E7%AB%99-URL-%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">浅谈 Vue SPA 网站 URL 保存数据实践</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-01-04 23:53:22" itemprop="dateCreated datePublished" datetime="2020-01-04T23:53:22+08:00">2020-01-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2020-01-20 00:00:00" itemprop="dateModified" datetime="2020-01-20T00:00:00+08:00">2020-01-20</time>
    </span>


  
    <span id="/2020/01/04/others/rxliuliBlog/JavaScript/%E6%B5%85%E8%B0%88-Vue-SPA-%E7%BD%91%E7%AB%99-URL-%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE%E5%AE%9E%E8%B7%B5/" class="post-meta-item leancloud_visitors" data-flag-title="浅谈 Vue SPA 网站 URL 保存数据实践" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="浅谈 Vue SPA 网站 URL 保存数据实践" href="/2020/01/04/others/rxliuliBlog/JavaScript/%E6%B5%85%E8%B0%88-Vue-SPA-%E7%BD%91%E7%AB%99-URL-%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE%E5%AE%9E%E8%B7%B5/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::67e36aa7bdbb6f16b6cedd0239a0084d" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>16k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>14 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><blockquote>
<p>该功能吾辈已经封装成 NPM 库 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/vue-url-persist">vue-url-persist</a></p>
</blockquote>
<p>在使用 Vue SPA 开发面向普通用户的网站时，吾辈也遇到了一些之前未被重视，但却实实在在存在的问题，这次便浅谈一下 SPA 网站将所有数据都存储到内存中导致数据很容易丢失以及吾辈思考并尝试的解决方案。</p>
<blockquote>
<p>参考：SPA 全称 <code>single page application</code>，意为 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8D%95%E9%A1%B5%E5%BA%94%E7%94%A8">单页应用</a>，不是泥萌想的那样！#笑哭</p>
</blockquote>
<p>思维导图</p>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:525px; height:245px;" src="https://www.processon.com/embed/5e1e5d93e4b0c3908f881d64"></iframe>

<p>首先列出为什么遇到这个问题，具体场景及解决的问题是什么？</p>
<p>想要解决的一些问题</p>
<ol>
<li>刷新页面数据不丢失：因为数据都保存在内存中，所以刷新之后自然不存在了</li>
<li>URL 复制给其他人数据不丢失：因为数据没有持久化到 URL 上，也没有根据 URL 上的数据进行初始化，所以复制给别人的 URL 当然会丢失数据（搜索条件之类）</li>
<li>页面返回数据不丢失：因为数据都保存在内存中，所以跳转到其他路由再跳转回来数据当然不会存在了</li>
</ol>
<p>那么，先谈一下每个问题的解决方案</p>
<ol>
<li>刷新页面数据不丢失<ul>
<li>将数据序列化到本地，例如 <code>localStorage</code> 中，然后在刷新后获取一次<ul>
<li>注：这方面已经有先行者了，例如 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/vuex-persist">vuex-persist</a> 和 <a target="_blank" rel="noopener" href="https://github.com/robinvdvleuten/vuex-persistedstate">vuex-persistedstate</a></li>
</ul>
</li>
<li>将数据序列化到 URL 上，每次加载都从 URL 上获取数据</li>
</ul>
</li>
<li>URL 复制给其他人数据不丢失<ul>
<li>只能将数据序列化到 URL 上</li>
</ul>
</li>
<li>页面返回数据不丢失<ul>
<li>将数据放到 vuex 中，并且在 URL 上使用 <code>key</code> 进行标识<ul>
<li>注：这方面已经有先行者了，例如 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/vue-navigation">vue-navigation</a> 和 <a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex-router-sync">vuex-router-sync</a></li>
</ul>
</li>
<li>将数据序列化到 URL 上，并且不新增路由记录</li>
<li>使用 vue-router 的缓存 <code>keep-alive</code></li>
</ul>
</li>
</ol>
<p>在了解了这么多的解决方案之后，吾辈最终选择了兼容性最好的 URL 保存数据，它能同时解决 3 个问题。然而，很遗憾的是，这似乎并没有很多人讨论这个问题，或许，这个问题本应该是默认就需要解决的，亦或是 SPA 网站真的很少关心这些了。</p>
<blockquote>
<p>虽说如此，吾辈还是找到了一些讨论的 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/42226479">StackOverflow: How to hold URL query params in Vue with Vue-Router</a></p>
</blockquote>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>一个基本的思路是能够确定的</p>
<ol>
<li>在组件创建时，从 URL 获取数据并为需要的数据进行初始化</li>
<li>在这些数据变化时，及时将数据序列化到 URL 上</li>
</ol>
<p><img src="https://img.rxliuli.com/20200105012847.png" alt="思路图"></p>
<p>然后，再次出现了一个分歧点，到底要不要绑定 Vue？</p>
<ol>
<li>不绑定 vue 手动监听对象变化并将对象的变化响应到 URL 上<br><img src="https://img.rxliuli.com/20200105012848.png" alt="不绑定 vue"></li>
<li>绑定 vue 并使用它的生命周期 <code>created, beforeRouteUpdate</code> 与监听器 <code>watch</code><br><img src="https://img.rxliuli.com/20200105012846.png" alt="绑定 vue"></li>
</ol>
<p>那么，两者有什么区别呢？</p>
<table>
<thead>
<tr>
<th>思路</th>
<th>不绑定 vue</th>
<th>绑定 vue</th>
</tr>
</thead>
<tbody><tr>
<td>优点</td>
<td>非框架强相关，理论上可以通用 <code>Vue/React</code></td>
<td>不需要手动实现 URL 的几种序列化模式，可以预见至少有两种：<code>HTML 5 History/Hash</code></td>
</tr>
<tr>
<td></td>
<td>没有 vue&#x2F;vue-router 的历史包袱</td>
<td>不需要手动实现数据监听&#x2F;响应（虽然现在已然不算难了）</td>
</tr>
<tr>
<td></td>
<td>可以不管 vue-router 实现 URL 动态设置，可以自动优雅降级</td>
<td>灵活性很强，实现比较好的封装之后使用成本很低</td>
</tr>
<tr>
<td>缺点</td>
<td>没有包袱，但同时没有基础，序列化&#x2F;数据监听都需要手动实现</td>
<td>存在历史包袱，vue&#x2F;vue-router 的怪癖一点都绕不过去</td>
</tr>
<tr>
<td></td>
<td>灵活性不足，只能初始化一次，需要&#x2F;不需要序列化的数据分割也相当有挑战</td>
<td>依赖 vue&#x2F;vue-router，在其更新之时也必须跟着更新</td>
</tr>
<tr>
<td></td>
<td>不绑定 vue 意味着与 vue 不可能完美契合</td>
<td>无法通用，在任何一个其他框架（React）上还要再写一套</td>
</tr>
</tbody></table>
<p>最终，在这个十字路口反复踌躇之后，吾辈选择了更加灵活、成本更低的第二种解决方案。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="已解决"><a href="#已解决" class="headerlink" title="已解决"></a>已解决</h3><ul>
<li>序列化数据到 URL 上导致路由记录会随着改变增加</li>
<li>即时序列化数据到 URL 上不现实<blockquote>
<p>这里吾辈对 <a target="_blank" rel="noopener" href="https://yarnpkg.com/">yarn</a> 进行了考察发现其也是异步更新 URL</p>
</blockquote>
</li>
<li>序列化到 URL 上时导致的死循环，<code>序列化数据到 URL 上 =&gt; 路由更新触发 =&gt; 初始化数据到 URL 上 =&gt; 触发数据改变 =&gt; 序列化数据到 URL 上。。。</code></li>
<li>同一个路由携带不同的查询参数的 URL 直接在地址栏输入回车一次不会触发页面数据更新</li>
<li>URL 最大保存数据 IE 最多支持 <code>2083</code> 长度的 URL，换算为中文即为 <code>231</code> 个，所以不能作为一种通用方式进行</li>
<li>Vue 插件不能动态混入，而是在各个生命周期中判断是否要处理的</li>
</ul>
<h3 id="仍遗留"><a href="#仍遗留" class="headerlink" title="仍遗留"></a>仍遗留</h3><ul>
<li>JSON 序列化的数据长度较 query param 更大</li>
</ul>
<blockquote>
<p>下面是具体实现及代码，不喜欢的话可以直接跳到最下面的 <a href="#%E6%80%BB%E7%BB%93">总结</a>。</p>
</blockquote>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/rxliuli/example/tree/linter_vue_example/vue_url_persist_vue_example">GitHub</a></p>
</blockquote>
<h3 id="基本尝试"><a href="#基本尝试" class="headerlink" title="基本尝试"></a>基本尝试</h3><p>首先，尝试不使用任何封装，直接在 <code>created</code> 生命周期中初始化并绑定 <code>$watch</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form1&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;keyword&quot;</span>&gt;</span>搜索名:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;form.keyword&quot;</span> <span class="attr">id</span>=<span class="string">&quot;keyword&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">v-model</span>=<span class="string">&quot;form.hobbyList&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">id</span>=<span class="string">&quot;anime&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">value</span>=<span class="string">&quot;anime&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;anime&quot;</span>&gt;</span>动画<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;form.hobbyList&quot;</span> <span class="attr">id</span>=<span class="string">&quot;game&quot;</span> <span class="attr">value</span>=<span class="string">&quot;game&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;game&quot;</span>&gt;</span>游戏<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">v-model</span>=<span class="string">&quot;form.hobbyList&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">id</span>=<span class="string">&quot;movie&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">value</span>=<span class="string">&quot;movie&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;movie&quot;</span>&gt;</span>电影<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;&#123; form &#125;&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">name</span>: <span class="string">&#x27;Form1&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="attr">form</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="attr">keyword</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="attr">hobbyList</span>: [],</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="title function_">created</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">const</span> key = <span class="string">&#x27;qb&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">const</span> urlData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>[key] || <span class="string">&#x27;&#123;&#125;&#x27;</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>.<span class="property">form</span>, urlData.<span class="property">form</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">this</span>.$watch(</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="string">&#x27;form&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      <span class="keyword">function</span>(<span class="params">val</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        urlData.<span class="property">form</span> = val</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">replace</span>(&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          <span class="attr">query</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            ...<span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            [key]: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(urlData),</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">          &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="attr">deep</span>: <span class="literal">true</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    )</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="分离通用性函数"><a href="#分离通用性函数" class="headerlink" title="分离通用性函数"></a>分离通用性函数</h3><p>然后，便是将之分离为单独的函数，方便在所有组件中进行复用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化一些数据需要序列化/反序列化到 url data 上</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initUrlData</span>(<span class="params">exps</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> key = <span class="string">&#x27;qb&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> urlData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>[key] || <span class="string">&#x27;&#123;&#125;&#x27;</span>)</span><br><span class="line">  exps.<span class="title function_">forEach</span>(<span class="function"><span class="params">exp</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>[exp], urlData[exp])</span><br><span class="line">    <span class="variable language_">this</span>.$watch(</span><br><span class="line">      exp,</span><br><span class="line">      <span class="keyword">function</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        urlData[exp] = val</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">replace</span>(&#123;</span><br><span class="line">          <span class="attr">query</span>: &#123;</span><br><span class="line">            ...<span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>,</span><br><span class="line">            [key]: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(urlData),</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">deep</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用起来需要在 <code>created</code> 生命中调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">created</span>(<span class="params"></span>) &#123;</span><br><span class="line">    initUrlData.<span class="title function_">call</span>(<span class="variable language_">this</span>, [<span class="string">&#x27;form&#x27;</span>])</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="处理深层监听"><a href="#处理深层监听" class="headerlink" title="处理深层监听"></a>处理深层监听</h3><p>如果需要监听的值不是 data 下的顶级字段，而是深层字段的话，便不能直接使用 <code>[]</code> 进行取值和赋值了，而是需要实现支持深层取值&#x2F;赋值的 <code>get/set</code>。而且，深层监听也意味着一般不会是对象，所以也不能采用 <code>Object.assign</code> 进行合并。</p>
<p>例如需要监听 <code>page</code> 对象中的 <code>offset, size</code> 两字段</p>
<p>首先，需要编写通用的 <code>get/set</code> 函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析字段字符串为数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> str 字段字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 字符串数组，数组的 `[]` 取法会被解析为数组的一个元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parseFieldStr</span>(<span class="params">str</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> str</span><br><span class="line">    .<span class="title function_">split</span>(<span class="regexp">/[\\.\\[]/</span>)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function"><span class="params">k</span> =&gt;</span> (<span class="regexp">/\]$/</span>.<span class="title function_">test</span>(k) ? k.<span class="title function_">slice</span>(<span class="number">0</span>, k.<span class="property">length</span> - <span class="number">1</span>) : k))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 安全的深度获取对象的字段</span></span><br><span class="line"><span class="comment"> * 注: 只要获取字段的值为 &#123;<span class="doctag">@type</span> null|undefined&#125;，就会直接返回 &#123;<span class="doctag">@param</span> defVal&#125;</span></span><br><span class="line"><span class="comment"> * 类似于 ES2019 的可选调用链特性: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/%E5%8F%AF%E9%80%89%E9%93%BE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> obj 获取的对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fields 字段字符串或数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> [defVal] 取不到值时的默认值，默认为 null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">obj, fields, defVal = <span class="literal">null</span></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fields === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    fields = <span class="title function_">parseFieldStr</span>(fields)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> res = obj</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> field <span class="keyword">of</span> fields) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      res = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(res, field)</span><br><span class="line">      <span class="keyword">if</span> (res === <span class="literal">undefined</span> || res === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> defVal</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">return</span> defVal</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 安全的深度设置对象的字段</span></span><br><span class="line"><span class="comment"> * 注: 只要设置字段的值为 &#123;<span class="doctag">@type</span> null|undefined&#125;，就会直接返回 &#123;<span class="doctag">@param</span> defVal&#125;</span></span><br><span class="line"><span class="comment"> * 类似于 ES2019 的可选调用链特性: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/%E5%8F%AF%E9%80%89%E9%93%BE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> obj 设置的对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fields 字段字符串或数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> [val] 设置字段的值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">set</span>(<span class="params">obj, fields, val</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fields === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    fields = <span class="title function_">parseFieldStr</span>(fields)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> res = obj</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, len = fields.<span class="property">length</span>; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> field = fields[i]</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(i, res, field, res[field])</span><br><span class="line">    <span class="keyword">if</span> (i === len - <span class="number">1</span>) &#123;</span><br><span class="line">      res[field] = val</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    res = res[field]</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;res: &#x27;</span>, res)</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> res !== <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，是替换赋值操作，将之修改为一个专门的函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为 vue 实例上的字段进行深度赋值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setInitData</span>(<span class="params">vm, exp, urlData</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> oldVal = <span class="title function_">get</span>(vm, exp, <span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> newVal = urlData[exp]</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> oldVal === <span class="string">&#x27;object&#x27;</span> &amp;&amp; newVal !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="title function_">get</span>(vm, exp), newVal)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">set</span>(vm, exp, newVal)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化一些数据需要序列化/反序列化到 url data 上</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initUrlData</span>(<span class="params">exps</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> key = <span class="string">&#x27;qb&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> urlData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>[key] || <span class="string">&#x27;&#123;&#125;&#x27;</span>)</span><br><span class="line">  exps.<span class="title function_">forEach</span>(<span class="function"><span class="params">exp</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setInitData</span>(<span class="variable language_">this</span>, exp, urlData)</span><br><span class="line">    <span class="variable language_">this</span>.$watch(</span><br><span class="line">      exp,</span><br><span class="line">      <span class="keyword">function</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        urlData[exp] = val</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">replace</span>(&#123;</span><br><span class="line">          <span class="attr">query</span>: &#123;</span><br><span class="line">            ...<span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>,</span><br><span class="line">            [key]: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(urlData),</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">deep</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，便能单独监听对象中的某个字段了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initUrlData.<span class="title function_">call</span>(<span class="variable language_">this</span>, [<span class="string">&#x27;form.keyword&#x27;</span>])</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参考：lodash 的函数 <a target="_blank" rel="noopener" href="https://lodash.com/docs/4.17.15#get">get</a>&#x2F;<a target="_blank" rel="noopener" href="https://lodash.com/docs/4.17.15#set">set</a></p>
</blockquote>
<h3 id="使用防抖避免触发过快"><a href="#使用防抖避免触发过快" class="headerlink" title="使用防抖避免触发过快"></a>使用防抖避免触发过快</h3><p>但目前而言每次同步都是即时的，在数据量较大时，可能会存在一些问题，所以使用防抖避免每次数据更新都即时同步到 URL 上。</p>
<p>首先，实现一个简单的防抖函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 函数去抖</span></span><br><span class="line"><span class="comment"> * 去抖 (debounce) 去抖就是对于一定时间段的连续的函数调用，只让其执行一次</span></span><br><span class="line"><span class="comment"> * 注: 包装后的函数如果两次操作间隔小于 delay 则不会被执行, 如果一直在操作就会一直不执行, 直到操作停止的时间大于 delay 最小间隔时间才会执行一次, 不管任何时间调用都需要停止操作等待最小延迟时间</span></span><br><span class="line"><span class="comment"> * 应用场景主要在那些连续的操作, 例如页面滚动监听, 包装后的函数只会执行最后一次</span></span><br><span class="line"><span class="comment"> * 注: 该函数第一次调用一定不会执行，第一次一定拿不到缓存值，后面的连续调用都会拿到上一次的缓存值。如果需要在第一次调用获取到的缓存值，则需要传入第三个参数 &#123;<span class="doctag">@param</span> init&#125;，默认为 &#123;<span class="doctag">@code</span> undefined&#125; 的可选参数</span></span><br><span class="line"><span class="comment"> * 注: 返回函数结果的高阶函数需要使用 &#123;<span class="doctag">@see</span> Proxy&#125; 实现，以避免原函数原型链上的信息丢失</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> action 真正需要执行的操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> delay 最小延迟时间，单位为 ms</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> init 初始的缓存值，不填默认为 &#123;<span class="doctag">@see</span> undefined&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> function(...[*]=): Promise&lt;any&gt; &#123;<span class="doctag">@see</span> action&#125; 是否异步没有太大关联</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">action, delay, init = <span class="literal">null</span></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> flag</span><br><span class="line">  <span class="keyword">let</span> result = init</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (flag) <span class="built_in">clearTimeout</span>(flag)</span><br><span class="line">      flag = <span class="built_in">setTimeout</span>(</span><br><span class="line">        <span class="function">() =&gt;</span> <span class="title function_">resolve</span>((result = action.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args))),</span><br><span class="line">        delay,</span><br><span class="line">      )</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">resolve</span>(result), delay)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将 <code>$watch</code> 中的函数用 <code>debounce</code> 进行包装</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化一些数据需要序列化/反序列化到 url data 上</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initUrlData</span>(<span class="params">exps</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> key = <span class="string">&#x27;qb&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> urlData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>[key] || <span class="string">&#x27;&#123;&#125;&#x27;</span>)</span><br><span class="line">  exps.<span class="title function_">forEach</span>(<span class="function"><span class="params">exp</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setInitData</span>(<span class="variable language_">this</span>, exp, urlData)</span><br><span class="line">    <span class="variable language_">this</span>.$watch(</span><br><span class="line">      exp,</span><br><span class="line">      <span class="title function_">debounce</span>(<span class="keyword">function</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        urlData[exp] = val</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">replace</span>(&#123;</span><br><span class="line">          <span class="attr">query</span>: &#123;</span><br><span class="line">            ...<span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>,</span><br><span class="line">            [key]: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(urlData),</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;, <span class="number">1000</span>),</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">deep</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>引用：<a target="_blank" rel="noopener" href="https://juejin.im/post/5b8de829f265da43623c4261">掘金：7 分钟理解 JS 的节流、防抖及使用场景</a><br>参考：lodash 的函数 <a target="_blank" rel="noopener" href="https://lodash.com/docs/4.17.15#debounce">debounce</a></p>
</blockquote>
<h3 id="处理路由不变但-query-修改的问题"><a href="#处理路由不变但-query-修改的问题" class="headerlink" title="处理路由不变但 query 修改的问题"></a>处理路由不变但 query 修改的问题</h3><p>接下来，就需要处理一种小众，但确实存在的场景了。</p>
<ul>
<li>同一个组件被多个路由复用，这些路由仅仅只是一个 path param 改变了。例如 <a target="_blank" rel="noopener" href="https://ant.design/components/tabs-cn/">标签页</a></li>
<li>用户复制 URL 之后，发现其中的查询关键字错了，于是修改了关键字之后又复制了一次，而粘贴两次路由相同 query param 不同的 URL 是不会重新创建组件的</li>
</ul>
<p>首先确定基本的思路：在路由改变但组件没有重新创建时将 URL 上的数据为需要的数据进行初始化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在组件被 vue-router 路由复用时，单独进行初始化数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> route 将要改变的路由对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initUrlDataByRouteUpdate</span>(<span class="params">exps, route</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> urlData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(route.<span class="property">query</span>[key] || <span class="string">&#x27;&#123;&#125;&#x27;</span>)</span><br><span class="line">  exps.<span class="title function_">forEach</span>(<span class="function"><span class="params">exp</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setInitData</span>(<span class="variable language_">this</span>, exp, urlData)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 vue 实例的生命周期 <code>beforeRouteUpdate, beforeRouteEnter</code> 重新初始化 <code>data</code> 中的数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">beforeRouteUpdate</span>(<span class="params">to, <span class="keyword">from</span>, next</span>) &#123;</span><br><span class="line">    initUrlDataByRouteUpdate.<span class="title function_">call</span>(<span class="variable language_">this</span>, [<span class="string">&#x27;form&#x27;</span>], to)</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">beforeRouteEnter</span>(<span class="params">to, <span class="keyword">from</span>, next</span>) &#123;</span><br><span class="line">    <span class="title function_">next</span>(<span class="function"><span class="params">vm</span> =&gt;</span> initUrlDataByRouteUpdate.<span class="title function_">call</span>(vm, [<span class="string">&#x27;form&#x27;</span>], to))</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>真的以为问题都解决了么？并不然，打开控制台你会发现一些 vue router 的警告</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue-router.esm.js?8c4f:2051 Uncaught (<span class="keyword">in</span> promise) NavigationDuplicated &#123;_name: <span class="string">&quot;NavigationDuplicated&quot;</span>, name: <span class="string">&quot;NavigationDuplicated&quot;</span>, message: <span class="string">&quot;Navigating to current location (&quot;</span>/form1/?qb=%7B%22…,%22movie%22,%22game%22%5D%7D%7D<span class="string">&quot;) is not allowed&quot;</span>, stack: <span class="string">&quot;Error↵    at new NavigationDuplicated (webpack-int…/views/Form1.vue?vue&amp;type=script&amp;lang=js&amp;:222:40)&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>其实是因为循环触发导致的：<code>序列化数据到 URL 上 =&gt; 路由更新触发 =&gt; 初始化数据到 URL 上 =&gt; 触发数据改变 =&gt; 序列化数据到 URL 上。。。</code>，目前可行的解决方案是在 <code>$watch</code> 中判断数据是否与原来的相同，相同就不进行赋值，避免再次触发 vue-router 的 <code>beforeRouteUpdate</code> 生命周期。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化一些数据需要序列化/反序列化到 url data 上</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initUrlData</span>(<span class="params">exps</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> urlData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>[key] || <span class="string">&#x27;&#123;&#125;&#x27;</span>)</span><br><span class="line">  exps.<span class="title function_">forEach</span>(<span class="function"><span class="params">exp</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setInitData</span>(<span class="variable language_">this</span>, exp, urlData)</span><br><span class="line">    <span class="variable language_">this</span>.$watch(</span><br><span class="line">      exp,</span><br><span class="line">      <span class="title function_">debounce</span>(<span class="keyword">function</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        urlData[exp] = val</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>[key] === <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(urlData)) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">replace</span>(&#123;</span><br><span class="line">          <span class="attr">query</span>: &#123;</span><br><span class="line">            ...<span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>,</span><br><span class="line">            [key]: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(urlData),</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;, <span class="number">1000</span>),</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">deep</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，控制台不会再有警告了。</p>
<h3 id="封装起来"><a href="#封装起来" class="headerlink" title="封装起来"></a>封装起来</h3><h4 id="使用-Vue-插件"><a href="#使用-Vue-插件" class="headerlink" title="使用 Vue 插件"></a>使用 Vue 插件</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; debounce, get, set &#125; <span class="keyword">from</span> <span class="string">&#x27;./common&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VueUrlPersist</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 一些选项</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">expListName</span> = <span class="string">&#x27;exps&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">urlPersistName</span> = <span class="string">&#x27;qb&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 将 URL 上的数据初始化到 data 上</span></span><br><span class="line"><span class="comment">   * 此处存在一个谬误</span></span><br><span class="line"><span class="comment">   * 1. 如果对象不使用合并而是赋值，则处理 [干净] 的 URL 就会很棘手，因为无法感知到初始值是什么</span></span><br><span class="line"><span class="comment">   * 2. 如果对象使用合并，则手动输入的相同路由不同参数的 URL 就无法处理</span></span><br><span class="line"><span class="comment">   *    注：该问题已经通过在 watch 中判断值是否变化而解决，但总感觉还有莫名其妙的坑在前面等着。。。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">vm</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">expOrFn</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">urlData</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">initVueData</span>(<span class="params">vm, expOrFn, urlData</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldVal = <span class="title function_">get</span>(vm, expOrFn, <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">const</span> newVal = urlData[expOrFn]</span><br><span class="line">    <span class="keyword">if</span> (oldVal === <span class="literal">undefined</span> || oldVal === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">set</span>(vm, expOrFn, newVal)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> oldVal === <span class="string">&#x27;object&#x27;</span> &amp;&amp; newVal !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="title function_">get</span>(vm, expOrFn), newVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在组件被 vue-router 路由复用时，单独进行初始化数据</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">vm</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">expOrFnList</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">route</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">initNextUrlData</span>(<span class="params">vm, expOrFnList, route</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> urlData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(route.<span class="property">query</span>[<span class="variable language_">this</span>.<span class="property">urlPersistName</span>] || <span class="string">&#x27;&#123;&#125;&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;urlData: &#x27;</span>, urlData)</span><br><span class="line">    expOrFnList.<span class="title function_">forEach</span>(<span class="function"><span class="params">expOrFn</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">initVueData</span>(vm, expOrFn, urlData)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在组件被 vue 创建后初始化数据并监听之，在发生变化时自动序列化到 URL 上</span></span><br><span class="line"><span class="comment">   * 注：需要序列化到 URL 上的数据必须能被 JSON.stringfy 序列化</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">vm</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">expOrFnList</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">initUrlData</span>(<span class="params">vm, expOrFnList</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> urlData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(vm.<span class="property">$route</span>.<span class="property">query</span>[<span class="variable language_">this</span>.<span class="property">urlPersistName</span>] || <span class="string">&#x27;&#123;&#125;&#x27;</span>)</span><br><span class="line">    expOrFnList.<span class="title function_">forEach</span>(<span class="function"><span class="params">expOrFn</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">initVueData</span>(vm, expOrFn, urlData)</span><br><span class="line"></span><br><span class="line">      vm.$watch(</span><br><span class="line">        expOrFn,</span><br><span class="line">        <span class="title function_">debounce</span>(<span class="number">1000</span>, <span class="keyword">async</span> val =&gt; &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;val 变化了: &#x27;</span>, val)</span><br><span class="line">          urlData[expOrFn] = val</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            vm.<span class="property">$route</span>.<span class="property">query</span>[<span class="variable language_">this</span>.<span class="property">urlPersistName</span>] === <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(urlData)</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">await</span> vm.<span class="property">$router</span>.<span class="title function_">replace</span>(&#123;</span><br><span class="line">            <span class="attr">query</span>: &#123;</span><br><span class="line">              ...vm.<span class="property">$route</span>.<span class="property">query</span>,</span><br><span class="line">              [<span class="variable language_">this</span>.<span class="property">urlPersistName</span>]: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(urlData),</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;),</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">deep</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">install</span>(<span class="params">Vue, options = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> _this = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">expListName</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">expListName</span> = options.<span class="property">expListName</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">urlPersistName</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">urlPersistName</span> = options.<span class="property">urlPersistName</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$urlPersist</span> = <span class="variable language_">this</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">initDataByRouteUpdate</span>(<span class="params">to</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> expList = <span class="variable language_">this</span>[_this.<span class="property">expListName</span>]</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(expList)) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$urlPersist</span>.<span class="title function_">initNextUrlData</span>(<span class="variable language_">this</span>, expList, to)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Vue</span>.<span class="title function_">mixin</span>(&#123;</span><br><span class="line">      <span class="title function_">created</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> expList = <span class="variable language_">this</span>[_this.<span class="property">expListName</span>]</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(expList)) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">$urlPersist</span>.<span class="title function_">initUrlData</span>(<span class="variable language_">this</span>, expList)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">beforeRouteUpdate</span>(<span class="params">to, <span class="keyword">from</span>, next</span>) &#123;</span><br><span class="line">        initDataByRouteUpdate.<span class="title function_">call</span>(<span class="variable language_">this</span>, to)</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">beforeRouteEnter</span>(<span class="params">to, <span class="keyword">from</span>, next</span>) &#123;</span><br><span class="line">        <span class="title function_">next</span>(<span class="function"><span class="params">vm</span> =&gt;</span> initDataByRouteUpdate.<span class="title function_">call</span>(vm, to))</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">VueUrlPersist</span></span><br></pre></td></tr></table></figure>

<p>使用起来和其他的插件没什么差别</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">VueUrlPersist</span> <span class="keyword">from</span> <span class="string">&#x27;./views/js/VueUrlPersist&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vueUrlPersist = <span class="keyword">new</span> <span class="title class_">VueUrlPersist</span>()</span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(vueUrlPersist)</span><br></pre></td></tr></table></figure>

<p>在需要使用的组件中只要声明这个属性就好了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Form2Tab&#x27;</span>,</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">form</span>: &#123;</span><br><span class="line">        <span class="attr">keyword</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">sex</span>: <span class="number">0</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">exps</span>: [<span class="string">&#x27;form&#x27;</span>],</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然而，使用 vue 插件有个致命的缺陷：无论是否需要，都会为每个组件中都混入三个生命周期函数，吾辈没有找到一种可以根据实例中是否包含某个值而决定是否混入的方式。</p>
<h4 id="使用高阶函数"><a href="#使用高阶函数" class="headerlink" title="使用高阶函数"></a>使用高阶函数</h4><p>所以，我们使用 <code>高阶函数</code> + <code>mixin</code> 的形式看看。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; debounce, get, set &#125; <span class="keyword">from</span> <span class="string">&#x27;./common&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VueUrlPersist</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 一些选项</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">&#123; key = <span class="string">&#x27;qb&#x27;</span> &#125; = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">key</span> = key</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 为 vue 实例上的字段进行深度赋值</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">setInitData</span>(<span class="params">vm, exp, urlData</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldVal = <span class="title function_">get</span>(vm, exp, <span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">const</span> newVal = urlData[exp]</span><br><span class="line">    <span class="comment">//如果原值是对象且新值也是对象，则进行浅合并</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      oldVal === <span class="literal">undefined</span> ||</span><br><span class="line">      oldVal === <span class="literal">null</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> oldVal === <span class="string">&#x27;string&#x27;</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> oldVal === <span class="string">&#x27;number&#x27;</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="title function_">set</span>(vm, exp, newVal)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> oldVal === <span class="string">&#x27;object&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> newVal === <span class="string">&#x27;object&#x27;</span>) &#123;</span><br><span class="line">      <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="title function_">get</span>(vm, exp), newVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 初始化一些数据需要序列化/反序列化到 url data 上</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> vm vue 实例</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">initUrlDataByCreated</span>(<span class="params">vm, exps</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="variable language_">this</span>.<span class="property">key</span></span><br><span class="line">    <span class="keyword">const</span> urlData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(vm.<span class="property">$route</span>.<span class="property">query</span>[key] || <span class="string">&#x27;&#123;&#125;&#x27;</span>)</span><br><span class="line">    exps.<span class="title function_">forEach</span>(<span class="function"><span class="params">exp</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setInitData</span>(vm, exp, urlData)</span><br><span class="line">      vm.$watch(</span><br><span class="line">        exp,</span><br><span class="line">        <span class="title function_">debounce</span>(<span class="keyword">function</span>(<span class="params">val</span>) &#123;</span><br><span class="line">          urlData[exp] = val</span><br><span class="line">          <span class="keyword">if</span> (vm.<span class="property">$route</span>.<span class="property">query</span>[key] === <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(urlData)) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">          &#125;</span><br><span class="line">          vm.<span class="property">$router</span>.<span class="title function_">replace</span>(&#123;</span><br><span class="line">            <span class="attr">query</span>: &#123;</span><br><span class="line">              ...vm.<span class="property">$route</span>.<span class="property">query</span>,</span><br><span class="line">              [key]: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(urlData),</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;, <span class="number">1000</span>),</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">deep</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在组件被 vue-router 路由复用时，单独进行初始化数据</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> vm vue 实例</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> route 将要改变的路由对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">initUrlDataByRouteUpdate</span>(<span class="params">vm, exps, route</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> urlData = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(route.<span class="property">query</span>[<span class="variable language_">this</span>.<span class="property">key</span>] || <span class="string">&#x27;&#123;&#125;&#x27;</span>)</span><br><span class="line">    exps.<span class="title function_">forEach</span>(<span class="function"><span class="params">exp</span> =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">setInitData</span>(vm, exp, urlData))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 生成可以 mixin 到 vue 实例的对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">&#123;created(): void, beforeRouteEnter(*=, *, *): void, beforeRouteUpdate(*=, *, *): void</span>&#125;&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">generateInitUrlData</span>(<span class="params">...exps</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> _this = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="title function_">created</span>(<span class="params"></span>) &#123;</span><br><span class="line">        _this.<span class="title function_">initUrlDataByCreated</span>(<span class="variable language_">this</span>, exps)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">beforeRouteUpdate</span>(<span class="params">to, <span class="keyword">from</span>, next</span>) &#123;</span><br><span class="line">        _this.<span class="title function_">initUrlDataByRouteUpdate</span>(<span class="variable language_">this</span>, exps, to)</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">beforeRouteEnter</span>(<span class="params">to, <span class="keyword">from</span>, next</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;beforeRouteEnter&#x27;</span>)</span><br><span class="line">        <span class="title function_">next</span>(<span class="function"><span class="params">vm</span> =&gt;</span> _this.<span class="title function_">initUrlDataByRouteUpdate</span>(vm, exps, to))</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 修改一些配置</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> options 配置项</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">config</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>, options)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> vueUrlPersist = <span class="keyword">new</span> <span class="title class_">VueUrlPersist</span>()</span><br><span class="line"><span class="keyword">const</span> generateInitUrlData = vueUrlPersist.<span class="property">generateInitUrlData</span>.<span class="title function_">bind</span>(</span><br><span class="line">  vueUrlPersist,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; vueUrlPersist, generateInitUrlData, <span class="title class_">VueUrlPersist</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> vueUrlPersist</span><br></pre></td></tr></table></figure>

<p>使用起来几乎一样简单</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; generateInitUrlData &#125; <span class="keyword">from</span> <span class="string">&#x27;./js/VueUrlPersist&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Form1&#x27;</span>,</span><br><span class="line">  <span class="attr">mixins</span>: [<span class="title function_">generateInitUrlData</span>(<span class="string">&#x27;form&#x27;</span>)],</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">form</span>: &#123;</span><br><span class="line">        <span class="attr">keyword</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">hobbyList</span>: [],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看起来，使用高阶函数也没有比 Vue 插件麻烦太多。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总的来说，虽然路途坎坷，不过这个问题还是很有趣的，而且确实能解决实际的问题，所以还是有研究价值的。</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2020/01/01/others/rxliuliBlog/dev/%E6%BC%AB%E8%B0%88-%E5%8F%8D%E4%B9%8C%E6%89%98%E9%82%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/01/01/others/rxliuliBlog/dev/%E6%BC%AB%E8%B0%88-%E5%8F%8D%E4%B9%8C%E6%89%98%E9%82%A6/" class="post-title-link" itemprop="url">漫谈 反乌托邦</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-01-01 20:09:08" itemprop="dateCreated datePublished" datetime="2020-01-01T20:09:08+08:00">2020-01-01</time>
    </span>


  
    <span id="/2020/01/01/others/rxliuliBlog/dev/%E6%BC%AB%E8%B0%88-%E5%8F%8D%E4%B9%8C%E6%89%98%E9%82%A6/" class="post-meta-item leancloud_visitors" data-flag-title="漫谈 反乌托邦" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="漫谈 反乌托邦" href="/2020/01/01/others/rxliuliBlog/dev/%E6%BC%AB%E8%B0%88-%E5%8F%8D%E4%B9%8C%E6%89%98%E9%82%A6/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::699f055be26cc37b1e03867307b12df4" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1984"><a href="#1984" class="headerlink" title="1984"></a>1984</h2><p>最近看完了 <strong>1984</strong> 这本小说，在之后也补了一下电影</p>
<p>Youtube 正版电影</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/S0WSCZx6R6M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p>一些设定令人惊奇</p>
<ul>
<li>真理部：负责新闻、娱乐、教育、艺术</li>
<li>和平部：负责战争</li>
<li>有爱不：负责维持法律和秩序</li>
<li>富裕部：负责经济事务</li>
</ul>
<p>一些名言令人印象深刻</p>
<ul>
<li>过去被禁止，控制过去的人控制未来，控制现在的人控制过去。</li>
<li>除了对集体的爱，没有其他的爱，与之竞争的都要被摧毁。</li>
<li>无产阶级就像牲口一样，什么办法都没有。</li>
<li>现代战争的本质，就是毁灭产品和人类的劳动，保持社会处于饥饿的边缘，一个分等级的社会只可能建立在贫穷和无知的基础上。</li>
<li>栗树荫下，我出卖你，你出卖我。</li>
</ul>
<p>里面小孩举报父母，被洗脑而不自知，或许，亦是因为一张白纸更容易染上颜色吧。</p>
<ul>
<li>低效的前进，高效的内斗</li>
</ul>
<p>现实场景</p>
<ul>
<li>这本书可以很容易买到</li>
<li>中文网络上没有国人影评&#x2F;同人小说</li>
<li>1984 在微博已经成为非法内容了</li>
<li>举报父母已有现实案例（所谓的大义灭亲）</li>
</ul>
<h2 id="美丽新世界"><a href="#美丽新世界" class="headerlink" title="美丽新世界"></a>美丽新世界</h2><ul>
<li>人工胚胎，设置命运：感觉是个恐怖的极权世界</li>
<li>从小开始的 SEX 游戏与索麻，消费&#x2F;享乐主义至上：或许是个天堂？</li>
<li>野人区：旧时代的信仰、肮脏的生活与 <strong>美丽新世界</strong> 对比，让人真不知道哪个是天堂？</li>
<li>野人疯了：发现自己苦苦追寻的事物、坚信的认知却一文不值时，疯掉了，<strong>天堂</strong> 对他而言也是地狱了</li>
<li><code>9/10</code> 的人口供养着 <code>1/10</code> 的人口是 <strong>阿尔法</strong>，无论是水上还是水下都会感到快乐，不提高产量的最大原因是为了避免闲暇时间造成资源的浪费</li>
</ul>
<p>那种 <strong>美丽新世界</strong> 和 <strong>野人区</strong> 真的很难说哪个更好，活到 60 岁，但一生都能保持年轻，并且 <strong>每个人属于每个人</strong> 的理念确实很厉害。</p>
<ul>
<li>要求 <strong>不快乐</strong> 的权力</li>
</ul>
<h2 id="疫情"><a href="#疫情" class="headerlink" title="疫情"></a>疫情</h2><p>花了几年营造出来的中国梦，在一个春节就破碎的不成样子了。</p>
<ul>
<li>双重思想在现实中确实存在，而且很常见。<ul>
<li><a target="_blank" rel="noopener" href="https://twitter.com/LiYing_2015/status/1227363930504196096">所以为歌颂伟大牺牲的时候，就防护服不足，以至于医护人员都不够用，为辟反动谣言的时候，就殡葬人员都必须有防护服。动动脑子想一想的结果就是如此的辩证</a></li>
<li>“我们要自由。我们反对香港游行、台湾独立。”，说这两句话的是同一批人。<ul>
<li>或许未曾意识到，香港、台湾他们也是为了自由，甚至于，或许只是跟风发泄一下情绪，并不明白自由是什么。。。</li>
</ul>
</li>
</ul>
</li>
<li>没有说 <code>1 + 1 = 2</code> 的权利<ul>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%9D%8E%E6%96%87%E4%BA%AE">李文亮</a></li>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%AD%A6%E6%BC%A2%E9%80%A0%E8%AC%A0%E5%85%AB%E5%90%9B%E5%AD%90">武汉「造谣」八君子</a></li>
</ul>
</li>
<li>未曾想过现实中真的有 <strong>新语</strong> 一说<ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/bS_8xCR2bxpwWKcoAeo4pw">为什么日本人显得比中国人更懂中国文化</a><ul>
<li>“山川异域，风月同天。” 居然比不上 <strong>新语</strong> 的 “武汉加油”。</li>
<li>新世纪笑话：<blockquote>
<p>我举一个例子，比如你是给武汉捐助救灾物资的一位执行者，你在包装箱上写了八个字：山川异域，风月同天。领导看见了，会直接骂你：“你特么神经病吗？写这个干嘛？应该写武汉加油，还要加一个大感叹号。”<br>为什么不能用这八个字？因为这八个字不在那一套新话系统里面。这就超出了一位领导干部的思维边界。超出思维边界的事物，都是危险的、不可控的，是不可以使用的。<br>领导还要问你：你听明白了吗？能不能做到？<br>所以，你只能写个 “武汉加油”。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/15/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><span class="page-number current">16</span><a class="page-number" href="/page/17/">17</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/17/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ftq</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">1.5m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">22:49</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="//unpkg.com/animejs@3.1.0/lib/anime.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




<script src="/js/third-party/sakuraPlus.js"></script>
<script src="/js/third-party/fireworks.js"></script>
<script src="/js/third-party/mouse_slide.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"6NuBzi5VSiFfQE2sYbymtv9t-gzGzoHsz","app_key":"stH9SzRt55d1wnwQD7LcoaQR","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<script class="next-config" data-name="changyan" type="application/json">{"enable":true,"appid":"cyw21b1ST","appkey":"045a89927c13c0e33a82c736b468fe51"}</script>
<script src="/js/third-party/comments/changyan.js"></script>

</body>
</html>
