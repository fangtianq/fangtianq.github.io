<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fangtianq.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"changyan","storage":false,"lazyload":false,"nav":null,"activeClass":"changyan"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="有志者事竟成">
<meta property="og:type" content="website">
<meta property="og:title" content="越努力，越幸运！">
<meta property="og:url" content="https://fangtianq.github.io/page/20/index.html">
<meta property="og:site_name" content="越努力，越幸运！">
<meta property="og:description" content="有志者事竟成">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ftq">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://fangtianq.github.io/page/20/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/20/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>越努力，越幸运！</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">越努力，越幸运！</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Where there is a will, there is a way!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">55</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">21</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">322</span></a></li><li class="menu-item menu-item-留言版"><a href="/guestbook/" rel="section"><i class="comments fa-fw"></i>留言版</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-friendlink"><a href="/friendlink/" rel="section"><i class="link fa-fw"></i>友链</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ftq"
      src="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
  <p class="site-author-name" itemprop="name">ftq</p>
  <div class="site-description" itemprop="description">有志者事竟成</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">322</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/fangtianq" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;fangtianq" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://gitee.com/fangtianq" title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;fangtianq" rel="noopener" target="_blank"><i class="github fa-fw"></i>Gitee</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://fangtianq.github.io/" title="GitHub.io → https:&#x2F;&#x2F;fangtianq.github.io&#x2F;"><i class="github fa-fw"></i>GitHub.io</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://fangtianq.gitee.io/" title="Gitee.io → https:&#x2F;&#x2F;fangtianq.gitee.io&#x2F;" rel="noopener" target="_blank"><i class="github fa-fw"></i>Gitee.io</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://leetcode-cn.com/" title="https:&#x2F;&#x2F;leetcode-cn.com&#x2F;" rel="noopener" target="_blank">力扣网</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://rap2.taobao.org/" title="http:&#x2F;&#x2F;rap2.taobao.org&#x2F;" rel="noopener" target="_blank">RAP2接口管理平台</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/06/12/others/rxliuliBlog/JavaScript/JavaScript-%E5%BC%82%E6%AD%A5%E6%97%B6%E5%BA%8F%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/12/others/rxliuliBlog/JavaScript/JavaScript-%E5%BC%82%E6%AD%A5%E6%97%B6%E5%BA%8F%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">JavaScript 异步时序问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-12 18:10:19" itemprop="dateCreated datePublished" datetime="2019-06-12T18:10:19+08:00">2019-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-06-13 00:00:00" itemprop="dateModified" datetime="2019-06-13T00:00:00+08:00">2019-06-13</time>
    </span>


  
    <span id="/2019/06/12/others/rxliuliBlog/JavaScript/JavaScript-%E5%BC%82%E6%AD%A5%E6%97%B6%E5%BA%8F%E9%97%AE%E9%A2%98/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript 异步时序问题" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript 异步时序问题" href="/2019/06/12/others/rxliuliBlog/JavaScript/JavaScript-%E5%BC%82%E6%AD%A5%E6%97%B6%E5%BA%8F%E9%97%AE%E9%A2%98/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::5c08384bc1dab59fa8f57fa6ef24ff50" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaScript-异步时序问题"><a href="#JavaScript-异步时序问题" class="headerlink" title="JavaScript 异步时序问题"></a>JavaScript 异步时序问题</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><blockquote>
<p>死后我们必升天堂，因为活时我们已在地狱。</p>
</blockquote>
<p>不知你是否遇到过，向后台发送了多次异步请求，结果最后显示的数据却并不正确 – 是旧的数据。</p>
<p>具体情况:</p>
<ol>
<li>用户触发事件，发送了第 1 次请求</li>
<li>用户触发事件，发送了第 2 次请求</li>
<li>第 2 次请求成功，更新页面上的数据</li>
<li>第 1 次请求成功，更新页面上的数据</li>
</ol>
<p>嗯？是不是感觉到异常了？这便是多次异步请求时会遇到的异步回调顺序与调用顺序不同的问题。</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><ul>
<li>为什么会出现这种问题？</li>
<li>出现这种问题怎么解决？</li>
</ul>
<h3 id="为什么会出现这种问题？"><a href="#为什么会出现这种问题？" class="headerlink" title="为什么会出现这种问题？"></a>为什么会出现这种问题？</h3><p>JavaScript 随处可见异步，但实际上并不是那么好控制。用户与 UI 交互，触发事件及其对应的处理函数，函数执行异步操作（网络请求），<strong>异步操作得到结果的时间（顺序）是不确定的</strong>，所以响应到 UI 上的时间就不确定，<strong>如果触发事件的频率较高&#x2F;异步操作的时间过长</strong>，就会造成前面的异步操作结果覆盖后面的异步操作结果。</p>
<p>关键点</p>
<ul>
<li>异步操作得到结果的时间（顺序）是不确定的</li>
<li>如果触发事件的频率较高&#x2F;异步操作的时间过长</li>
</ul>
<h3 id="出现这种问题怎么解决？"><a href="#出现这种问题怎么解决？" class="headerlink" title="出现这种问题怎么解决？"></a>出现这种问题怎么解决？</h3><p>既然关键点由两个要素组成，那么，只要破坏了任意一个即可。</p>
<ul>
<li>手动控制异步返回结果的顺序</li>
<li>降低触发频率并限制异步超时时间</li>
</ul>
<h2 id="手动控制返回结果的顺序"><a href="#手动控制返回结果的顺序" class="headerlink" title="手动控制返回结果的顺序"></a>手动控制返回结果的顺序</h2><p>根据对异步操作结果处理情况的不同也有三种不同的思路</p>
<ol>
<li>后面异步操作得到结果后<strong>等待</strong>前面的异步操作返回结果</li>
<li>后面异步操作得到结果后<strong>放弃</strong>前面的异步操作返回结果</li>
<li>依次处理每一个异步操作，等待上一个异步操作完成之后再执行下一个</li>
</ol>
<p>这里先引入一个公共的 <code>wait</code> 函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 等待指定的时间/等待指定表达式成立</span></span><br><span class="line"><span class="comment"> * 如果未指定等待条件则立刻执行</span></span><br><span class="line"><span class="comment"> * 注: 此实现在 nodejs 10- 会存在宏任务与微任务的问题，切记 async-await 本质上还是 Promise 的语法糖，实际上并非真正的同步函数！！！即便在浏览器，也不要依赖于这种特性。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> param 等待时间/等待条件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> Promise 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">wait</span>(<span class="params">param</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(resolve, param)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">param</span>()) &#123;</span><br><span class="line">          <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">          <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="number">100</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-后面异步操作得到结果后等待前面的异步操作返回结果"><a href="#1-后面异步操作得到结果后等待前面的异步操作返回结果" class="headerlink" title="1. 后面异步操作得到结果后等待前面的异步操作返回结果"></a>1. 后面异步操作得到结果后<strong>等待</strong>前面的异步操作返回结果</h3><ol>
<li>为每一次的异步调用都声称一个唯一 id</li>
<li>使用列表记录所有的异步 id</li>
<li>在真正调用异步操作后，添加一个唯一 id</li>
<li>判断上一个正在执行的异步操作是否完成</li>
<li>如果未完成等待上一个异步操作完成，否则直接跳过</li>
<li>从列表中删除掉当前的 id</li>
<li>最后等待异步操作然后返回结果</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将一个异步函数包装为具有时序的异步函数</span></span><br><span class="line"><span class="comment"> * 注: 该函数会按照调用顺序依次返回结果，后面的调用的结果需要等待前面的，所以如果不关心过时的结果，请使用 &#123;<span class="doctag">@link</span> switchMap&#125; 函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fn 一个普通的异步函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 包装后的函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mergeMap</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="comment">// 当前执行的异步操作 id</span></span><br><span class="line">  <span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 所执行的异步操作 id 列表</span></span><br><span class="line">  <span class="keyword">const</span> ids = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(fn, &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">apply</span>(<span class="params">_, _this, args</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> prom = <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(_, _this, args)</span><br><span class="line">      <span class="keyword">const</span> temp = id</span><br><span class="line">      ids.<span class="title function_">add</span>(temp)</span><br><span class="line">      id++</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="function">() =&gt;</span> !ids.<span class="title function_">has</span>(temp - <span class="number">1</span>))</span><br><span class="line">      ids.<span class="title function_">delete</span>(temp)</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> prom</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://codepen.io/rxliuli/pen/orXpEY">测试一下</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 模拟一个异步请求，接受参数并返回它，然后等待指定的时间</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">ms</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">wait</span>(ms)</span><br><span class="line">    <span class="keyword">return</span> ms</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">mergeMap</span>(get)</span><br><span class="line">  <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> sum = <span class="number">0</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">30</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">20</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">10</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">  ])</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(last)</span><br><span class="line">  <span class="comment">// 实际上确实执行了 3 次，结果也确实为 3 次调用参数之和</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(sum)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="2-后面异步操作得到结果后放弃前面的异步操作返回结果"><a href="#2-后面异步操作得到结果后放弃前面的异步操作返回结果" class="headerlink" title="2. 后面异步操作得到结果后放弃前面的异步操作返回结果"></a>2. 后面异步操作得到结果后<strong>放弃</strong>前面的异步操作返回结果</h3><ol>
<li>为每一次的异步调用都声称一个唯一 id</li>
<li>记录最新得到异步操作结果的 id</li>
<li>记录最新得到的异步操作结果</li>
<li>执行并等待返回结果</li>
<li>判断本次异步调用后面是否已经有调用出现结果了<ol>
<li>是的话就直接返回后面的异步调用结果</li>
<li>否则将本地异步调用 id 及其结果最为[最后的]</li>
<li>返回这次的异步调用结果</li>
</ol>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将一个异步函数包装为具有时序的异步函数</span></span><br><span class="line"><span class="comment"> * 注: 该函数会丢弃过期的异步操作结果，这样的话性能会稍稍提高（主要是响应比较快的结果会立刻生效而不必等待前面的响应结果）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fn 一个普通的异步函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 包装后的函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">switchMap</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="comment">// 当前执行的异步操作 id</span></span><br><span class="line">  <span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 最后一次异步操作的 id，小于这个的操作结果会被丢弃</span></span><br><span class="line">  <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 缓存最后一次异步操作的结果</span></span><br><span class="line">  <span class="keyword">let</span> cache</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(fn, &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">apply</span>(<span class="params">_, _this, args</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> temp = id</span><br><span class="line">      id++</span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(_, _this, args)</span><br><span class="line">      <span class="keyword">if</span> (temp &lt; last) &#123;</span><br><span class="line">        <span class="keyword">return</span> cache</span><br><span class="line">      &#125;</span><br><span class="line">      cache = res</span><br><span class="line">      last = temp</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://codepen.io/rxliuli/pen/BgNJbq">测试一下</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 模拟一个异步请求，接受参数并返回它，然后等待指定的时间</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">ms</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">wait</span>(ms)</span><br><span class="line">    <span class="keyword">return</span> ms</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">switchMap</span>(get)</span><br><span class="line">  <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> sum = <span class="number">0</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">30</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">20</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">10</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">  ])</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(last)</span><br><span class="line">  <span class="comment">// 实际上确实执行了 3 次，然而结果并不是 3 次调用参数之和，因为前两次的结果均被抛弃，实际上返回了最后一次发送请求的结果</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(sum)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="3-依次处理每一个异步操作，等待上一个异步操作完成之后再执行下一个"><a href="#3-依次处理每一个异步操作，等待上一个异步操作完成之后再执行下一个" class="headerlink" title="3. 依次处理每一个异步操作，等待上一个异步操作完成之后再执行下一个"></a>3. 依次处理每一个异步操作，等待上一个异步操作完成之后再执行下一个</h3><ol>
<li>为每一次的异步调用都声称一个唯一 id</li>
<li>使用列表记录所有的异步 id</li>
<li>向列表中添加一个唯一 id</li>
<li>判断上一个正在执行的异步操作是否完成</li>
<li>如果未完成等待上一个异步操作完成，否则直接跳过</li>
<li>真正调用异步操作</li>
<li>从列表中删除掉当前的 id</li>
<li>最后等待异步操作然后返回结果</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将一个异步函数包装为具有时序的异步函数</span></span><br><span class="line"><span class="comment"> * 注: 该函数会按照调用顺序依次返回结果，后面的执行的调用（不是调用结果）需要等待前面的，此函数适用于异步函数的内里执行也必须保证顺序时使用，否则请使用 &#123;<span class="doctag">@link</span> mergeMap&#125; 函数</span></span><br><span class="line"><span class="comment"> * 注: 该函数其实相当于调用 &#123;<span class="doctag">@code</span> asyncLimiting(fn, &#123;limit: 1&#125;)&#125; 函数</span></span><br><span class="line"><span class="comment"> * 例如即时保存文档到服务器，当然要等待上一次的请求结束才能请求下一次，不然数据库保存的数据就存在谬误了</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fn 一个普通的异步函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 包装后的函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">concatMap</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="comment">// 当前执行的异步操作 id</span></span><br><span class="line">  <span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 所执行的异步操作 id 列表</span></span><br><span class="line">  <span class="keyword">const</span> ids = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(fn, &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">apply</span>(<span class="params">_, _this, args</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> temp = id</span><br><span class="line">      ids.<span class="title function_">add</span>(temp)</span><br><span class="line">      id++</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="function">() =&gt;</span> !ids.<span class="title function_">has</span>(temp - <span class="number">1</span>))</span><br><span class="line">      <span class="keyword">const</span> prom = <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(_, _this, args)</span><br><span class="line">      ids.<span class="title function_">delete</span>(temp)</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> prom</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://codepen.io/rxliuli/pen/xoGYxq">测试一下</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 模拟一个异步请求，接受参数并返回它，然后等待指定的时间</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">ms</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">wait</span>(ms)</span><br><span class="line">    <span class="keyword">return</span> ms</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">concatMap</span>(get)</span><br><span class="line">  <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> sum = <span class="number">0</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">30</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">20</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">10</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">  ])</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(last)</span><br><span class="line">  <span class="comment">// 实际上确实执行了 3 次，然而结果并不是 3 次调用参数之和，因为前两次的结果均被抛弃，实际上返回了最后一次发送请求的结果</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(sum)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>虽然三个函数看似效果都差不多，但还是有所不同的。</p>
<ol>
<li>是否允许异步操作并发？否: <code>concatMap</code>, 是: 到下一步</li>
<li>是否需要处理旧的的结果？否: <code>switchMap</code>, 是: <code>mergeMap</code></li>
</ol>
<h2 id="降低触发频率并限制异步超时时间"><a href="#降低触发频率并限制异步超时时间" class="headerlink" title="降低触发频率并限制异步超时时间"></a>降低触发频率并限制异步超时时间</h2><p>思考一下第二种解决方式，本质上其实是 <strong>限流 + 自动超时</strong>，首先实现这两个函数。</p>
<ul>
<li>限流: 限制函数调用的频率，如果调用的频率过快则不会真正执行调用而是返回旧值</li>
<li>自动超时: 如果到了超时时间，即便函数还未得到结果，也会自动超时并抛出错误</li>
</ul>
<p>下面来分别实现它们</p>
<h3 id="限流实现"><a href="#限流实现" class="headerlink" title="限流实现"></a>限流实现</h3><blockquote>
<p>具体实现思路可见: <a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/1a8df23d/">JavaScript 防抖和节流</a></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 函数节流</span></span><br><span class="line"><span class="comment"> * 节流 (throttle) 让一个函数不要执行的太频繁，减少执行过快的调用，叫节流</span></span><br><span class="line"><span class="comment"> * 类似于上面而又不同于上面的函数去抖, 包装后函数在上一次操作执行过去了最小间隔时间后会直接执行, 否则会忽略该次操作</span></span><br><span class="line"><span class="comment"> * 与上面函数去抖的明显区别在连续操作时会按照最小间隔时间循环执行操作, 而非仅执行最后一次操作</span></span><br><span class="line"><span class="comment"> * 注: 该函数第一次调用一定会执行，不需要担心第一次拿不到缓存值，后面的连续调用都会拿到上一次的缓存值</span></span><br><span class="line"><span class="comment"> * 注: 返回函数结果的高阶函数需要使用 &#123;<span class="doctag">@link</span> Proxy&#125; 实现，以避免原函数原型链上的信息丢失</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; delay 最小间隔时间，单位为 ms</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; action 真正需要执行的操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">Function</span>&#125; 包装后有节流功能的函数。该函数是异步的，与需要包装的函数 &#123;<span class="doctag">@link</span> action&#125; 是否异步没有太大关联</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">throttle</span> = (<span class="params">delay, action</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> result</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(action, &#123;</span><br><span class="line">    <span class="title function_">apply</span>(<span class="params">target, thisArg, args</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> curr = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">        <span class="keyword">if</span> (curr - last &gt; delay) &#123;</span><br><span class="line">          result = <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(target, thisArg, args)</span><br><span class="line">          last = curr</span><br><span class="line">          <span class="title function_">resolve</span>(result)</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">resolve</span>(result)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自动超时"><a href="#自动超时" class="headerlink" title="自动超时"></a>自动超时</h3><blockquote>
<p>注: <code>asyncTimeout</code> 函数实际上只是为了避免一种情况，异步请求时间超过节流函数最小间隔时间导致结果返回顺序错乱。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为异步函数添加自动超时功能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeout 超时时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> action 异步函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 包装后的异步函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">asyncTimeout</span>(<span class="params">timeout, action</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(action, &#123;</span><br><span class="line">    <span class="title function_">apply</span>(<span class="params">_, _this, args</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>([</span><br><span class="line">        <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(_, _this, args),</span><br><span class="line">        <span class="title function_">wait</span>(timeout).<span class="title function_">then</span>(<span class="title class_">Promise</span>.<span class="property">reject</span>),</span><br><span class="line">      ])</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="结合使用"><a href="#结合使用" class="headerlink" title="结合使用"></a>结合使用</h3><p><a target="_blank" rel="noopener" href="https://codepen.io/pen/?editors=1112">测试一下</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 模拟一个异步请求，接受参数并返回它，然后等待指定的时间</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">ms</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">wait</span>(ms)</span><br><span class="line">    <span class="keyword">return</span> ms</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> time = <span class="number">100</span></span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">asyncTimeout</span>(time, <span class="title function_">throttle</span>(time, get))</span><br><span class="line">  <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> sum = <span class="number">0</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">30</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">20</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">10</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">  ])</span><br><span class="line">  <span class="comment">// last 结果为 10，和 switchMap 的不同点在于会保留最小间隔期间的第一次，而抛弃掉后面的异步结果，和 switchMap 正好相反！</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(last)</span><br><span class="line">  <span class="comment">// 实际上确实执行了 3 次，结果也确实为第一次次调用参数的 3 倍</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(sum)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>起初吾辈因为好奇实现了这种方式，但原以为会和 <code>concatMap</code> 类似的函数却变成了现在这样 – 更像倒置的 <code>switchMap</code> 了。不过由此看来这种方式的可行性并不大，毕竟，没人需要旧的数据。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>其实第一种实现方式属于 <a target="_blank" rel="noopener" href="https://github.com/ReactiveX/rxjs">rxjs</a> 早就已经走过的道路，目前被 Angular 大量采用（类比于 React 中的 Redux）。但 rxjs 实在太强大也太复杂了，对于吾辈而言，仅仅需要一只香蕉，而不需要拿着香蕉的大猩猩，以及其所处的整个森林（此处原本是被人吐槽面向对象编程的隐含环境，这里吾辈稍微藉此吐槽一下动不动就上库的开发者）。</p>
<blockquote>
<p>可以看到吾辈在这里大量使用了 <code>Proxy</code>，那么，原因是什么呢？这个疑问就留到下次再说吧！</p>
</blockquote>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/06/10/others/rxliuliBlog/JavaScript/JavaScript-%E8%A7%84%E8%8C%83%E6%95%B4%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/10/others/rxliuliBlog/JavaScript/JavaScript-%E8%A7%84%E8%8C%83%E6%95%B4%E7%90%86/" class="post-title-link" itemprop="url">JavaScript 规范整理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-10 12:56:43" itemprop="dateCreated datePublished" datetime="2019-06-10T12:56:43+08:00">2019-06-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-06-13 00:00:00" itemprop="dateModified" datetime="2019-06-13T00:00:00+08:00">2019-06-13</time>
    </span>


  
    <span id="/2019/06/10/others/rxliuliBlog/JavaScript/JavaScript-%E8%A7%84%E8%8C%83%E6%95%B4%E7%90%86/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript 规范整理" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript 规范整理" href="/2019/06/10/others/rxliuliBlog/JavaScript/JavaScript-%E8%A7%84%E8%8C%83%E6%95%B4%E7%90%86/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::de8cfac42bc6861f328bb50586bfa476" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaScript-规范整理"><a href="#JavaScript-规范整理" class="headerlink" title="JavaScript 规范整理"></a>JavaScript 规范整理</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><blockquote>
<p>圣人走过的道路，荆棘遍布，火焰片片焚烧……</p>
</blockquote>
<p>日常 <code>review</code> 代码时看到一些奇怪的代码，这里记录一下重构方案以及原因。</p>
<h2 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h2><h3 id="不要使用拼音命名"><a href="#不要使用拼音命名" class="headerlink" title="不要使用拼音命名"></a>不要使用拼音命名</h3><p>如果不熟悉英语，可以使用 <a target="_blank" rel="noopener" href="https://unbug.github.io/codelf/">Codelf</a> 或者 <a target="_blank" rel="noopener" href="https://translate.google.com/">Google 翻译</a>，避免使用拼音命名。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里是用户状态</span></span><br><span class="line"><span class="keyword">const</span> yongHuZhuangTai = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userStatus = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="函数中的变量"><a href="#函数中的变量" class="headerlink" title="函数中的变量"></a>函数中的变量</h3><p>js 中普通变量使用 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Camel_case">小写开头驼峰命名法</a>，而非不区分大小写，或使用下划线命名等等。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用户操作日志备注</span></span><br><span class="line"><span class="keyword">const</span> useroperatinglogremark = <span class="string">&#x27;新增用户&#x27;</span></span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userOperatingLogRemark = <span class="string">&#x27;新增用户&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="内部变量"><a href="#内部变量" class="headerlink" title="内部变量"></a>内部变量</h3><p>如果需要不想让使用者使用的属性（能够看到），需要使用下划线开头。例如 <code>_value</code>，代表内部的值，外部不应该直接访问（实际上可以做到）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DateFormat</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">fmt</span>) &#123;</span><br><span class="line">    <span class="comment">// 不想让外部使用</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_fmt</span> = fmt</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">format</span>(<span class="params">date</span>) &#123;</span><br><span class="line">    <span class="comment">// 具体格式化代码</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">parse</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="comment">// 具体解析代码</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不要使用无意义的前缀命名"><a href="#不要使用无意义的前缀命名" class="headerlink" title="不要使用无意义的前缀命名"></a>不要使用无意义的前缀命名</h3><p>如果一个对象的变量名已经很好的标识了该对象，那么内部的属性就不能使用对象名作为前缀！</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 活跃的日志信息</span></span><br><span class="line"><span class="keyword">const</span> activeLog = &#123;</span><br><span class="line">  <span class="attr">activeUserId</span>: <span class="string">&#x27;rx&#x27;</span>,</span><br><span class="line">  <span class="attr">activeTime</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> activeLog = &#123;</span><br><span class="line">  <span class="attr">userId</span>: <span class="string">&#x27;rx&#x27;</span>,</span><br><span class="line">  <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ES6"><a href="#ES6" class="headerlink" title="ES6"></a>ES6</h2><h3 id="优先使用-const-x2F-let"><a href="#优先使用-const-x2F-let" class="headerlink" title="优先使用 const&#x2F;let"></a>优先使用 const&#x2F;let</h3><p>一般情况下，使用 <code>const/let</code> 声明变量，而不是使用 <code>var</code>。因为使用 <code>var</code> 声明的变量会存在变量提升。</p>
<p>示例代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 使用 var 声明的变量（初始值为 undefined）</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i)</span><br><span class="line">  i = <span class="number">1</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i)</span><br><span class="line">  <span class="comment">// 此时使用 var 声明的变量 i 相当于在 function 顶部声明，然后在此处进行了赋值操作</span></span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 const 声明的变量（抛出异常 k is not defined）</span></span><br><span class="line">  <span class="comment">// console.log(k)</span></span><br><span class="line">  k = <span class="number">1</span></span><br><span class="line">  <span class="keyword">const</span> k = <span class="number">0</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>关于可以参考 <a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/acfc2875/">let 与 var 在 for 循环中的区别</a></p>
<h3 id="使用新的函数声明方式"><a href="#使用新的函数声明方式" class="headerlink" title="使用新的函数声明方式"></a>使用新的函数声明方式</h3><p>ES6 推出了一种更简洁的函数声明方式，不需要在写 <code>function</code>，只要 <strong>名字 + ()</strong> 即可在 <code>class</code> 或 <code>Object</code> 中声明函数。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;rx&#x27;</span>,</span><br><span class="line">  <span class="attr">hello</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello&#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;rx&#x27;</span>,</span><br><span class="line">  <span class="title function_">hello</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello&#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="优先使用箭头函数而非-function"><a href="#优先使用箭头函数而非-function" class="headerlink" title="优先使用箭头函数而非 function"></a>优先使用箭头函数而非 function</h3><p>优先使用 <strong>箭头函数</strong> 而不是使用传统的函数，尤其是使用 <strong>匿名函数</strong> 时，更应如此。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sum = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">  <span class="comment">// 过滤出偶数</span></span><br><span class="line">  .<span class="title function_">filter</span>(<span class="keyword">function</span>(<span class="params">i</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> i % <span class="number">2</span> === <span class="number">0</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 将偶数翻倍</span></span><br><span class="line">  .<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">i</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> i * <span class="number">2</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 计算总和</span></span><br><span class="line">  .<span class="title function_">reduce</span>(<span class="keyword">function</span>(<span class="params">res, i</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (res += i)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sum)</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sum = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">  <span class="comment">// 过滤出偶数</span></span><br><span class="line">  .<span class="title function_">filter</span>(<span class="function"><span class="params">i</span> =&gt;</span> i % <span class="number">2</span> === <span class="number">0</span>)</span><br><span class="line">  <span class="comment">// 将偶数翻倍</span></span><br><span class="line">  .<span class="title function_">map</span>(<span class="function"><span class="params">i</span> =&gt;</span> i * <span class="number">2</span>)</span><br><span class="line">  <span class="comment">// 计算总和</span></span><br><span class="line">  .<span class="title function_">reduce</span>(<span class="function">(<span class="params">res, i</span>) =&gt;</span> (res += i))</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sum)</span><br></pre></td></tr></table></figure>

<h3 id="不要使用-if-判断再赋予默认值"><a href="#不要使用-if-判断再赋予默认值" class="headerlink" title="不要使用 if 判断再赋予默认值"></a>不要使用 if 判断再赋予默认值</h3><p>如果函数需要对参数做默认值处理，请不要使用 <code>if</code> 判空之后再修改参数，而是使用 ES6 的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Default_parameters">默认参数</a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment">解构赋值</a>。</p>
<p>主要优点</p>
<ul>
<li>减少代码，JavaScript 是动态语言，维护起来较为麻烦，代码越少，错误越少</li>
<li>清晰明了，可以让人一眼就能看出这个参数的默认值，而不需要关心函数内部的逻辑</li>
<li>IDE 大多对此进行了支持，代码提示时便会告诉我们参数是可选的并且有默认值</li>
</ul>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 格式化日期</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Date</span>&#125; [date] 日期对象。默认为当前时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">String</span>&#125; 格式化日期字符串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">formatDate</span>(<span class="params">date</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (date === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    date = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;date.getFullYear()&#125;</span>-<span class="subst">$&#123;date.getMonth() + <span class="number">1</span>&#125;</span>-<span class="subst">$&#123;date.getDate()&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">formatDate</span>(<span class="params">date = <span class="keyword">new</span> <span class="built_in">Date</span>()</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;date.getFullYear()&#125;</span>-<span class="subst">$&#123;date.getMonth() + <span class="number">1</span>&#125;</span>-<span class="subst">$&#123;date.getDate()&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里如果展开来讲实在太多，请参考 <a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/5985b64e/">JavaScript 善用解构赋值</a></p>
<h3 id="优先使用-Map-做键值对映射而非传统的对象"><a href="#优先使用-Map-做键值对映射而非传统的对象" class="headerlink" title="优先使用 Map 做键值对映射而非传统的对象"></a>优先使用 Map 做键值对映射而非传统的对象</h3><p>如果需要 <strong>键值映射</strong>，不要使用一般的对象，而是用 ES6 的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Map">Map</a>。它不仅可以使用 <strong>任意类型的键</strong>，另外 Map 本身也是 <strong>有序</strong> 的哦</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="number">2</span>: <span class="string">&#x27;琉璃&#x27;</span>,</span><br><span class="line">  <span class="number">1</span>: <span class="string">&#x27;rx&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;1&#x27;</span>: <span class="string">&#x27;liuli&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 结果为 true，因为属性 1 实际上会被转换为 &#x27;1&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj[<span class="number">1</span>] === obj[<span class="string">&#x27;1&#x27;</span>])</span><br><span class="line"><span class="comment">// 结果为 [ &#x27;1&#x27;, &#x27;2&#x27;]，因为是按照属性字符串排序的</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">keys</span>(obj))</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">2</span>, <span class="string">&#x27;琉璃&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;liuli&#x27;</span>)</span><br><span class="line"><span class="comment">// 结果为 false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(map.<span class="title function_">get</span>(<span class="number">1</span>) === map.<span class="title function_">get</span>(<span class="string">&#x27;1&#x27;</span>))</span><br><span class="line"><span class="comment">// 结果为 [ 2, 1, &#x27;1&#x27; ]，因为是按照插入顺序排序的</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Array</span>.<span class="title function_">from</span>(map.<span class="title function_">keys</span>()))</span><br></pre></td></tr></table></figure>

<h3 id="优先使用模板字符串拼接多个字符串变量"><a href="#优先使用模板字符串拼接多个字符串变量" class="headerlink" title="优先使用模板字符串拼接多个字符串变量"></a>优先使用模板字符串拼接多个字符串变量</h3><p>如果需要拼接多个对象以及字符串时，不要使用 <code>+</code> 进行拼接，使用 es6 的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/template_strings">模板字符串</a> 会更好一点。一般而言，如果需要拼接的变量超过 3 个，那么就应该使用模板字符串了。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params">name, age, sex</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;name: &#x27;</span> + name + <span class="string">&#x27;, age: &#x27;</span> + age + <span class="string">&#x27;, sex: &#x27;</span> + sex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params">name, age, sex</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`name: <span class="subst">$&#123;name&#125;</span>, age: <span class="subst">$&#123;age&#125;</span>, sex: <span class="subst">$&#123;sex&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="当独立参数超过-3-个时使用对象参数并解构"><a href="#当独立参数超过-3-个时使用对象参数并解构" class="headerlink" title="当独立参数超过 3 个时使用对象参数并解构"></a>当独立参数超过 3 个时使用对象参数并解构</h3><p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params">name, age, sex</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`name: <span class="subst">$&#123;name&#125;</span>, age: <span class="subst">$&#123;age&#125;</span>, sex: <span class="subst">$&#123;sex&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params">&#123; name, age, sex &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`name: <span class="subst">$&#123;name&#125;</span>, age: <span class="subst">$&#123;age&#125;</span>, sex: <span class="subst">$&#123;sex&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不要写多余的-await"><a href="#不要写多余的-await" class="headerlink" title="不要写多余的 await"></a>不要写多余的 await</h3><p>如果 <code>await</code> 是不必要的（在返回语句时，那么就不要用 <code>async</code> 标识函数），这是没有必要的 – 除非，你需要在这个函数内异步操作完成后有其他操作。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!useranme) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;用户名不能为空&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!password) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;密码不能为空&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 真正发起登录请求</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> userApi.<span class="title function_">login</span>(user)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = (<span class="params">&#123; username, password &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!useranme) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;用户名不能为空&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!password) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;密码不能为空&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 真正发起登录请求</span></span><br><span class="line">  <span class="keyword">return</span> userApi.<span class="title function_">login</span>(user)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不要使用-x3D-x3D-进行比较"><a href="#不要使用-x3D-x3D-进行比较" class="headerlink" title="不要使用 &#x3D;&#x3D; 进行比较"></a>不要使用 &#x3D;&#x3D; 进行比较</h3><p>在 js 中使用 <code>==</code> 比较相当危险，你永远不知道 js 到底是按照什么类型比较的，因为 js 会做各种隐式转换。而如果使用 <code>===</code> 比较，则会同时比较 <strong>值</strong> 和 <strong>类型</strong> 是否都相同，避免了各种不确定的问题。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span> == <span class="literal">true</span>) <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span> == <span class="string">&#x27;1&#x27;</span>) <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span> == <span class="literal">true</span>) <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;0&#x27;</span> == <span class="literal">true</span>) <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>([] == []) <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>扪心自问，你真的知道上面为什么会出现这种结果么？即便知道，对于其他人而言仍然是难以预测的，所以抛弃掉 <code>==</code> 吧，学会使用更好的 <code>===</code> 最好</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span> == <span class="literal">true</span>) <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span> == <span class="string">&#x27;1&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span> == <span class="literal">true</span>) <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;0&#x27;</span> == <span class="literal">true</span>) <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>([] == []) <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<h3 id="使用计算属性名替代使用方括号表示法赋值"><a href="#使用计算属性名替代使用方括号表示法赋值" class="headerlink" title="使用计算属性名替代使用方括号表示法赋值"></a>使用计算属性名替代使用方括号表示法赋值</h3><p>目前而言已经有了 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Object_initializer#%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E5%90%8D">计算属性名</a> 用以在初始化时计算属性名，所以不需要再先声明对象再使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Property_Accessors#%E6%96%B9%E6%8B%AC%E5%8F%B7%E8%A1%A8%E7%A4%BA%E6%B3%95">方括号表示法</a> 进行赋值了。</p>
<p>ES5 写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  <span class="string">&#x27;user.username&#x27;</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">state[<span class="title class_">Date</span>.<span class="title function_">now</span>()] = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(state)</span><br></pre></td></tr></table></figure>

<p>ES6 写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  <span class="string">&#x27;user.username&#x27;</span>() &#123;&#125;,</span><br><span class="line">  [<span class="title class_">Date</span>.<span class="title function_">now</span>()]: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(state)</span><br></pre></td></tr></table></figure>

<h3 id="简单的选项列表优先使用-Map-而非数组"><a href="#简单的选项列表优先使用-Map-而非数组" class="headerlink" title="简单的选项列表优先使用 Map 而非数组"></a>简单的选项列表优先使用 Map 而非数组</h3><p>对于复选框，想必很多人相当熟悉。下面使用 js 模拟一个复选框</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> item = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">role</span>: [<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>],</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> options = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">roleid</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="attr">label</span>: <span class="string">&#x27;黄金糕&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">roleid</span>: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">    <span class="attr">label</span>: <span class="string">&#x27;双皮奶&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">roleid</span>: <span class="string">&#x27;3&#x27;</span>,</span><br><span class="line">    <span class="attr">label</span>: <span class="string">&#x27;蚵仔煎&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>现在的需求是根据 <code>role</code> 计算显示值 <code>name</code> 的值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">item.<span class="property">name</span> = item.<span class="property">role</span></span><br><span class="line">  .<span class="title function_">map</span>(<span class="function"><span class="params">role</span> =&gt;</span> options.<span class="title function_">find</span>(<span class="function"><span class="params">op</span> =&gt;</span> op.<span class="property">roleid</span> === role))</span><br><span class="line">  .<span class="title function_">filter</span>(<span class="function"><span class="params">s</span> =&gt;</span> s)</span><br><span class="line">  .<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>但实际上这里应该使用 <code>Map</code> 替代数组，因为数组的 <code>find</code> 其实非常低效，也需要进行遍历，使用 <code>Map</code> 的实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> item = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">role</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> options = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">1</span>, <span class="string">&#x27;黄金糕&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">2</span>, <span class="string">&#x27;双皮奶&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">3</span>, <span class="string">&#x27;蚵仔煎&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">calcName</span>(<span class="params">role</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> role</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function"><span class="params">k</span> =&gt;</span> options.<span class="title function_">get</span>(k))</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="function"><span class="params">s</span> =&gt;</span> s)</span><br><span class="line">    .<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">item.<span class="property">name</span> = <span class="title function_">calcName</span>(item.<span class="property">role</span>)</span><br></pre></td></tr></table></figure>

<p>可以看到，获取时使用了 <code>Map#get</code>，在效率上应该是极好的。</p>
<blockquote>
<p>附: 该问题来自 <a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000019426996">https://segmentfault.com/q/1010000019426996</a></p>
</blockquote>
<h3 id="存放-id-标识列表使用-Set-而非数组"><a href="#存放-id-标识列表使用-Set-而非数组" class="headerlink" title="存放 id 标识列表使用 Set 而非数组"></a>存放 id 标识列表使用 Set 而非数组</h3><p>还是上面的例子，当你需要存取当前选中复选框的值 <code>role</code> 使用数组时，有可能遇到 id 重复的问题，实际上导致每次添加前需要使用 <code>Array#includes</code> 判断是否已存在。这里可以使用 <code>Set</code> 从数据结构层面避免掉可能重复的问题。</p>
<p>修改后的实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> item = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">role</span>: <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="number">1</span>, <span class="number">2</span>]),</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> options = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">1</span>, <span class="string">&#x27;黄金糕&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">2</span>, <span class="string">&#x27;双皮奶&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">3</span>, <span class="string">&#x27;蚵仔煎&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">calcName</span>(<span class="params">role</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(role)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function"><span class="params">k</span> =&gt;</span> options.<span class="title function_">get</span>(k))</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="function"><span class="params">s</span> =&gt;</span> s)</span><br><span class="line">    .<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">item.<span class="property">name</span> = <span class="title function_">calcName</span>(item.<span class="property">role</span>)</span><br></pre></td></tr></table></figure>

<p>先判断是否存在执行某些操作也非常方便，可以使用 <code>Set#has</code> 进行判断，当然时间复杂度时 O1。</p>
<h2 id="逻辑代码"><a href="#逻辑代码" class="headerlink" title="逻辑代码"></a>逻辑代码</h2><h3 id="不要判断一个-Boolean-值并以此返回-Boolean-值"><a href="#不要判断一个-Boolean-值并以此返回-Boolean-值" class="headerlink" title="不要判断一个 Boolean 值并以此返回 Boolean 值"></a>不要判断一个 Boolean 值并以此返回 Boolean 值</h3><p>不要在得到一个 <code>Boolean</code> 的值后使用 <code>if-else</code> 进行判断，然后根据结果返回 <code>true</code> 或 <code>false</code>，这真的显得非常非常蠢！</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> res = username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br><span class="line">  <span class="keyword">if</span> (res) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt;</span><br><span class="line">  username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="不要使用多余的变量"><a href="#不要使用多余的变量" class="headerlink" title="不要使用多余的变量"></a>不要使用多余的变量</h3><p>如果一个表达式立刻被使用并且只会被使用一次，那就不要使用变量声明，直接在需要的地方使用好了。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> res = username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不要使用嵌套-if"><a href="#不要使用嵌套-if" class="headerlink" title="不要使用嵌套 if"></a>不要使用嵌套 if</h3><p>不要使用多级的 <code>if</code> 嵌套，这会让代码变得丑陋且难以调试，应当优先使用 <strong>提前 return</strong> 的策略。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt;</span><br><span class="line">  username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">submit</span>(<span class="params">user</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = user</span><br><span class="line">  <span class="keyword">if</span> (username) &#123;</span><br><span class="line">    <span class="keyword">if</span> (password) &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">login</span>(user)</span><br><span class="line">      <span class="keyword">if</span> (res) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;登录成功，即将跳转到首页&#x27;</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;登录失败，请检查用户名和密码&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;用户密码不能为空&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;用户名不能为空&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt;</span><br><span class="line">  username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">submit</span>(<span class="params">user</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = user</span><br><span class="line">  <span class="keyword">if</span> (!username) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;用户名不能为空&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!password) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;用户密码不能为空&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">login</span>(user)</span><br><span class="line">  <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;登录失败，请检查用户名和密码&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;登录成功，即将跳转到首页&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不要先声明空对象然后一个个追加属性"><a href="#不要先声明空对象然后一个个追加属性" class="headerlink" title="不要先声明空对象然后一个个追加属性"></a>不要先声明空对象然后一个个追加属性</h3><p>有时候会碰到这种情况，先声明一个空对象，然后在下面一个个追加属性，为什么创建对象与初始化不放到一起做呢？</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt;</span><br><span class="line">  username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">submit</span>(<span class="params">username, password</span>) &#123;</span><br><span class="line">  <span class="comment">// 数据格式校验处理。。。</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> user = &#123;&#125;</span><br><span class="line">  user.<span class="property">username</span> = username.<span class="title function_">trim</span>()</span><br><span class="line">  user.<span class="property">password</span> = password.<span class="title function_">trim</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">login</span>(user)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 后续的错误处理。。。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt;</span><br><span class="line">  username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">submit</span>(<span class="params">username, password</span>) &#123;</span><br><span class="line">  <span class="comment">// 数据格式校验处理。。。</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> user = &#123;</span><br><span class="line">    <span class="attr">username</span>: username.<span class="title function_">trim</span>(),</span><br><span class="line">    <span class="attr">password</span>: password.<span class="title function_">trim</span>(),</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">login</span>(user)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 后续的错误处理。。。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不要使用无意义的函数包裹"><a href="#不要使用无意义的函数包裹" class="headerlink" title="不要使用无意义的函数包裹"></a>不要使用无意义的函数包裹</h3><p>使用函数时，如果你想包裹的函数和原来函数的参数&#x2F;返回值相同，那就直接应该使用函数作为参数，而非在包裹一层。给人的感觉就像是大夏天穿着棉袄吃雪糕 – 多此一举！</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否是偶数的函数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isEven</span> = i =&gt; i % <span class="number">2</span> === <span class="number">0</span></span><br><span class="line"><span class="comment">//过滤出所有偶数</span></span><br><span class="line"><span class="keyword">const</span> res = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>].<span class="title function_">filter</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="title function_">isEven</span>(i))</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否是偶数的函数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isEven</span> = i =&gt; i % <span class="number">2</span> === <span class="number">0</span></span><br><span class="line"><span class="comment">//过滤出所有偶数</span></span><br><span class="line"><span class="keyword">const</span> res = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>].<span class="title function_">filter</span>(isEven)</span><br></pre></td></tr></table></figure>

<h3 id="不要使用三元运算符进行复杂的计算"><a href="#不要使用三元运算符进行复杂的计算" class="headerlink" title="不要使用三元运算符进行复杂的计算"></a>不要使用三元运算符进行复杂的计算</h3><p>三元运算符适合于替代简单的 <code>if-else</code> 的情况，如果碰到较为复杂的情况，请使用 <code>if + return</code> 或者解构&#x2F;默认参数的方式解决。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">formatUser</span>(<span class="params">user</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> user === <span class="literal">undefined</span></span><br><span class="line">    ? <span class="string">&#x27;username: noname, password: blank&#x27;</span></span><br><span class="line">    : <span class="string">&#x27;username: &#x27;</span> +</span><br><span class="line">        (user.<span class="property">username</span> === <span class="literal">undefined</span> ? <span class="string">&#x27;noname&#x27;</span> : user.<span class="property">username</span>) +</span><br><span class="line">        <span class="string">&#x27;, password: &#x27;</span> +</span><br><span class="line">        (user.<span class="property">password</span> === <span class="literal">undefined</span> ? <span class="string">&#x27;blank&#x27;</span> : user.<span class="property">password</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到上面的代码就感觉到一股烂代码的味道扑面而来，这实在是太糟糕了！实际上只需要两行代码就好了！</p>
<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">formatUser</span>(<span class="params">&#123; username = <span class="string">&#x27;noname&#x27;</span>, password = <span class="string">&#x27;blank&#x27;</span> &#125; = &#123;&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`username: <span class="subst">$&#123;username&#125;</span>, password: <span class="subst">$&#123;password&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="如果变量有所关联则使用对象而非多个单独的变量"><a href="#如果变量有所关联则使用对象而非多个单独的变量" class="headerlink" title="如果变量有所关联则使用对象而非多个单独的变量"></a>如果变量有所关联则使用对象而非多个单独的变量</h3><p>如果变量有所关联，例如一个表单，存储的时候不要使用单独的变量，将之存储到一个表单变量中更好。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> username = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#username&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> password = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#password&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> remeberMe = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#remeberMe&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一些校验。。。</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">validate</span>(username, password, remeberMe)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 请求后台</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> userLogin.<span class="title function_">login</span>(username, password, remeberMe)</span><br><span class="line">  <span class="comment">// 后处理。。。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> user = &#123;</span><br><span class="line">    username : <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#username&#x27;</span>),</span><br><span class="line">    password : <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#password&#x27;</span>),</span><br><span class="line">    remeberMe : <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#remeberMe&#x27;</span>),</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 一些校验。。。</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">validate</span>(user)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 请求后台</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> userLogin.<span class="title function_">login</span>(user)</span><br><span class="line">  <span class="comment">// 后处理。。。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="应该尽量解决编辑器警告"><a href="#应该尽量解决编辑器警告" class="headerlink" title="应该尽量解决编辑器警告"></a>应该尽量解决编辑器警告</h3><p>如果编辑器对我们的代码发出警告，那么一般都是我们代码出现了问题（一般开发人员的能力并不足以比肩编辑器 #MS 那些 dalao 的能力）。所以，如果出现了警告，应该先去解决它 – 如果你确认发生了错误，则通过注释&#x2F;配置禁用它！</p>
<h3 id="使用类型定义参数对象"><a href="#使用类型定义参数对象" class="headerlink" title="使用类型定义参数对象"></a>使用类型定义参数对象</h3><p>如果一个函数需要一个对象参数，最好专门定义一个类型，并在注释上说明，便于在使用时 IDE 进行提示，而不需要去查找文档手册。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 格式化用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; user 格式化的用户对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">formatUser</span>(<span class="params">user</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = user || &#123;&#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`user, username: <span class="subst">$&#123;username&#125;</span>, password: <span class="subst">$&#123;password&#125;</span>`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 此处别人并不知道 User 里面到底有什么属性，只能去查看文档</span></span><br><span class="line"><span class="keyword">const</span> str = <span class="title function_">formatUser</span>(&#123; <span class="attr">username</span>: <span class="string">&#x27;rx&#x27;</span>, <span class="attr">password</span>: <span class="string">&#x27;123456&#x27;</span> &#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str)</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">username, password</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">username</span> = username</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">password</span> = password</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 格式化用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">User</span>&#125; user 格式化的用户对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">formatUser</span>(<span class="params">user</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = user || &#123;&#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`user, username: <span class="subst">$&#123;username&#125;</span>, password: <span class="subst">$&#123;password&#125;</span>`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> str = <span class="title function_">formatUser</span>(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&#x27;rx&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str)</span><br></pre></td></tr></table></figure>

<h3 id="尽量扁平化代码"><a href="#尽量扁平化代码" class="headerlink" title="尽量扁平化代码"></a>尽量扁平化代码</h3><p>尽量将 <code>a</code> 调用 <code>b</code>, <code>b</code> 调用 <code>c</code>，然后 <code>b</code> 调用 <code>d</code>，优化为依次调用 <code>a, b, c, d</code>。</p>
<blockquote>
<p>注意: 这里使用的是<strong>尽量</strong>而非<strong>不要</strong>，深层嵌套不可避免，但在局部上，应该采取扁平化的策略，<strong>提前 return</strong> 避免嵌套 if-else 是个很好的例子。</p>
</blockquote>
<h3 id="自执行函数前面必须加分号"><a href="#自执行函数前面必须加分号" class="headerlink" title="自执行函数前面必须加分号"></a>自执行函数前面必须加分号</h3><p>如果我们需要使用自执行函数，则开头必须加上 <code>;</code> 以避免可能出现的歧义。</p>
<p>错误示例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> returnItself(o) &#123;</span><br><span class="line">  <span class="built_in">return</span> o</span><br><span class="line">&#125;</span><br><span class="line">returnItself(() =&gt; console.log(1))</span><br><span class="line">(() =&gt; &#123;</span><br><span class="line">  console.log(2)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>上面这段代码是有问题的，因为后面的自执行函数会被认为是上一句的 <code>returnItself</code> 返回函数的参数，最后的括号会被认为又是一次调用，将会抛出错误</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">returnItself</span>(...)(...) is not a <span class="keyword">function</span></span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">returnItself</span>(<span class="params">o</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> o</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">returnItself</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>))</span><br><span class="line">;(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>使用分号可以明确告诉 JavaScript 这是一行新的代码，上面的代码已经到此为止了。</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/05/27/others/rxliuliBlog/Tool/Windows/%E4%BC%98%E5%8C%96-Google-Chrome-%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/27/others/rxliuliBlog/Tool/Windows/%E4%BC%98%E5%8C%96-Google-Chrome-%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/" class="post-title-link" itemprop="url">优化 Google Chrome 的使用体验</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-27 18:29:11" itemprop="dateCreated datePublished" datetime="2019-05-27T18:29:11+08:00">2019-05-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-12-09 00:00:00" itemprop="dateModified" datetime="2019-12-09T00:00:00+08:00">2019-12-09</time>
    </span>


  
    <span id="/2019/05/27/others/rxliuliBlog/Tool/Windows/%E4%BC%98%E5%8C%96-Google-Chrome-%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/" class="post-meta-item leancloud_visitors" data-flag-title="优化 Google Chrome 的使用体验" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="优化 Google Chrome 的使用体验" href="/2019/05/27/others/rxliuliBlog/Tool/Windows/%E4%BC%98%E5%8C%96-Google-Chrome-%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::5d073eaae8d1346ea0d6f081c2ac2a8c" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="优化-Google-Chrome-的使用体验"><a href="#优化-Google-Chrome-的使用体验" class="headerlink" title="优化 Google Chrome 的使用体验"></a>优化 Google Chrome 的使用体验</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>假若我没有看见光明，我本可以忍受黑暗。</p>
</blockquote>
<p>下面是吾辈在使用 Chrome 遇到的一些不舒服的地方，以及对应的解决方法。一切皆是为了一个目标：<strong>提高浏览器的使用体验！</strong></p>
<h2 id="字体"><a href="#字体" class="headerlink" title="字体"></a>字体</h2><p>在之前吾辈也未曾对字体有过什么注意，直到后来听闻 MacOS 的字体显示比 Windows 上好很多，去看了一下确实如此。想要有一个好看的字体，字体本身极为重要，这里吾辈目前在使用，也很推荐的字体是 <a target="_blank" rel="noopener" href="https://github.com/be5invis/Sarasa-Gothic">Sarasa Gothic</a>。支持 <strong>简中&#x2F;繁中&#x2F;英&#x2F;日</strong> 四种语言，虽然体积稍微庞大，但效果却是相当不错。</p>
<p>Windows 字体预览</p>
<p><img src="https://img.rxliuli.com/20190527190659.png" alt="更纱黑体"></p>
<blockquote>
<p>这里也推荐作为编程字体，毕竟程序中同时存在中英文，而一个同时支持中英文的等宽字体实在难得。</p>
</blockquote>
<h2 id="设置网页默认字体"><a href="#设置网页默认字体" class="headerlink" title="设置网页默认字体"></a>设置网页默认字体</h2><p>安装完了字体，然而 Chrome 默认并不会使用它，我们还需要 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/stylus/clngdbkpkpeebahjckkjfobafhncgmne">Stylus</a> 进行指定。</p>
<p><img src="https://img.rxliuli.com/20190527221308.png" alt="添加 UserCSS"></p>
<p>添加一个新的样式，内容只需要设置所有元素使用的字体为 <strong>Sarasa Mono CL</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 全局字体设置 */</span></span><br><span class="line">* &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">&#x27;Sarasa Mono CL&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 强制指定 input 框中的字体 */</span></span><br><span class="line"><span class="selector-tag">input</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">&#x27;Sarasa Mono CL&#x27;</span> <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时候查看一下字体效果</p>
<p><img src="https://img.rxliuli.com/20190527221458.png" alt="效果"></p>
<h2 id="夜间模式"><a href="#夜间模式" class="headerlink" title="夜间模式"></a>夜间模式</h2><p>如果你像吾辈一样，喜欢暗色的主题，可以使用插件 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/dark-reader/eimadpbcbfnmbkopoojfekhnkhdbieeh">Dark Reader</a>，它能够让网页默认使用暗色模式，看起来和编辑器保持一致：并且，看起来很 <strong>Geek</strong>！</p>
<p><img src="https://img.rxliuli.com/20190531203702.png" alt="暗色模式"></p>
<p>看起来标题栏很违和？安装一个 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/morpheon-dark/mafbdhjdkjnoafhfelkjpchpaepjknad">Dark 主题</a> 试试看。<br>现在，是不是变得很和谐了呢？</p>
<p><img src="https://img.rxliuli.com/20190531225833.png" alt="暗色标题栏"></p>
<h2 id="广告过滤"><a href="#广告过滤" class="headerlink" title="广告过滤"></a>广告过滤</h2><p>目前而言，浏览网站时，没有一个广告过滤插件的话，广告的数量将是难以置信的庞大，而且讨人厌！<br>吾辈目前在 Chrome 上仅推荐 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/ublock-origin/cjpalhdlnbpafiamejdnhcphjbkeiagm">uBlock Origin</a>，开源免费，不推荐 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/adblock-plus-free-ad-bloc/cfhdojbkjhnklbpkdaibdccddilifddb">Adblock Plus</a> 与 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/ublock/epcnnfbjfcgphgdmggkamkmgojdagdnn">Ublock</a>。前者将广告拦截做成了生意（参见 <a target="_blank" rel="noopener" href="https://36kr.com/p/5052897">向来以屏蔽互联网广告为己任的 AdBlock Plus，为什么卖起广告了？</a>），后者则是接手开发者的自私接受捐款导致原作者 Fork 并开发了新版本 Ublock Origin（参见 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/UBlock_Origin">Wiki uBlock Origin 历史</a>）。</p>
<p>虽然吾辈基本上日常 Google，不过为了比较这里来看一下未进行广告过滤前的百度搜索结果</p>
<p>搜索<strong>购物</strong>，天啊，第一页全都是<strong>广告</strong>，百度真的丧心病狂。。。</p>
<blockquote>
<p>注意每个搜索结果下面的小字 <strong>广告</strong></p>
</blockquote>
<p><img src="https://img.rxliuli.com/20190531210354.png" alt="百度的广告"></p>
<p>使用插件后的效果</p>
<p><img src="https://img.rxliuli.com/20190531210454.png" alt="过滤后的百度搜索"></p>
<p>嗯，清爽了许多呢 ~ o(*￣ ▽ ￣*)o</p>
<p>这里对比一下 Google 的搜索结果，可以明显看出来百度的广告的数量之多。。。</p>
<p><img src="https://img.rxliuli.com/20190531210759.png" alt="对比的 Google 搜索结果"></p>
<h2 id="自动翻页"><a href="#自动翻页" class="headerlink" title="自动翻页"></a>自动翻页</h2><p>如果你也觉得搜索结果需要翻页好麻烦，那么 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/uautopagerize/kdplapeciagkkjoignnkfpbfkebcfbpb">uAutoPagerize</a> 可以一样可以帮到你！</p>
<blockquote>
<p>相比于 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/autopagerize/igiofjhpmpihnifddepnpngfjhkfenbp">AutoPagerize</a> 万年不更新，uAutoPagerize 仍在积极维护中！</p>
</blockquote>
<p>下面是使用了 uAutoPagerize 后的 Google 搜索结果，会在滚动到接近底部时，自动获取下一页的内容并拼接到最后！</p>
<p><img src="https://img.rxliuli.com/20191114123652.png" alt="使用 uAutoPagerize"></p>
<p>当然，它也支持百度哦</p>
<h2 id="屏蔽-Google-搜索结果"><a href="#屏蔽-Google-搜索结果" class="headerlink" title="屏蔽 Google 搜索结果"></a>屏蔽 Google 搜索结果</h2><p>当你搜索中文技术相关的内容时，一定会遇到一个令人厌恶的社区 – CSDN 博客。里面的内容基本上都是复制粘贴，甚至作者都并未真实尝试过就发出来了，实在是太烂了！<br>所以，使用 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo">Tampermonkey</a> 油猴插件 + 油猴脚本便可以轻松屏蔽掉它们。</p>
<blockquote>
<p>吾辈并不否认 CSDN 有很多有趣的作者，但是啊，相比于这个平台的大多数人，他们实在太少了，简直如同大海捞针一般。<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh/Greasemonkey">油猴脚本</a>: 是一段可以在某个网页自动运行的 JavaScript 脚本，事实上，抛开 Tampermonkey 这个运行容器不说，油猴脚本就是彻头彻尾的 JavaScript 代码，任何了解过 Web 开发的人应该都能写一个简单的油猴脚本。如果你打算尝试玩玩油猴脚本，可以参考吾辈踩过的坑 <a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/75bbc83f/">Greasemonkey 踩坑之路</a></p>
</blockquote>
<p>你需要先安装 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo">Tampermonkey</a> 插件，然后在 <a target="_blank" rel="noopener" href="https://greasyfork.org/zh-CN/">Greasy Fork</a> 安装脚本 <a target="_blank" rel="noopener" href="https://greasyfork.org/zh-CN/scripts/1682">Google Hit Hider by Domain</a>。</p>
<p>然后在 Google 搜索 <a target="_blank" rel="noopener" href="https://www.google.com/search?q=js+%E6%95%B0%E7%BB%84%E5%8E%BB%E9%87%8D">js 数组去重</a>，可以看到包含了几个的 CSDN 博客的结果</p>
<p><img src="https://img.rxliuli.com/20190531213523.png" alt="CSND 博客搜索结果"></p>
<p>现在，让我们从 Google 搜索中屏蔽 blog.csdn.net 这个域名</p>
<p><img src="https://img.rxliuli.com/20190531214002.png" alt="Block 操作"></p>
<p>屏蔽后的搜索结果，CSDN Blog 那些垃圾博客不见了，心情大好！</p>
<p><img src="https://img.rxliuli.com/20190531214650.png" alt="屏蔽后的结果"></p>
<h2 id="冻结后台标签页"><a href="#冻结后台标签页" class="headerlink" title="冻结后台标签页"></a>冻结后台标签页</h2><p>你是否也曾因为 Chrome 开了太多标签页而占用了庞大的内存？那么 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/the-great-suspender/klbibkeccnjlkjkiokjodocebajanakg">The Great Suspender</a> 就是最好的帮手，它能自动冻结后台一段时间没有访问的标签页，以便于释放系统内存。并且，当你再次访问时，标签页将会自动重新加载。如果你也经常开了很多个标签页忘记关闭了，那么它可以帮助你自动管理他们。</p>
<p>下面演示多个标签页被冻结的效果</p>
<p><img src="https://img.rxliuli.com/20190531220652.png" alt="冻结的标签页"></p>
<h2 id="下载增强"><a href="#下载增强" class="headerlink" title="下载增强"></a>下载增强</h2><p>你使用 Chrome 下载过资料么？是否也对 Chrome 单线程下载并且在下载完成后强制检查资源安全性感到不满？那么 <a target="_blank" rel="noopener" href="https://www.freedownloadmanager.org/zh/">FDM</a> 应该是 Windows 上比较好的选择下载工具了，你可以下载并安装到 PC 上，然后安装 Chrome 插件 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/free-download-manager/ahmpjcflkgiildlgicmcieglgoilbfdp">Free Download Manager</a> 即可将所有 Chrome 中的下载请求交给 FDM，并且，它携带着 Cookie，所以即使是有权限校验的下载也能够胜任。</p>
<p>FDM 的优势</p>
<ul>
<li>多线程下载</li>
<li>断点续传</li>
<li>支持 BT</li>
<li>自动分类</li>
<li>下载限速</li>
<li>国际化</li>
<li>自由免费</li>
</ul>
<p>所以，如果经常下载资料的话推荐入坑 FDM，这里放一张首页</p>
<p><img src="https://img.rxliuli.com/20190531221709.png" alt="FDM 首页"></p>
<h2 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h2><p>使用浏览器，一些高频操作的快捷键也是必不可少的。</p>
<ul>
<li><code>CS-T</code>: 重新打开上一个关闭的标签页</li>
<li><code>中键/C-左键</code>: 强制在新标签页打开链接</li>
<li><code>中键(浏览器标签上)</code>: 关闭这个标签页</li>
<li><code>A-左键</code>: 选择链接中的文字（不会触发拖动链接）</li>
<li><code>S-滚轮</code>: 水平移动滚动条</li>
<li><code>空格</code>: 翻到下一页</li>
<li><code>F12</code>: 开启&#x2F;关闭开发者工具</li>
<li><code>C-R</code>: 重新加载当前页面</li>
<li><code>CS-R</code>: 硬性重新加载</li>
<li><code>CS-N</code>: 打开隐私标签页</li>
<li><code>C-T</code>: 打开新的标签页</li>
<li><code>C-W</code>: 关闭当前标签页</li>
</ul>
<h2 id="GitHub-优化"><a href="#GitHub-优化" class="headerlink" title="GitHub 优化"></a>GitHub 优化</h2><p>众所周知，GitHub 作为最大的开源平台，平时访问的频率是相当高的，这里吾辈推荐一些插件&#x2F;UserCSS 以增强使用体验。</p>
<h3 id="树结构浏览代码"><a href="#树结构浏览代码" class="headerlink" title="树结构浏览代码"></a>树结构浏览代码</h3><p>GitHub 浏览代码侧边栏没有一个文件栏实在难受，所以这里推荐 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/gitako-github-file-tree/giljefjcheohhamkjphiebfjnlphnokk">Gitako</a>   这个插件。它能够为 GitHub 添加一个侧边栏，极大的方便了在线代码浏览。</p>
<blockquote>
<p>相比于 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/octotree/bkhaagjahfmjljalopjnoealnfndnagc">Octotree</a>，Gitako 的性能更好，而且是完全免费的。</p>
</blockquote>
<p><img src="https://img.rxliuli.com/20191114123238.png" alt="Gitako 侧边文件夹"></p>
<h3 id="立体化-GitHub-用户活动"><a href="#立体化-GitHub-用户活动" class="headerlink" title="立体化 GitHub 用户活动"></a>立体化 GitHub 用户活动</h3><p>当你查看一个 GitHub 用户的活动概览时，总是平面方块未免有些无聊，而且以颜色深浅区分也尚不明了。</p>
<p><img src="https://img.rxliuli.com/20190531223619.png" alt="GitHub 用户活动平面图"></p>
<p>所以，你可以使用 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/isometric-contributions/mjoedlfflcchnleknnceiplgaeoegien">Isometric Contributions</a> 插件，让活动变得更有趣一点，变成更直观的 3D 柱状图。</p>
<p><img src="https://img.rxliuli.com/20190531223909.png" alt="GitHub 用户活动 3D 图"></p>
<h3 id="统计仓库大小"><a href="#统计仓库大小" class="headerlink" title="统计仓库大小"></a>统计仓库大小</h3><p>或许你也有 clone 之前先知道仓库大小的习惯，这在网络稍差的环境中尤为重要，例如 TypeScript 的仓库大小超过 1G，如果没有准备的话直接下载很容易炸！</p>
<blockquote>
<p>GitHub 下载仓库时并不会给出下载的百分比，所以什么时候下载完成是个玄学。。。</p>
</blockquote>
<p><img src="https://img.rxliuli.com/20190531224452.png" alt="统计仓库大小"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Chrome 有很多可以优化体验的地方，这里也只是吾辈所接触到的一部分罢了，欢迎在下面留言补充！</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/05/23/others/rxliuliBlog/JavaScript/JavaScript-TypeScript-%E8%BF%81%E7%A7%BB%E4%BD%93%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/23/others/rxliuliBlog/JavaScript/JavaScript-TypeScript-%E8%BF%81%E7%A7%BB%E4%BD%93%E9%AA%8C/" class="post-title-link" itemprop="url">JavaScript => TypeScript 迁移体验</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-23 20:22:36" itemprop="dateCreated datePublished" datetime="2019-05-23T20:22:36+08:00">2019-05-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-06-28 00:00:00" itemprop="dateModified" datetime="2019-06-28T00:00:00+08:00">2019-06-28</time>
    </span>


  
    <span id="/2019/05/23/others/rxliuliBlog/JavaScript/JavaScript-TypeScript-%E8%BF%81%E7%A7%BB%E4%BD%93%E9%AA%8C/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript => TypeScript 迁移体验" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript => TypeScript 迁移体验" href="/2019/05/23/others/rxliuliBlog/JavaScript/JavaScript-TypeScript-%E8%BF%81%E7%A7%BB%E4%BD%93%E9%AA%8C/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::1638afb8689c45a2b0e2c900783eb902" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaScript-x3D-gt-TypeScript-迁移体验"><a href="#JavaScript-x3D-gt-TypeScript-迁移体验" class="headerlink" title="JavaScript &#x3D;&gt; TypeScript 迁移体验"></a>JavaScript &#x3D;&gt; TypeScript 迁移体验</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>如果你使用 JavaScript 没出现什么问题，那吾辈就不推荐你迁移到 TypeScript！</p>
</blockquote>
<ul>
<li><code>JavaScript</code> 不能无缝迁移到 <code>TypeScript</code>！</li>
<li><code>JavaScript</code> 不能无缝迁移到 <code>TypeScript</code>！</li>
<li><code>JavaScript</code> 不能无缝迁移到 <code>TypeScript</code>！</li>
</ul>
<p>重要的话说三遍，TypeScript 是 JavaScript 的超集，所以有很多人认为（并宣称）JavaScript 可以很容易迁移到 TypeScript，甚至是无缝迁移的！<br>导致了 JavaScript 开发者满心欢喜的入坑了 TypeScript（包括吾辈），然后掉进了坑里，甚至差点爬不出来。。。</p>
<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><ul>
<li>问: 为什么吾辈用 JavaScript 用的好好的，偏偏自找麻烦去入坑了 TypeScript 了呢？</li>
<li>答: JavaScript 因为一些固有问题和主流编辑器 VSCode 支持不力，导致代码写起来会感觉很不方便</li>
<li>问: 具体谈谈</li>
<li>答: 有很多令人不满意的地方，这里只谈几点:<ul>
<li>JavaScript 没有类型，所以写 JSDoc 感觉很麻烦，但不写又不太好。然而，JavaScript 代码写的太顺利的话就可能忘记加上 JSDoc，之后代码就很难维护。</li>
<li>VSCode 支持不好，这点或许才是最重要的: VSCode 使用 TypeScript 编写，并基于 TypeScript 实现的语法提示功能，虽然也支持根据 JSDoc 的注释进行提示，然而当你去做一个开源项目，并将之发布到 npm 之后，情况发生了变化。。。当一个用户使用 npm&#x2F;yarn 安装了你的项目之后，发现并没有任何代码提示，如此你会怎么做？</li>
<li>复杂的类型很难使用 JSDoc 表达出来并清晰地告诉调用者，例如高阶函数。</li>
<li>等等。。。。</li>
</ul>
</li>
</ul>
<p>是的，TypeScript 确实解决了以上的一些问题，却同时带入了另外一些问题。</p>
<ul>
<li>TypeScript 有类型了，然而即便有类型推导，还是要加很多类型，而且有时候 TypeScript 和我们的想法不同的时候还要用 <code>!</code>&#x2F;<code>(t as unkonwn) as R</code> 这种 <strong>hack 技巧</strong>。</li>
<li>VSCode 天生支持 TypeScript，但 TypeScript 的 API Doc 生成工具实在谈不上多好，例如 <a target="_blank" rel="noopener" href="https://typedoc.org/">typedoc</a> 相比于 <a target="_blank" rel="noopener" href="https://esdoc.org/">ESDoc</a> 不过是个半吊子。。。</li>
<li>事实上，即便使用 TypeScript 写的项目，只要使用者没有在 <code>jsconfig.json</code> 中进行配置的话，提示仍然默认不存在</li>
<li>TypeScript 的类型系统是把双刃剑，实在太复杂了，当然有理由认为是为了兼容 JavaScript。然而在 TypeScript 想要正确的表达类型也是一件相当困难的事情。</li>
</ul>
<h2 id="类型系统踩坑"><a href="#类型系统踩坑" class="headerlink" title="类型系统踩坑"></a>类型系统踩坑</h2><h3 id="如何声明参数与返回值类型相同？"><a href="#如何声明参数与返回值类型相同？" class="headerlink" title="如何声明参数与返回值类型相同？"></a>如何声明参数与返回值类型相同？</h3><p>例如一个函数接受一个参数，并返回一个完全相同类型的返回值。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">returnItself</span>(<span class="params">obj: <span class="built_in">any</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假使这样写的话，类型系统就不会发挥作用了，调用函数的结果将是 <code>any</code>，意味着类型系统将没有效果。</p>
<p>例如下面的代码会被 ts 认为是错误</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这段代码并不会有提示</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">returnItself</span>(<span class="string">&#x27;abc&#x27;</span>).<span class="property">length</span>)</span><br></pre></td></tr></table></figure>

<p>需要写成</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> returnItself&lt;T = <span class="built_in">any</span>&gt;(<span class="attr">obj</span>: T): T &#123;</span><br><span class="line">  <span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要声明了参数和返回值是同一类型，默认为 any，但具体取决于参数的不同而使得返回值也不同，返回值不会丢失类型信息。</p>
<h3 id="如何声明参数与返回值类型有关联？"><a href="#如何声明参数与返回值类型有关联？" class="headerlink" title="如何声明参数与返回值类型有关联？"></a>如何声明参数与返回值类型有关联？</h3><p>例如一个计算函数执行时间的函数 <code>timing</code>，接受一个函数参数，有可能是同步&#x2F;异步的，所以要根据函数的返回值确定 <code>timing</code> 的返回值为 <code>number/Promise&lt;number&gt;</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params"></span></span><br><span class="line"><span class="params">  fn: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span> | <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">number</span> | <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> begin = performance.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">fn</span>()</span><br><span class="line">  <span class="keyword">if</span> (!(result <span class="keyword">instanceof</span> <span class="title class_">Promise</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> performance.<span class="title function_">now</span>() - begin</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result.<span class="title function_">then</span>(<span class="function">() =&gt;</span> performance.<span class="title function_">now</span>() - begin)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然而在使用时你会发现返回值类型不太对，因为 <code>timing</code> 的返回值是 <code>number | Promise&lt;number&gt;</code> 这种复合类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里会提示类型错误</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">res</span>: <span class="built_in">number</span> = <span class="title function_">timing</span>(<span class="function">() =&gt;</span> <span class="title function_">sleep</span>(<span class="number">100</span>))</span><br><span class="line"><span class="title function_">expect</span>(res).<span class="title function_">toBeGreaterThan</span>(<span class="number">99</span>)</span><br></pre></td></tr></table></figure>

<p>解决方案有二</p>
<ol>
<li>使用函数声明重载</li>
<li>使用类型判断</li>
</ol>
<h4 id="使用函数声明重载"><a href="#使用函数声明重载" class="headerlink" title="使用函数声明重载"></a>使用函数声明重载</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params">fn: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params">fn: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span></span>): <span class="built_in">number</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params"></span></span><br><span class="line"><span class="params">  fn: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span> | <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">number</span> | <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> begin = performance.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">fn</span>()</span><br><span class="line">  <span class="keyword">if</span> (!(result <span class="keyword">instanceof</span> <span class="title class_">Promise</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> performance.<span class="title function_">now</span>() - begin</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result.<span class="title function_">then</span>(<span class="function">() =&gt;</span> performance.<span class="title function_">now</span>() - begin)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>感觉函数声明顺序有点奇怪是因为 <code>Promise&lt;any&gt;</code> 属于 <code>any</code> 的子类，而函数声明重载必须由具体到宽泛。当然，我们有方法可以在 <code>any</code> 中排除掉 <code>Promise&lt;any&gt;</code>，这样顺序就对了！</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params"></span></span><br><span class="line"><span class="params">  fn: (...args: <span class="built_in">any</span>[]) =&gt; Exclude&lt;<span class="built_in">any</span>, <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;&gt;,</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">number</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params">fn: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params"></span></span><br><span class="line"><span class="params">  fn: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span> | <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">number</span> | <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> begin = performance.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">fn</span>()</span><br><span class="line">  <span class="keyword">if</span> (!(result <span class="keyword">instanceof</span> <span class="title class_">Promise</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> performance.<span class="title function_">now</span>() - begin</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result.<span class="title function_">then</span>(<span class="function">() =&gt;</span> performance.<span class="title function_">now</span>() - begin)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用类型判断"><a href="#使用类型判断" class="headerlink" title="使用类型判断"></a>使用类型判断</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params"></span></span><br><span class="line"><span class="params">  fn: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span> | <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params">  <span class="comment">// 函数返回类型是 Promise 的话，则返回 Promise&lt;number&gt;，否则返回 number</span></span></span><br><span class="line"><span class="params"></span>): R <span class="keyword">extends</span> <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt; ? <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; : <span class="built_in">number</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> begin = performance.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">fn</span>()</span><br><span class="line">  <span class="keyword">if</span> (!(result <span class="keyword">instanceof</span> <span class="title class_">Promise</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> (performance.<span class="title function_">now</span>() - begin) <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result.<span class="title function_">then</span>(<span class="function">() =&gt;</span> performance.<span class="title function_">now</span>() - begin) <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>可以看出来，第一种方式的优点在于可以很精细的控制每个不同参数对应的返回值，并且，可以处理特别复杂的情况，缺点则是如果写 doc 文档的话需要为每个声明都写上，即便，它们有大部分注释是相同的。<br>而第二种方式，则在代码量上有所减少，而且不必使用函数声明重载。缺点则是无法应对特别复杂的情况，另外一点就是使用了 <code>any</code>，可能会造成<strong>重构火葬场</strong>。</p>
<h3 id="TypeScript-类型系统就是认为吾辈错了怎么办？"><a href="#TypeScript-类型系统就是认为吾辈错了怎么办？" class="headerlink" title="TypeScript 类型系统就是认为吾辈错了怎么办？"></a>TypeScript 类型系统就是认为吾辈错了怎么办？</h3><p>有时候，明明自己知道是正确的，但 TypeScript 偏偏认为你写错了。思考以下功能如何实现？</p>
<p>将 Array 转换为 Map，接受三个参数</p>
<ol>
<li>需要转换的数组</li>
<li>将数组元素转换为 Map key 的函数</li>
<li>将数组元素转换为 Map value 的函数，可选，默认为数组元素</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> returnItself&lt;T = <span class="built_in">any</span>&gt;(<span class="attr">obj</span>: T): T &#123;</span><br><span class="line">  <span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">ArrayCallback</span>&lt;T, R&gt; = <span class="function">(<span class="params">item: T, index: <span class="built_in">number</span>, arr: T[]</span>) =&gt;</span> R</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> arrayToMap&lt;T, K, V&gt;(</span><br><span class="line">  <span class="attr">arr</span>: T[],</span><br><span class="line">  <span class="attr">kFn</span>: <span class="title class_">ArrayCallback</span>&lt;T, K&gt;,</span><br><span class="line">  <span class="attr">vFn</span>: <span class="title class_">ArrayCallback</span>&lt;T, V&gt; = returnItself,</span><br><span class="line">): <span class="title class_">Map</span>&lt;K, V&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> arr.<span class="title function_">reduce</span>(</span><br><span class="line">    <span class="function">(<span class="params">res, item, index, arr</span>) =&gt;</span></span><br><span class="line">      res.<span class="title function_">set</span>(<span class="title function_">kFn</span>(item, index, arr), <span class="title function_">vFn</span>(item, index, arr)),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Map</span>&lt;K, V&gt;(),</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可能有以上代码，然而实际上 <code>returnItself</code> 无法直接赋值给 <code>ArrayCallback&lt;T, V&gt;</code>。当然，我们知道，这一定是可以赋值的，但 TypeScript 却无法编译通过！</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> arrayToMap&lt;T, K, V&gt;(</span><br><span class="line">  <span class="attr">arr</span>: T[],</span><br><span class="line">  <span class="attr">kFn</span>: <span class="title class_">ArrayCallback</span>&lt;T, K&gt;,</span><br><span class="line">  <span class="comment">// 是的，这里添加 as any 就好了</span></span><br><span class="line">  <span class="attr">vFn</span>: <span class="title class_">ArrayCallback</span>&lt;T, V&gt; = returnItself <span class="keyword">as</span> <span class="built_in">any</span>,</span><br><span class="line">): <span class="title class_">Map</span>&lt;K, V&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> arr.<span class="title function_">reduce</span>(</span><br><span class="line">    <span class="function">(<span class="params">res, item, index, arr</span>) =&gt;</span></span><br><span class="line">      res.<span class="title function_">set</span>(<span class="title function_">kFn</span>(item, index, arr), <span class="title function_">vFn</span>(item, index, arr)),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Map</span>&lt;K, V&gt;(),</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者，如果 <code>returnItself</code> 用的比较多的话（例如吾辈），可以使用另一种方式</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改 returnItself 的返回值</span></span><br><span class="line"><span class="keyword">function</span> returnItself&lt;T, R = T&gt;(<span class="attr">obj</span>: T): R &#123;</span><br><span class="line">  <span class="keyword">return</span> obj <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">ArrayCallback</span>&lt;T, R&gt; = <span class="function">(<span class="params">item: T, index: <span class="built_in">number</span>, arr: T[]</span>) =&gt;</span> R</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> arrayToMap&lt;T, K, V&gt;(</span><br><span class="line">  <span class="attr">arr</span>: T[],</span><br><span class="line">  <span class="attr">kFn</span>: <span class="title class_">ArrayCallback</span>&lt;T, K&gt;,</span><br><span class="line">  <span class="attr">vFn</span>: <span class="title class_">ArrayCallback</span>&lt;T, V&gt; = returnItself,</span><br><span class="line">): <span class="title class_">Map</span>&lt;K, V&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> arr.<span class="title function_">reduce</span>(</span><br><span class="line">    <span class="function">(<span class="params">res, item, index, arr</span>) =&gt;</span></span><br><span class="line">      res.<span class="title function_">set</span>(<span class="title function_">kFn</span>(item, index, arr), <span class="title function_">vFn</span>(item, index, arr)),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Map</span>&lt;K, V&gt;(),</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="如何强制调用非空时对象上的函数？"><a href="#如何强制调用非空时对象上的函数？" class="headerlink" title="如何强制调用非空时对象上的函数？"></a>如何强制调用非空时对象上的函数？</h3><p>当有时候你得到一个对象可能为空时，无法直接调用其上的函数，会提示函数不存在。<br>例如下面从数组中查询字符串，然后获取长度，在 TypeScript 中便会报错，因为 str 的类型为 string&#x2F;undefined。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="keyword">const</span> str = arr.<span class="title function_">find</span>(<span class="function"><span class="params">s</span> =&gt;</span> s === <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str.<span class="property">length</span>)</span><br></pre></td></tr></table></figure>

<p>之前使用 JavaScript 从未遇到过这种事情，事实上确实有可能为空，但 JavaScript 太过于动态，并不会提示错误，而 TypeScript 就会提示这种低级错误，因为类型系统。<br>但是啊，凡事都有例外，当吾辈确实想调用 string 上的函数时报错真的是有点讨厌，那么有什么办法呢？</p>
<ol>
<li><p>使用 <code>!</code> 强制调用</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="keyword">const</span> str = arr.<span class="title function_">find</span>(<span class="function"><span class="params">s</span> =&gt;</span> s === <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str!.<span class="property">length</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <code>(str as any)</code> 转换为 any 类型之后再随意调用任何函数</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="keyword">const</span> str = arr.<span class="title function_">find</span>(<span class="function"><span class="params">s</span> =&gt;</span> s === <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>((str <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">length</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用注释 <code>// @ts-ignore</code> 忽略错误（非常强力，少用）</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="keyword">const</span> str = arr.<span class="title function_">find</span>(<span class="function"><span class="params">s</span> =&gt;</span> s === <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"><span class="comment">// @ts-ignore</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str.<span class="property">length</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<p>注意: 三种方式推荐程度逐渐降低，因为后两种实际上都会忽略类型系统，导致编写代码没有提示！</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>截至目前为止，吾辈已经着手使用 TypeScript 重构工具函数库 <a target="_blank" rel="noopener" href="https://github.com/rxliuli/rx-util">rx-util</a> 两周了，基本上打包配置，文档生成，类型定义基本上算是大致完成，感觉之后的公共项目大概都会用 TypeScript 实现了，毕竟前端主流开发工具 VSCode 对其的支持真的很好，而且 TypeScript 的接口这种概念真的太有用了！</p>
<h2 id="一些吐槽"><a href="#一些吐槽" class="headerlink" title="一些吐槽"></a>一些吐槽</h2><p>使用了有一段时间了，这里不得不再次声明一下，TypeScript 的类型系统复杂度超乎想象，如果你没有准备好在生产系统中使用，那就最好不要使用。缺少关于类型系统（尤其是原生类型，例如 <code>PromiseLike</code> 居然没有人讲过）的说明，使得 TypeScript 的类型系统很多时候看起来都只是为了<strong>好玩</strong>而已。而且稍微复杂一点的情况思考如何设计类型的时间将会超过具体的代码实现，使用它请务必再三慎重考虑！</p>
<p>TypeScript 的类型系统为了兼容 JavaScript 缺陷实在太大了。</p>
<blockquote>
<p>参见某个知乎用户的话:</p>
</blockquote>
<ol>
<li><p>ts 写不出一个合并对象的方法</p>
<p>下面是一个 js 合并对象的方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">extend</span>(<span class="params">dest, ...sources</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">assign</span>(dest, ...sources)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这么一个简单的方法，ts 写不出不丢失类型信息的实现。</p>
<p>下面贴的是 typescript 源码中对 Object.assign 的声明，我相信都能看出有多傻：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">assign&lt;T, U&gt;(<span class="attr">target</span>: T, <span class="attr">source</span>: U): T &amp; U;</span><br><span class="line">assign&lt;T, U, V&gt;(<span class="attr">target</span>: T, <span class="attr">source1</span>: U, <span class="attr">source2</span>: V): T &amp; U &amp; V;</span><br><span class="line">assign&lt;T, U, V, W&gt;(<span class="attr">target</span>: T, <span class="attr">source1</span>: U, <span class="attr">source2</span>: V, <span class="attr">source3</span>: W): T &amp; U &amp; &amp; W;</span><br><span class="line"><span class="title function_">assign</span>(<span class="attr">target</span>: <span class="built_in">object</span>, ...<span class="attr">sources</span>: <span class="built_in">any</span>[]): <span class="built_in">any</span>;</span><br></pre></td></tr></table></figure>

<p>按这个实现，多于 4 个参数就直接丢掉类型信息了，建议 ts 至少把 A-Z 都作为泛型量用上…</p>
</li>
<li><p>一些很明显的类型推断却推断不出来</p>
<p>用 assert 方法做参数检查是很常用的做法，一个简单的 assert 方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">assert</span>(<span class="params">condition, msg</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (condition) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后看这样一段代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">p: <span class="built_in">number</span> | <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="title function_">assert</span>(<span class="keyword">typeof</span> p === <span class="string">&#x27;number&#x27;</span>, <span class="string">&#x27;p is a number&#x27;</span>)</span><br><span class="line">  p.<span class="property">length</span> <span class="comment">// 这里报错，ts 竟然不知道到这一步 p 必定是 string 类型</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/05/22/others/rxliuliBlog/JavaScript/JavaScript-%E5%A4%84%E7%90%86%E6%A0%91%E7%BB%93%E6%9E%84%E6%95%B0%E6%8D%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/22/others/rxliuliBlog/JavaScript/JavaScript-%E5%A4%84%E7%90%86%E6%A0%91%E7%BB%93%E6%9E%84%E6%95%B0%E6%8D%AE/" class="post-title-link" itemprop="url">JavaScript 处理树数据结构</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-23 00:00:00" itemprop="dateCreated datePublished" datetime="2019-05-23T00:00:00+08:00">2019-05-23</time>
    </span>


  
    <span id="/2019/05/22/others/rxliuliBlog/JavaScript/JavaScript-%E5%A4%84%E7%90%86%E6%A0%91%E7%BB%93%E6%9E%84%E6%95%B0%E6%8D%AE/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript 处理树数据结构" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript 处理树数据结构" href="/2019/05/22/others/rxliuliBlog/JavaScript/JavaScript-%E5%A4%84%E7%90%86%E6%A0%91%E7%BB%93%E6%9E%84%E6%95%B0%E6%8D%AE/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::a8fe5d44cd22599ac9465f7d95f862bf" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaScript-处理树结构数据"><a href="#JavaScript-处理树结构数据" class="headerlink" title="JavaScript 处理树结构数据"></a>JavaScript 处理树结构数据</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>即便在前端，也有很多时候需要操作 <strong>树结构</strong> 的情况，最典型的场景莫过于 _无限级分类_。之前吾辈曾经遇到过这种场景，但当时没有多想直接手撕 JavaScript 列表转树了，并没有想到进行封装。后来遇到的场景多了，想到如何封装树结构操作，但考虑到不同场景的树节点结构的不同，就没有继续进行下去了。</p>
<p>直到吾辈开始经常运用了 ES6 <code>Proxy</code> 之后，吾辈想到了新的解决方案！</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><ul>
<li>问: 之前为什么停止封装树结构操作了？</li>
<li>答: 因为不同的树结构节点可能有不同的结构，例如某个项目的树节点父节点 id 字段是 <code>parent</code>，而另一个项目则是 <code>parentId</code></li>
<li>问: <code>Proxy</code> 如何解决这个问题呢？</li>
<li>答: <code>Proxy</code> 可以拦截对象的操作，当访问对象不存在的字段时，<code>Proxy</code> 能将之代理到已经存在的字段上</li>
<li>问: 这点意味着什么？</li>
<li>答: 它意味着 <code>Proxy</code> 能够抹平不同的树节点结构之间的差异！</li>
<li>问: 我还是不太明白 <code>Proxy</code> 怎么用，能举个具体的例子么？</li>
<li>答: 当然可以，我现在就让你看看 <code>Proxy</code> 的能力</li>
</ul>
<p>下面思考一下如何在同一个函数中处理这两种树节点结构</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统菜单</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SysMenu</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构造函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; id 菜单 id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; name 显示的名称</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; parent 父级菜单 id</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">id, name, parent</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = id</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = parent</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统权限</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SysPermission</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构造函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; uid 系统唯一 uuid</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; label 显示的菜单名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; parentId 父级权限 uid</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">uid, label, parentId</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">uid</span> = uid</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">label</span> = label</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parentId</span> = parentId</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面让我们使用 <code>Proxy</code> 来抹平访问它们之间的差异</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sysMenuMap = <span class="keyword">new</span> <span class="title class_">Map</span>().<span class="title function_">set</span>(<span class="string">&#x27;parentId&#x27;</span>, <span class="string">&#x27;parent&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> sysMenu = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="keyword">new</span> <span class="title class_">SysMenu</span>(<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>), &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">_, k</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (sysMenuMap.<span class="title function_">has</span>(k)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, sysMenuMap.<span class="title function_">get</span>(k))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, k)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sysMenu.<span class="property">id</span>, sysMenu.<span class="property">name</span>, sysMenu.<span class="property">parentId</span>) <span class="comment">// 1 &#x27;rx&#x27; 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sysPermissionMap = <span class="keyword">new</span> <span class="title class_">Map</span>().<span class="title function_">set</span>(<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;uid&#x27;</span>).<span class="title function_">set</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;label&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> sysPermission = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="keyword">new</span> <span class="title class_">SysPermission</span>(<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>), &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">_, k</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (sysPermissionMap.<span class="title function_">has</span>(k)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, sysPermissionMap.<span class="title function_">get</span>(k))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, k)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sysPermission.<span class="property">id</span>, sysPermission.<span class="property">name</span>, sysPermission.<span class="property">parentId</span>) <span class="comment">// 1 &#x27;rx&#x27; 0</span></span><br></pre></td></tr></table></figure>

<h2 id="定义桥接函数"><a href="#定义桥接函数" class="headerlink" title="定义桥接函数"></a>定义桥接函数</h2><p>现在，差异确实抹平了，我们可以通过访问相同的属性来获取到不同结构对象的值！然而，每个对象都写一次代理终究有点麻烦，所以我们实现一个通用函数用以包装。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 桥接对象不存在的字段</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; map 代理的字段映射 Map</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Function</span>&#125; 转换一个对象为代理对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">bridge</span>(<span class="params">map</span>) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 为对象添加代理的函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; obj 任何对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">Proxy</span>&#125; 代理后的对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, &#123;</span><br><span class="line">      <span class="title function_">get</span>(<span class="params">target, k</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Reflect</span>.<span class="title function_">has</span>(map, k)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, <span class="title class_">Reflect</span>.<span class="title function_">get</span>(map, k))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, k)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">set</span>(<span class="params">target, k, v</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Reflect</span>.<span class="title function_">has</span>(map, k)) &#123;</span><br><span class="line">          <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, <span class="title class_">Reflect</span>.<span class="title function_">get</span>(map, k), v)</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, k, v)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，我们可以用更简单的方式来做代理了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sysMenu = <span class="title function_">bridge</span>(&#123;</span><br><span class="line">  <span class="attr">parentId</span>: <span class="string">&#x27;parent&#x27;</span>,</span><br><span class="line">&#125;)(<span class="keyword">new</span> <span class="title class_">SysMenu</span>(<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sysMenu.<span class="property">id</span>, sysMenu.<span class="property">name</span>, sysMenu.<span class="property">parentId</span>) <span class="comment">// 1 &#x27;rx&#x27; 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sysPermission = <span class="title function_">bridge</span>(&#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="string">&#x27;uid&#x27;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;label&#x27;</span>,</span><br><span class="line">&#125;)(<span class="keyword">new</span> <span class="title class_">SysPermission</span>(<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sysPermission.<span class="property">id</span>, sysPermission.<span class="property">name</span>, sysPermission.<span class="property">parentId</span>) <span class="comment">// 1 &#x27;rx&#x27; 0</span></span><br></pre></td></tr></table></figure>

<h2 id="定义标准树结构"><a href="#定义标准树结构" class="headerlink" title="定义标准树结构"></a>定义标准树结构</h2><p>想要抹平差异，我们至少还需要一个标准的树结构，告诉别人我们需要什么样的树节点数据结构，以便于在之后处理树节点的函数中统一使用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基本的 Node 节点结构定义接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@interface</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">INode</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构造函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; [options] 可选项参数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; [options.id] 树结点的 id 属性名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; [options.parentId] 树结点的父节点 id 属性名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; [options.child] 树结点的子节点数组属性名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; [options.path] 树结点的全路径属性名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Array.&lt;Object&gt;</span>&#125; [options.args] 其他参数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">&#123; id, parentId, child, path, ...args &#125; = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@field</span> 树结点的 id 属性名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = id</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@field</span> 树结点的父节点 id 属性名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parentId</span> = parentId</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@field</span> 树结点的子节点数组属性名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">child</span> = child</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@field</span> 树结点的全路径属性名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">path</span> = path</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现列表转树"><a href="#实现列表转树" class="headerlink" title="实现列表转树"></a>实现列表转树</h2><p>列表转树，除了递归之外，也可以使用循环实现，这里便以循环为示例。</p>
<p>思路</p>
<ol>
<li>在外层遍历子节点</li>
<li>如果是根节点，就添加到根节点中并不在找其父节点。</li>
<li>否则在内层循环中找该节点的父节点，找到之后将子节点追加到父节点的子节点列表中，然后结束本次内层循环。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将列表转换为树节点</span></span><br><span class="line"><span class="comment"> * 注：该函数默认树的根节点只有一个，如果有多个，则返回一个数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Array.&lt;Object&gt;</span>&#125; list 树节点列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; [options] 其他选项</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; [options.isRoot] 判断节点是否为根节点。默认根节点的父节点为空</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; [options.bridge=returnItself] 桥接函数，默认返回自身</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Object|Array.&lt;String&gt;</span>&#125; 树节点，或是树节点列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">listToTree</span>(<span class="params"></span></span><br><span class="line"><span class="params">  list,</span></span><br><span class="line"><span class="params">  &#123; isRoot = node =&gt; !node.parentId, bridge = returnItself &#125; = &#123;&#125;,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> res = list.<span class="title function_">reduce</span>(<span class="function">(<span class="params">root, _sub</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isRoot</span>(sub)) &#123;</span><br><span class="line">      root.<span class="title function_">push</span>(sub)</span><br><span class="line">      <span class="keyword">return</span> root</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> sub = <span class="title function_">bridge</span>(_sub)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> _parent <span class="keyword">of</span> list) &#123;</span><br><span class="line">      <span class="keyword">const</span> parent = <span class="title function_">bridge</span>(_parent)</span><br><span class="line">      <span class="keyword">if</span> (sub.<span class="property">parentId</span> === parent.<span class="property">id</span>) &#123;</span><br><span class="line">        parent.<span class="property">child</span> = parent.<span class="property">child</span> || []</span><br><span class="line">        parent.<span class="property">child</span>.<span class="title function_">push</span>(sub)</span><br><span class="line">        <span class="keyword">return</span> root</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line">  &#125;, [])</span><br><span class="line">  <span class="comment">// 根据顶级节点的数量决定如何返回</span></span><br><span class="line">  <span class="keyword">const</span> len = res.<span class="property">length</span></span><br><span class="line">  <span class="keyword">if</span> (len === <span class="number">0</span>) <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  <span class="keyword">if</span> (len === <span class="number">1</span>) <span class="keyword">return</span> res[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="抽取通用的树结构遍历逻辑"><a href="#抽取通用的树结构遍历逻辑" class="headerlink" title="抽取通用的树结构遍历逻辑"></a>抽取通用的树结构遍历逻辑</h2><p>首先，明确一点，树结构的完全遍历是通用的，大致实现基本如下</p>
<ol>
<li>遍历顶级树节点</li>
<li>遍历树节点的子节点列表</li>
<li>递归调用函数并传入子节点</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回第一个参数的函数</span></span><br><span class="line"><span class="comment"> * 注：一般可以当作返回参数自身的函数，如果你只关注第一个参数的话</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; obj 任何对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Object</span>&#125; 传入的第一个参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">returnItself</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遍历并映射一棵树的每个节点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; root 树节点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; [options] 其他选项</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; [options.before=returnItself] 遍历子节点之前的操作。默认返回自身</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; [options.after=returnItself] 遍历子节点之后的操作。默认返回自身</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; [options.paramFn=(node, args) =&gt; []] 递归的参数生成函数。默认返回一个空数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">INode</span>&#125; 递归遍历后的树节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">treeMapping</span>(<span class="params"></span></span><br><span class="line"><span class="params">  root,</span></span><br><span class="line"><span class="params">  &#123;</span></span><br><span class="line"><span class="params">    before = returnItself,</span></span><br><span class="line"><span class="params">    after = returnItself,</span></span><br><span class="line"><span class="params">    paramFn = (node, ...args) =&gt; [],</span></span><br><span class="line"><span class="params">  &#125; = &#123;&#125;,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 遍历一颗完整的树</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">INode</span>&#125; node 要遍历的树节点</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span>  &#123;<span class="type">...Object</span>&#125; [args] 每次递归遍历时的参数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">_treeMapping</span>(<span class="params">node, ...args</span>) &#123;</span><br><span class="line">    <span class="comment">// 之前的操作</span></span><br><span class="line">    <span class="keyword">let</span> _node = <span class="title function_">before</span>(node, ...args)</span><br><span class="line">    <span class="keyword">const</span> childs = _node.<span class="property">child</span></span><br><span class="line">    <span class="keyword">if</span> (arrayValidator.<span class="title function_">isEmpty</span>(childs)) &#123;</span><br><span class="line">      <span class="keyword">return</span> _node</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 产生一个参数</span></span><br><span class="line">    <span class="keyword">const</span> len = childs.<span class="property">length</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">      childs[i] = <span class="title function_">_treeMapping</span>(childs[i], ...<span class="title function_">paramFn</span>(_node, ...args))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 之后的操作</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">after</span>(_node, ...args)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">_treeMapping</span>(root)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>treeMapping</code> 遍历树并打印</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tree = &#123;</span><br><span class="line">  <span class="attr">uid</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">childrens</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">uid</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">parent</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">childrens</span>: [&#123; <span class="attr">uid</span>: <span class="number">3</span>, <span class="attr">parent</span>: <span class="number">2</span> &#125;, &#123; <span class="attr">uid</span>: <span class="number">4</span>, <span class="attr">parent</span>: <span class="number">2</span> &#125;],</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">uid</span>: <span class="number">5</span>,</span><br><span class="line">      <span class="attr">parent</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">childrens</span>: [&#123; <span class="attr">uid</span>: <span class="number">6</span>, <span class="attr">parent</span>: <span class="number">5</span> &#125;, &#123; <span class="attr">uid</span>: <span class="number">7</span>, <span class="attr">parent</span>: <span class="number">5</span> &#125;],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 桥接函数</span></span><br><span class="line"><span class="keyword">const</span> bridge = <span class="title function_">bridge</span>(&#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="string">&#x27;uid&#x27;</span>,</span><br><span class="line">  <span class="attr">parentId</span>: <span class="string">&#x27;parent&#x27;</span>,</span><br><span class="line">  <span class="attr">child</span>: <span class="string">&#x27;childrens&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title function_">treeMapping</span>(tree, &#123;</span><br><span class="line">  <span class="comment">// 进行桥接抹平差异</span></span><br><span class="line">  <span class="attr">before</span>: bridge,</span><br><span class="line">  <span class="comment">// 之后打印每一个</span></span><br><span class="line">  <span class="title function_">after</span>(<span class="params">node</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(node)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="实现树转列表"><a href="#实现树转列表" class="headerlink" title="实现树转列表"></a>实现树转列表</h2><p>当然，我们亦可使用 <code>treeMapping</code> 简单的实现 <code>treeToList</code>，当然，这里考虑了是否计算全路径，毕竟还是要考虑性能的！</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将树节点转为树节点列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; root 树节点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; [options] 其他选项</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Boolean</span>&#125; [options.calcPath=false] 是否计算节点全路径，默认为 false</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; [options.bridge=returnItself] 桥接函数，默认返回自身</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Array.&lt;Object&gt;</span>&#125; 树节点列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">treeToList</span>(<span class="params"></span></span><br><span class="line"><span class="params">  root,</span></span><br><span class="line"><span class="params">  &#123; calcPath = <span class="literal">false</span>, bridge = returnItself &#125; = &#123;&#125;,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> res = []</span><br><span class="line">  <span class="title function_">treeMapping</span>(root, &#123;</span><br><span class="line">    <span class="title function_">before</span>(<span class="params">_node, parentPath</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> node = <span class="title function_">bridge</span>(_node)</span><br><span class="line">      <span class="comment">// 是否计算全路径</span></span><br><span class="line">      <span class="keyword">if</span> (calcPath) &#123;</span><br><span class="line">        node.<span class="property">path</span> = (parentPath ? parentPath + <span class="string">&#x27;,&#x27;</span> : <span class="string">&#x27;&#x27;</span>) + node.<span class="property">id</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 此时追加到数组中</span></span><br><span class="line">      res.<span class="title function_">push</span>(node)</span><br><span class="line">      <span class="keyword">return</span> node</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">paramFn</span>: <span class="function"><span class="params">node</span> =&gt;</span> (calcPath ? [node.<span class="property">path</span>] : []),</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，我们可以转换任意树结构为列表了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tree = &#123;</span><br><span class="line">  <span class="attr">uid</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">childrens</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">uid</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">parent</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">childrens</span>: [&#123; <span class="attr">uid</span>: <span class="number">3</span>, <span class="attr">parent</span>: <span class="number">2</span> &#125;, &#123; <span class="attr">uid</span>: <span class="number">4</span>, <span class="attr">parent</span>: <span class="number">2</span> &#125;],</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">uid</span>: <span class="number">5</span>,</span><br><span class="line">      <span class="attr">parent</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">childrens</span>: [&#123; <span class="attr">uid</span>: <span class="number">6</span>, <span class="attr">parent</span>: <span class="number">5</span> &#125;, &#123; <span class="attr">uid</span>: <span class="number">7</span>, <span class="attr">parent</span>: <span class="number">5</span> &#125;],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> fn = <span class="title function_">bridge</span>(&#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="string">&#x27;uid&#x27;</span>,</span><br><span class="line">  <span class="attr">parentId</span>: <span class="string">&#x27;parent&#x27;</span>,</span><br><span class="line">  <span class="attr">child</span>: <span class="string">&#x27;childrens&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> list = <span class="title function_">treeToList</span>(tree, &#123;</span><br><span class="line">  <span class="attr">bridge</span>: fn,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(list)</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>那么，JavaScript 中处理树结构数据就到这里了。当然，树结构数据还有其他的更多操作尚未实现，例如常见的查询子节点列表，节点过滤，最短路径查找等等。但目前列表与树的转换才是最常用的，而且其他操作基本上也是基于它们做的，所以这里也便点到为止了。</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/05/15/others/rxliuliBlog/JavaScript/JavaScript-%E5%BE%AE%E4%BB%BB%E5%8A%A1-%E5%AE%8F%E4%BB%BB%E5%8A%A1%E8%B8%A9%E5%9D%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/15/others/rxliuliBlog/JavaScript/JavaScript-%E5%BE%AE%E4%BB%BB%E5%8A%A1-%E5%AE%8F%E4%BB%BB%E5%8A%A1%E8%B8%A9%E5%9D%91/" class="post-title-link" itemprop="url">JavaScript 微任务/宏任务踩坑</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-15 09:15:37" itemprop="dateCreated datePublished" datetime="2019-05-15T09:15:37+08:00">2019-05-15</time>
    </span>


  
    <span id="/2019/05/15/others/rxliuliBlog/JavaScript/JavaScript-%E5%BE%AE%E4%BB%BB%E5%8A%A1-%E5%AE%8F%E4%BB%BB%E5%8A%A1%E8%B8%A9%E5%9D%91/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript 微任务/宏任务踩坑" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript 微任务/宏任务踩坑" href="/2019/05/15/others/rxliuliBlog/JavaScript/JavaScript-%E5%BE%AE%E4%BB%BB%E5%8A%A1-%E5%AE%8F%E4%BB%BB%E5%8A%A1%E8%B8%A9%E5%9D%91/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::fbe6c31a79319d470bec1cad6ee22ba9" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaScript-微任务-x2F-宏任务踩坑"><a href="#JavaScript-微任务-x2F-宏任务踩坑" class="headerlink" title="JavaScript 微任务&#x2F;宏任务踩坑"></a>JavaScript 微任务&#x2F;宏任务踩坑</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000019181961">SegmentFault</a></p>
</blockquote>
<p>在使用 <code>async-await</code> 时，吾辈总是习惯把它们当作同步，终于，现在踩到坑里去了。<br>使用 <code>setTimeout</code> 和 <code>setInterval</code> 实现的基于 <code>Promise</code> 的 <code>wait</code> 函数，然而测试边界情况的时候却发现了一些问题！</p>
<p>实现代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 等待指定的时间/等待指定表达式成立</span></span><br><span class="line"><span class="comment"> * 如果未指定等待条件则立刻执行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number|Function</span>&#125; [param] 等待时间/等待条件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise</span>&#125; Promise 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">wait</span> = param =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(resolve, param)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">param</span>()) &#123;</span><br><span class="line">          <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">          <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="number">100</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 标识当前是否有异步函数 add 在运行了</span></span><br><span class="line">  <span class="keyword">let</span> taskIsRun = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">add</span> = <span class="keyword">async</span> (<span class="params">_v, i</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 如果已经有运行的 add 函数，则等待</span></span><br><span class="line">    <span class="keyword">if</span> (taskIsRun) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断前: &#x27;</span>)</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !taskIsRun</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      taskIsRun = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun)</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">100</span>)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 执行后: &#x27;</span>)</span><br><span class="line">      taskIsRun = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">    <span class="title class_">Array</span>(<span class="number">10</span>)</span><br><span class="line">      .<span class="title function_">fill</span>(<span class="number">0</span>)</span><br><span class="line">      .<span class="title function_">map</span>(add),</span><br><span class="line">  )</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>() - start)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>那么，先不要往下看，猜一下最后打印的大概会是多少呢？</p>
<p>实际执行结果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">0 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">1 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">2 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">3 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">4 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">5 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">6 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">7 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">8 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">9 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">0 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">1 判断后: <span class="literal">false</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">1 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">// 这儿的 1 执行前，结果 2 就已经判断通过并准备执行了？？？发生了什么？</span><br><span class="line"></span><br><span class="line">2 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">2 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">3 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">3 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">4 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">4 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">5 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">5 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">6 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">6 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">7 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">7 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">8 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">8 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">9 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">9 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">1 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">2 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">3 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">4 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">5 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">6 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">7 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">8 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">9 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">307 ​​​​​at ​​​Date.now() - start​​​ ​src/module/function/wait.js:52:2​</span><br></pre></td></tr></table></figure>

<p>可以看到，很神奇的是 _判断后 &#x3D;&gt; 执行前 &#x3D;&gt; 判断后…&#x3D;&gt; 执行后…_，并不是预想中的 <em>判断后 &#x3D;&gt; 执行前 &#x3D;&gt; 执行后…</em> 的循环，所以，到底发生了什么呢？</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>这个问题卡了吾辈两天之久，直到吾辈在 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/56126223/js-asynchronous-concurrent-locks-are-not-in-effect?noredirect=1#comment98896413_56126223">StackOverflow</a> 提出的另一个相关的问题被外国友人回答了，瞬间吾辈就想起了 – <strong>async-await 本质上还是异步</strong>。</p>
<p>是的，为什么会出现 <code>wait</code> 一直在执行而后面的 <code>taskIsRun = true</code> 却并没有执行？因为 JavaScript 中的 <code>async-await</code> 虽然可以写出来很像同步代码的异步代码，但实际上还是异步的，原理还是基于 <code>Promise</code>。</p>
<p>我们改造一下代码，将之使用原生 <code>Promise</code> 实现一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 等待指定的时间/等待指定表达式成立</span></span><br><span class="line"><span class="comment"> * 如果未指定等待条件则立刻执行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number|Function</span>&#125; [param] 等待时间/等待条件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise</span>&#125; Promise 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">wait</span> = param =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(resolve, param)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">param</span>()) &#123;</span><br><span class="line">          <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">          <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="number">100</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">;(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 标识当前是否有异步函数 add 在运行了</span></span><br><span class="line">  <span class="keyword">let</span> taskIsRun = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">add</span> = (<span class="params">_v, i</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 如果已经有运行的 add 函数，则等待</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (taskIsRun) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断前: &#x27;</span>)</span><br><span class="line">          <span class="comment">// 关键在于这里，实际上执行完成之后并不会到下一个 then，而是继续另一个 wait 的判断</span></span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">wait</span>(<span class="function">() =&gt;</span> !taskIsRun).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        taskIsRun = <span class="literal">true</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun)</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">wait</span>(<span class="number">100</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 执行后: &#x27;</span>)</span><br><span class="line">        taskIsRun = <span class="literal">false</span></span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">    <span class="title class_">Array</span>(<span class="number">10</span>)</span><br><span class="line">      .<span class="title function_">fill</span>(<span class="number">0</span>)</span><br><span class="line">      .<span class="title function_">map</span>(add),</span><br><span class="line">  ).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>() - start))</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>这个时候就可以看出来了，判断逻辑是处在一个 <code>then</code> 后继里面的。那么，执行完 <code>console.log(i + &#39; 判断后: &#39; + taskIsRun)</code> 之后，就一定会继续执行下面的 <code>then</code> 函数么？并不，这时候 <code>wait</code> 函数内部实现中的 <code>setInterval</code> 还在运转，实际上 <code>nodejs</code> 并不会优先继续 <code>then</code> 这种 <code>microtask</code>（微任务），而是会继续进行 <code>setInterval</code> 这种 <code>macrotask</code>（宏任务）。这是 nodejs 与浏览器实现不一致的地方，吾辈将这些代码复制到浏览器上，确实可以正常执行并得到预期的结果。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://juejin.im/entry/58d4df3b5c497d0057eb99ff">微任务与宏任务参考</a></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (taskIsRun) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断前: &#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">wait</span>(<span class="function">() =&gt;</span> !taskIsRun).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当然，nodejs 11 修复了这个问题，参考 <a target="_blank" rel="noopener" href="https://github.com/nodejs/node/pull/22842">https://github.com/nodejs/node/pull/22842</a>。然而目前 NodeJS LTS 为 10，最新版本为 12，这个问题可能还要持续一段时间。</p>
</blockquote>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>那么，难道吾辈就必须等到 NodeJS LTS 最新版之后才能用 wait 么？或者说，吾辈就必须依赖于浏览器的 <code>microtask/macrotask</code> 么？并不，吾辈对之手动进行了处理即可！</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 等待指定的时间/等待指定表达式成立</span></span><br><span class="line"><span class="comment"> * 如果未指定等待条件则立刻执行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number|Function</span>&#125; [param] 等待时间/等待条件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise</span>&#125; Promise 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">wait</span> = param =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(resolve, param)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">param</span>()) &#123;</span><br><span class="line">          <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">          <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="number">100</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 标识当前是否有异步函数 add 在运行了</span></span><br><span class="line">  <span class="keyword">let</span> taskIsRun = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">add</span> = <span class="keyword">async</span> (<span class="params">_v, i</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 如果已经有运行的 add 函数，则等待</span></span><br><span class="line">    <span class="keyword">if</span> (taskIsRun) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断前: &#x27;</span>)</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> result = !taskIsRun</span><br><span class="line">        <span class="comment">// 关键在于这里</span></span><br><span class="line">        <span class="keyword">if</span> (result) &#123;</span><br><span class="line">          taskIsRun = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      taskIsRun = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun)</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">100</span>)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 执行后: &#x27;</span>)</span><br><span class="line">      taskIsRun = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">    <span class="title class_">Array</span>(<span class="number">10</span>)</span><br><span class="line">      .<span class="title function_">fill</span>(<span class="number">0</span>)</span><br><span class="line">      .<span class="title function_">map</span>(add),</span><br><span class="line">  )</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>() - start)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>吾辈在 <code>wait</code> 函数中，即 <code>setInterval</code> 循环调用的函数中对 <code>taskIsRun</code> 进行了修改，而不是在 <code>wait</code> 后面，即 <code>then</code> 之后的 <code>microtask</code> 中进行修改，结果便一切如同吾辈所期待的一样了！</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/05/09/others/rxliuliBlog/JavaScript/JavaScript-%E9%98%B2%E6%8A%96%E5%92%8C%E8%8A%82%E6%B5%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/09/others/rxliuliBlog/JavaScript/JavaScript-%E9%98%B2%E6%8A%96%E5%92%8C%E8%8A%82%E6%B5%81/" class="post-title-link" itemprop="url">JavaScript 防抖和节流</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-09 11:29:51" itemprop="dateCreated datePublished" datetime="2019-05-09T11:29:51+08:00">2019-05-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-05-15 00:00:00" itemprop="dateModified" datetime="2019-05-15T00:00:00+08:00">2019-05-15</time>
    </span>


  
    <span id="/2019/05/09/others/rxliuliBlog/JavaScript/JavaScript-%E9%98%B2%E6%8A%96%E5%92%8C%E8%8A%82%E6%B5%81/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript 防抖和节流" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript 防抖和节流" href="/2019/05/09/others/rxliuliBlog/JavaScript/JavaScript-%E9%98%B2%E6%8A%96%E5%92%8C%E8%8A%82%E6%B5%81/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::073f69b517521fe286bc0dc34bea9cfb" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaScript-防抖和节流"><a href="#JavaScript-防抖和节流" class="headerlink" title="JavaScript 防抖和节流"></a>JavaScript 防抖和节流</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>网络上已经存在了大量的有关 <strong>防抖</strong> 和 <strong>节流</strong> 的文章，为何吾辈还要再写一篇呢？事实上，防抖和节流，吾辈在使用中发现了一些奇怪的问题，并经过了数次的修改，这里主要分享一下吾辈遇到的问题以及是如何解决的。</p>
<h3 id="为什么要用防抖和节流？"><a href="#为什么要用防抖和节流？" class="headerlink" title="为什么要用防抖和节流？"></a>为什么要用防抖和节流？</h3><p>因为某些函数触发&#x2F;调用的频率过快，吾辈需要手动去限制其执行的频率。例如常见的监听滚动条的事件，如果没有防抖处理的话，并且，每次函数执行花费的时间超过了触发的间隔时间的话 – 页面就会卡顿。</p>
<h2 id="演进"><a href="#演进" class="headerlink" title="演进"></a>演进</h2><h3 id="初始实现"><a href="#初始实现" class="headerlink" title="初始实现"></a>初始实现</h3><p>我们先实现一个简单的去抖函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">delay, action</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> tId</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (tId) <span class="built_in">clearTimeout</span>(tId)</span><br><span class="line">    tId = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">action</span>(...args)</span><br><span class="line">    &#125;, delay)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 Promise 简单封装 setTimeout，下同</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">wait</span> = ms =&gt; <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, ms))</span><br><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> num = <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">add</span> = (<span class="params"></span>) =&gt; ++num</span><br><span class="line"></span><br><span class="line">  <span class="title function_">add</span>()</span><br><span class="line">  <span class="title function_">add</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(num) <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">debounce</span>(<span class="number">10</span>, add)</span><br><span class="line">  <span class="title function_">fn</span>()</span><br><span class="line">  <span class="title function_">fn</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(num) <span class="comment">// 2</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">20</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(num) <span class="comment">// 3</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>好了，看来基本的效果是实现了的。包装过的函数 <code>fn</code> 调用了两次，却并没有立刻执行，而是等待时间间隔过去之后才最终执行了一次。</p>
<h3 id="this-怎么办？"><a href="#this-怎么办？" class="headerlink" title="this 怎么办？"></a>this 怎么办？</h3><p>然而，上面的实现有一个致命的问题，没有处理 <code>this</code>！当你用在原生的事件处理时或许还不觉得，然而，当你使用了 ES6 <code>class</code> 这类对 <code>this</code> 敏感的代码时，就一定会遇到 <code>this</code> 带来的问题。</p>
<p>例如下面使用 <code>class</code> 来声明一个计数器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">i</span> = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">i</span>++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可能想在 <code>constructor</code> 中添加新的属性 <code>fn</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">i</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fn</span> = <span class="title function_">debounce</span>(<span class="number">10</span>, <span class="variable language_">this</span>.<span class="property">add</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">i</span>++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但很遗憾，这里的 <code>this</code> 绑定是有问题的，执行以下代码试试看</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> counter = <span class="keyword">new</span> <span class="title class_">Counter</span>()</span><br><span class="line">counter.<span class="title function_">fn</span>() <span class="comment">// Cannot read property &#x27;i&#x27; of undefined</span></span><br></pre></td></tr></table></figure>

<p>会抛出异常 <code>Cannot read property &#39;i&#39; of undefined</code>，究其原因就是 <code>this</code> 没有绑定，我们可以手动绑定 this <code>.bind(this)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">i</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fn</span> = <span class="title function_">debounce</span>(<span class="number">10</span>, <span class="variable language_">this</span>.<span class="property">add</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">i</span>++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但更好的方式是修改 <code>debounce</code>，使其能够自动绑定 <code>this</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">delay, action</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> tId</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (tId) <span class="built_in">clearTimeout</span>(tId)</span><br><span class="line">    tId = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      action.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">    &#125;, delay)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，代码将如同预期的运行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">i</span> = <span class="number">0</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">fn</span> = <span class="title function_">debounce</span>(<span class="number">10</span>, <span class="variable language_">this</span>.<span class="property">add</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">i</span>++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> counter = <span class="keyword">new</span> <span class="title class_">Counter</span>()</span><br><span class="line">  counter.<span class="title function_">add</span>()</span><br><span class="line">  counter.<span class="title function_">add</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="property">i</span>) <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">  counter.<span class="title function_">fn</span>()</span><br><span class="line">  counter.<span class="title function_">fn</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="property">i</span>) <span class="comment">// 2</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">20</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="property">i</span>) <span class="comment">// 3</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="返回值呢？"><a href="#返回值呢？" class="headerlink" title="返回值呢？"></a>返回值呢？</h3><p>不知道你有没有发现，现在使用 <code>debounce</code> 包装的函数都没有返回值，是完全只有副作用的函数。然而，吾辈还是遇到了需要返回值的场景。<br>例如：<em>输入停止后，使用 Ajax 请求后台数据判断是否已存在相同的数据。</em></p>
<p>修改 <code>debounce</code> 成会缓存上一次执行结果并且有初始结果参数的实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">delay, action, init = <span class="literal">undefined</span></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> flag</span><br><span class="line">  <span class="keyword">let</span> result = init</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (flag) <span class="built_in">clearTimeout</span>(flag)</span><br><span class="line">    flag = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      result = action.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">    &#125;, delay)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用代码变成了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">i</span> = <span class="number">0</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">fn</span> = <span class="title function_">debounce</span>(<span class="number">10</span>, <span class="variable language_">this</span>.<span class="property">add</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> ++<span class="variable language_">this</span>.<span class="property">i</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> counter = <span class="keyword">new</span> <span class="title class_">Counter</span>()</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="title function_">add</span>()) <span class="comment">// 1</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="title function_">add</span>()) <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="title function_">fn</span>()) <span class="comment">// 0</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="title function_">fn</span>()) <span class="comment">// 0</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">20</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="title function_">fn</span>()) <span class="comment">// 3</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>看起来很完美？然而，没有考虑到异步函数是个大失败！</p>
<p>尝试以下测试代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">get</span> = <span class="keyword">async</span> i =&gt; i</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">1</span>))</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">2</span>))</span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">debounce</span>(<span class="number">10</span>, get, <span class="number">0</span>)</span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">3</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i)) <span class="comment">// fn(...).then is not a function</span></span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">4</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i))</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">20</span>)</span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">5</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i))</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>会抛出异常 <code>fn(...).then is not a function</code>，因为我们包装过后的函数是同步的，第一次返回的值并不是 <code>Promise</code> 类型。</p>
<p>除非我们修改默认值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">get</span> = <span class="keyword">async</span> i =&gt; i</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">1</span>))</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">2</span>))</span><br><span class="line">  <span class="comment">// 注意，修改默认值为 Promise</span></span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">debounce</span>(<span class="number">10</span>, get, <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="title function_">resolve</span>(<span class="number">0</span>)))</span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">3</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i)) <span class="comment">// 0</span></span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">4</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i)) <span class="comment">// 0</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">20</span>)</span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">5</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i)) <span class="comment">// 4</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="支持有返回值的异步函数"><a href="#支持有返回值的异步函数" class="headerlink" title="支持有返回值的异步函数"></a>支持有返回值的异步函数</h3><p>支持异步有两种思路</p>
<ol>
<li>将异步函数包装为同步函数</li>
<li>将包装后的函数异步化</li>
</ol>
<p>第一种思路实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">delay, action, init = <span class="literal">undefined</span></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> flag</span><br><span class="line">  <span class="keyword">let</span> result = init</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (flag) <span class="built_in">clearTimeout</span>(flag)</span><br><span class="line">    flag = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> temp = action.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">      <span class="keyword">if</span> (temp <span class="keyword">instanceof</span> <span class="title class_">Promise</span>) &#123;</span><br><span class="line">        temp.<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> (result = res))</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = temp</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, delay)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用方式和同步函数完全一样，当然，是支持异步函数的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">get</span> = <span class="keyword">async</span> i =&gt; i</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">1</span>))</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">2</span>))</span><br><span class="line">  <span class="comment">// 注意，修改默认值为 Promise</span></span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">debounce</span>(<span class="number">10</span>, get, <span class="number">0</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">fn</span>(<span class="number">3</span>)) <span class="comment">// 0</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">fn</span>(<span class="number">4</span>)) <span class="comment">// 0</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">20</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">fn</span>(<span class="number">5</span>)) <span class="comment">// 4</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>第二种思路实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">debounce</span> = (<span class="params">delay, action, init = <span class="literal">undefined</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> flag</span><br><span class="line">  <span class="keyword">let</span> result = init</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (flag) <span class="built_in">clearTimeout</span>(flag)</span><br><span class="line">      flag = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        result = action.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">        <span class="title function_">resolve</span>(result)</span><br><span class="line">      &#125;, delay)</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(result)</span><br><span class="line">      &#125;, delay)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用方式支持异步的方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">get</span> = <span class="keyword">async</span> i =&gt; i</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">1</span>))</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">2</span>))</span><br><span class="line">  <span class="comment">// 注意，修改默认值为 Promise</span></span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">debounce</span>(<span class="number">10</span>, get, <span class="number">0</span>)</span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">3</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i)) <span class="comment">// 0</span></span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">4</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i)) <span class="comment">// 4</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">20</span>)</span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">5</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i)) <span class="comment">// 5</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>可以看到，第一种思路带来的问题是返回值永远会是 <strong>旧的</strong> 返回值，第二种思路主要问题是将同步函数也给包装成了异步。利弊权衡之下，吾辈觉得第二种思路更加正确一些，毕竟使用场景本身不太可能必须是同步的操作。而且，原本 <code>setTimeout</code> 也是异步的，只是不需要返回值的时候并未意识到这点。</p>
<h3 id="避免原函数信息丢失"><a href="#避免原函数信息丢失" class="headerlink" title="避免原函数信息丢失"></a>避免原函数信息丢失</h3><p>后来，有人提出了一个问题，如果函数上面携带其他信息，例如类似于 <code>jQuery</code> 的 <code>$</code>，既是一个函数，但也同时含有其他属性，如果使用 <code>debounce</code> 就找不到了呀</p>
<p>一开始吾辈立刻想到了复制函数上面的所有可遍历属性，然后想起了 ES6 的 <code>Proxy</code> 特性 – 这实在是太<strong>魔法</strong>了。使用 Proxy 解决这个问题将异常的简单 – 因为除了调用函数，其他的一切操作仍然指向原函数！</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">debounce</span> = (<span class="params">delay, action, init = <span class="literal">undefined</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> flag</span><br><span class="line">  <span class="keyword">let</span> result = init</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(action, &#123;</span><br><span class="line">    <span class="title function_">apply</span>(<span class="params">target, thisArg, args</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (flag) <span class="built_in">clearTimeout</span>(flag)</span><br><span class="line">        flag = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">resolve</span>((result = <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(target, thisArg, args)))</span><br><span class="line">        &#125;, delay)</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">resolve</span>(result)</span><br><span class="line">        &#125;, delay)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">get</span> = <span class="keyword">async</span> i =&gt; i</span><br><span class="line">  get.<span class="property">rx</span> = <span class="string">&#x27;rx&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(get.<span class="property">rx</span>) <span class="comment">// rx</span></span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">debounce</span>(<span class="number">10</span>, get, <span class="number">0</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(fn.<span class="property">rx</span>) <span class="comment">// rx</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="实现节流"><a href="#实现节流" class="headerlink" title="实现节流"></a>实现节流</h3><p>以这种思路实现一个节流函数 <code>throttle</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 函数节流</span></span><br><span class="line"><span class="comment"> * 节流 (throttle) 让一个函数不要执行的太频繁，减少执行过快的调用，叫节流</span></span><br><span class="line"><span class="comment"> * 类似于上面而又不同于上面的函数去抖, 包装后函数在上一次操作执行过去了最小间隔时间后会直接执行, 否则会忽略该次操作</span></span><br><span class="line"><span class="comment"> * 与上面函数去抖的明显区别在连续操作时会按照最小间隔时间循环执行操作, 而非仅执行最后一次操作</span></span><br><span class="line"><span class="comment"> * 注: 该函数第一次调用一定会执行，不需要担心第一次拿不到缓存值，后面的连续调用都会拿到上一次的缓存值</span></span><br><span class="line"><span class="comment"> * 注: 返回函数结果的高阶函数需要使用 &#123;<span class="doctag">@link</span> Proxy&#125; 实现，以避免原函数原型链上的信息丢失</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; delay 最小间隔时间，单位为 ms</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; action 真正需要执行的操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">Function</span>&#125; 包装后有节流功能的函数。该函数是异步的，与需要包装的函数 &#123;<span class="doctag">@link</span> action&#125; 是否异步没有太大关联</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">throttle</span> = (<span class="params">delay, action</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> result</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(action, &#123;</span><br><span class="line">    <span class="title function_">apply</span>(<span class="params">target, thisArg, args</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> curr = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">        <span class="keyword">if</span> (curr - last &gt; delay) &#123;</span><br><span class="line">          result = <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(target, thisArg, args)</span><br><span class="line">          last = curr</span><br><span class="line">          <span class="title function_">resolve</span>(result)</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">resolve</span>(result)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>嘛，实际上这里的防抖和节流仍然是简单的实现，其他的像 <strong>取消防抖</strong>&#x2F;<strong>强制刷新缓存</strong> 等功能尚未实现。当然，对于吾辈而言功能已然足够了，也被放到了公共的函数库 <a target="_blank" rel="noopener" href="https://rx-util.rxliuli.com/">rx-util</a> 中。</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/04/11/others/rxliuliBlog/JavaScript/layui-layer-load-%E5%BC%B9%E7%AA%97%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%E7%9A%84%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/11/others/rxliuliBlog/JavaScript/layui-layer-load-%E5%BC%B9%E7%AA%97%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%E7%9A%84%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">layui-layer load 弹窗自动关闭的问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-12 00:00:00" itemprop="dateCreated datePublished" datetime="2019-04-12T00:00:00+08:00">2019-04-12</time>
    </span>


  
    <span id="/2019/04/11/others/rxliuliBlog/JavaScript/layui-layer-load-%E5%BC%B9%E7%AA%97%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%E7%9A%84%E9%97%AE%E9%A2%98/" class="post-meta-item leancloud_visitors" data-flag-title="layui-layer load 弹窗自动关闭的问题" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="layui-layer load 弹窗自动关闭的问题" href="/2019/04/11/others/rxliuliBlog/JavaScript/layui-layer-load-%E5%BC%B9%E7%AA%97%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%E7%9A%84%E9%97%AE%E9%A2%98/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::7e4fe4f6bca0df2ea36504e8c1338ef0" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="layui-layer-load-弹窗自动关闭的问题"><a href="#layui-layer-load-弹窗自动关闭的问题" class="headerlink" title="layui-layer load 弹窗自动关闭的问题"></a>layui-layer load 弹窗自动关闭的问题</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>项目中的 Ajax 加载时的 loading 框有时候会关闭了弹窗之后很久页面上的数据才加载出来，而且这个问题是随机出现的，有些页面存在，有些页面则正常。</p>
<p>最小复现代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/rx-util@1.6.3/dist/rx-util.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/jquery@3.4.0/dist/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/layui-layer@1.0.9/dist/layer.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/**</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * 加载遮罩框</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       *</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * <span class="doctag">@returns</span> &#123;<span class="type">Function</span>&#125; 一个关闭遮罩框的函数</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">function</span> <span class="title function_">load</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> id = layer.<span class="title function_">load</span>(<span class="number">1</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">          layer.<span class="title function_">close</span>(id)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/**</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * 模拟 ajax 异步请求</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">time</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> close = <span class="title function_">load</span>()</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;request start: &#x27;</span>, time)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">await</span> rx.<span class="title function_">wait</span>(time)</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">close</span>()</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;request end: &#x27;</span>, time)</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      ;(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">request</span>(<span class="number">5000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第二个请求加载完成了&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">request</span>(<span class="number">1000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第一个请求加载完成了&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">      &#125;)()</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>控制台打印</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request start:  5000</span><br><span class="line">request start:  1000</span><br><span class="line">request end:  1000</span><br><span class="line">第一个请求加载完成了</span><br><span class="line">request end:  5000</span><br><span class="line">第二个请求加载完成了</span><br></pre></td></tr></table></figure>

<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>本来吾辈猜测是 vuejs 页面渲染的锅，认为 vuejs 的生命周期函数 <code>mouted</code> 执行时 DOM 还没加载完全的缘故。<br>所以把 <code>load</code> 异步化，等待 document 加载完毕才会真正执行。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/rx-util@1.6.3/dist/rx-util.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/jquery@3.4.0/dist/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/layui-layer@1.0.9/dist/layer.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/**</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * 加载遮罩框</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       *</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * <span class="doctag">@returns</span> &#123;<span class="type">Function</span>&#125; 一个关闭遮罩框的函数</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">load</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">await</span> rx.<span class="title function_">wait</span>(<span class="function">() =&gt;</span> <span class="variable language_">document</span>.<span class="property">readyState</span> === <span class="string">&#x27;complete&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> id = layer.<span class="title function_">load</span>(<span class="number">1</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="keyword">async</span> () =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">await</span> rx.<span class="title function_">wait</span>(<span class="function">() =&gt;</span> <span class="variable language_">document</span>.<span class="property">readyState</span> === <span class="string">&#x27;complete&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">          layer.<span class="title function_">close</span>(id)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/**</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * 模拟 ajax 异步请求</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">time</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> close = <span class="keyword">await</span> <span class="title function_">load</span>()</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;request start: &#x27;</span>, time)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">await</span> rx.<span class="title function_">wait</span>(time)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">await</span> <span class="title function_">close</span>()</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;request end: &#x27;</span>, time)</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      ;(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">request</span>(<span class="number">5000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第二个请求加载完成了&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">request</span>(<span class="number">1000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第一个请求加载完成了&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">      &#125;)()</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>控制台打印</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request start:  5000</span><br><span class="line">request start:  1000</span><br><span class="line">request end:  1000</span><br><span class="line">第一个请求加载完成了</span><br><span class="line">request end:  5000</span><br><span class="line">第二个请求加载完成了</span><br></pre></td></tr></table></figure>

<p>然而实际上却并不是这个问题。。。</p>
<p>经过某位网友提醒，layer 源码中默认只允许一个活动的 <code>load</code> 弹窗。瞬间吾辈都不知道要怎么吐槽了，单例模式避免无谓的内存浪费是正常的，然而新的 <code>load</code> 函数却会关闭之前的 <code>load</code> 这种操作真的是很厉害了呢</p>
<p>例如下面这段代码，无论调用多少次 <code>layer.close(id1)</code>，页面上的 <code>loading</code> 都不会关闭。。。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> id1 = layer.<span class="title function_">load</span>()</span><br><span class="line"><span class="keyword">const</span> id2 = layer.<span class="title function_">load</span>()</span><br><span class="line">layer.<span class="title function_">close</span>(id1)</span><br><span class="line">layer.<span class="title function_">close</span>(id1)</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">layer.<span class="title function_">close</span>(id1)</span><br><span class="line">layer.<span class="title function_">close</span>(id1)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里吾辈可以想象到，layer 认为先加载的 <code>load()</code> 就应该先被 <code>close()</code>，而没有考虑到复杂异步的情况。</p>
</blockquote>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>既然 layer 的 <code>load</code> 本身存在缺陷，那么却是只能自己对 <code>load</code> 和 <code>close</code> 功能做控制了<br>基本思路</p>
<ol>
<li><code>layer.load</code> 每次都会关闭掉之前的弹窗，那么就记录最后一次的弹窗 id，在真正需要关闭的时候 close 掉就好了</li>
<li><code>layer.load</code> 关闭是直接关闭弹窗，如果是最后一个就会出现弹窗消失但数据没加载完全的问题，那么关闭这儿要判断当前是否还有活动的弹窗，只有在没有的情况下才真正关闭</li>
</ol>
<p>修改后的代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/rx-util@1.6.3/dist/rx-util.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/jquery@3.4.0/dist/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/layui-layer@1.0.9/dist/layer.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/**</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * 加载遮罩框</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       *</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * <span class="doctag">@returns</span> &#123;<span class="type">Function</span>&#125; 一个关闭遮罩框的函数</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> load = (<span class="function">(<span class="params">num, lastId</span>) =&gt;</span> <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        lastId = layer.<span class="title function_">load</span>(<span class="number">1</span>)</span></span><br><span class="line"><span class="language-javascript">        num++</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">          num--</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">if</span> (num &lt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            num = <span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">          &#125;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">if</span> (num &gt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;弹窗没有真正关闭哦&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span></span></span><br><span class="line"><span class="language-javascript">          &#125;</span></span><br><span class="line"><span class="language-javascript">          layer.<span class="title function_">close</span>(lastId)</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;弹窗真的关闭啦&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;)(<span class="number">0</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/**</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * 模拟 ajax 异步请求</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">time</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> close = <span class="keyword">await</span> <span class="title function_">load</span>()</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;request start: &#x27;</span>, time)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">await</span> rx.<span class="title function_">wait</span>(time)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">await</span> <span class="title function_">close</span>()</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;request end: &#x27;</span>, time)</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      ;(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">request</span>(<span class="number">5000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第二个请求加载完成了&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">request</span>(<span class="number">1000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第一个请求加载完成了&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">      &#125;)()</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>控制台打印</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">request start:  5000</span><br><span class="line">request start:  1000</span><br><span class="line">弹窗没有真正关闭哦</span><br><span class="line">request end:  1000</span><br><span class="line">第一个请求加载完成了</span><br><span class="line">弹窗真的关闭啦</span><br><span class="line">request end:  5000</span><br><span class="line">第二个请求加载完成了</span><br></pre></td></tr></table></figure>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/04/09/others/rxliuliBlog/Java/%E4%BD%BF%E7%94%A8-GitHub-%E4%BD%9C%E4%B8%BA-Maven-%E4%BB%93%E5%BA%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/09/others/rxliuliBlog/Java/%E4%BD%BF%E7%94%A8-GitHub-%E4%BD%9C%E4%B8%BA-Maven-%E4%BB%93%E5%BA%93/" class="post-title-link" itemprop="url">使用 GitHub 作为 Maven 仓库</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-09 21:13:07" itemprop="dateCreated datePublished" datetime="2019-04-09T21:13:07+08:00">2019-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-04-10 00:00:00" itemprop="dateModified" datetime="2019-04-10T00:00:00+08:00">2019-04-10</time>
    </span>


  
    <span id="/2019/04/09/others/rxliuliBlog/Java/%E4%BD%BF%E7%94%A8-GitHub-%E4%BD%9C%E4%B8%BA-Maven-%E4%BB%93%E5%BA%93/" class="post-meta-item leancloud_visitors" data-flag-title="使用 GitHub 作为 Maven 仓库" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="使用 GitHub 作为 Maven 仓库" href="/2019/04/09/others/rxliuliBlog/Java/%E4%BD%BF%E7%94%A8-GitHub-%E4%BD%9C%E4%B8%BA-Maven-%E4%BB%93%E5%BA%93/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::e9e4321087f05e2d0a6e0c2f30a552b9" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="使用-GitHub-作为-Maven-仓库"><a href="#使用-GitHub-作为-Maven-仓库" class="headerlink" title="使用 GitHub 作为 Maven 仓库"></a>使用 GitHub 作为 Maven 仓库</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/rxliuli/maven-repository-example">GitHub 示例</a></p>
</blockquote>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>吾辈在日常工具中也有一些公共的代码库，一直想分离成单独的类库却没有机会，看到使用 github 就能部署 maven 仓库就尝试了一下。</p>
<blockquote>
<p>这里吐槽一下 maven 中央仓库的发布流程，不知道为什么不能像 npm 一样一个简单的命令就能发布多好！</p>
</blockquote>
<h2 id="创建一个-maven-项目上传到-github"><a href="#创建一个-maven-项目上传到-github" class="headerlink" title="创建一个 maven 项目上传到 github"></a>创建一个 maven 项目上传到 github</h2><p>这是初始的 <code>pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pom.xml --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 项目的组织名，如果没有域名或组织的话就是用 com.github.[你的用户名] --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rxliuli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 项目的名字 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-repository-example<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 版本号，默认是 1.0-SNAPSHOT --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加一个忽略配置 <em>.gitignore</em> 就可以上传到 GitHub 了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">target/</span><br><span class="line">pom.xml.tag</span><br><span class="line">pom.xml.releaseBackup</span><br><span class="line">pom.xml.versionsBackup</span><br><span class="line">pom.xml.next</span><br><span class="line">release.properties</span><br><span class="line">dependency-reduced-pom.xml</span><br><span class="line">buildNumber.properties</span><br><span class="line">.mvn/timing.properties</span><br><span class="line">.mvn/wrapper/maven-wrapper.jar</span><br><span class="line"></span><br><span class="line"># 忽略 IDEA 配置文件</span><br><span class="line">*.iml</span><br><span class="line">.idea/</span><br><span class="line">rebel.xml</span><br></pre></td></tr></table></figure>

<h2 id="修改-maven-deploy-plugin-插件"><a href="#修改-maven-deploy-plugin-插件" class="headerlink" title="修改 maven-deploy-plugin 插件"></a>修改 <code>maven-deploy-plugin</code> 插件</h2><p>主要是设置部署目录</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 其他内容。。。 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-deploy-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--设置部署目录--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">altDeploymentRepository</span>&gt;</span></span><br><span class="line">          internal.repo::default::file://$&#123;project.build.directory&#125;/mvn-repo</span><br><span class="line">        <span class="tag">&lt;/<span class="name">altDeploymentRepository</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 其他内容。。。 --&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="在-settings-xml-中添加-github-用户信息"><a href="#在-settings-xml-中添加-github-用户信息" class="headerlink" title="在 settings.xml 中添加 github 用户信息"></a>在 settings.xml 中添加 github 用户信息</h2><p>找到 maven 用户配置文件，默认位置在 _~&#x2F;.m2&#x2F;settings.xml_。如果不存在，则从 maven 安装目录复制一份过来，具体位置在 _MAVEN_HOME&#x2F;conf&#x2F;settings.xml_。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 其他内容。。。 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- id，这只是一个标识名，根据它找到用户名和密码 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>github<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- github 用户名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">username</span>&gt;</span>rxliuli<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- github 密码 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 其他内容。。。 --&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="添加插件-com-github-github"><a href="#添加插件-com-github-github" class="headerlink" title="添加插件 com.github.github"></a>添加插件 com.github.github</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 其他内容。。。 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 设置 github 服务器使用的配置，在 ~/.m2/settings.xml 中定义 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">github.global.server</span>&gt;</span>github<span class="tag">&lt;/<span class="name">github.global.server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.github<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>site-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        这里需要使用 0.12, 0.9 部署时会出错，具体查看</span></span><br><span class="line"><span class="comment">        https://github.com/github/maven-plugins/issues/105</span></span><br><span class="line"><span class="comment">      --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--git 提交的消息--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">message</span>&gt;</span>Maven artifacts for $&#123;project.version&#125;<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--禁用网页处理--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">noJekyll</span>&gt;</span>true<span class="tag">&lt;/<span class="name">noJekyll</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--部署的目录，这里是和上面的 maven-deploy-plugin 的 configuration.altDeploymentRepository 对应--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>$&#123;project.build.directory&#125;/mvn-repo</span><br><span class="line">        <span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span> <span class="comment">&lt;!-- matches distribution management repository url above --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--远程分支名--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">branch</span>&gt;</span>refs/heads/mvn-repo<span class="tag">&lt;/<span class="name">branch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/*<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--github 仓库的名字--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repositoryName</span>&gt;</span>maven-repository-example<span class="tag">&lt;/<span class="name">repositoryName</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--github 用户名--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repositoryOwner</span>&gt;</span>rxliuli<span class="tag">&lt;/<span class="name">repositoryOwner</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--suppress MybatisMapperXmlInspection --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>site<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">phase</span>&gt;</span>deploy<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 其他内容。。。 --&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="进行部署"><a href="#进行部署" class="headerlink" title="进行部署"></a>进行部署</h2><p>使用命令进行部署</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean deploy</span><br></pre></td></tr></table></figure>

<p>查看 github 项目库，可以看到已经自动创建了一个分支 <code>mvn-repo</code> 并存放了部署后的文件。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>添加仓库地址</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-repository-example<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 格式是 https://raw.githubusercontent.com/[github 用户名]/[github 仓库名]/[分支名]/repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">      https://raw.githubusercontent.com/rxliuli/maven-repository-example/mvn-repo/repository</span><br><span class="line">    <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>就像其他 maven 仓库一样，我们知道 <code>groupId</code>, <code>artifactId</code> 与 <code>version</code>，自然可以直接使用啦</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rxliuli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-repository-example<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注: 这种使用 github 部署的 maven 仓库，在 <a target="_blank" rel="noopener" href="https://mvnrepository.com/">maven 中央仓库</a> 中并不能搜索到的哦</p>
</blockquote>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/04/07/others/rxliuliBlog/Essay/%E7%A8%8B%E5%BA%8F%E5%91%98%E5%AF%B9-996-%E7%9A%84%E5%8F%8D%E6%8A%97%E5%BC%95%E6%9D%A5%E5%85%A8%E7%90%83%E5%85%B3%E6%B3%A8%EF%BC%8C%E5%AE%83%E6%98%AF%E5%A6%82%E4%BD%95%E4%BB%A5%E7%A8%8B%E5%BA%8F%E5%91%98%E8%87%AA%E5%B7%B1%E7%9A%84%E6%96%B9%E5%BC%8F%E5%BB%BA%E7%AB%8B%E8%B5%B7%E6%9D%A5%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/07/others/rxliuliBlog/Essay/%E7%A8%8B%E5%BA%8F%E5%91%98%E5%AF%B9-996-%E7%9A%84%E5%8F%8D%E6%8A%97%E5%BC%95%E6%9D%A5%E5%85%A8%E7%90%83%E5%85%B3%E6%B3%A8%EF%BC%8C%E5%AE%83%E6%98%AF%E5%A6%82%E4%BD%95%E4%BB%A5%E7%A8%8B%E5%BA%8F%E5%91%98%E8%87%AA%E5%B7%B1%E7%9A%84%E6%96%B9%E5%BC%8F%E5%BB%BA%E7%AB%8B%E8%B5%B7%E6%9D%A5%EF%BC%9F/" class="post-title-link" itemprop="url">程序员对 996 的反抗引来全球关注，它是如何以程序员自己的方式建立起来？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-07 20:51:04" itemprop="dateCreated datePublished" datetime="2019-04-07T20:51:04+08:00">2019-04-07</time>
    </span>


  
    <span id="/2019/04/07/others/rxliuliBlog/Essay/%E7%A8%8B%E5%BA%8F%E5%91%98%E5%AF%B9-996-%E7%9A%84%E5%8F%8D%E6%8A%97%E5%BC%95%E6%9D%A5%E5%85%A8%E7%90%83%E5%85%B3%E6%B3%A8%EF%BC%8C%E5%AE%83%E6%98%AF%E5%A6%82%E4%BD%95%E4%BB%A5%E7%A8%8B%E5%BA%8F%E5%91%98%E8%87%AA%E5%B7%B1%E7%9A%84%E6%96%B9%E5%BC%8F%E5%BB%BA%E7%AB%8B%E8%B5%B7%E6%9D%A5%EF%BC%9F/" class="post-meta-item leancloud_visitors" data-flag-title="程序员对 996 的反抗引来全球关注，它是如何以程序员自己的方式建立起来？" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="程序员对 996 的反抗引来全球关注，它是如何以程序员自己的方式建立起来？" href="/2019/04/07/others/rxliuliBlog/Essay/%E7%A8%8B%E5%BA%8F%E5%91%98%E5%AF%B9-996-%E7%9A%84%E5%8F%8D%E6%8A%97%E5%BC%95%E6%9D%A5%E5%85%A8%E7%90%83%E5%85%B3%E6%B3%A8%EF%BC%8C%E5%AE%83%E6%98%AF%E5%A6%82%E4%BD%95%E4%BB%A5%E7%A8%8B%E5%BA%8F%E5%91%98%E8%87%AA%E5%B7%B1%E7%9A%84%E6%96%B9%E5%BC%8F%E5%BB%BA%E7%AB%8B%E8%B5%B7%E6%9D%A5%EF%BC%9F/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::05d887f8a920c052aa7366169abb7570" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="程序员对-996-的反抗引来全球关注，它是如何以程序员自己的方式建立起来？"><a href="#程序员对-996-的反抗引来全球关注，它是如何以程序员自己的方式建立起来？" class="headerlink" title="程序员对 996 的反抗引来全球关注，它是如何以程序员自己的方式建立起来？"></a>程序员对 996 的反抗引来全球关注，它是如何以程序员自己的方式建立起来？</h1><blockquote>
<p>转自: <a target="_blank" rel="noopener" href="https://m.douban.com/note/712945658/?dt_dapp=1">https://m.douban.com/note/712945658/?dt_dapp=1</a>，原文应该来自 <a target="_blank" rel="noopener" href="https://www.qdaily.com/">好奇心日报</a>，但目前已被删除。<br>国内的各大互联网公司争相屏蔽 <a target="_blank" rel="noopener" href="https://996.icu/">996.ICU</a> 及其 <a target="_blank" rel="noopener" href="https://github.com/996icu/996.ICU">GitHub</a>，甚至在 <a target="_blank" rel="noopener" href="https://github.com/996icu/996.ICU/issues">GitHub Issues</a> 大肆雇佣水军发布乱七八糟的东西导致 Issues 被关闭。<br>包括百度上无法搜索到官网，中文搜索结果中甚至搜索不到 GitHub。QQ&#x2F;360&#x2F;百度&#x2F;UC 这些常见的国内浏览器直接添加本地规则禁止访问，但 Chrome&#x2F;Firefox 则安然无恙（所以真的无法理解程序员为什么会用 360？）</p>
</blockquote>
<p>一场关于劳工权益的抗议在过去一周里爆发，让中国互联网公司习惯的 996（早九点、晚九点、一周六天）加班时间成为中国乃至全球关注的焦点。</p>
<p>有程序员发起了一个抵制 996 工作制的项目 <a target="_blank" rel="noopener" href="https://996.icu/">996.ICU</a>。讨论从技术社区开始，在互联网公司的微信群流传开来，蔓延到豆瓣、知乎，很快上了微博热搜，在百度的搜索热度达到平日的十倍。《中国青年报》、《南方日报》的报道被项目发起人标注进了项目的说明页面。</p>
<p>一周下来，事件的影响在海外逐渐升温。最早跟进报道的英文媒体是关注中国的《南华早报》，它在 3 月 29 日对此事的报道被 Python 之父 <a target="_blank" rel="noopener" href="https://twitter.com/gvanrossum">Guido van Rossum</a> 转发并附上一句评论：“<strong>996 工作制是不人道的。</strong>”</p>
<p>全球程序员聚集讨论区 Hacker News 和相应 Reddit 论坛，996 也成了一个热门话题。The Verge、Financial Times 分别在 4 月 2 日和 4 月 3 日跟进，《连线》等媒体也已经在采访参与者。</p>
<p>和前两年以悲剧方式获得全球关注的中国制造业从业者不同，程序员看起来是最不容易为工作环境走向对抗的一个群体。外界对他们的印象主要是收入高、习惯天天加班、办公室放着行军床、生活简单就想着买房结婚。一个典型的中产阶级行业，而中产阶级往往被认为是革命中重要但同时也是阻力最大的阶层。</p>
<p>但不同于其它也要日常加班，强度更大收入更少的行业，程序员有一个说话的渠道。</p>
<h2 id="1"><a href="#1" class="headerlink" title="1"></a>1</h2><p>996.icu 网站的域名最早由一个年轻的程序员注册。</p>
<p>在技术论坛 V2EX 上，这位用户曾在一个关于工作薪酬讨论的帖子里提到自己毕业于北京一所 211 大学，在一家与百度、阿里、腾讯同级的大型互联网公司工作，刚转正没多久，每月薪酬在一万多元。</p>
<p>之前，他都在论坛里发帖讨论技术，讨论同一个公司不同的团队之间为什么薪资会有差别。但最近，他所在的公司开始实行 996 工作制。</p>
<p>3 月 20 日，他在论坛的域名推广版宣布注册了一个域名 <a target="_blank" rel="noopener" href="http://996.icu/">http://996.icu</a>，口号是：“工作 996，生病 ICU。”</p>
<p>3 月 26 日后，他在一个职场话题下回复道：“我才感到 996 多么毁人，除了工作就是休息，跟家人沟通都少了。”在那个回帖里，他再次推荐了 996.ICU 网站。</p>
<p><a target="_blank" rel="noopener" href="http://996.icu/">996.ICU</a> 就是一个网站，自上而下分成 996 介绍、十七条劳动权益相关法规和相关事件报道三个部分。这三部分自第一天就在，虽然内容在过去一周日渐丰富起来。</p>
<p><a target="_blank" rel="noopener" href="http://996.icu/"><img src="https://img.rxliuli.com/20190407205931.png" alt="996 icu"></a></p>
<p>网站作者还在介绍后面加上了一句“Developers’ Lives Matter”（开发者的命也是命），模仿美国对抗种族不平等运动的“Black Lives Matter”（黑人的命也是命）。</p>
<p>它的影响力并不来自这个网页。而是来自同样在 3 月 26 日上线的 <a target="_blank" rel="noopener" href="https://github.com/996icu/996.ICU">GitHub</a> 项目。</p>
<p>项目由一个叫 996icu 的匿名 ID 发起，和域名持有者的关系不得而知。但从每天对最多 260 个建议的快速处理来看，这个账号即便是那位年轻程序员创建，现在很可能也不是他一个人在用。</p>
<p>今天，软件开发已经不需要凡事都重新发明一个轮子，用开源的代码可以快速完成一个功能。</p>
<p>而 GitHub 就是存放这些代码的最大平台。程序员们在 GitHub 上管理自己的项目，发起讨论、提交修改建议。</p>
<p>目前 GitHub 有<a target="_blank" rel="noopener" href="http://www.sohu.com/a/276484595_671058">三千万程序员用户</a>，托管了大约 8000 万个代码仓库，平均每秒创建的存储库就有 1.6 个。2018 年，<a target="_blank" rel="noopener" href="https://techcrunch.com/2012/07/14/what-exactly-is-github-anyway/">微软宣布 75 亿美元收购 GitHub</a>。</p>
<p>GitHub 上之前也有关于中国互联网公司加班问题的项目，两个月前一个主题是 <a target="_blank" rel="noopener" href="https://github.com/shengxinjing/programmer-job-blacklist">“程序员找工作黑名单”</a> 的项目上线，这个黑名单在两个月内获得了超过 18000 次“加星点赞”（Star）。</p>
<p>但这看起来更像是程序员在找工作时的一份操作指南。而 996.ICU 则更直接、更简单，从一开始就是一份反 996 工作制的宣言。</p>
<p>这让它迅速引起共鸣。</p>
<p>996 一直没有好名声。最早可以追溯到 <a target="_blank" rel="noopener" href="http://it.sohu.com/20140405/n397797427.shtml">2014 阿里巴巴怀孕员工加班回家后大出血去世</a> 的新闻报道。2016 年，<a target="_blank" rel="noopener" href="http://finance.cnr.cn/gs/20160901/t20160901_523105136.shtml">58 同城就因为对 2 万多员工强制 996</a> 遭到不少抵制。</p>
<p>今年 1 月，<a target="_blank" rel="noopener" href="http://www.linkshop.com.cn/web/archives/2019/418163.shtml">杭州有赞 CEO</a> 在公司年会上突然宣布全公司强制执行 996，有赞高管表示如果工作家庭不好平衡，可以选择离婚。</p>
<p>更近的，京东 3 月初开始执行 995 工作制度。面对质疑，<a target="_blank" rel="noopener" href="http://tech.163.com/19/0312/13/EA2QGIOK00097U7R.html">京东公关总监刘力回应不会强制要求，但鼓励员工全情投入</a>。</p>
<p>中国互联网公司加班不被认为是特例，但以往有高回报盼头。2017 年，软件业平均薪资 13.3 万，连续两年超过金融业成为全国最赚钱的行业。阿里巴巴纽交所挂牌上市，一夜之间产生了 1 万多名千万富翁。</p>
<p>2018 年开始的上市潮没能重现另一个阿里巴巴。小米 2014 年估值达到 450 亿美元，2018 年上市前预期公司市值能有 800 - 1000 亿美元，四年老员工手中股票价值有望翻倍。但等到 2019 年年初员工可以卖股票的时候，小米市值缩水至 315 亿美元，股票价值也比 2014 年缩水 30%。</p>
<p>而小米已经是过去一年上市公司里表现很好的。<a target="_blank" rel="noopener" href="https://www.jiemian.com/article/2703824.html">蘑菇街直接以稀释员工股权的手段将员工持股价值缩水为 1&#x2F;25</a>。蘑菇街挂牌价为 14 美元，1 万股理应价值 96.6 万元，但稀释 25 倍后只有 4 万元。</p>
<p>甚至工作也不一定能保证。互联网行业早几年处于风口，大量风险投资涌入。创业公司不在乎利润，可以开更高薪水来挖人。</p>
<p>但现在形势变了。2018 年，中国 VC&#x2F;PE 募资规模 341.12 亿美元，<a target="_blank" rel="noopener" href="https://36kr.com/p/5150552">同比骤降 74.59%</a>。靠烧钱做大规模的互联网公司上市后也面对盈利问题。缺乏资金来源，为了减少亏损，裁员成为一个普遍的做法。</p>
<p>去年 8 月，美图、拉勾网各裁员 20%。10 月，锤子科技解散成都分公司，为它从北京搬去成都的程序员也失去工作。11 月，趣店裁员 200 人，不从北京搬去杭州也得走，同月斗鱼裁员 70 人。12 月，知乎裁员 20%，300 人被要求当天离开公司；科大讯飞裁员 20%，回应为末位淘汰；摩拜裁员 30%，称为正常调整。今年 2 月，滴滴裁员 15%，2000 人离职；京东先裁员 20% 员工，2 月又裁员 10% 副总裁级别高管。3 月，腾讯中层裁去 20%，<a target="_blank" rel="noopener" href="http://m.kanshangjie.com/Index/Show?id=161549">腾讯总裁刘炽平称</a> 为年轻化主动革新。</p>
<p>高强度的工作变得强度更高、曾经可以指望的上市故事愈加渺茫，甚至能工作多少年也在大裁员背景下变得难以确定。</p>
<p>在这样的背景之下，996.ICU 项目上线一小时内就收获了超过 2000 颗星星，一天内加星数超过一万，登上了 GitHub 实时热门榜。</p>
<p>更多人注意到了。</p>
<h2 id="2"><a href="#2" class="headerlink" title="2"></a>2</h2><p>Anony 就是在 3 月 26 日 996.ICU 上线一小时的时候开始关注的。他自称是一个普通的码农，平时喜欢逛 GitHub。他说自己平时逛 GitHub 就“类似于你们刷微博”。</p>
<p>尽管 Anony 所在公司没有实行 996 工作制，他还是持续对这个项目的进展保持关注，也参与了修改措辞的工作。</p>
<p>在 996.ICU 的讨论区（Issues 区）里，加星即将破十万前，有人留言说，没想到以这种方式参与了大型开源项目。</p>
<p>在社交网络上人们分享自己关于 996 工作的经历、见解以及解决方案。但在程序员社区里，一切都按照程序员们开发开源软件的方式推进着。</p>
<p>想象一栋充满无数会议室的大楼，每间会议室里的白板上写着一项软件的所有代码。GitHub 可以让程序员走入其中开放的会议室，观看白板上的代码（Watch），点赞（Star），并按自己的想法进行修改。</p>
<p>但随意修改会扰乱白板上的代码，Github 方便用户将白板上的代码库整体复制到自己账户下，修改不影响项目代码。修改完成后，程序员可以提交“拉回请求”（Pull Request）给项目维护者进行合并，将自己的修改加入项目。</p>
<p>这是目前开源软件在线协作的工作方法，而 996.ICU 的进化过程完全遵照此方法进行。</p>
<p>GitHub 上最初的 996.ICU 项目很简单：一段 26 行的 Markdown 格式网页文档。</p>
<p>一段段劳动法摘录、五一国际劳动节的由来、国际歌歌词、英文版本是最早的一批更新。</p>
<p>996.ICU 项目的补充、完善，都是由参与者以提交“拉回”请求的方式推进，逐渐成为今天的样子。</p>
<p>这和在论坛留言不一样，如果一个人看到代码就产生不适感，那就无法在这里提出修改请求。</p>
<p>各种细节被快速完善。有人提交请求，称主页面上的案例之一京东的英文版本如果直译 JINGDONG 无法让外国投资者理解，要改成 <a href="jd.com">JD.COM</a>。</p>
<p>大小写、空格、错误链接、全角半角符号错用等问题都被更新，放进 Markdown 格式的文档里，还有人上传了自制的 Logo。</p>
<p>法语、德语、意大利语、日语、韩语、葡萄牙语、巴西葡萄牙语、泰语、繁体中文、越南语、俄语、希腊语等主要语言版本翻译都在项目上线第二天提交。还有人写了<a target="_blank" rel="noopener" href="https://github.com/996icu/996.ICU/pull/16430/files%E3%80%81">颇正式的文言文版本</a>：“996”事制，即日早九至岗，直至晚九点事，每周工作六日。2016 年九初起，续有网爆料称，58 同城行全员 996 事制，且周末加班无文……</p>
<p>3 月 28 日是进展飞快第一天，项目有了两个关联项目：<a target="_blank" rel="noopener" href="https://github.com/fengT-T/996_list">996 公司黑名单</a> 和 <a target="_blank" rel="noopener" href="https://github.com/formulahendry/955.WLB">955 公司白名单</a>。</p>
<p>黑名单上都是实行了 996 或过度加班的公司，国内的大互联网公司基本在列，京东以超过 1200 票遥遥领先。作者还提出建议，希望在提名的时候加上部门、省区、工资范围，总之给出的信息越详细越好。</p>
<p>黑名单的作者原先将投票设置在一个论坛上，并没有考虑到会有那么多人参与投票，以至于网站太卡，人们只关注到了排名在前面的大公司。目前，这位作者正在建设新的网站，他在项目说明里写道：“因为太卡大家都只关注到了前面的大公司，希望大家能够注意到 996 的群体实际上很大，不仅仅有 BAT ，还有很多小公司。”</p>
<p>而白名单上的公司更多是外企。</p>
<p>955 公司白名单作者 formulahendry 在上海一家大外企做程序员，他的 GitHub 页面有超过 600 个关注者，还坚持用英文写过一段时间技术博客。</p>
<p>像几乎所有外企一样，formulahendry 并不需要 996。他对《好奇心日报》称，996 就完全没有个人的生活时间，最近这个现象越来越普遍，并不是一个好的趋势，他反对 996 的理由与许多人类似：比起一周工作 40 小时，一周工作 72 小时的 996 单位时间的产出不高。</p>
<p>注意到 996.ICU 之后，他觉得与其吐槽 996，不如看看有哪些公司实行 955（一周工作五天，朝九晚五） 的公司。</p>
<p>项目上线第二天，他创建白名单投票，项目的名字 WLB 是他自创的缩写，意思是 Work Life balance，即生活与工作的平衡。WLB 一天内加星数超过了 1000，上线第二天上了 GitHub 实时热门榜。</p>
<p>投票的雏形是基于 formulahendry 对上海 IT 公司的了解，在接下来的几天里，他利用下班在班车上的时间以及周末的时间维护着项目更新。</p>
<p>虽然 formulahendry 建了白名单，但是项目被创建出来之后就不再是他一个人能决定的事：一切都得按照 GitHub 的方式来。</p>
<p>996 公司黑名单则吸引了更多的参与：一个公司被添加到黑名单的方式与开源项目代码审核没什么太大区别，每个人都可以提交论据，只是提交论据的方式对非程序员来说有一定门槛。论据包括媒体报道、知乎讨论、公司官网公告等。</p>
<p>华为 和 <a target="_blank" rel="noopener" href="https://github.com/formulahendry/955.WLB">字节跳动等公司</a> 是否能够上榜都引发了众多讨论。在要求“删除黑名单字节跳动”的请求下有 51 组对话，要求删除的人和不同意删除的人各自举证。</p>
<p>发起删除请求的用户给出了两点理由：</p>
<ol>
<li>公司虽然下班晚，上班也晚，算上午饭、晚饭后的休息时间，实际工作时长并没有一天 12 小时；公司实行大小周，但是小周周日加班给加班费；</li>
<li>猝死事件的程序员是刚从腾讯跳槽到字节跳动不久，不能武断归咎于字节跳动加班。</li>
</ol>
<p>反驳方指出“说的好像 955 的公司不午休不吃饭一样。”接着还有反驳者给出加班费计算方法的猫腻，比如周日加班按 1.2 倍工资而不是 2 倍工资计算。</p>
<p>一个请求能否通过，实际上是以一种简单的投票实现的。删除字节跳动的请求有 8 人支持，269 人反对。最后 996.ICU 项目负责人拒绝了删除字节跳动的请求。</p>
<p>虽然项目负责账号可以对请求作出判断，但由于开源项目的可复制性，如果项目发起人背离社区大多数人的诉求，程序员们可以很容易转而支持另一个在这个基础上分出来的项目。</p>
<p>从一个个人项目，演变为社区项目之后，决定项目发展的就不再是发起人，而是所有参与贡献的人共同决定的结果。这些都是开源软件开发的基本方式。</p>
<p>就像比如 Linux 系统最早是 Linus 一个人的作品。但随着全球开发者的加入，有 1.5 万开发者和超过 1400 家公司添砖加瓦。现在 Linux 远不是 Linus 所能控制的，它的管理由一个专门的基金会所负责。</p>
<p>996.ICU 也没什么区别。不论是谁启动了这个项目，现在它已经不再是一个人决定的事。</p>
<h2 id="3"><a href="#3" class="headerlink" title="3"></a>3</h2><p>讨论变得敏感，是从 3 月 29 日项目的 issues 被关闭开始。</p>
<p>仓库下的讨论区（Issues）突然被关闭，也引发了不少讨论，比如 issues 太多（过了十万）、太多广告，还有人贴出白宫请愿的号召截图怀疑是政治原因。几小时后，作者贴出解释称是主动选择关闭。</p>
<p>不过这对讨论没有太大影响。项目上线之初，有人发出各地微信群的二维码，与此同时就有人回应说程序员应该用程序员的工具，而不是用 QQ、微信来沟通。于是程序员常用的即时通信工具 Slack、游戏即时通信工具 Discord 都被用起来、国内不能直接访问的通讯工具 Telegram 上也出现了 996.ICU 讨论组。</p>
<p>996.ICU 的 Slack 讨论频道在五天内吸引了 1000 多名成员，成员自发将 Slack 群组划分成了公告、招聘、讨论、中文、英文、城市等数个频道。在 Slack 频道里讨论最多的，是劳动权益受到侵害之后如何维权。</p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/317847010/answer/636013957">一名拥有二十年经验的程序员陈皓</a> 在知乎回答了问题：“如果想抵制 996，除了利用 GitHub 发起抗议，还有哪些巧妙的方案？”，提出通过法律手段、政府信访、集体抗议等途径。</p>
<p>在 Slack 群组讨论中，他的解决方案遇到了不少阻力，一些成员质疑劳动仲裁的效率，还有一些成员则担忧信访手段可能招致政府机关的强制手段。</p>
<p>在完善了措辞、不同语言版本和黑名单、白名单之后。996.ICU 从上周末开始的最大进展是“反 996 软件授权协议”从想法到落地。</p>
<p>3 月 27 日，<a target="_blank" rel="noopener" href="https://github.com/996icu/996.ICU/pull/15642">一个想法被热切讨论后采用</a>：设计一种关于劳动保护的软件授权协议——996ICU 协议，如果这个协议被兼容进各个开源项目的授权协议，实行 996 工作制的公司不得使用该开源项目，就可能给公司带来实际的约束作用。</p>
<p>劳动法一直在，但执行是问题。大互联网公司往往为一个城市解决数万就业，有些还提供数十甚至上百亿利税。理论上地方法院，比如深圳当地法院应该公平对待腾讯、华为和它们的员工，但这是理论上。</p>
<p>而软件授权协议是软件行业内的一个约束。简单来说，软件授权协议就像是一本书的版权声明。在项目开发中开源软件的使用不可避免，使用开源软软件不需要付费，但是需要遵守作者写在授权协议中的条款，如果公司或个人使用了开源代码，但是没有遵守条款，作者可以据此提起诉讼，要求赔偿、停止使用代码。</p>
<p>这个想法被上千人点赞，400 多人参与了该协议的讨论。</p>
<p>但协议怎么写还没人想好，一开始只有这样三行：</p>
<p>The 996ICU License (996ICU)Copyright © 2019 3 月 30 日晚间，伊利诺伊大学厄巴纳 - 香槟分校法学博士 Katt Gu 花了一夜时间起草了授权协议。这个版本在常用的 <a target="_blank" rel="noopener" href="https://github.com/kattgu7/Anti-996-License/wiki">MIT 开源授权协议基础之上</a> 改编。协议一共三条，在所有协议都会有的惯例版权声明条款，Katt Gu 增加了两条内容：</p>
<ul>
<li><p>个人或法人实体必须严格遵守与个人实际所在地或个人出生地或归化地、或法人实体注册地或经营地（以较严格者为准）的司法管辖区所有适用的与劳动和就业相关法律、法规、规则和标准。如果该司法管辖区没有此类法律、法规、规章和标准或其法律、法规、规章和标准不可执行，则个人或法人实体必须遵守国际劳工标准的核心公约。</p>
</li>
<li><p>个人或法人不得以任何方式诱导或强迫其全职或兼职员工或其独立承包人以口头或书面形式同意直接或间接限制、削弱或放弃其所拥有的，受相关与劳动和就业有关的法律、法规、规则和标准保护的权利或补救措施，无论该等书面或口头协议是否被该司法管辖区的法律所承认，该等个人或法人实体也不得以任何方法限制其雇员或独立承包人向版权持有人或监督许可证合规情况的有关当局报告或投诉上述违反许可证的行为的权利。</p>
</li>
</ul>
<p>Katt Gu 关注新技术立法，也著有关于 <a target="_blank" rel="noopener" href="https://scholar.google.com/citations?user=PTcpQwcAAAAJ&hl=en&oi=ao">中国特定领域法律与实践鸿沟</a> 的论文。</p>
<p>3 月 29 日晚上，Katt Gu 的丈夫，一直关注软件版权演进的创业者 Suji Yan 在看到 996.ICU 之后催促她起草一份协议。Gu 回忆说最初她并不愿意。</p>
<p>“因为我本人是一个工作狂，但是仔细想想这是一个关乎自愿选择的事。”Gu 对《好奇心日报》表示，她的顾虑还来源于专业，这份协议起草涉及 IP 法、劳动法以及国际公约等领域的研究，她从未有过相关经验。</p>
<p>起草协议之前，一位律师告诉她，要做好这份协议，得先研究十年劳动法、再研究十年 IP 法，或者在几个涉及的领域各找十个专家来讨论、研究，再拟定草稿。</p>
<p>但是 Katt Gu 觉得协议的实用效果远小于宣传效果，今天最重要的那些开源协议一开始也不是以那样的立法方式做出来的。</p>
<p>经过一夜研究，她决定以最简单的通用法（Common Law）为基础，草拟一份协议草案。而起草的模版则是简单且应用广泛的 MIT 开源协议。</p>
<p>这份协议以及协议期待产生的效果，都是相当理想化的。</p>
<p>根据 Suji Yan 所设想的最理想状态，协议可以对中国互联网公司有一个约束。他的逻辑是今天软件开发基本上已经不可能不用开源代码——微软一度都是开源软件的最大贡献者。当足够多的开源项目用了 996ICU 协议，企业强制 996 就等于自己的产品违反协议，开源代码拥有者就可以起诉该公司。哪怕在中国大陆起诉艰难，这些公司基本都在香港或美国上市，也可以在其它地区发起诉讼。</p>
<p>不过解释完之后，他自己也说“这当然是一个极其理想化的设想”。</p>
<p>“本来觉得我们不做会有别人做，但是现在觉得还是需要更多人关注。”Katt Gu 说协议公布之后收到一封感谢邮件，“感觉就像看医生收到那种‘妙手回春’的锦旗。”</p>
<p>对协议约束力持怀疑态度的人很普遍，而反对者也不少。比如目前 GitHub 上第三大项目的创作者尤雨溪在微博上表示自己个人反对和谴责 996，但是也反对在开源项目许可证中包含 Discriminatory Clause（禁止部分用户使用的条款），或是利用开源项目做任何形式的政治博弈。</p>
<p>“我个人有个人的看法，但项目是中立的。Vue 的许可证不会禁止任何人使用，现在不会，以后也不会。”他在微博上写道。Vue.js 是一个开发网页用户界面的框架。</p>
<p>但添加反 996 许可证的项目 <a target="_blank" rel="noopener" href="https://github.com/996icu/996.ICU/blob/master/awesomelist/projects.md">在不断增多</a>。目前已经有 75 个开源项目添加了许可证，其中大部分是个人开发者维护的项目，但也有多个点赞数在四五千以上，有一定规模、被很多公司使用的开源软件项目加入。而和 Vue 相关的数个插件项目也加入了反 996 许可协议——任何项目开源扩大之后，就不再是作者一个人决定的了。</p>
<p>Katt Gu 称接下来自己的协议修改要它与更多的主流开源软件协议兼容，这样才有希望被更多开源项目所接纳。</p>
<p>“我自己只想把这个协议写好，写好估计就没有我啥事了，如果要写细，可能要花两三年。”Katt Gu 说做完这个应该就不会管了。Suji Yan 则补充了一句：“还给社区。”</p>
<p>社区有一个大目标。4 月 1 日，有人号召把反 996 协议加入 GitHub <a target="_blank" rel="noopener" href="http://choosealicense.com/">官方收录协议</a> 当中，这样新开源项目就可以很容易把协议加入项目。</p>
<p>更长远的目标是让它被 GitHub 高亮显示，这样任何项目在创建选择协议时都有机会看到它。</p>
<p>这些都不容易，尤其是在主页高亮，需要超过 1000 个公开项目使用该协议，3 个明星项目使用、OSI 和 GNU 批准。</p>
<p>作为开源软件的推动力量，理查德·斯托曼（ Richard Stallman）在 1985 年发表《GNU 宣言》，提出所有软件都应该贯彻自由软件的精神——运行、复制、发布、研究、修改和改进该软件的自由。</p>
<p>但从一开始，这个运动就没有停留在技术或者免费用软件的层面，发起者认为大众都能接触到的应用都应完全掌控在用户自己手中。如果 996.ICU 的贡献者们计划成功，这将是开源软件届第一个被认可的约定劳动权益的协议。</p>
<p>一周不到，对 996.ICU 的反击已经来了。</p>
<p>没有公司敢直接攻击 GitHub。2015 年的持续攻击 <a target="_blank" rel="noopener" href="http://choosealicense.com/">没有成功</a>。现在它是微软的财产，商业公司攻击它就更不明智。</p>
<p>攻击者们用了自己最习惯的手段，屏蔽。</p>
<p>3 月 30 日开始，Slack 讨论群组中开始有人报错：北京地区微信内无法打开 996.ICU 的 GitHub 页面，更多的测试显示，这不是孤例。</p>
<p>QQ 浏览器称这个唯一公开诉求就是让公司遵守劳动法的网站包含欺诈信息。微信显示的理由则是“该网页包含违法或违规内容，为维护绿色上网环境，已停止访问”。阿里巴巴旗下的 UC 浏览器和 360 浏览器都将该页面认定为包含违法信息的网站。最独特的猎豹浏览器打开这个页面会弹出提示称“网站含有大量淫秽色情信息”。</p>
<p>使用百度搜索 996，中文版搜索结果里找不到 996.icu 网站和对应 GitHub 页面的链接。</p>
<p>和以往不同的是，这一次它们并不能直接封杀 996.ICU 的存在，也没法让讨论它的渠道消失。</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/19/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/page/33/">33</a><a class="extend next" rel="next" href="/page/21/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ftq</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">1.5m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">22:53</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="//unpkg.com/animejs@3.1.0/lib/anime.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




<script src="/js/third-party/sakuraPlus.js"></script>
<script src="/js/third-party/fireworks.js"></script>
<script src="/js/third-party/mouse_slide.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"6NuBzi5VSiFfQE2sYbymtv9t-gzGzoHsz","app_key":"stH9SzRt55d1wnwQD7LcoaQR","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<script class="next-config" data-name="changyan" type="application/json">{"enable":true,"appid":"cyw21b1ST","appkey":"045a89927c13c0e33a82c736b468fe51"}</script>
<script src="/js/third-party/comments/changyan.js"></script>

</body>
</html>
