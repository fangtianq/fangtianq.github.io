<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fangtianq.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"changyan","storage":false,"lazyload":false,"nav":null,"activeClass":"changyan"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="有志者事竟成">
<meta property="og:type" content="website">
<meta property="og:title" content="越努力，越幸运！">
<meta property="og:url" content="https://fangtianq.github.io/page/25/index.html">
<meta property="og:site_name" content="越努力，越幸运！">
<meta property="og:description" content="有志者事竟成">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ftq">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://fangtianq.github.io/page/25/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/25/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>越努力，越幸运！</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">越努力，越幸运！</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Where there is a will, there is a way!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">55</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">21</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">322</span></a></li><li class="menu-item menu-item-留言版"><a href="/guestbook/" rel="section"><i class="comments fa-fw"></i>留言版</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-friendlink"><a href="/friendlink/" rel="section"><i class="link fa-fw"></i>友链</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ftq"
      src="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
  <p class="site-author-name" itemprop="name">ftq</p>
  <div class="site-description" itemprop="description">有志者事竟成</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">322</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/fangtianq" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;fangtianq" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://gitee.com/fangtianq" title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;fangtianq" rel="noopener" target="_blank"><i class="github fa-fw"></i>Gitee</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://fangtianq.github.io/" title="GitHub.io → https:&#x2F;&#x2F;fangtianq.github.io&#x2F;"><i class="github fa-fw"></i>GitHub.io</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://fangtianq.gitee.io/" title="Gitee.io → https:&#x2F;&#x2F;fangtianq.gitee.io&#x2F;" rel="noopener" target="_blank"><i class="github fa-fw"></i>Gitee.io</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://leetcode-cn.com/" title="https:&#x2F;&#x2F;leetcode-cn.com&#x2F;" rel="noopener" target="_blank">力扣网</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://rap2.taobao.org/" title="http:&#x2F;&#x2F;rap2.taobao.org&#x2F;" rel="noopener" target="_blank">RAP2接口管理平台</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/01/05/others/rxliuliBlog/JavaScript/JavaScript-%E4%BD%BF%E7%94%A8%E9%80%92%E5%BD%92%E5%BC%82%E6%AD%A5%E7%9A%84%E8%AF%B7%E6%B1%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/01/05/others/rxliuliBlog/JavaScript/JavaScript-%E4%BD%BF%E7%94%A8%E9%80%92%E5%BD%92%E5%BC%82%E6%AD%A5%E7%9A%84%E8%AF%B7%E6%B1%82/" class="post-title-link" itemprop="url">JavaScript 使用递归异步的请求</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-01-06 00:00:00" itemprop="dateCreated datePublished" datetime="2019-01-06T00:00:00+08:00">2019-01-06</time>
    </span>


  
    <span id="/2019/01/05/others/rxliuliBlog/JavaScript/JavaScript-%E4%BD%BF%E7%94%A8%E9%80%92%E5%BD%92%E5%BC%82%E6%AD%A5%E7%9A%84%E8%AF%B7%E6%B1%82/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript 使用递归异步的请求" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript 使用递归异步的请求" href="/2019/01/05/others/rxliuliBlog/JavaScript/JavaScript-%E4%BD%BF%E7%94%A8%E9%80%92%E5%BD%92%E5%BC%82%E6%AD%A5%E7%9A%84%E8%AF%B7%E6%B1%82/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::e35af829c03a58c1e4c766578ac4617d" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaScript-使用递归异步的请求"><a href="#JavaScript-使用递归异步的请求" class="headerlink" title="JavaScript 使用递归异步的请求"></a>JavaScript 使用递归异步的请求</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>之前写了个 <code>user.js</code> 脚本来抓取百度网盘的文件元信息列表，用来进行二级查看和分析,脚本放到了 <a target="_blank" rel="noopener" href="https://greasyfork.org/zh-CN/scripts/375701">GreasyFork</a>。最开始为了简化代码直接使用了 <code>async/await</code> 单线程进行异步请求，导致请求的速度十分不理想！<br>关键代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文件数据信息类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">File</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构造函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; path 全路径</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; parent 父级路径</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; name 文件名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; size 大小(b)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; isdir 是否为文件</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; &#123;<span class="type">origin</span>&#125; 百度云文件信息的源对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">path, parent, name, size, isdir, origin</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">path</span> = path</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = parent</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">size</span> = size</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isdir</span> = isdir</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">orgin</span> = origin</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取指定文件夹下的一级文件/文件夹列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; path 绝对路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise</span>&#125; 文件/文件夹列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getDir</span>(<span class="params">path</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> baseUrl = <span class="string">&#x27;https://pan.baidu.com/api/list?&#x27;</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>dir=<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(path)&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">var</span> json = <span class="keyword">await</span> res.<span class="title function_">json</span>()</span><br><span class="line">    <span class="keyword">return</span> json.<span class="property">list</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`读取文件夹 <span class="subst">$&#123;path&#125;</span> 发生了错误：`</span>, err)</span><br><span class="line">    <span class="keyword">return</span> []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将数组异步压平一层</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Array</span>&#125; arr 数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; fn 映射方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">asyncFlatMap</span>(<span class="params">arr, fn</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> res = []</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> i <span class="keyword">in</span> arr) &#123;</span><br><span class="line">    res.<span class="title function_">push</span>(...(<span class="keyword">await</span> <span class="title function_">fn</span>(arr[i])))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 递归获取到所有的子级文件/文件夹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; path 指定获取的文件夹路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Array</span>&#125; 指定文件夹下所有的文件/文件夹列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">syncList</span>(<span class="params">path</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> fileList = <span class="keyword">await</span> <span class="title function_">getDir</span>(path)</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">asyncFlatMap</span>(fileList, <span class="keyword">async</span> file =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> res = <span class="keyword">new</span> <span class="title class_">File</span>(</span><br><span class="line">      file.<span class="property">path</span>,</span><br><span class="line">      path,</span><br><span class="line">      file.<span class="property">server_filename</span>,</span><br><span class="line">      file.<span class="property">size</span>,</span><br><span class="line">      file.<span class="property">isdir</span>,</span><br><span class="line">      file,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> (res.<span class="property">isdir</span> !== <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> [res]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [res].<span class="title function_">concat</span>(<span class="keyword">await</span> <span class="title function_">syncList</span>(res.<span class="property">path</span>))</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，使用的方式是 <code>递归 + 单异步</code>，这就导致了脚本的效率不高，使用体验很差！</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>吾辈想要使用多异步模式，需要解决的问题有二：</p>
<ul>
<li>如何知道现在有多个异步在执行并且在数量过多时等待</li>
<li>如何知道所有的请求都执行完成了然后结束</li>
</ul>
<p>解决思路</p>
<ol>
<li>判断并限定异步的数量<ol>
<li>添加记录正在执行的异步请求的计数器 <code>execQueue</code></li>
<li>每次请求前先检查 <code>execQueue</code> 是否到达限定值<ul>
<li>如果没有，<code>execQueue + 1</code></li>
<li>如果有，等待 <code>execQueue</code> 减小</li>
</ul>
</li>
<li>执行请求，请求结束 <code>execQueue - 1</code></li>
</ol>
</li>
<li>判断所有请求都执行完成<ol>
<li>添加记录正在等待的异步请求的计数器 <code>waitQueue</code></li>
<li>在判断 <code>execQueue</code> 是否到达限定值之前 <code>waitQueue + 1</code></li>
<li>在判断 <code>execQueue</code> 是否到达限定值之后（等待之后） <code>waitQueue - 1</code></li>
<li>请求结束后判断 <code>waitQueue</code> 和 <code>waitQueue</code> 是否均为 <code>0</code><ul>
<li>是：返回结果</li>
<li>否：什么都不做</li>
</ul>
</li>
</ol>
</li>
</ol>
<p>具体实现如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文件数据信息类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">File</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构造函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; path 全路径</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; parent 父级路径</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; name 文件名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; size 大小(b)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; isdir 是否为文件</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; &#123;<span class="type">origin</span>&#125; 百度云文件信息的源对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">path, parent, name, size, isdir, origin</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">path</span> = path</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = parent</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">size</span> = size</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isdir</span> = isdir</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">orgin</span> = origin</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 等待指定的时间/等待指定表达式成立</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number|Function</span>&#125; param 等待时间/等待条件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise</span>&#125; Promise 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">wait</span>(<span class="params">param</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(resolve, param)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">param</span>()) &#123;</span><br><span class="line">          <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">          <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="number">100</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取指定文件夹下的一级文件/文件夹列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; path 绝对路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise</span>&#125; 文件/文件夹列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getDir</span>(<span class="params">path</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> baseUrl = <span class="string">&#x27;https://pan.baidu.com/api/list?&#x27;</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>dir=<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(path)&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">var</span> json = <span class="keyword">await</span> res.<span class="title function_">json</span>()</span><br><span class="line">    <span class="keyword">return</span> json.<span class="property">list</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`读取文件夹 <span class="subst">$&#123;path&#125;</span> 发生了错误：`</span>, err)</span><br><span class="line">    <span class="keyword">return</span> []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 递归获取所有文件/文件夹</span></span><br><span class="line"><span class="comment"> * 测试获取 34228 条数据</span></span><br><span class="line"><span class="comment"> * - 100 线程：156518ms</span></span><br><span class="line"><span class="comment"> * - 5   线程：220500ms</span></span><br><span class="line"><span class="comment"> * - 1   线程：超过 20min</span></span><br><span class="line"><span class="comment"> * 实现：</span></span><br><span class="line"><span class="comment"> * 1. 请求文件夹下的所有文件/文件夹</span></span><br><span class="line"><span class="comment"> * 2. 如果是文件则直接添加到结果数组中</span></span><br><span class="line"><span class="comment"> * 3. 如果是文件夹则递归调用当前方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; [path] 指定文件夹，默认为根路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; [limit] 指定限定异步数量，默认为 5</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise</span>&#125; 异步对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">asyncList</span>(<span class="params">path = <span class="string">&#x27;/&#x27;</span>, limit = <span class="number">5</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">1</span></span><br><span class="line">    <span class="keyword">var</span> execCount = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> waitQueue = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结果数组</span></span><br><span class="line">    <span class="keyword">var</span> result = []</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">children</span>(<span class="params">path</span>) &#123;</span><br><span class="line">      waitQueue++</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="function">() =&gt;</span> execCount &lt; limit)</span><br><span class="line">      waitQueue--</span><br><span class="line">      execCount++</span><br><span class="line">      <span class="title function_">getDir</span>(path).<span class="title function_">then</span>(<span class="function"><span class="params">fileList</span> =&gt;</span> &#123;</span><br><span class="line">        fileList.<span class="title function_">forEach</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">var</span> res = <span class="keyword">new</span> <span class="title class_">File</span>(</span><br><span class="line">            file.<span class="property">path</span>,</span><br><span class="line">            path,</span><br><span class="line">            file.<span class="property">server_filename</span>,</span><br><span class="line">            file.<span class="property">size</span>,</span><br><span class="line">            file.<span class="property">isdir</span>,</span><br><span class="line">            file,</span><br><span class="line">          )</span><br><span class="line">          result.<span class="title function_">push</span>(res)</span><br><span class="line">          <span class="keyword">if</span> (res.<span class="property">isdir</span> === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="title function_">children</span>(res.<span class="property">path</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">if</span> (--execCount === <span class="number">0</span> &amp;&amp; waitQueue === <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="title function_">resolve</span>(result)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">children</span>(path)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>吾辈使用 <code>timing</code> 函数测试了一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试函数的执行时间</span></span><br><span class="line"><span class="comment"> * 注：如果函数返回 Promise，则该函数也会返回 Promise，否则直接返回执行时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; 需要测试的函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Number|Promise</span>&#125; 执行的毫秒数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> begin = performance.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">var</span> result = <span class="title function_">fn</span>()</span><br><span class="line">  <span class="keyword">if</span> (!(result <span class="keyword">instanceof</span> <span class="title class_">Promise</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> performance.<span class="title function_">now</span>() - begin</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result.<span class="title function_">then</span>(<span class="function">() =&gt;</span> performance.<span class="title function_">now</span>() - begin)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求了 <code>2028</code> 次，两个函数的性能比较如下（单位是毫秒）</p>
<ul>
<li><code>asyncList</code>：109858.80000004545</li>
<li><code>syncList</code>：451904.3000000529</li>
</ul>
<p>差距近 4.5 倍，几乎等同于默认的异步倍数了，看起来优化还是很值得呢！</p>
<blockquote>
<p>附：其实 <code>asyncList</code> 如果使用单异步的话效率反而更低，因为要做一些额外的判断导致单次请求更慢，但因为多个异步请求同时执行的缘故因此缺点被弥补了</p>
</blockquote>
<hr>
<p>那么，关于 JavaScript 使用递归异步的请求就到这里啦</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/01/04/others/rxliuliBlog/JavaScript/%E7%82%B9%E5%87%BB%E6%8C%89%E9%92%AE%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4%E4%BA%86-Form-%E8%A1%A8%E5%8D%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/01/04/others/rxliuliBlog/JavaScript/%E7%82%B9%E5%87%BB%E6%8C%89%E9%92%AE%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4%E4%BA%86-Form-%E8%A1%A8%E5%8D%95/" class="post-title-link" itemprop="url">点击按钮自动提交了 Form 表单</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-01-04 20:22:43" itemprop="dateCreated datePublished" datetime="2019-01-04T20:22:43+08:00">2019-01-04</time>
    </span>


  
    <span id="/2019/01/04/others/rxliuliBlog/JavaScript/%E7%82%B9%E5%87%BB%E6%8C%89%E9%92%AE%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4%E4%BA%86-Form-%E8%A1%A8%E5%8D%95/" class="post-meta-item leancloud_visitors" data-flag-title="点击按钮自动提交了 Form 表单" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="点击按钮自动提交了 Form 表单" href="/2019/01/04/others/rxliuliBlog/JavaScript/%E7%82%B9%E5%87%BB%E6%8C%89%E9%92%AE%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4%E4%BA%86-Form-%E8%A1%A8%E5%8D%95/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::e8f033e10c9d74bf87f3e519b3719234" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="点击按钮自动提交了-Form-表单"><a href="#点击按钮自动提交了-Form-表单" class="headerlink" title="点击按钮自动提交了 Form 表单"></a>点击按钮自动提交了 Form 表单</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>在吾辈的写 HTML 时遇到了一个问题，一个普通的按钮，点击之后一旦在 <code>click</code> 事件中进行了 <code>return</code>，则立刻提交 <code>Form</code> 表单。</p>
<p>像下面这段代码，不管是点击 <em>修改按钮</em> 还是 _提交按钮_，<code>Form</code> 表单都会被提交（可以看到 <code>alert</code> 弹框）。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;form&quot;</span> <span class="attr">onsubmit</span>=<span class="string">&quot;submitFn()&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;文本输入框&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;updateFn()&quot;</span>&gt;</span>修改<span class="tag">&lt;/<span class="name">button</span>&gt;</span> <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 提交方法</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">submitFn</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">alert</span>(<span class="string">&#x27;form 表单被提交了&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 修改方法</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">updateFn</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> $username = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#form &gt; input&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!$username.<span class="property">value</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span> <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    $username.<span class="property">value</span> = <span class="string">&#x27;&#x27;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>后来经过同事提醒，在 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/button#%E5%B1%9E%E6%80%A7">MDN</a> 找到了关于 <code>button</code> 按钮的解释，在 <em>属性 &#x3D;&gt; type</em> 小结中，有下面这样一段内容</p>
<blockquote>
<p><strong>type</strong><br>button 的类型。可选值：</p>
<ul>
<li><code>submit</code>: 此按钮将表单数据提交给服务器。如果未指定属性，或者属性动态更改为空值或无效值，则此值为默认值。</li>
<li><code>reset</code>: 此按钮重置所有组件为初始值。</li>
<li><code>button</code>: 此按钮没有默认行为。它可以有与元素事件相关的客户端脚本，当事件出现时可触发。</li>
<li><code>menu</code>: 此按钮打开一个由指定 <code>&lt;menu&gt;</code> 元素进行定义的弹出菜单。</li>
</ul>
</blockquote>
<p>是的，当没有指定 <code>button</code> 元素的 <code>type</code> 属性时，浏览器将默认为 <code>submit</code> 而非 <code>button</code>，导致了在 <code>Form</code> 表单中容易出现奇怪的自动提交问题。</p>
<p>修改后的代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span> <span class="attr">id</span>=<span class="string">&quot;form&quot;</span> <span class="attr">onsubmit</span>=<span class="string">&quot;submitFn()&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;文本输入框&quot;</span> /&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 实际上只是在这里加了一个 type=&quot;button&quot; 属性而已 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;updateFn()&quot;</span>&gt;</span>修改<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 提交方法</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">submitFn</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">alert</span>(<span class="string">&#x27;form 表单被提交了&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 修改方法</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">updateFn</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> $username = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#form &gt; input&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!$username.<span class="property">value</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span> <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    $username.<span class="property">value</span> = <span class="string">&#x27;&#x27;</span></span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>实际上吾辈也只添加了一个 <code>type</code> 属性，但却因为这个问题耗费许久，终归是基础知识的坑踩得不够多。不过幸好，吾辈可以记录下来，避免在同一个坑里跌倒两次！</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2018/12/27/others/rxliuliBlog/JavaScript/let-%E4%B8%8E-var-%E5%9C%A8-for-%E5%BE%AA%E7%8E%AF%E4%B8%AD%E7%9A%84%E5%8C%BA%E5%88%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/12/27/others/rxliuliBlog/JavaScript/let-%E4%B8%8E-var-%E5%9C%A8-for-%E5%BE%AA%E7%8E%AF%E4%B8%AD%E7%9A%84%E5%8C%BA%E5%88%AB/" class="post-title-link" itemprop="url">let 与 var 在 for 循环中的区别</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-27 17:32:38" itemprop="dateCreated datePublished" datetime="2018-12-27T17:32:38+08:00">2018-12-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2018-12-28 00:00:00" itemprop="dateModified" datetime="2018-12-28T00:00:00+08:00">2018-12-28</time>
    </span>


  
    <span id="/2018/12/27/others/rxliuliBlog/JavaScript/let-%E4%B8%8E-var-%E5%9C%A8-for-%E5%BE%AA%E7%8E%AF%E4%B8%AD%E7%9A%84%E5%8C%BA%E5%88%AB/" class="post-meta-item leancloud_visitors" data-flag-title="let 与 var 在 for 循环中的区别" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="let 与 var 在 for 循环中的区别" href="/2018/12/27/others/rxliuliBlog/JavaScript/let-%E4%B8%8E-var-%E5%9C%A8-for-%E5%BE%AA%E7%8E%AF%E4%B8%AD%E7%9A%84%E5%8C%BA%E5%88%AB/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::6a107ff811694b9a080438ea1b173cc8" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="let-与-var-在-for-循环中的区别"><a href="#let-与-var-在-for-循环中的区别" class="headerlink" title="let 与 var 在 for 循环中的区别"></a>let 与 var 在 for 循环中的区别</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>今天遇到的一个很有趣的问题，下面两段 js 代码执行的结果是什么？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i), <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i), <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>嗯，乍看之下好像没什么区别，只有声明方式 <code>let</code> 和 <code>var</code> 不一样而已。</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>这里先说一下吾辈两个关于 js 的认知</p>
<ol>
<li>js 里 <code>setTimeout</code> 如果延迟时间为 0 应该会立刻执行</li>
<li>js 里的 for 循环和 java 应该差不多，for 循环内部是单独的作用域</li>
</ol>
<p>图解如下</p>
<p><img src="https://img.rxliuli.com/20181227214410.png" alt="js for 循环和 setTimeout 理解"></p>
<p>那么答案只有一个，两段代码执行的结果应该都是 <code>0 1 2</code> 才对！Ｏ(≧▽≦)Ｏ</p>
<p>然而当吾辈执行后的结果却是</p>
<ul>
<li><code>let</code>: <code>0 1 2</code></li>
<li><code>var</code>: <code>3 3 3</code></li>
</ul>
<p>发生了什么？吾辈表示很无语。。。┐(￣ヮ￣)┌</p>
<h2 id="解答"><a href="#解答" class="headerlink" title="解答"></a>解答</h2><p>然而，上面的两个认知全错了！</p>
<h3 id="其一：js-里-setTimeout-如果延迟时间为-0-应该会立刻执行"><a href="#其一：js-里-setTimeout-如果延迟时间为-0-应该会立刻执行" class="headerlink" title="其一：js 里 setTimeout 如果延迟时间为 0 应该会立刻执行"></a>其一：js 里 <code>setTimeout</code> 如果延迟时间为 0 应该会立刻执行</h3><p>好吧，异步没有 <em>立刻执行</em> 这个说法，js 中异步函数实际上是被 <strong>事件队列</strong> 所管理的。当使用 <code>setTimeout</code> 函数时，即便延迟为 0，函数 <code>() =&gt; console.log(i)</code> 也不会立刻执行，而是会被放到 <strong>事件队列</strong> 中去，然后等待浏览器空闲之后执行。</p>
<p>在 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop#%E9%9B%B6%E5%BB%B6%E8%BF%9F">MDN</a> 上有一段关于零延迟的描述</p>
<blockquote>
<p>零延迟</p>
<p>零延迟并不意味着回调会立即执行。以 0 为第二参数调用 <code>setTimeout</code> 并不表示在 <code>0</code> 毫秒后就立即调用回调函数。<br>其等待的时间取决于队列里待处理的消息数量。在下面的例子中，”this is just a message” 将会在回调获得处理之前输出到控制台，这是因为延迟参数是运行时处理请求所需的最小等待时间，但并不保证是准确的等待时间。<br>基本上，<code>setTimeout</code> 需要等待当前队列中所有的消息都处理完毕之后才能执行，即使已经超出了由第二参数所指定的时间。</p>
</blockquote>
<p>所以 <code>setTimeout</code> 实际上并没有立刻执行，而是等到整个 <code>for</code> 循环结束之后才执行的。</p>
<h3 id="其二：js-里的-for-循环和-java-应该差不多，for-循环内部是单独的作用域"><a href="#其二：js-里的-for-循环和-java-应该差不多，for-循环内部是单独的作用域" class="headerlink" title="其二：js 里的 for 循环和 java 应该差不多，for 循环内部是单独的作用域"></a>其二：js 里的 for 循环和 java 应该差不多，for 循环内部是单独的作用域</h3><p>好吧，这个认知更是错的一塌糊涂，for 循环居然没有块级作用域？i 和 k 都是可以直接访问的，犹如直接声明到 for 循环外一样。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">var</span> k = <span class="number">10</span> - i</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`i: <span class="subst">$&#123;i&#125;</span>, k: <span class="subst">$&#123;k&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结果：</span></span><br><span class="line"><span class="comment">// i: 3, k: 8</span></span><br></pre></td></tr></table></figure>

<p>相当于</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line"><span class="keyword">var</span> k</span><br><span class="line"><span class="keyword">for</span> (; i &lt; <span class="number">3</span>; ) &#123;</span><br><span class="line">  k = <span class="number">10</span> - i</span><br><span class="line">  i++</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果换成 let 则两者都无法访问</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="keyword">let</span> k = <span class="number">10</span> - i</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`i: <span class="subst">$&#123;i&#125;</span>, k: <span class="subst">$&#123;k&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结果：</span></span><br><span class="line"><span class="comment">// Uncaught ReferenceError: i is not defined</span></span><br></pre></td></tr></table></figure>

<p>甚至还有一个更有趣的情况，在 for 的表达式和块中可以声明相同的变量，这只说明了一件事，let 声明的变量和循环内部声明的变量不在同一个作用域中！</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;in for expression&#x27;</span>, i), i++) &#123;</span><br><span class="line">  <span class="keyword">let</span> i</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;in for block&#x27;</span>, i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结果：</span></span><br><span class="line"><span class="comment">// in for block undefined</span></span><br><span class="line"><span class="comment">// in for expression 0</span></span><br><span class="line"><span class="comment">// in for block undefined</span></span><br><span class="line"><span class="comment">// in for expression 1</span></span><br><span class="line"><span class="comment">// in for block undefined</span></span><br><span class="line"><span class="comment">// in for expression 2</span></span><br></pre></td></tr></table></figure>

<p>或许，i 只是加了新的作用域，就像下面这样，如此，循环外面就访问不到内部的值，循环内部和 for 的表达式也同样不在一个作用域了，每次循环结束就更新这个值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  ;(<span class="function"><span class="params">_i</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(_i), <span class="number">0</span>)</span><br><span class="line">    i = _i</span><br><span class="line">  &#125;)(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>附：这里吾辈是根据 babel 编译的结果修改而来。而且 babel 真的很聪明，当迭代变量 i 没有更新时，就不会使用 <code>_i</code> 进行区分呢！</p>
</blockquote>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>重新建立了自己的认知之后，可以再对 <code>let/var</code> 在 for 循环进行分析了。</p>
<p>首先是 <code>let + for</code></p>
<h3 id="let-for"><a href="#let-for" class="headerlink" title="let + for"></a>let + for</h3><p>再看下面这段代码，可以对其进行分解</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i), <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>创建 for 循环，表达式中存在 let 变量，for 将会创建一个块级作用域（ES6 let 专用）</li>
<li>每次迭代时，会创建一个子块级作用域，迭代变量 i 也会重新生成</li>
<li>对 i 的任何操作，都会被记住并赋值给下一次的迭代</li>
</ol>
<blockquote>
<p>块级作用域只对 let 有效，var 声明的变量仍然能在 for 循环外使用，证明 for 循环并不是像函数作用域那样是连 var 都能封闭的作用域。</p>
</blockquote>
<p>图解如下</p>
<p><img src="https://img.rxliuli.com/20181227212650.png" alt="let + for 图解"></p>
<h3 id="var-for"><a href="#var-for" class="headerlink" title="var + for"></a>var + for</h3><p>分析一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i), <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>进入 for 循环</li>
<li>在这里创建了迭代变量 i，因为是函数作用域变量所以在 for 循环外可以访问，被提升到了函数作用域顶部声明</li>
<li>setTimeout 函数执行，闭包绑定函数作用域外部变量 i，在循环结束输出 i 的值 3</li>
<li>继续迭代</li>
</ol>
<p><img src="https://img.rxliuli.com/20181227213014.png" alt="var + for 图解"></p>
<hr>
<p>所以以后如果可能，还是要拥抱这些新特性呢！那么，关于 <code>let/var</code> 在 <code>for</code> 循环中的区别就到这里啦</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2018/12/24/others/rxliuliBlog/Tool/Windows/%E4%BD%9C%E4%B8%BA%E4%B8%80%E5%90%8D-developer-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%9C%B0%E4%BD%BF%E7%94%A8-Chrome/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/12/24/others/rxliuliBlog/Tool/Windows/%E4%BD%9C%E4%B8%BA%E4%B8%80%E5%90%8D-developer-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%9C%B0%E4%BD%BF%E7%94%A8-Chrome/" class="post-title-link" itemprop="url">作为一名 developer 如何正确地使用 Chrome</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-24 14:08:52" itemprop="dateCreated datePublished" datetime="2018-12-24T14:08:52+08:00">2018-12-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-07-26 00:00:00" itemprop="dateModified" datetime="2019-07-26T00:00:00+08:00">2019-07-26</time>
    </span>


  
    <span id="/2018/12/24/others/rxliuliBlog/Tool/Windows/%E4%BD%9C%E4%B8%BA%E4%B8%80%E5%90%8D-developer-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%9C%B0%E4%BD%BF%E7%94%A8-Chrome/" class="post-meta-item leancloud_visitors" data-flag-title="作为一名 developer 如何正确地使用 Chrome" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="作为一名 developer 如何正确地使用 Chrome" href="/2018/12/24/others/rxliuliBlog/Tool/Windows/%E4%BD%9C%E4%B8%BA%E4%B8%80%E5%90%8D-developer-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%9C%B0%E4%BD%BF%E7%94%A8-Chrome/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::56c84bb7a7c443471f9d852910015c43" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="作为一名-developer-如何正确地使用-Chrome"><a href="#作为一名-developer-如何正确地使用-Chrome" class="headerlink" title="作为一名 developer 如何正确地使用 Chrome"></a>作为一名 developer 如何正确地使用 Chrome</h1><ul>
<li><a href="#%E4%BD%9C%E4%B8%BA%E4%B8%80%E5%90%8D-developer-%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%9C%B0%E4%BD%BF%E7%94%A8-chrome">作为一名 developer 如何正确地使用 Chrome</a><ul>
<li><a href="#%E5%9C%BA%E6%99%AF">场景</a></li>
<li><a href="#devtool">DevTool</a><ul>
<li><a href="#network">Network</a></li>
<li><a href="#element">Element</a></li>
<li><a href="#sources">Sources</a></li>
</ul>
</li>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%8F%92%E4%BB%B6">使用插件</a><ul>
<li><a href="#%E6%97%A5%E5%B8%B8%E4%BD%BF%E7%94%A8">日常使用</a></li>
<li><a href="#stylus">Stylus</a></li>
<li><a href="#tampermonkey">Tampermonkey</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>现如今，<a target="_blank" rel="noopener" href="https://www.google.com/chrome/">Google Chrome</a> 是全世界最流行的浏览器，具体有多流行，可以看看 <a target="_blank" rel="noopener" href="https://www.netmarketshare.com/browser-market-share.aspx">浏览器市场份额统计</a>。然而，有许多人，只是简单的安装了 Chrome，然后直接使用，却并未想过如何才能更好的使用它。</p>
<h2 id="DevTool"><a href="#DevTool" class="headerlink" title="DevTool"></a>DevTool</h2><p>Chrome 的开发者工具可以说是目前最好的了，然而除了简单的查看 <code>Network/Element</code> 之外，你可还使用过其他的功能？下面让我们一起来探讨一下 DevTool 的 <strong>奇淫技巧</strong> 吧！</p>
<h3 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h3><ol>
<li><p><code>Copy =&gt; Copy as fetch</code><br>以 <code>fetch</code> 方式复制这个请求，如果你对 <code>fetch</code> 还不了解，可以去 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch">MDN: 使用 Fetch</a> 上查看它，并尝试使用它。这是一个浏览器原生的接口，用于进行 HTTP 操作。相比于 <code>XMLHttpRequest</code>，<code>fetch</code> 通常被称为下一代的 Ajax 技术。<br>这也正是吾辈将之单独列出的重要原因，因为它是纯 JavaScript 的，所以我们可以直接在浏览器中对其进行测试&#x2F;修改&#x2F;执行，这点对于 <code>user.js</code> 和 <code>nodejs 爬虫</code> 尤其重要。</p>
<p><img src="https://img.rxliuli.com/20190104212920.png" alt="Copy =&gt; Copy as fetch"></p>
</li>
<li><p>Network 设置</p>
<ul>
<li><code>Disable Cache</code>：禁用网络缓存，开发阶段必备。如果你不想在开发时使用 <code>CS-R</code> 进行硬性重新加载，那最好禁用掉它，避免修改的代码没有及时生效。</li>
<li><code>Preserve log</code>：保留日志。一般而言，当你刷新页面后，<code>Network</code> 将被清空。然而有时候，我们想知道代码修改前后请求发生了哪些变化（修改之前请求一切正常，修改之后就 GG 了），这是便需要使用该选项保留所有的网络请求，方便对比刷新前后请求的变化。</li>
<li><code>Group by frame</code>：根据 frame 对请求进行分组。常见于 Web 后台开发，很多后台项目都使用 frame 实现了标签页的功能，所以按照 frame 进行分组会方便进行查看一点。</li>
</ul>
<p><img src="https://img.rxliuli.com/20190104214338.png" alt="Network 设置"></p>
</li>
</ol>
<h3 id="Element"><a href="#Element" class="headerlink" title="Element"></a>Element</h3><ol>
<li><p><code>Copy =&gt; Copy selector</code><br>复制 DOM 元素的选择器，该选择器实际上是供 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document_Object_Model/Locating_DOM_elements_using_selectors">Selectors API</a> 使用（<code>querySelector/querySelectorAll</code>），但 jquery 的选择器应该兼容它。我们复制完选择器后就可以使用 <code>Selectors API</code> 或 <code>jquery</code> 之类的选择器去获取到元素，然后对之进行操作。这对 <code>user.js</code>&#x2F;<code>nodejs 爬虫</code>&#x2F;<code>快速获取元素</code> 有着重要的意义。</p>
<p><img src="https://img.rxliuli.com/20190104220838.png" alt="Copy =&gt; Copy selector"></p>
</li>
<li><p><code>Break on</code><br>在开发过程中，你是否遇到过这样的问题：“某个元素改变了，但始终不知道是那里的代码改变的”。这时候，DOM 断点就派上用场了，监听某个元素，并根据条件触发并暂停当前 JavaScript 进入 Debug 模式。</p>
<ul>
<li><code>subtree modification</code>：当子节点发生改变时触发</li>
<li><code>attribute modification</code>：当节点属性发生改变时触发</li>
<li><code>node removal</code>：当节点移除时触发</li>
</ul>
<p><img src="https://img.rxliuli.com/20190104221816.png" alt="Break on"></p>
</li>
<li><p>DOM 元素强制指定状态<br>某个元素只有在指定状态下才会有某些效果，当你想让这个元素的状态一直维持不变以仔细观察时，就需要强制指定元素的状态了。<br>思考以下场景<br>下拉菜单只有在鼠标悬浮时才会展开，但鼠标移到 DOM 元素查看时却收起来了，感觉非常难受.JPG！幸好，浏览器为我们提供了这个功能。<br><img src="https://img.rxliuli.com/20190726221706.png" alt="Force state"></p>
</li>
</ol>
<h3 id="Sources"><a href="#Sources" class="headerlink" title="Sources"></a>Sources</h3><ol>
<li><p><code>Drawer Show Search</code><br>显示搜索框，全文搜索当前页面载入的代码，用于快速定位到指定的代码片段。如果你不知道某段代码在什么地方，就可以使用它快速查找。搜索的内容可以使用正则表达式以及区分大小写模式。</p>
<blockquote>
<p>在除了 Console 选项卡之外都可以使用 <code>CS-F</code> 直接打开</p>
</blockquote>
<p><img src="https://img.rxliuli.com/20190108222409.png" alt="Drawer Show Search"></p>
</li>
<li><p>Debug</p>
<ul>
<li>预览表达式结果<br>当你选中一个表达式后，鼠标悬浮在选中的代码上，Chrome 就会自动计算出表达式的结果，并在鼠标附近显示出来。<blockquote>
<p>注：</p>
<ul>
<li>表达式不是代码片段，所以如果选中多段代码是不会得到结果的</li>
<li>非纯函数，例如使用了 Ajax 请求</li>
</ul>
</blockquote>
</li>
<li><code>Evaluate in console</code><br>想要查看某段代码执行的结果，便可以选中这段代码，然后右键选择在控制台中执行它。该功能与上面的预览表达式结果相辅相成。</li>
<li><code>Conditional breakpoint</code><br>条件断点。允许指定某个断点在指定表达式为 <code>true</code> 的情况下才停止，便于在循环中使用断点调试某种特殊情况。</li>
<li><code>Deactivate breakpoints</code><br>停用所有的断点。当我们打了一大堆断点之后，想直接看一下效果，又不想把现有的断点删除，就可以暂时停用现有断点，方便查看效果。</li>
</ul>
</li>
</ol>
<h2 id="使用插件"><a href="#使用插件" class="headerlink" title="使用插件"></a>使用插件</h2><p>自从 Firefox59 以来，随着大量旧体系的插件大量失效，Firefox 的插件库已经不像以往了。如今，Chrome 的插件库是这个星球上最庞大的浏览器插件库了。如果你还没有使用过插件，那恐怕只能使用 Chrome 的一部分功能罢了。</p>
<h3 id="日常使用"><a href="#日常使用" class="headerlink" title="日常使用"></a>日常使用</h3><ul>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/autopagerize/igiofjhpmpihnifddepnpngfjhkfenbp">AutoPagerize</a>：自动翻页插件，浏览很多网站时不需要手动点击下一页了，可以自动加载出来下一页的结果。</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/checker-plus-for-gmail/oeopbcgkkoapgobdbedcemjljbihmemj">Checker Plus for Gmail™</a>：对于日常使用 Gmail 的吾辈而言非常有用</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/crxmouse-chrome-gestures/jlgkpaicikihijadgifklkbpdajbkhjo">crxMouse Chrome™ 手势</a>：鼠标手势插件，可以使用手势更简单地完成一些事情</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/dark-reader/eimadpbcbfnmbkopoojfekhnkhdbieeh">Dark Reader</a>：为所有网站加上黑色主题，大部分情况下都还不错</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/anlikcnbgdeidpacdbdljnabclhahhmd">Enhanced Github</a>：显示 GitHub Repository 大小，允许单独下载每一个文件</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/enhancer-for-youtube/ponfpcnoihfmfllpaingbgckeeldkhle">Enhancer for YouTube™</a>：怎么说呢，Youtube 已经很好了，但吾辈还是觉得需要这个插件来优化播放体验</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/fatkun-batch-download-ima/nnjjahlikiabnchcpehcpkdeckfgnohf">Fatkun 图片批量下载</a>：批量下载网页上的图片，偶尔用一下吧</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/free-download-manager/ahmpjcflkgiildlgicmcieglgoilbfdp">Free Download Manager</a>：FDM Chrome 集成插件，将 Chrome 下载链接使用 FDM 多线程下载</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/github-hovercard/mmoahbbnojgkclgceahhakhnccimnplk">GitHub Hovercard</a>：GitHub 增强插件，鼠标悬浮在仓库链接上面就可以预览</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/image-search-options/kljmejbpilkadikecejccebmccagifhl">Image Search Options</a>：使用右键以图搜图</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/isometric-contributions/mjoedlfflcchnleknnceiplgaeoegien">Isometric Contributions</a>：GitHub 美化插件，将 GitHub 贡献以 3D 的效果显示出来</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/jetbrains-ide-support/hmhgeddbohgjknpmjagkdomcpobmllji">JetBrains IDE Support</a>：使用 Chrome 实时显示 IDEA 的 HTML&#x2F;CSS&#x2F;JavaScript 文件，与 IDEA 的插件配合使用</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/lastpass-free-password-ma/hdokiejnpimakedhajhdlcegeplioahd">LastPass: Free Password Manager</a>：跨平台的免费密码管理器，有了这个之后再也不用所有网站都使用同一个密码了</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/mailto-for-gmail/dgkkmcknielgdhebimdnfahpipajcpjn">Mailto: for Gmail™</a>：对于 mailto 协议的链接以 Gmail 网页版打开</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/markdown-here/elifhakcjgalahccnjkneoccemfahfoa">Markdown Here</a>：在线将 Markdown 转换为有格式的文档，例如在一个普通的富文本编辑器（不支持 Markdown）中，可以先用 Markdown 语法写内容，然后转换一下就得到了有样式的内容了。</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/neat-url/jchobbjgibcahbheicfocecmhocglkco">Neat URL</a>：移除网址中的无用段，例如返利链接后面的参数</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/octotree/bkhaagjahfmjljalopjnoealnfndnagc">Octotree</a>：GitHub 代码树状图插件，方便查看项目文件</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/owo/ckfodameiahfhlainaclajkgfagkpodb">OwO</a>：颜文字插件，多亏了这个让吾辈能够愉快的刷推了</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/proxy-switchyomega/padekgcemlokbadohgkifijomclgjgif">Proxy SwitchyOmega</a>：科学上网必需</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/stylus/clngdbkpkpeebahjckkjfobafhncgmne">Stylus</a>：使用自定义网站样式的插件，比 Stylish 的名声好一些</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/tabliss-a-beautiful-new-t/hipekcciheckooncpjeljhnekcoolahp">Tabliss</a>：新标签页插件</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo">Tampermonkey</a>：使用自定义网站脚本的插件，可以使用各种 <code>user.js</code> 脚本，相当于小型的插件管理器了</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/the-great-suspender/klbibkeccnjlkjkiokjodocebajanakg">The Great Suspender</a>：自动休眠标签页，避免 Chrome 使用的内存太过庞大</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/ublock-origin/cjpalhdlnbpafiamejdnhcphjbkeiagm">uBlock Origin</a>：日常上网必须，屏蔽各种广告，比 ADBlock 的名声好一些</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/vuejs-devtools/nhdogjmejiglipccpnnnanhbledajbpd">Vue.js devtools</a>：在 DevTool 中添加 VueJS 选项卡，便于对 VueJS 进行调试</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/webrtc-network-limiter/npeicpdbkakmehahjeeohfdhnlpdklia">WebRTC Network Limiter</a>：阻止浏览器通过 WebRTC 泄露 IP 地址</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/web%E5%89%8D%E7%AB%AF%E5%8A%A9%E6%89%8Bfehelper/pkgccpejnmalmdinmhkkfafefagiiiad">WEB 前端助手(FeHelper)</a>：貌似是百度的前端插件，但目前还没有什么流氓行为</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/%E5%BF%AB%E7%BF%BB%E8%AF%91/chpeaiibggkmaongjphijmielpkokcdg">快翻译</a>：这个翻译插件是真心不错，某种意义上讲比 Chrome 自带的翻译都要好（#大雾）</li>
<li><a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/extension-manager/gjldcdngmdknpinoemndlidpcabkggco">扩展管理器（Extension Manager）</a>：插件很少的时候还好，一多起来还是需要一个插件进行管理，快速启用和禁用一些插件，根据场景切换启用插件列表</li>
</ul>
<h3 id="Stylus"><a href="#Stylus" class="headerlink" title="Stylus"></a>Stylus</h3><p>为网页自定义 CSS 样式，主要用于网站美化，但也可以用于屏蔽网站内容（现在某些网站会检测用户浏览器是否安装了 uBlock Origin 之类的广告过滤插件）。</p>
<p>例如吾辈就写了一些 css 来提高使用浏览器的体验</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 全局字体设置 */</span></span><br><span class="line">* &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">&#x27;RTWS YueGothic Trial Regular&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*滚动条美化*/</span></span><br><span class="line">::-webkit-scrollbar &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">6px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">6px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::-webkit-scrollbar-track-piece &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#cccccc</span>;</span><br><span class="line">  -webkit-<span class="attribute">border-radius</span>: <span class="number">6px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::-webkit-scrollbar-thumb:horizontal &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">5px</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#cccccc</span>;</span><br><span class="line">  -webkit-<span class="attribute">border-radius</span>: <span class="number">6px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*滚动条滑块的宽高*/</span></span><br><span class="line">::-webkit-scrollbar &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">9px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">9px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::-webkit-scrollbar-track-piece &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: transparent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::-webkit-scrollbar-track-piece:no-button &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">::-webkit-scrollbar-thumb &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#3994ef</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">3px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*滑块的样式*/</span></span><br><span class="line">::-webkit-scrollbar-thumb:vertical &#123;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">5px</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#4afffe</span>;</span><br><span class="line">  -webkit-<span class="attribute">border-radius</span>: <span class="number">6px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*鼠标悬浮于滑块上*/</span></span><br><span class="line">::-webkit-scrollbar-thumb:hover &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#39ffff</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*鼠标按下于滑块上*/</span></span><br><span class="line">::-webkit-scrollbar-thumb:active &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#00fffd</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*纵向滚动条的宽度*/</span></span><br><span class="line">::-webkit-scrollbar-button:vertical &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">9px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*横向滚动条的宽度*/</span></span><br><span class="line">::-webkit-scrollbar-button:horizontal &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">9px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*纵向滚动条的开始按钮（右上角）*/</span></span><br><span class="line">::-webkit-scrollbar-button:vertical:start:decrement &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#00fffd</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*纵向滚动条的开始按钮（右下角）*/</span></span><br><span class="line">::-webkit-scrollbar-button:vertical:end:increment &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#00fffd</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*横向滚动条的开始按钮（左下角）*/</span></span><br><span class="line">::-webkit-scrollbar-button:horizontal:start:decrement &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#00fffd</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*横向滚动条的结束按钮（右下角）*/</span></span><br><span class="line">::-webkit-scrollbar-button:horizontal:end:increment &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#00fffd</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">body</span>::-webkit-scrollbar-track-piece &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: white;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然，也安装了一些其他人写好的</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://userstyles.org/styles/37035/github-dark">GitHub Dark</a>：将 GitHub 页面设置为暗色护眼模式</li>
<li><a target="_blank" rel="noopener" href="https://userstyles.org/styles/155039">A Better Twitter</a>：删除了 Twitter 上用不到的内容，例如广告，新闻栏</li>
<li><a target="_blank" rel="noopener" href="https://userstyles.org/styles/144506/bilibili">Bilibili 屏蔽广告 &amp; 首页去除 舞蹈、生活、时尚、娱乐…… 分类区块</a>：精简 Bilibili，毕竟，现在 B 站无关的内容实在太多了</li>
</ul>
<h3 id="Tampermonkey"><a href="#Tampermonkey" class="headerlink" title="Tampermonkey"></a>Tampermonkey</h3><p>非常强大的一个插件，如果真要展开说明，恐怕又要写一篇博客了。可以将用户自定义的 js 代码 <strong>注入</strong> 到网页中，而这，其实就代表着，任何只要会 JavaScript 的人，都可以在自己浏览器上任意修改网站内容。</p>
<p>那么，说的好像很厉害的样子，具体能做些什么呢？下面列出吾辈常用的 user.js 脚本</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://greasyfork.org/zh-CN/scripts/375701">百度网盘导出数据</a>：百度网盘将文件数据导出出来便于二次分析</li>
<li><a target="_blank" rel="noopener" href="https://greasyfork.org/scripts/2185">為什麼你們就是不能加個空格呢？</a>：网站本身不加空格吾辈帮它加咯</li>
<li><a target="_blank" rel="noopener" href="https://greasyfork.org/scripts/1682">Google Hit Hider by Domain</a>：Google 搜索结果过滤域名</li>
<li><a target="_blank" rel="noopener" href="https://greasyfork.org/scripts/41075">网页限制解除</a>：解除网页不能复制&#x2F;粘贴&#x2F;右键的问题</li>
<li><a target="_blank" rel="noopener" href="https://greasyfork.org/zh-CN/scripts/372516">bilibili merged flv+mp4+ass+enhance</a>：下载 bilibili 上的视频</li>
<li><a target="_blank" rel="noopener" href="https://greasyfork.org/scripts/40496">Ci-Aria2 百度云盘增强版</a>：提取百度网盘下载直链</li>
<li><a target="_blank" rel="noopener" href="https://greasyfork.org/scripts/29762">网盘自动填写密码</a>：自动填写百度网盘提取密码</li>
<li><a target="_blank" rel="noopener" href="https://greasyfork.org/scripts/34175">Booru Downloader + Viewer</a>：图站抓图之用</li>
<li><a target="_blank" rel="noopener" href="https://greasyfork.org/zh-CN/scripts/369418">Youtube Download</a>：下载 Youtube 上的视频</li>
</ul>
<p>哦，如果你很懒，也可以先去 <a target="_blank" rel="noopener" href="https://greasyfork.org/">Greasy Fork</a> 搜索一下是否有你需要的 user.js 脚本。有的话可以直接安装。</p>
<blockquote>
<p>Greasy Fork 上的脚本全部都是开源的，如果你不信任其他开发者，可以随意对脚本进行检查。</p>
</blockquote>
<hr>
<p>那么，有关 Chrome 的使用就到这里啦。如果你也知道什么有趣的操作，可以在下方留言告诉吾辈呢</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2018/12/23/others/rxliuliBlog/JavaScript/%E4%BD%BF%E7%94%A8-Greasemonkey-%E8%A7%A3%E9%99%A4%E7%BD%91%E9%A1%B5%E5%A4%8D%E5%88%B6%E7%B2%98%E8%B4%B4%E9%99%90%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/12/23/others/rxliuliBlog/JavaScript/%E4%BD%BF%E7%94%A8-Greasemonkey-%E8%A7%A3%E9%99%A4%E7%BD%91%E9%A1%B5%E5%A4%8D%E5%88%B6%E7%B2%98%E8%B4%B4%E9%99%90%E5%88%B6/" class="post-title-link" itemprop="url">使用 Greasemonkey 解除网页复制粘贴限制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-23 15:10:04" itemprop="dateCreated datePublished" datetime="2018-12-23T15:10:04+08:00">2018-12-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-10-16 00:00:00" itemprop="dateModified" datetime="2019-10-16T00:00:00+08:00">2019-10-16</time>
    </span>


  
    <span id="/2018/12/23/others/rxliuliBlog/JavaScript/%E4%BD%BF%E7%94%A8-Greasemonkey-%E8%A7%A3%E9%99%A4%E7%BD%91%E9%A1%B5%E5%A4%8D%E5%88%B6%E7%B2%98%E8%B4%B4%E9%99%90%E5%88%B6/" class="post-meta-item leancloud_visitors" data-flag-title="使用 Greasemonkey 解除网页复制粘贴限制" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="使用 Greasemonkey 解除网页复制粘贴限制" href="/2018/12/23/others/rxliuliBlog/JavaScript/%E4%BD%BF%E7%94%A8-Greasemonkey-%E8%A7%A3%E9%99%A4%E7%BD%91%E9%A1%B5%E5%A4%8D%E5%88%B6%E7%B2%98%E8%B4%B4%E9%99%90%E5%88%B6/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::4ad6fb586c5588148154bf0640a794a7" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="使用-Greasemonkey-解除网页复制粘贴限制"><a href="#使用-Greasemonkey-解除网页复制粘贴限制" class="headerlink" title="使用 Greasemonkey 解除网页复制粘贴限制"></a>使用 Greasemonkey 解除网页复制粘贴限制</h1><blockquote>
<p>吾辈发布了一个油猴脚本，可以直接安装 <a target="_blank" rel="noopener" href="https://greasyfork.org/zh-CN/scripts/391193">解除网页限制</a> 以获得更好的使用体验。</p>
</blockquote>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>在浏览网页时经常会出现的一件事，当吾辈想要复制，突然发现复制好像没用了？（<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/23994286">知乎禁止转载的文章</a>）亦或者是复制的最后多出了一点内容（<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0a85e4c7d3d3">简书</a>），或者干脆直接不能选中了（<a target="_blank" rel="noopener" href="http://www.360doc.cn/">360doc</a>）。粘贴时也有可能发现一直粘贴不了（<a target="_blank" rel="noopener" href="https://auth.alipay.com/login/index.htm">支付宝登录</a>）。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>欲先制敌，必先惑敌。想要解除复制粘贴的限制，就必须要清楚它们是如何实现的。不管如何，浏览器上能够运行的都是 JavaScript，它们都是使用 JavaScript 实现的。实现方式大致都是监听相应的事件（例如 <code>onkeydown</code> 监听 <code>Ctrl-C</code>），然后做一些特别的操作。</p>
<p>例如屏蔽复制功能只需要一句代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="property">oncopy</span> = <span class="function"><span class="params">event</span> =&gt;</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>是的，只要返回了 false，那么 copy 就会失效。还有一个更讨厌的方式，直接在 <code>body</code> 元素上加行内事件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">oncopy</span>=<span class="string">&quot;javascript: return false&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>可以看出，一般都是使用 JavaScript 在相应事件中返回 false，来阻止对应事件。那么，既然事件都被阻止了，是否意味着我们就束手无策了呢？吾辈所能想到的解决方案大致有三种方向</p>
<ul>
<li>使用 JavaScript 监听事件并自行实现复制&#x2F;剪切&#x2F;粘贴功能<ul>
<li>优点：实现完成后不管是任何网站都能使用，并且不会影响到监听之外的事件，也不会删除监听的同类型事件，可以解除浏览器本身的限制（密码框禁止复制）</li>
<li>缺点：某些功能自行实现难度很大，例如选择文本</li>
</ul>
</li>
<li>重新实现 <code>addEventListener</code> 然后删除掉网站自定义的事件<ul>
<li>优点：事件生效范围广泛，通用性高，不仅 _复制&#x2F;剪切&#x2F;粘贴_，其他类型的事件也可以解除</li>
<li>缺点：实现起来需要替换 <code>addEventListener</code> 事件<strong>够早</strong>，对浏览器默认操作不会生效（密码框禁止复制），而且某些网站也无法破解</li>
</ul>
</li>
<li>替换元素并删除 DOM 上的事件属性<ul>
<li>优点：能够确保网站 js 的限制被解除，通用性高，事件生效范围广泛</li>
<li>缺点：可能影响到其他类型的事件，复制节点时不会复制使用 <code>addEventListener</code> 添加的事件<blockquote>
<p>注：此方法不予演示，缺陷实在过大</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<p>总之，如果真的想解除<strong>限制</strong>，恐怕需要两种方式并用才可以呢</p>
<h2 id="使用-JavaScript-监听事件并自行实现复制-x2F-剪切-x2F-粘贴功能"><a href="#使用-JavaScript-监听事件并自行实现复制-x2F-剪切-x2F-粘贴功能" class="headerlink" title="使用 JavaScript 监听事件并自行实现复制&#x2F;剪切&#x2F;粘贴功能"></a>使用 JavaScript 监听事件并自行实现复制&#x2F;剪切&#x2F;粘贴功能</h2><h3 id="实现强制复制"><a href="#实现强制复制" class="headerlink" title="实现强制复制"></a>实现强制复制</h3><p>思路</p>
<ol>
<li>冒泡监听 <code>copy</code> 事件</li>
<li>获取当前选中的内容</li>
<li>设置剪切版的内容</li>
<li>阻止默认事件处理</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 强制复制</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(</span><br><span class="line">  <span class="string">&#x27;copy&#x27;</span>,</span><br><span class="line">  <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    event.<span class="property">clipboardData</span>.<span class="title function_">setData</span>(</span><br><span class="line">      <span class="string">&#x27;text/plain&#x27;</span>,</span><br><span class="line">      <span class="variable language_">document</span>.<span class="title function_">getSelection</span>().<span class="title function_">toString</span>(),</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// 阻止默认的事件处理</span></span><br><span class="line">    event.<span class="title function_">preventDefault</span>()</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="literal">true</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="实现强制剪切"><a href="#实现强制剪切" class="headerlink" title="实现强制剪切"></a>实现强制剪切</h3><p>思路</p>
<ol>
<li>冒泡监听 <code>cut</code> 事件</li>
<li>获取当前选中的内容</li>
<li>设置剪切版的内容</li>
<li>如果是可编辑内容要删除选中部分</li>
<li>阻止默认事件处理</li>
</ol>
<blockquote>
<p>可以看到唯一需要增加的就是需要额外处理可编辑内容了，然而代码量瞬间爆炸了哦</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 字符串安全的转换为小写</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; str 字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">String</span>&#125; 转换后得到的全小写字符串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toLowerCase</span>(<span class="params">str</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!str || <span class="keyword">typeof</span> str !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> str</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> str.<span class="title function_">toLowerCase</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断指定元素是否是可编辑元素</span></span><br><span class="line"><span class="comment"> * 注：可编辑元素并不一定能够进行编辑，例如只读的 input 元素</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Element</span>&#125; el 需要进行判断的元素</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Boolean</span>&#125; 是否为可编辑元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isEditable</span>(<span class="params">el</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> inputEls = [<span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;date&#x27;</span>, <span class="string">&#x27;datetime&#x27;</span>, <span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;textarea&#x27;</span>]</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    el &amp;&amp; (el.<span class="property">isContentEditable</span> || inputEls.<span class="title function_">includes</span>(<span class="title function_">toLowerCase</span>(el.<span class="property">tagName</span>)))</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取输入框中光标所在位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">Element</span>&#125; el 需要获取的输入框元素</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Number</span>&#125; 光标所在位置的下标</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getCusorPostion</span>(<span class="params">el</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> el.<span class="property">selectionStart</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置输入框中选中的文本/光标所在位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Element</span>&#125; el 需要设置的输入框元素</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; start 光标所在位置的下标</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; &#123;<span class="type">end</span>&#125; 结束位置，默认为输入框结束</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setCusorPostion</span>(<span class="params">el, start, end = start</span>) &#123;</span><br><span class="line">  el.<span class="title function_">focus</span>()</span><br><span class="line">  el.<span class="title function_">setSelectionRange</span>(start, end)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在指定范围内删除文本</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Element</span>&#125; el 需要设置的输入框元素</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; &#123;<span class="type">start</span>&#125; 开始位置，默认为当前选中开始位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; &#123;<span class="type">end</span>&#125; 结束位置，默认为当前选中结束位置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">removeText</span>(<span class="params">el, start = el.selectionStart, end = el.selectionEnd</span>) &#123;</span><br><span class="line">  <span class="comment">// 删除之前必须要 [记住] 当前光标的位置</span></span><br><span class="line">  <span class="keyword">var</span> index = <span class="title function_">getCusorPostion</span>(el)</span><br><span class="line">  <span class="keyword">var</span> value = el.<span class="property">value</span></span><br><span class="line">  el.<span class="property">value</span> = value.<span class="title function_">substr</span>(<span class="number">0</span>, start) + value.<span class="title function_">substr</span>(end, value.<span class="property">length</span>)</span><br><span class="line">  <span class="title function_">setCusorPostion</span>(el, index)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 强制剪切</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(</span><br><span class="line">  <span class="string">&#x27;cut&#x27;</span>,</span><br><span class="line">  <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    event.<span class="property">clipboardData</span>.<span class="title function_">setData</span>(</span><br><span class="line">      <span class="string">&#x27;text/plain&#x27;</span>,</span><br><span class="line">      <span class="variable language_">document</span>.<span class="title function_">getSelection</span>().<span class="title function_">toString</span>(),</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// 如果是可编辑元素还要进行删除</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isEditable</span>(event.<span class="property">target</span>)) &#123;</span><br><span class="line">      <span class="title function_">removeText</span>(event.<span class="property">target</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    event.<span class="title function_">preventDefault</span>()</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="literal">true</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="实现强制粘贴"><a href="#实现强制粘贴" class="headerlink" title="实现强制粘贴"></a>实现强制粘贴</h3><ol>
<li>冒泡监听 <code>focus/blur</code>，以获得最后一个获得焦点的可编辑元素</li>
<li>冒泡监听 <code>paste</code> 事件</li>
<li>获取剪切版的内容</li>
<li>获取最后一个获得焦点的可编辑元素</li>
<li>删除当前选中的文本</li>
<li>在当前光标处插入文本</li>
<li>阻止默认事件处理</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取到最后一个获得焦点的元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> getLastFocus = (<span class="function"><span class="params">lastFocusEl</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(</span><br><span class="line">    <span class="string">&#x27;focus&#x27;</span>,</span><br><span class="line">    <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">      lastFocusEl = event.<span class="property">target</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">  )</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(</span><br><span class="line">    <span class="string">&#x27;blur&#x27;</span>,</span><br><span class="line">    <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">      lastFocusEl = <span class="literal">null</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> lastFocusEl</span><br><span class="line">&#125;)(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 字符串安全的转换为小写</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; str 字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">String</span>&#125; 转换后得到的全小写字符串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toLowerCase</span>(<span class="params">str</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!str || <span class="keyword">typeof</span> str !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> str</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> str.<span class="title function_">toLowerCase</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断指定元素是否是可编辑元素</span></span><br><span class="line"><span class="comment"> * 注：可编辑元素并不一定能够进行编辑，例如只读的 input 元素</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Element</span>&#125; el 需要进行判断的元素</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Boolean</span>&#125; 是否为可编辑元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isEditable</span>(<span class="params">el</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> inputEls = [<span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;date&#x27;</span>, <span class="string">&#x27;datetime&#x27;</span>, <span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;textarea&#x27;</span>]</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    el &amp;&amp; (el.<span class="property">isContentEditable</span> || inputEls.<span class="title function_">includes</span>(<span class="title function_">toLowerCase</span>(el.<span class="property">tagName</span>)))</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取输入框中光标所在位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">Element</span>&#125; el 需要获取的输入框元素</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Number</span>&#125; 光标所在位置的下标</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getCusorPostion</span>(<span class="params">el</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> el.<span class="property">selectionStart</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置输入框中选中的文本/光标所在位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Element</span>&#125; el 需要设置的输入框元素</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; start 光标所在位置的下标</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; &#123;<span class="type">end</span>&#125; 结束位置，默认为输入框结束</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setCusorPostion</span>(<span class="params">el, start, end = start</span>) &#123;</span><br><span class="line">  el.<span class="title function_">focus</span>()</span><br><span class="line">  el.<span class="title function_">setSelectionRange</span>(start, end)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在指定位置后插入文本</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Element</span>&#125; el 需要设置的输入框元素</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; value 要插入的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; &#123;<span class="type">start</span>&#125; 开始位置，默认为当前光标处</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">insertText</span>(<span class="params">el, text, start = getCusorPostion(el)</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> value = el.<span class="property">value</span></span><br><span class="line">  el.<span class="property">value</span> = value.<span class="title function_">substr</span>(<span class="number">0</span>, start) + text + value.<span class="title function_">substr</span>(start)</span><br><span class="line">  <span class="title function_">setCusorPostion</span>(el, start + text.<span class="property">length</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在指定范围内删除文本</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Element</span>&#125; el 需要设置的输入框元素</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; &#123;<span class="type">start</span>&#125; 开始位置，默认为当前选中开始位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; &#123;<span class="type">end</span>&#125; 结束位置，默认为当前选中结束位置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">removeText</span>(<span class="params">el, start = el.selectionStart, end = el.selectionEnd</span>) &#123;</span><br><span class="line">  <span class="comment">// 删除之前必须要 [记住] 当前光标的位置</span></span><br><span class="line">  <span class="keyword">var</span> index = <span class="title function_">getCusorPostion</span>(el)</span><br><span class="line">  <span class="keyword">var</span> value = el.<span class="property">value</span></span><br><span class="line">  el.<span class="property">value</span> = value.<span class="title function_">substr</span>(<span class="number">0</span>, start) + value.<span class="title function_">substr</span>(end, value.<span class="property">length</span>)</span><br><span class="line">  <span class="title function_">setCusorPostion</span>(el, index)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 强制粘贴</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(</span><br><span class="line">  <span class="string">&#x27;paste&#x27;</span>,</span><br><span class="line">  <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 获取当前剪切板内容</span></span><br><span class="line">    <span class="keyword">var</span> clipboardData = event.<span class="property">clipboardData</span></span><br><span class="line">    <span class="keyword">var</span> items = clipboardData.<span class="property">items</span></span><br><span class="line">    <span class="keyword">var</span> item = items[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (item.<span class="property">kind</span> !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> text = clipboardData.<span class="title function_">getData</span>(item.<span class="property">type</span>)</span><br><span class="line">    <span class="comment">// 获取当前焦点元素</span></span><br><span class="line">    <span class="comment">// 粘贴的时候获取不到焦点？</span></span><br><span class="line">    <span class="keyword">var</span> focusEl = <span class="title function_">getLastFocus</span>()</span><br><span class="line">    <span class="comment">// input 居然不是 [可编辑] 的元素？</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isEditable</span>(focusEl)) &#123;</span><br><span class="line">      <span class="title function_">removeText</span>(focusEl)</span><br><span class="line">      <span class="title function_">insertText</span>(focusEl, text)</span><br><span class="line">      event.<span class="title function_">preventDefault</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="literal">true</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>脚本全貌</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&#x27;use strict&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 两种思路：</span></span><br><span class="line"><span class="comment">   * 1. 自己实现</span></span><br><span class="line"><span class="comment">   * 2. 替换元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取到最后一个获得焦点的元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">var</span> getLastFocus = (<span class="function"><span class="params">lastFocusEl</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(</span><br><span class="line">      <span class="string">&#x27;focus&#x27;</span>,</span><br><span class="line">      <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">        lastFocusEl = event.<span class="property">target</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(</span><br><span class="line">      <span class="string">&#x27;blur&#x27;</span>,</span><br><span class="line">      <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">        lastFocusEl = <span class="literal">null</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> lastFocusEl</span><br><span class="line">  &#125;)(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 字符串安全的转换为小写</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; str 字符串</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">String</span>&#125; 转换后得到的全小写字符串</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">toLowerCase</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!str || <span class="keyword">typeof</span> str !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> str</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str.<span class="title function_">toLowerCase</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 字符串安全的转换为大写</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; str 字符串</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">String</span>&#125; 转换后得到的全大写字符串</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">toUpperCase</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!str || <span class="keyword">typeof</span> str !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> str</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str.<span class="title function_">toUpperCase</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 判断指定元素是否是可编辑元素</span></span><br><span class="line"><span class="comment">   * 注：可编辑元素并不一定能够进行编辑，例如只读的 input 元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Element</span>&#125; el 需要进行判断的元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">Boolean</span>&#125; 是否为可编辑元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">isEditable</span>(<span class="params">el</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> inputEls = [<span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;date&#x27;</span>, <span class="string">&#x27;datetime&#x27;</span>, <span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;textarea&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      el &amp;&amp; (el.<span class="property">isContentEditable</span> || inputEls.<span class="title function_">includes</span>(<span class="title function_">toLowerCase</span>(el.<span class="property">tagName</span>)))</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取输入框中光标所在位置</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span>  &#123;<span class="type">Element</span>&#125; el 需要获取的输入框元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">Number</span>&#125; 光标所在位置的下标</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getCusorPostion</span>(<span class="params">el</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> el.<span class="property">selectionStart</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 设置输入框中选中的文本/光标所在位置</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Element</span>&#125; el 需要设置的输入框元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; start 光标所在位置的下标</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; &#123;<span class="type">end</span>&#125; 结束位置，默认为输入框结束</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">setCusorPostion</span>(<span class="params">el, start, end = start</span>) &#123;</span><br><span class="line">    el.<span class="title function_">focus</span>()</span><br><span class="line">    el.<span class="title function_">setSelectionRange</span>(start, end)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在指定位置后插入文本</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Element</span>&#125; el 需要设置的输入框元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; value 要插入的值</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; &#123;<span class="type">start</span>&#125; 开始位置，默认为当前光标处</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">insertText</span>(<span class="params">el, text, start = getCusorPostion(el)</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> value = el.<span class="property">value</span></span><br><span class="line">    el.<span class="property">value</span> = value.<span class="title function_">substr</span>(<span class="number">0</span>, start) + text + value.<span class="title function_">substr</span>(start)</span><br><span class="line">    <span class="title function_">setCusorPostion</span>(el, start + text.<span class="property">length</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在指定范围内删除文本</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Element</span>&#125; el 需要设置的输入框元素</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; &#123;<span class="type">start</span>&#125; 开始位置，默认为当前选中开始位置</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; &#123;<span class="type">end</span>&#125; 结束位置，默认为当前选中结束位置</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">removeText</span>(<span class="params">el, start = el.selectionStart, end = el.selectionEnd</span>) &#123;</span><br><span class="line">    <span class="comment">// 删除之前必须要 [记住] 当前光标的位置</span></span><br><span class="line">    <span class="keyword">var</span> index = <span class="title function_">getCusorPostion</span>(el)</span><br><span class="line">    <span class="keyword">var</span> value = el.<span class="property">value</span></span><br><span class="line">    el.<span class="property">value</span> = value.<span class="title function_">substr</span>(<span class="number">0</span>, start) + value.<span class="title function_">substr</span>(end, value.<span class="property">length</span>)</span><br><span class="line">    <span class="title function_">setCusorPostion</span>(el, index)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 强制复制</span></span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(</span><br><span class="line">    <span class="string">&#x27;copy&#x27;</span>,</span><br><span class="line">    <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">      event.<span class="property">clipboardData</span>.<span class="title function_">setData</span>(</span><br><span class="line">        <span class="string">&#x27;text/plain&#x27;</span>,</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getSelection</span>().<span class="title function_">toString</span>(),</span><br><span class="line">      )</span><br><span class="line">      event.<span class="title function_">preventDefault</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 强制剪切</span></span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(</span><br><span class="line">    <span class="string">&#x27;cut&#x27;</span>,</span><br><span class="line">    <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">      event.<span class="property">clipboardData</span>.<span class="title function_">setData</span>(</span><br><span class="line">        <span class="string">&#x27;text/plain&#x27;</span>,</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getSelection</span>().<span class="title function_">toString</span>(),</span><br><span class="line">      )</span><br><span class="line">      <span class="comment">// 如果是可编辑元素还要进行删除</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isEditable</span>(event.<span class="property">target</span>)) &#123;</span><br><span class="line">        <span class="title function_">removeText</span>(event.<span class="property">target</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      event.<span class="title function_">preventDefault</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 强制粘贴</span></span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(</span><br><span class="line">    <span class="string">&#x27;paste&#x27;</span>,</span><br><span class="line">    <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 获取当前剪切板内容</span></span><br><span class="line">      <span class="keyword">var</span> clipboardData = event.<span class="property">clipboardData</span></span><br><span class="line">      <span class="keyword">var</span> items = clipboardData.<span class="property">items</span></span><br><span class="line">      <span class="keyword">var</span> item = items[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">if</span> (item.<span class="property">kind</span> !== <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> text = clipboardData.<span class="title function_">getData</span>(item.<span class="property">type</span>)</span><br><span class="line">      <span class="comment">// 获取当前焦点元素</span></span><br><span class="line">      <span class="comment">// 粘贴的时候获取不到焦点？</span></span><br><span class="line">      <span class="keyword">var</span> focusEl = <span class="title function_">getLastFocus</span>()</span><br><span class="line">      <span class="comment">// input 居然不是 [可编辑] 的元素？</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isEditable</span>(focusEl)) &#123;</span><br><span class="line">        <span class="title function_">removeText</span>(focusEl)</span><br><span class="line">        <span class="title function_">insertText</span>(focusEl, text)</span><br><span class="line">        event.<span class="title function_">preventDefault</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">true</span>,</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">selection</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> dom</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">onmousedown</span> = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">      dom = event.<span class="property">target</span></span><br><span class="line">      <span class="comment">// console.log(&#x27;点击: &#x27;, dom)</span></span><br><span class="line">      <span class="keyword">debugger</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;光标所在处: &#x27;</span>, <span class="title function_">getCusorPostion</span>(dom))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">onmousemove</span> = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;移动: &#x27;</span>, dom)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">onmouseup</span> = <span class="function"><span class="params">event</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;松开: &#x27;</span>, dom)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h2 id="重新实现-addEventListener-然后删除掉网站自定义的事件"><a href="#重新实现-addEventListener-然后删除掉网站自定义的事件" class="headerlink" title="重新实现 addEventListener 然后删除掉网站自定义的事件"></a>重新实现 <code>addEventListener</code> 然后删除掉网站自定义的事件</h2><blockquote>
<p>该实现来灵感来源自 <a target="_blank" rel="noopener" href="https://greasyfork.org/en/scripts/41075">https://greasyfork.org/en/scripts/41075</a>，几乎完美实现了解除限制的功能</p>
</blockquote>
<p>原理很简单，修改原型，重新实现 <code>EventTarget</code> 和 <code>docuement</code> 的 <code>addEventListener</code> 函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         解除网页限制</span></span><br><span class="line"><span class="comment">// @namespace    http://github.com/rxliuli</span></span><br><span class="line"><span class="comment">// @version      1.0</span></span><br><span class="line"><span class="comment">// @description  破解禁止复制/剪切/粘贴/选择/右键菜单的网站</span></span><br><span class="line"><span class="comment">// @author       rxliuli</span></span><br><span class="line"><span class="comment">// @include      https://www.jianshu.com/*</span></span><br><span class="line"><span class="comment">// @grant        GM.getValue</span></span><br><span class="line"><span class="comment">// @grant        GM.setValue</span></span><br><span class="line"><span class="comment">// 这里的 @run-at 非常重要，设置在文档开始时就载入脚本</span></span><br><span class="line"><span class="comment">// @run-at       document-start</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">;(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 监听所有的 addEventListener, removeEventListener 事件</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">var</span> documentAddEventListener = <span class="variable language_">document</span>.<span class="property">addEventListener</span></span><br><span class="line">  <span class="keyword">var</span> eventTargetAddEventListener = <span class="title class_">EventTarget</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">addEventListener</span></span><br><span class="line">  <span class="keyword">var</span> documentRemoveEventListener = <span class="variable language_">document</span>.<span class="property">removeEventListener</span></span><br><span class="line">  <span class="keyword">var</span> eventTargetRemoveEventListener = <span class="title class_">EventTarget</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">removeEventListener</span></span><br><span class="line">  <span class="keyword">var</span> events = []</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 用来保存监听到的事件信息</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Event</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">el, type, listener, useCapture</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">el</span> = el</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">type</span> = type</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">listener</span> = listener</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">useCapture</span> = useCapture</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 自定义的添加事件监听函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; type 事件类型</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">EventListener</span>&#125; listener 事件监听函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Boolean</span>&#125; &#123;<span class="type">useCapture</span>&#125; 是否需要捕获事件冒泡，默认为 false</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">addEventListener</span>(<span class="params">type, listener, useCapture = <span class="literal">false</span></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> _this = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">var</span> $addEventListener =</span><br><span class="line">      _this === <span class="variable language_">document</span></span><br><span class="line">        ? documentAddEventListener</span><br><span class="line">        : eventTargetAddEventListener</span><br><span class="line">    events.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Event</span>(_this, type, listener, useCapture))</span><br><span class="line">    $addEventListener.<span class="title function_">apply</span>(<span class="variable language_">this</span>, <span class="variable language_">arguments</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 自定义的根据类型删除事件函数</span></span><br><span class="line"><span class="comment">   * 该方法会删除这个类型下面全部的监听函数，不管数量</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; type 事件类型</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">removeEventListenerByType</span>(<span class="params">type</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> _this = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">var</span> $removeEventListener =</span><br><span class="line">      _this === <span class="variable language_">document</span></span><br><span class="line">        ? documentRemoveEventListener</span><br><span class="line">        : eventTargetRemoveEventListener</span><br><span class="line">    <span class="keyword">var</span> removeIndexs = events</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function">(<span class="params">e, i</span>) =&gt;</span> (e.<span class="property">el</span> === _this || e.<span class="property">type</span> === <span class="variable language_">arguments</span>[<span class="number">0</span>] ? i : -<span class="number">1</span>))</span><br><span class="line">      .<span class="title function_">filter</span>(<span class="function"><span class="params">i</span> =&gt;</span> i !== -<span class="number">1</span>)</span><br><span class="line">    removeIndexs.<span class="title function_">forEach</span>(<span class="function"><span class="params">i</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> e = events[i]</span><br><span class="line">      $removeEventListener.<span class="title function_">apply</span>(e.<span class="property">el</span>, [e.<span class="property">type</span>, e.<span class="property">listener</span>, e.<span class="property">useCapture</span>])</span><br><span class="line">    &#125;)</span><br><span class="line">    removeIndexs.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> b - a).<span class="title function_">forEach</span>(<span class="function"><span class="params">i</span> =&gt;</span> events.<span class="title function_">splice</span>(i, <span class="number">1</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">clearEvent</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> eventTypes = [</span><br><span class="line">      <span class="string">&#x27;copy&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;cut&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;select&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;contextmenu&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;selectstart&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;dragstart&#x27;</span>,</span><br><span class="line">    ]</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;*&#x27;</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">el</span> =&gt;</span> &#123;</span><br><span class="line">      eventTypes.<span class="title function_">forEach</span>(<span class="function"><span class="params">type</span> =&gt;</span> el.<span class="title function_">removeEventListenerByType</span>(type))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ;(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">addEventListener</span> = <span class="title class_">EventTarget</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">addEventListener</span> = addEventListener</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">removeEventListenerByType</span> = <span class="title class_">EventTarget</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">removeEventListenerByType</span> = removeEventListenerByType</span><br><span class="line">  &#125;)()</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">clearEvent</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<hr>
<p>最后，JavaScript hook 技巧是真的很多，果然写 Greasemonkey 脚本这方面用得很多呢 (๑&gt;ᴗ&lt;๑)</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2018/12/21/others/rxliuliBlog/SQL/MySQL/MySQL-%E8%A1%8C%E5%88%97%E8%BD%AC%E6%8D%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/12/21/others/rxliuliBlog/SQL/MySQL/MySQL-%E8%A1%8C%E5%88%97%E8%BD%AC%E6%8D%A2/" class="post-title-link" itemprop="url">MySQL 行列转换</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-21 15:53:57" itemprop="dateCreated datePublished" datetime="2018-12-21T15:53:57+08:00">2018-12-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2018-12-28 00:00:00" itemprop="dateModified" datetime="2018-12-28T00:00:00+08:00">2018-12-28</time>
    </span>


  
    <span id="/2018/12/21/others/rxliuliBlog/SQL/MySQL/MySQL-%E8%A1%8C%E5%88%97%E8%BD%AC%E6%8D%A2/" class="post-meta-item leancloud_visitors" data-flag-title="MySQL 行列转换" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="MySQL 行列转换" href="/2018/12/21/others/rxliuliBlog/SQL/MySQL/MySQL-%E8%A1%8C%E5%88%97%E8%BD%AC%E6%8D%A2/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::08ae7cf809fcc32857c21b0de59e90c2" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>10k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MySQL-行列转换"><a href="#MySQL-行列转换" class="headerlink" title="MySQL 行列转换"></a>MySQL 行列转换</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>面试的时候遇到的一个问题，之前没有碰到过这种场景，所以却是无论如何都回答不了呢！然而本着遇到的坑跌倒过一次就够了的理念，回来时吾辈稍微 Google 了一下这个问题，结果便在此记录一下好啦</p>
<h2 id="行转列"><a href="#行转列" class="headerlink" title="行转列"></a>行转列</h2><p>指的是将数据行根据状态区分为不同的列，主要应用场景应该是统计报表吧</p>
<p>例如下面这个 <code>exam</code> 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> exam;</span><br><span class="line"><span class="keyword">create table</span> exam (</span><br><span class="line">  name    <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not null</span></span><br><span class="line">  comment <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  subject <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not null</span></span><br><span class="line">  comment <span class="string">&#x27;考试科目&#x27;</span>,</span><br><span class="line">  score   <span class="type">int</span>         <span class="keyword">null</span></span><br><span class="line">  comment <span class="string">&#x27;考试成绩&#x27;</span></span><br><span class="line">)</span><br><span class="line">  comment <span class="string">&#x27;考试记录&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert into</span> exam <span class="keyword">values</span> (<span class="string">&#x27;琉璃&#x27;</span>, <span class="string">&#x27;语文&#x27;</span>, <span class="number">90</span>);</span><br><span class="line"><span class="keyword">insert into</span> exam <span class="keyword">values</span> (<span class="string">&#x27;琉璃&#x27;</span>, <span class="string">&#x27;英语&#x27;</span>, <span class="number">85</span>);</span><br><span class="line"><span class="keyword">insert into</span> exam <span class="keyword">values</span> (<span class="string">&#x27;楚轩&#x27;</span>, <span class="string">&#x27;数学&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert into</span> exam <span class="keyword">values</span> (<span class="string">&#x27;楚轩&#x27;</span>, <span class="string">&#x27;物理&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert into</span> exam <span class="keyword">values</span> (<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;化学&#x27;</span>, <span class="number">40</span>);</span><br><span class="line"><span class="keyword">insert into</span> exam <span class="keyword">values</span> (<span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;生物&#x27;</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<p>直接查询会是下面这个样子</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>科目</th>
<th>分数</th>
</tr>
</thead>
<tbody><tr>
<td>琉璃</td>
<td>语文</td>
<td>90</td>
</tr>
<tr>
<td>琉璃</td>
<td>英语</td>
<td>85</td>
</tr>
<tr>
<td>楚轩</td>
<td>数学</td>
<td>100</td>
</tr>
<tr>
<td>楚轩</td>
<td>物理</td>
<td>100</td>
</tr>
<tr>
<td>张三</td>
<td>化学</td>
<td>40</td>
</tr>
<tr>
<td>李四</td>
<td>生物</td>
<td>100</td>
</tr>
</tbody></table>
<p>然而需要的结果却是</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>语文</th>
<th>数学</th>
<th>英语</th>
<th>物理</th>
<th>化学</th>
<th>生物</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>40</td>
<td>0</td>
</tr>
<tr>
<td>李四</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>100</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>楚轩</td>
<td>0</td>
<td>100</td>
<td>0</td>
<td>100</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>琉璃</td>
<td>90</td>
<td>0</td>
<td>85</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody></table>
<p>大致的实现思路是判断 <code>subject</code> 的值，如果等于 <code>转换列</code> 的值，就将之设置为该 <code>转换列</code> 的值。（此处的 <code>转换列</code> 指的是根据 <code>subject</code> 的值查询的新列）</p>
<p>目前网络上能找到的方法有下面两种</p>
<h3 id="使用-if-实现行转列"><a href="#使用-if-实现行转列" class="headerlink" title="使用 if 实现行转列"></a>使用 if 实现行转列</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  name                              <span class="keyword">as</span> <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;语文&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;语文&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;数学&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;数学&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;英语&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;英语&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;物理&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;物理&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;化学&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;化学&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;生物&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;生物&#x27;</span></span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>

<p>优点：简单方便，即便是将几列合并也可以简单做到。例如我们想要统计主科&#x2F;副科的总分</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  name                                                                  <span class="keyword">as</span> <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  <span class="built_in">sum</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;语文&#x27;</span> <span class="keyword">or</span> subject <span class="operator">=</span> <span class="string">&#x27;数学&#x27;</span> <span class="keyword">or</span> subject <span class="operator">=</span> <span class="string">&#x27;英语&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;主科&#x27;</span>,</span><br><span class="line">  <span class="built_in">sum</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;物理&#x27;</span> <span class="keyword">or</span> subject <span class="operator">=</span> <span class="string">&#x27;化学&#x27;</span> <span class="keyword">or</span> subject <span class="operator">=</span> <span class="string">&#x27;生物&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;副科&#x27;</span></span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>

<p>查询结果</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>主科</th>
<th>副科</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>0</td>
<td>40</td>
</tr>
<tr>
<td>李四</td>
<td>0</td>
<td>100</td>
</tr>
<tr>
<td>楚轩</td>
<td>100</td>
<td>100</td>
</tr>
<tr>
<td>琉璃</td>
<td>250</td>
<td>0</td>
</tr>
</tbody></table>
<p>或者简单的实现小计</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  <span class="comment">-- 这里的 ifnull 其实是为了让最后一行的统计不为 null</span></span><br><span class="line">  ifnull(name, <span class="string">&#x27;total&#x27;</span>)             <span class="keyword">as</span> <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;语文&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;语文&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;数学&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;数学&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;英语&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;英语&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;物理&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;物理&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;化学&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;化学&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;生物&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;生物&#x27;</span>,</span><br><span class="line">  <span class="comment">-- 统计每一行数据</span></span><br><span class="line">  <span class="built_in">sum</span>(score)                        <span class="keyword">as</span> total</span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line"><span class="comment">-- 按照 name 进行分组并进行小计</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name <span class="keyword">with</span> <span class="keyword">rollup</span>;</span><br></pre></td></tr></table></figure>

<p>查询结果</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>语文</th>
<th>数学</th>
<th>英语</th>
<th>物理</th>
<th>化学</th>
<th>生物</th>
<th>total</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>40</td>
<td>0</td>
<td>40</td>
</tr>
<tr>
<td>李四</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>100</td>
<td>100</td>
</tr>
<tr>
<td>楚轩</td>
<td>0</td>
<td>100</td>
<td>0</td>
<td>100</td>
<td>0</td>
<td>0</td>
<td>200</td>
</tr>
<tr>
<td>琉璃</td>
<td>90</td>
<td>0</td>
<td>85</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>250</td>
</tr>
<tr>
<td>total</td>
<td>90</td>
<td>100</td>
<td>85</td>
<td>100</td>
<td>40</td>
<td>100</td>
<td>590</td>
</tr>
</tbody></table>
<h3 id="使用-case-when-实现行转列"><a href="#使用-case-when-实现行转列" class="headerlink" title="使用 case when 实现行转列"></a>使用 case when 实现行转列</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  name <span class="keyword">as</span> <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">&#x27;语文&#x27;</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;语文&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">&#x27;数学&#x27;</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;数学&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">&#x27;英语&#x27;</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;英语&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">&#x27;物理&#x27;</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;物理&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">&#x27;化学&#x27;</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;化学&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">&#x27;生物&#x27;</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;生物&#x27;</span></span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>

<p>优点：相比于 <code>if</code> 更加灵活，可以对每个 <code>转换列</code> 的值进行单独的处理。例如我们想要统计主科&#x2F;副科的总分，并设置计算语文&#x2F;数学时增加一半，而英语的分数则忽略不计</p>
<blockquote>
<p>感觉这个优势相当的小，当然如果用到的话却是无需多言的</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  name     <span class="keyword">as</span> <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  <span class="built_in">sum</span>(<span class="keyword">case</span> subject</span><br><span class="line">      <span class="keyword">when</span> <span class="string">&#x27;语文&#x27;</span></span><br><span class="line">        <span class="keyword">then</span> score <span class="operator">*</span> <span class="number">1.5</span></span><br><span class="line">      <span class="keyword">when</span> <span class="string">&#x27;数学&#x27;</span></span><br><span class="line">        <span class="keyword">then</span> score <span class="operator">*</span> <span class="number">1.5</span></span><br><span class="line">      <span class="keyword">when</span> <span class="string">&#x27;英语&#x27;</span></span><br><span class="line">        <span class="keyword">then</span> <span class="number">0</span></span><br><span class="line">      <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">      <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;主科&#x27;</span>,</span><br><span class="line">  <span class="built_in">sum</span>(<span class="keyword">case</span> subject</span><br><span class="line">      <span class="keyword">when</span> <span class="string">&#x27;物理&#x27;</span></span><br><span class="line">        <span class="keyword">then</span> score</span><br><span class="line">      <span class="keyword">when</span> <span class="string">&#x27;化学&#x27;</span></span><br><span class="line">        <span class="keyword">then</span> score</span><br><span class="line">      <span class="keyword">when</span> <span class="string">&#x27;生物&#x27;</span></span><br><span class="line">        <span class="keyword">then</span> score</span><br><span class="line">      <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">      <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;副科&#x27;</span></span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>

<p>查询结果</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>主科</th>
<th>副科</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>0.0</td>
<td>40</td>
</tr>
<tr>
<td>李四</td>
<td>0.0</td>
<td>100</td>
</tr>
<tr>
<td>楚轩</td>
<td>150.0</td>
<td>100</td>
</tr>
<tr>
<td>琉璃</td>
<td>247.5</td>
<td>0</td>
</tr>
</tbody></table>
<h3 id="使用子查询实现行转列"><a href="#使用子查询实现行转列" class="headerlink" title="使用子查询实现行转列"></a>使用子查询实现行转列</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  name,</span><br><span class="line">  if(<span class="keyword">language</span> <span class="operator">!=</span> <span class="string">&#x27;null&#x27;</span>, <span class="keyword">language</span>, <span class="number">0</span>)       <span class="keyword">as</span> <span class="string">&#x27;语文&#x27;</span>,</span><br><span class="line">  if(mathematics <span class="operator">!=</span> <span class="string">&#x27;null&#x27;</span>, mathematics, <span class="number">0</span>) <span class="keyword">as</span> <span class="string">&#x27;数学&#x27;</span>,</span><br><span class="line">  if(english <span class="operator">!=</span> <span class="string">&#x27;null&#x27;</span>, english, <span class="number">0</span>)         <span class="keyword">as</span> <span class="string">&#x27;英语&#x27;</span>,</span><br><span class="line">  if(physical <span class="operator">!=</span> <span class="string">&#x27;null&#x27;</span>, physical, <span class="number">0</span>)       <span class="keyword">as</span> <span class="string">&#x27;物理&#x27;</span>,</span><br><span class="line">  if(chemistry <span class="operator">!=</span> <span class="string">&#x27;null&#x27;</span>, chemistry, <span class="number">0</span>)     <span class="keyword">as</span> <span class="string">&#x27;化学&#x27;</span>,</span><br><span class="line">  if(biological <span class="operator">!=</span> <span class="string">&#x27;null&#x27;</span>, biological, <span class="number">0</span>)   <span class="keyword">as</span> <span class="string">&#x27;生物&#x27;</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">       <span class="keyword">select</span></span><br><span class="line">         e.name,</span><br><span class="line">         (<span class="keyword">select</span> e1.score <span class="keyword">from</span> exam e1 <span class="keyword">where</span> subject <span class="operator">=</span> <span class="string">&#x27;语文&#x27;</span> <span class="keyword">and</span> e1.name <span class="operator">=</span> e.name limit <span class="number">1</span>) <span class="keyword">as</span> <span class="keyword">language</span>,</span><br><span class="line">         (<span class="keyword">select</span> e1.score <span class="keyword">from</span> exam e1 <span class="keyword">where</span> subject <span class="operator">=</span> <span class="string">&#x27;数学&#x27;</span> <span class="keyword">and</span> e1.name <span class="operator">=</span> e.name limit <span class="number">1</span>) <span class="keyword">as</span> mathematics,</span><br><span class="line">         (<span class="keyword">select</span> e1.score <span class="keyword">from</span> exam e1 <span class="keyword">where</span> subject <span class="operator">=</span> <span class="string">&#x27;英语&#x27;</span> <span class="keyword">and</span> e1.name <span class="operator">=</span> e.name limit <span class="number">1</span>) <span class="keyword">as</span> english,</span><br><span class="line">         (<span class="keyword">select</span> e1.score <span class="keyword">from</span> exam e1 <span class="keyword">where</span> subject <span class="operator">=</span> <span class="string">&#x27;物理&#x27;</span> <span class="keyword">and</span> e1.name <span class="operator">=</span> e.name limit <span class="number">1</span>) <span class="keyword">as</span> physical,</span><br><span class="line">         (<span class="keyword">select</span> e1.score <span class="keyword">from</span> exam e1 <span class="keyword">where</span> subject <span class="operator">=</span> <span class="string">&#x27;化学&#x27;</span> <span class="keyword">and</span> e1.name <span class="operator">=</span> e.name limit <span class="number">1</span>) <span class="keyword">as</span> chemistry,</span><br><span class="line">         (<span class="keyword">select</span> e1.score <span class="keyword">from</span> exam e1 <span class="keyword">where</span> subject <span class="operator">=</span> <span class="string">&#x27;生物&#x27;</span> <span class="keyword">and</span> e1.name <span class="operator">=</span> e.name limit <span class="number">1</span>) <span class="keyword">as</span> biological</span><br><span class="line">       <span class="keyword">from</span> exam e</span><br><span class="line">       <span class="keyword">group</span> <span class="keyword">by</span> name</span><br><span class="line">     ) temp;</span><br></pre></td></tr></table></figure>

<p>优点：使用起来最灵活，但代码量也是最大的。可以对每一个列的多条&#x2F;单条数据进行单独的处理，不需要必须使用统计函数（<code>sum/avg/max/min/count</code>）。例如上面就是如果查到了多条数据就直接取第一条，当然也可以对第一条数据做后续处理。</p>
<h3 id="使用-group-concat-简单的行连接"><a href="#使用-group-concat-简单的行连接" class="headerlink" title="使用 group_concat 简单的行连接"></a>使用 group_concat 简单的行连接</h3><p>并非是真正的行转列，实际上只是把不同字段的数据 <em>连接</em> 了起来</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  name                              <span class="keyword">as</span> <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  group_concat(subject, <span class="string">&#x27; &#x27;</span>, score) <span class="keyword">as</span> <span class="string">&#x27;成绩单&#x27;</span></span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>

<p>查询结果</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>成绩单</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>化学 40</td>
</tr>
<tr>
<td>李四</td>
<td>生物 100</td>
</tr>
<tr>
<td>楚轩</td>
<td>数学 100,物理 100</td>
</tr>
<tr>
<td>琉璃</td>
<td>语文 75,语文 90,英语 85</td>
</tr>
</tbody></table>
<h2 id="列转行"><a href="#列转行" class="headerlink" title="列转行"></a>列转行</h2><p>将类似的列按照某种规则变成一列，并生成等同倍数的行。</p>
<p>我们需要将上面行转列得到的表转换回来，例如下面的 <code>exam_score</code> 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create table</span> exam_score (</span><br><span class="line">  name        <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not null</span></span><br><span class="line">  comment <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  <span class="keyword">language</span>    <span class="type">int</span>         <span class="keyword">not null</span></span><br><span class="line">  comment <span class="string">&#x27;语文&#x27;</span>,</span><br><span class="line">  mathematics <span class="type">int</span>         <span class="keyword">not null</span></span><br><span class="line">  comment <span class="string">&#x27;数学&#x27;</span>,</span><br><span class="line">  english     <span class="type">int</span>         <span class="keyword">not null</span></span><br><span class="line">  comment <span class="string">&#x27;英语&#x27;</span>,</span><br><span class="line">  physical    <span class="type">int</span>         <span class="keyword">not null</span></span><br><span class="line">  comment <span class="string">&#x27;物理&#x27;</span>,</span><br><span class="line">  chemistry   <span class="type">int</span>         <span class="keyword">not null</span></span><br><span class="line">  comment <span class="string">&#x27;化学&#x27;</span>,</span><br><span class="line">  biological  <span class="type">int</span>         <span class="keyword">not null</span></span><br><span class="line">  comment <span class="string">&#x27;生物&#x27;</span></span><br><span class="line">)</span><br><span class="line">  comment <span class="string">&#x27;考试成绩&#x27;</span>;</span><br><span class="line"><span class="keyword">insert into</span> exam_score (name, <span class="keyword">language</span>, mathematics, english, physical, chemistry, biological)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">&#x27;张三&#x27;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert into</span> exam_score (name, <span class="keyword">language</span>, mathematics, english, physical, chemistry, biological)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">&#x27;李四&#x27;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert into</span> exam_score (name, <span class="keyword">language</span>, mathematics, english, physical, chemistry, biological)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">&#x27;楚轩&#x27;</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert into</span> exam_score (name, <span class="keyword">language</span>, mathematics, english, physical, chemistry, biological)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">&#x27;琉璃&#x27;</span>, <span class="number">90</span>, <span class="number">0</span>, <span class="number">85</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>直接查询结果是</p>
<table>
<thead>
<tr>
<th>name</th>
<th>language</th>
<th>mathematics</th>
<th>english</th>
<th>physical</th>
<th>chemistry</th>
<th>biological</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>40</td>
<td>0</td>
</tr>
<tr>
<td>李四</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>100</td>
</tr>
<tr>
<td>楚轩</td>
<td>0</td>
<td>100</td>
<td>0</td>
<td>100</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>琉璃</td>
<td>90</td>
<td>0</td>
<td>85</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody></table>
<p>然而我们需要得到</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>科目</th>
<th>分数</th>
</tr>
</thead>
<tbody><tr>
<td>琉璃</td>
<td>语文</td>
<td>90</td>
</tr>
<tr>
<td>琉璃</td>
<td>英语</td>
<td>85</td>
</tr>
<tr>
<td>楚轩</td>
<td>数学</td>
<td>100</td>
</tr>
<tr>
<td>楚轩</td>
<td>物理</td>
<td>100</td>
</tr>
<tr>
<td>张三</td>
<td>化学</td>
<td>40</td>
</tr>
<tr>
<td>李四</td>
<td>生物</td>
<td>100</td>
</tr>
</tbody></table>
<h3 id="使用-union-all-联合查询"><a href="#使用-union-all-联合查询" class="headerlink" title="使用 union all 联合查询"></a>使用 union all 联合查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  name,</span><br><span class="line">  <span class="string">&#x27;语文&#x27;</span>     <span class="keyword">as</span> <span class="string">&#x27;subject&#x27;</span>,</span><br><span class="line">  <span class="keyword">language</span> <span class="keyword">as</span> score</span><br><span class="line"><span class="keyword">from</span> exam_score</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">language</span> <span class="operator">!=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  name,</span><br><span class="line">  <span class="string">&#x27;数学&#x27;</span>        <span class="keyword">as</span> <span class="string">&#x27;subject&#x27;</span>,</span><br><span class="line">  mathematics <span class="keyword">as</span> score</span><br><span class="line"><span class="keyword">from</span> exam_score</span><br><span class="line"><span class="keyword">where</span> mathematics <span class="operator">!=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  name,</span><br><span class="line">  <span class="string">&#x27;英语&#x27;</span>    <span class="keyword">as</span> <span class="string">&#x27;subject&#x27;</span>,</span><br><span class="line">  english <span class="keyword">as</span> score</span><br><span class="line"><span class="keyword">from</span> exam_score</span><br><span class="line"><span class="keyword">where</span> english <span class="operator">!=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  name,</span><br><span class="line">  <span class="string">&#x27;物理&#x27;</span>     <span class="keyword">as</span> <span class="string">&#x27;subject&#x27;</span>,</span><br><span class="line">  physical <span class="keyword">as</span> score</span><br><span class="line"><span class="keyword">from</span> exam_score</span><br><span class="line"><span class="keyword">where</span> physical <span class="operator">!=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  name,</span><br><span class="line">  <span class="string">&#x27;化学&#x27;</span>      <span class="keyword">as</span> <span class="string">&#x27;subject&#x27;</span>,</span><br><span class="line">  chemistry <span class="keyword">as</span> score</span><br><span class="line"><span class="keyword">from</span> exam_score</span><br><span class="line"><span class="keyword">where</span> chemistry <span class="operator">!=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  name,</span><br><span class="line">  <span class="string">&#x27;生物&#x27;</span>       <span class="keyword">as</span> <span class="string">&#x27;subject&#x27;</span>,</span><br><span class="line">  biological <span class="keyword">as</span> score</span><br><span class="line"><span class="keyword">from</span> exam_score</span><br><span class="line"><span class="keyword">where</span> biological <span class="operator">!=</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>唔，好长的 sql 语句，这还只是 6 个 <code>转换列</code>，如果有更多的话恐怕。。。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="sql-行转列的问题"><a href="#sql-行转列的问题" class="headerlink" title="sql 行转列的问题"></a>sql 行转列的问题</h3><p>sql 的技巧确实很多，然而相比之下 sql 只是一门 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/SQL">结构化查询语言</a>，并不算是真正的编程语言呢！行转列&#x2F;列转行这些需求放到真正的编程语言中是很容易处理的，下面演示使用 js 的实现</p>
<h3 id="使用-JavaScript-实现行转列"><a href="#使用-JavaScript-实现行转列" class="headerlink" title="使用 JavaScript 实现行转列"></a>使用 JavaScript 实现行转列</h3><p>假设有下面这样一个 json 数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;琉璃&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subject&quot;</span><span class="punctuation">:</span> <span class="string">&quot;语文&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">75</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;琉璃&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subject&quot;</span><span class="punctuation">:</span> <span class="string">&quot;语文&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">90</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;琉璃&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subject&quot;</span><span class="punctuation">:</span> <span class="string">&quot;英语&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">85</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;楚轩&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subject&quot;</span><span class="punctuation">:</span> <span class="string">&quot;数学&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;楚轩&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subject&quot;</span><span class="punctuation">:</span> <span class="string">&quot;物理&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subject&quot;</span><span class="punctuation">:</span> <span class="string">&quot;化学&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">40</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;subject&quot;</span><span class="punctuation">:</span> <span class="string">&quot;生物&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;score&quot;</span><span class="punctuation">:</span> <span class="number">100</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>转换方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 行转列</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Array</span>&#125; arr 需要进行行转列的数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Array</span>&#125; 行转列得到的数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">rowToCol</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * js 数组按照某个条件进行分组</span></span><br><span class="line"><span class="comment">   * 注：分组完成后会得到一个二维数组，并且顺序会被打乱</span></span><br><span class="line"><span class="comment">   * 时间复杂度为 2On</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; &#123;<span class="type">fn</span>&#125; 元素分组的方法，默认使用 &#123;<span class="doctag">@link</span> JSON.stringify()&#125;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">Array</span>&#125; 新的数组</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">groupBy</span> = <span class="keyword">function</span>(<span class="params">fn = item =&gt; <span class="built_in">JSON</span>.stringify(item)</span>) &#123;</span><br><span class="line">    <span class="comment">// 将元素按照分组条件进行分组得到一个 条件 -&gt; 数组 的对象</span></span><br><span class="line">    <span class="keyword">const</span> obj = &#123;&#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> name = <span class="title function_">fn</span>(item)</span><br><span class="line">      <span class="comment">// 如果已经有这个键了就直接追加, 否则先将之赋值为 [] 再追加元素</span></span><br><span class="line">      ;(obj[name] || (obj[name] = [])).<span class="title function_">push</span>(item)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 将对象转换为数组</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(obj).<span class="title function_">map</span>(<span class="function"><span class="params">key</span> =&gt;</span> obj[key])</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * js 的数组去重方法</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; &#123;<span class="type">fn</span>&#125; 唯一标识元素的方法，默认使用 &#123;<span class="doctag">@link</span> JSON.stringify()&#125;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">Array</span>&#125; 进行去重操作之后得到的新的数组 (原数组并未改变)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">uniqueBy</span> = <span class="keyword">function</span>(<span class="params">fn = item =&gt; <span class="built_in">JSON</span>.stringify(item)</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> obj = &#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">filter</span>(<span class="keyword">function</span>(<span class="params">item</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> obj.<span class="title function_">hasOwnProperty</span>(<span class="title function_">fn</span>(item)) ? <span class="literal">false</span> : (obj[<span class="title function_">fn</span>(item)] = <span class="literal">true</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取所有的科目 -&gt; 分数映射表</span></span><br><span class="line"><span class="comment">   * 看起来函数有点奇怪，但实际上只是一个闭包函数而已</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">Object</span>&#125; 所有的科目 -&gt; 分数映射表的拷贝</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> subjectMap = (<span class="function"><span class="params">obj</span> =&gt;</span> <span class="function">() =&gt;</span> <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, obj))(</span><br><span class="line">    arr</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function"><span class="params">row</span> =&gt;</span> row.<span class="property">subject</span>)</span><br><span class="line">      .<span class="title function_">uniqueBy</span>()</span><br><span class="line">      .<span class="title function_">reduce</span>(<span class="function">(<span class="params">res, subject</span>) =&gt;</span> &#123;</span><br><span class="line">        res[subject] = <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">      &#125;, &#123;&#125;)</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">return</span> arr</span><br><span class="line">    .<span class="title function_">groupBy</span>(<span class="function"><span class="params">row</span> =&gt;</span> row.<span class="property">name</span>)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function"><span class="params">arr</span> =&gt;</span></span><br><span class="line">      arr</span><br><span class="line">        .<span class="title function_">uniqueBy</span>(<span class="function"><span class="params">row</span> =&gt;</span> row.<span class="property">subject</span>)</span><br><span class="line">        .<span class="title function_">reduce</span>(<span class="function">(<span class="params">res, temp</span>) =&gt;</span> &#123;</span><br><span class="line">          res = <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="title function_">subjectMap</span>(), res)</span><br><span class="line">          res.<span class="property">name</span> = temp.<span class="property">name</span></span><br><span class="line">          res[temp.<span class="property">subject</span>] = temp.<span class="property">score</span></span><br><span class="line">          <span class="keyword">return</span> res</span><br><span class="line">        &#125;, &#123;&#125;)</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看起来好像更长了？但实际上 <code>groupBy()/uniqueBy()</code> 都是通用的函数，所以实际代码应该不超过 20 行。转换后的数据如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;语文&quot;</span><span class="punctuation">:</span> <span class="number">75</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;英语&quot;</span><span class="punctuation">:</span> <span class="number">85</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;数学&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;物理&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;化学&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;生物&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;琉璃&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;语文&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;英语&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;数学&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;物理&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;化学&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;生物&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;楚轩&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;语文&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;英语&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;数学&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;物理&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;化学&quot;</span><span class="punctuation">:</span> <span class="number">40</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;生物&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;语文&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;英语&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;数学&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;物理&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;化学&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;生物&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;李四&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h3 id="使用-JavaScript-实现列转行"><a href="#使用-JavaScript-实现列转行" class="headerlink" title="使用 JavaScript 实现列转行"></a>使用 JavaScript 实现列转行</h3><p>那么，如何转换回来呢？转换回来的话却是简单许多了呢</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列转行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Array</span>&#125; arr 需要进行列转行的数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Array</span>&#125; 列转行得到的数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">colToRow</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">  <span class="comment">// 定义好需要进行合并列的数组</span></span><br><span class="line">  <span class="keyword">var</span> cols = [<span class="string">&#x27;语文&#x27;</span>, <span class="string">&#x27;英语&#x27;</span>, <span class="string">&#x27;数学&#x27;</span>, <span class="string">&#x27;物理&#x27;</span>, <span class="string">&#x27;化学&#x27;</span>, <span class="string">&#x27;生物&#x27;</span>]</span><br><span class="line">  <span class="keyword">return</span> arr.<span class="title function_">flatMap</span>(<span class="function"><span class="params">row</span> =&gt;</span></span><br><span class="line">    cols</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function"><span class="params">subject</span> =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">name</span>: row.<span class="property">name</span>,</span><br><span class="line">        <span class="attr">subject</span>: subject,</span><br><span class="line">        <span class="attr">score</span>: row[subject]</span><br><span class="line">      &#125;))</span><br><span class="line">      .<span class="title function_">filter</span>(<span class="function"><span class="params">newRow</span> =&gt;</span> newRow.<span class="property">score</span> != <span class="number">0</span>)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>那么，关于 MySQL 行列转换的问题就到这里啦</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2018/12/20/others/rxliuliBlog/JavaScript/%E8%A7%A3%E5%86%B3-npm-%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E8%BF%87%E6%85%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/12/20/others/rxliuliBlog/JavaScript/%E8%A7%A3%E5%86%B3-npm-%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E8%BF%87%E6%85%A2/" class="post-title-link" itemprop="url">解决 npm 下载速度过慢</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-21 01:23:30" itemprop="dateCreated datePublished" datetime="2018-12-21T01:23:30+08:00">2018-12-21</time>
    </span>


  
    <span id="/2018/12/20/others/rxliuliBlog/JavaScript/%E8%A7%A3%E5%86%B3-npm-%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E8%BF%87%E6%85%A2/" class="post-meta-item leancloud_visitors" data-flag-title="解决 npm 下载速度过慢" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="解决 npm 下载速度过慢" href="/2018/12/20/others/rxliuliBlog/JavaScript/%E8%A7%A3%E5%86%B3-npm-%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E8%BF%87%E6%85%A2/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::b69442ba47354f07f1e7cf5178717f50" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>439</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="解决-npm-下载速度过慢"><a href="#解决-npm-下载速度过慢" class="headerlink" title="解决 npm 下载速度过慢"></a>解决 npm 下载速度过慢</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>由于 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%98%B2%E7%81%AB%E9%95%BF%E5%9F%8E">墙</a> 的存在，所以我们使用 npm 下载依赖时会很慢，不解决的话实在是难以忍受 200k 的下载速度。。。</p>
<h2 id="使用代理"><a href="#使用代理" class="headerlink" title="使用代理"></a>使用代理</h2><p>以 <code>SSR</code> 的本地 <code>http</code> 代理为例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm config <span class="built_in">set</span> proxy http://127.0.0.1:1080</span><br><span class="line">npm config <span class="built_in">set</span> https-proxy http://127.0.0.1:1080</span><br></pre></td></tr></table></figure>

<h2 id="使用国内镜像"><a href="#使用国内镜像" class="headerlink" title="使用国内镜像"></a>使用国内镜像</h2><p>以 taobao 的 npm 镜像为例</p>
<ul>
<li>临时使用<br><code>npm [你需要执行的命令] --registry https://registry.npm.taobao.org</code></li>
<li>永久设置<br><code>npm config set registry https://registry.npm.taobao.org</code></li>
<li>或者使用 cnpm<br><code>npm install -g cnpm --registry=https://registry.npm.taobao.org</code><blockquote>
<p>不推荐使用该方法，cnpm 下载的依赖包很奇怪，和 npm 下载的并不一样呢</p>
</blockquote>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>吾辈个人还是推荐使用代理啦，当然如果你没有稳定梯子却是不得不用国内镜像了呢</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2018/12/19/others/rxliuliBlog/JavaScript/Greasemonkey-%E8%B8%A9%E5%9D%91%E4%B9%8B%E8%B7%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/12/19/others/rxliuliBlog/JavaScript/Greasemonkey-%E8%B8%A9%E5%9D%91%E4%B9%8B%E8%B7%AF/" class="post-title-link" itemprop="url">Greasemonkey 踩坑之路</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-19 22:40:04" itemprop="dateCreated datePublished" datetime="2018-12-19T22:40:04+08:00">2018-12-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2018-12-21 00:00:00" itemprop="dateModified" datetime="2018-12-21T00:00:00+08:00">2018-12-21</time>
    </span>


  
    <span id="/2018/12/19/others/rxliuliBlog/JavaScript/Greasemonkey-%E8%B8%A9%E5%9D%91%E4%B9%8B%E8%B7%AF/" class="post-meta-item leancloud_visitors" data-flag-title="Greasemonkey 踩坑之路" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="Greasemonkey 踩坑之路" href="/2018/12/19/others/rxliuliBlog/JavaScript/Greasemonkey-%E8%B8%A9%E5%9D%91%E4%B9%8B%E8%B7%AF/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::da78a677c7434a02b5ed03a4094f365a" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Greasemonkey-踩坑之路"><a href="#Greasemonkey-踩坑之路" class="headerlink" title="Greasemonkey 踩坑之路"></a>Greasemonkey 踩坑之路</h1><ul>
<li><a href="#greasemonkey-%E8%B8%A9%E5%9D%91%E4%B9%8B%E8%B7%AF">Greasemonkey 踩坑之路</a><ul>
<li><a href="#%E5%9C%BA%E6%99%AF">场景</a></li>
<li><a href="#window-%E5%AF%B9%E8%B1%A1%E4%B8%8D%E8%83%BD%E5%92%8C%E5%A4%96%E9%83%A8%E4%BA%A4%E6%8D%A2%E6%95%B0%E6%8D%AE">window 对象不能和外部交换数据</a></li>
<li><a href="#greasemonkey-api-%E6%98%BE%E7%A4%BA-undefined">Greasemonkey API 显示 undefined</a></li>
<li><a href="#%E5%86%85%E5%AD%98%E7%88%86%E7%82%B8">内存爆炸</a></li>
<li><a href="#greasemonkey-%E5%8A%A0%E8%BD%BD%E6%97%B6%E6%9C%BA%E5%A4%AA%E6%99%9A">Greasemonkey 加载时机太晚</a><ul>
<li><a href="#%E7%AD%89%E5%BE%85%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E5%86%8D%E8%B0%83%E7%94%A8%E4%BE%8B%E5%A6%82%E7%AD%89%E4%B8%AA%E5%87%A0%E7%A7%92-greasemonkey-%E8%84%9A%E6%9C%AC%E5%8F%AF%E8%83%BD%E5%B0%B1%E5%8A%A0%E8%BD%BD%E4%BA%86">等待一段时间再调用，例如等个几秒 Greasemonkey 脚本可能就加载了</a></li>
<li><a href="#%E5%BB%B6%E8%BF%9F%E5%88%B0-greasemonkey-%E8%84%9A%E6%9C%AC%E5%8A%A0%E8%BD%BD%E5%AE%8C%E6%88%90%E5%86%8D%E4%B8%8E%E4%B9%8B%E4%BA%A4%E4%BA%92">延迟到 Greasemonkey 脚本加载完成再与之交互</a></li>
<li><a href="#%E6%9A%B4%E9%9C%B2%E5%87%BA%E9%9C%80%E8%A6%81%E4%BA%A4%E4%BA%92%E7%9A%84%E5%87%BD%E6%95%B0%E7%AD%89%E5%88%B0-greasemonkey-%E5%8A%A0%E8%BD%BD%E5%AE%8C%E6%88%90%E5%90%8E%E8%BF%9B%E8%A1%8C%E5%9B%9E%E8%B0%83">暴露出需要交互的函数等到 Greasemonkey 加载完成后进行回调</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>最近在玩 Greasemonkey 脚本，遇到了各种奇怪的问题，便于此处统一记录一下。</p>
<h2 id="window-对象不能和外部交换数据"><a href="#window-对象不能和外部交换数据" class="headerlink" title="window 对象不能和外部交换数据"></a>window 对象不能和外部交换数据</h2><p>场景</p>
<p>在写 Greasemonkey 脚本时遇到的一个奇怪的问题，吾辈想要把某些数据添加到 <code>window</code> 对象上，方便在 DevTool console 中进行测试。然而却由此印发了一个新的问题，即 <code>window</code> 对象不是真正的 <code>window</code> 对象的问题。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         Testing</span></span><br><span class="line"><span class="comment">// @namespace    http://tampermonkey.net/</span></span><br><span class="line"><span class="comment">// @version      0.1</span></span><br><span class="line"><span class="comment">// @description  用来测试的 userjs 脚本</span></span><br><span class="line"><span class="comment">// @author       rxliuli</span></span><br><span class="line"><span class="comment">// @include     http://*</span></span><br><span class="line"><span class="comment">// @include			https://*</span></span><br><span class="line"><span class="comment">// @grant        MIT</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">;(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&#x27;use strict&#x27;</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">rxliuli</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;这里是 rxliuli 编写的 user.js 脚本&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">rxliuli</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>控制台正常输出了一句话。然而，当吾辈在 console 中输入 <code>window.rxliuli</code> 的结果却是 <code>undefined</code>。</p>
<hr>
<p>解决</p>
<p>吾辈估计又是 Greasemonkey 自身的问题，所以不得不去翻了 <a target="_blank" rel="noopener" href="https://wiki.greasespot.net/">Wiki</a> 上查找，直到看到了 <a target="_blank" rel="noopener" href="https://wiki.greasespot.net/Greasemonkey_Manual:Environment">Greasemonkey Manual:Environment</a>。里面有这么一段话</p>
<blockquote>
<p>Depending on the usage, the special Greasemonkey environment may seem perfectly normal, or excessively limiting.<br>The Greasemonkey environment is a vanilla XPCNativeWrapper of the content window, with only certain extra bits added in to emulate a normal environment, or changed. Specifically:</p>
<ul>
<li>window is an XPCNativeWrapper of the content window.</li>
<li>document is the document object of the XPCNativeWrapper window object.</li>
<li>XPathResult is added so that document.evaluate() works.</li>
<li>Unless the @unwrap metadata imperative is present in the user script header, the entire script is wrapped inside an anonymous function, to guarantee the script’s identifiers do not collide with identifiers present in the Mozilla JavaScript sandbox. This function wrapper captures any function definitions and var variable declarations made (e.g. var i &#x3D; 5;) into the function’s local scope. Declarations made without var will however end up on the script’s this object, which in Greasemonkey is the global object, contrary to in the normal browser object model, where the window object fills this function. In effect, after i &#x3D; 5;, the values of window[‘i’] and window.i remain undefined, whereas this[‘i’] and this.i will be 5. See also: Global object</li>
<li>In order to access variables on the page, use the unsafeWindow object. To use values defined in a script, simply reference them by their names.</li>
</ul>
</blockquote>
<p>大意是 Greasemonkey 为了安全所以 Greasemonkey 脚本是在沙箱中执行的，并且限制了一些内容。其中就包括了 <code>window</code> 对象并非浏览器的原生对象，而是 <code>XPCNativeWrapper</code>。<br>所以，<code>XPCNativeWrapper</code> 是什么。。。？（一个 Greasemonkey 的坑太多了吧 #吐血）<br>吾辈找到了两篇文章</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-TW/docs/XPCNativeWrapper">XPCNat ive Wrapper</a></li>
<li><a target="_blank" rel="noopener" href="http://kb.mozillazine.org/XPCNativeWrapper">Use XPCNativeWrapper</a></li>
</ul>
<p>看完之后表示只知道 <code>XPCNativeWrapper</code> 是在扩展中用来保护不受信任的对象，并非浏览器客户端本身的 API。</p>
<p>好吧，说了这么多解决方案是什么呢？</p>
<p>答案很简单，其实使用 <a target="_blank" rel="noopener" href="https://wiki.greasespot.net/UnsafeWindow">unsafeWindow</a> 对象就能像使用原生的 <code>window</code> 对象行为一致，即便这是不推荐的方法，但有时仍然是必须的！</p>
<h2 id="Greasemonkey-API-显示-undefined"><a href="#Greasemonkey-API-显示-undefined" class="headerlink" title="Greasemonkey API 显示 undefined"></a>Greasemonkey API 显示 undefined</h2><p>场景</p>
<p>在 <a target="_blank" rel="noopener" href="https://wiki.greasespot.net/Greasemonkey_Manual:API">Greasemonkey 手册：API</a> 写出的 API 有很多都不能正常使用，吾辈打印下来的结果是</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         test</span></span><br><span class="line"><span class="comment">// @namespace    http://tampermonkey.net/</span></span><br><span class="line"><span class="comment">// @version      0.1</span></span><br><span class="line"><span class="comment">// @description  test</span></span><br><span class="line"><span class="comment">// @match        *</span></span><br><span class="line"><span class="comment">// @author       rxliuli</span></span><br><span class="line"><span class="comment">// @grant        MIT</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">;(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&#x27;use strict&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">info</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">deleteValue</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">getValue</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">listValues</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">setValue</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">getResourceUrl</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">notification</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">openInTab</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">setClipboard</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">setClipboard</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(unsafeWindow)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p><img src="https://img.rxliuli.com/20181219225309.png" alt="Greasemonkey API 显示 undefined"></p>
<p>测试环境如下：</p>
<ul>
<li>Windows 10 Ltsc</li>
<li>Chrome 71</li>
<li>tampermonkey 4.7.44</li>
</ul>
<hr>
<p>解决</p>
<p>吾辈在翻 <a target="_blank" rel="noopener" href="https://github.com/sindresorhus/globals/issues/122">GitHub Issue</a> 找到了问题所在，原因是这些 API 必须要手动获取准许才行。<br>即使用 <code>// @grant GM.[Function]</code> 来获取需要的 API，所以吾辈的脚本变成了下面这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         test</span></span><br><span class="line"><span class="comment">// @namespace    http://tampermonkey.net/</span></span><br><span class="line"><span class="comment">// @version      0.1</span></span><br><span class="line"><span class="comment">// @description  test</span></span><br><span class="line"><span class="comment">// @match        *</span></span><br><span class="line"><span class="comment">// @author       rxliuli</span></span><br><span class="line"><span class="comment">// @grant        MIT</span></span><br><span class="line"><span class="comment">// @grant        GM.deleteValue</span></span><br><span class="line"><span class="comment">// @grant        GM.getValue</span></span><br><span class="line"><span class="comment">// @grant        GM.listValues</span></span><br><span class="line"><span class="comment">// @grant        GM.setValue</span></span><br><span class="line"><span class="comment">// @grant        GM.getResourceUrl</span></span><br><span class="line"><span class="comment">// @grant        GM.notification</span></span><br><span class="line"><span class="comment">// @grant        GM.openInTab</span></span><br><span class="line"><span class="comment">// @grant        GM.setClipboard</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">;(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&#x27;use strict&#x27;</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">info</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">deleteValue</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">getValue</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">listValues</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">setValue</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">getResourceUrl</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">notification</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">openInTab</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">setClipboard</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">GM</span>.<span class="property">setClipboard</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(unsafeWindow)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>问题解决了，现在，所有的 API 都有值了。</p>
<p><img src="https://img.rxliuli.com/20181219225919.png" alt="GM API 都有值了"></p>
<h2 id="内存爆炸"><a href="#内存爆炸" class="headerlink" title="内存爆炸"></a>内存爆炸</h2><p>场景</p>
<p>使用了 <code>GM.setValue()/GM.getValue()</code> 两个 API，结果内存分分钟爆炸。吾辈安装 Chrome 以来第一次碰到加载网页能把内存耗尽的情况，果然 GM 的限制不是没有道理的呢<br><img src="https://img.rxliuli.com/20181220002112.png" alt="内存爆炸"><br><img src="https://img.rxliuli.com/20181220013001.png" alt="浏览器崩溃"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         Testing</span></span><br><span class="line"><span class="comment">// @namespace    http://tampermonkey.net/</span></span><br><span class="line"><span class="comment">// @match        *</span></span><br><span class="line"><span class="comment">// @version      0.1</span></span><br><span class="line"><span class="comment">// @description  用来测试的 userjs 脚本</span></span><br><span class="line"><span class="comment">// @author       rxliuli</span></span><br><span class="line"><span class="comment">// @grant        GM.getValue</span></span><br><span class="line"><span class="comment">// @grant        GM.setValue</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">;(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="string">&#x27;use strict&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> domains = &#123;</span><br><span class="line">    <span class="attr">domainsName</span>: <span class="string">&#x27;domains&#x27;</span>,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">list</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> valueStr = <span class="variable constant_">GM</span>.<span class="title function_">getValue</span>(<span class="variable language_">this</span>.<span class="property">domainsName</span>)</span><br><span class="line">      <span class="keyword">if</span> (!valueStr) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>(valueStr)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="keyword">var</span> defaultArr = []</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">set</span>(defaultArr)</span><br><span class="line">        <span class="keyword">return</span> defaultArr</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">set</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="variable constant_">GM</span>.<span class="title function_">setValue</span>(<span class="variable language_">this</span>.<span class="property">domainsName</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(arr))</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">list</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">0</span>).<span class="title function_">fill</span>(<span class="number">0</span>).<span class="title function_">map</span>(<span class="function">(<span class="params">v, i</span>) =&gt;</span> i)</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">await</span> domains.<span class="title function_">set</span>(arr)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">init</span>()</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<hr>
<p>解决</p>
<p>Debug 之后发现是调用 <code>GM.setValue()</code> 没有使用 <code>await</code> 造成的异步请求数量不断积累最终导致网页崩溃。果然 Promise 什么的还是要小心一点好呀<br>当然，不信的话你也可以新建一个 Greasemonkey 脚本尝试一下内存爆炸的感觉咯</p>
<blockquote>
<p>递归不是主要问题，吾辈 PC 上的 Chrome 最多到 1.4w+ 次递归就会抛出异常（网页没有崩溃），还没到 1.4w+ 次，所以说递归不是主要问题呀</p>
</blockquote>
<h2 id="Greasemonkey-加载时机太晚"><a href="#Greasemonkey-加载时机太晚" class="headerlink" title="Greasemonkey 加载时机太晚"></a>Greasemonkey 加载时机太晚</h2><p>场景</p>
<p>Greasemonkey 的加载是在页面加载完毕时，类似于 <code>window.onload</code>，所以造成了一个问题：如果想要在网站的 JavaScript 代码中与 Greasemonkey 脚本交互，那么必须要等到 Greasemonkey 加载完成，而加载完成的时机是不确定的。</p>
<p>吾辈目前想要的解决方案有三种</p>
<h3 id="等待一段时间再调用，例如等个几秒-Greasemonkey-脚本可能就加载了"><a href="#等待一段时间再调用，例如等个几秒-Greasemonkey-脚本可能就加载了" class="headerlink" title="等待一段时间再调用，例如等个几秒 Greasemonkey 脚本可能就加载了"></a>等待一段时间再调用，例如等个几秒 Greasemonkey 脚本可能就加载了</h3><p>思路</p>
<p>现在没有人，我等会再来问一次！</p>
<p>实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title function_">wait</span> = ms =&gt; <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, ms))</span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现和调用最为简单，但无法保证等待之后就一定能获得资源了</span></span><br><span class="line"><span class="title function_">wait</span>(<span class="number">1000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(完成))</span><br></pre></td></tr></table></figure>

<h3 id="延迟到-Greasemonkey-脚本加载完成再与之交互"><a href="#延迟到-Greasemonkey-脚本加载完成再与之交互" class="headerlink" title="延迟到 Greasemonkey 脚本加载完成再与之交互"></a>延迟到 Greasemonkey 脚本加载完成再与之交互</h3><p>思路</p>
<p>有人吗? 没有的话我等会再来问！</p>
<p>实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 轮询等待指定资源加载完毕再执行操作</span></span><br><span class="line"><span class="comment"> * 使用 Promises 实现，可以使用 ES7 的 &#123;<span class="doctag">@async</span>&#125;/&#123;<span class="doctag">@await</span>&#125; 调用</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; resourceFn 判断必须的资源是否存在的方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; options 选项</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> Promise 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">waitResource</span>(<span class="params">resourceFn, options</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> optionsRes = <span class="title class_">Object</span>.<span class="title function_">assign</span>(</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">interval</span>: <span class="number">1000</span>,</span><br><span class="line">      <span class="attr">max</span>: <span class="number">10</span></span><br><span class="line">    &#125;,</span><br><span class="line">    options</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">var</span> current = <span class="number">0</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">resourceFn</span>()) &#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">        <span class="title function_">resolve</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      current++</span><br><span class="line">      <span class="keyword">if</span> (current &gt;= optionsRes.<span class="property">max</span>) &#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">        <span class="title function_">reject</span>(<span class="string">&#x27;等待超时&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, optionsRes.<span class="property">interval</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> resourceFn = (<span class="function"><span class="params">i</span> =&gt;</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`第 <span class="subst">$&#123;i++&#125;</span> 次调用`</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;)(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="title function_">waitResource</span>(resourceFn, &#123;</span><br><span class="line">  <span class="attr">interval</span>: <span class="number">1000</span>,</span><br><span class="line">  <span class="attr">max</span>: <span class="number">3</span></span><br><span class="line">&#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;完成&#x27;</span>))</span><br><span class="line">  .<span class="keyword">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err))</span><br></pre></td></tr></table></figure>

<h3 id="暴露出需要交互的函数等到-Greasemonkey-加载完成后进行回调"><a href="#暴露出需要交互的函数等到-Greasemonkey-加载完成后进行回调" class="headerlink" title="暴露出需要交互的函数等到 Greasemonkey 加载完成后进行回调"></a>暴露出需要交互的函数等到 Greasemonkey 加载完成后进行回调</h3><p>思路</p>
<p>现在没有人，有人的时候再叫我！</p>
<p>实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 等待被调用</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; ms 超时毫秒数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; name 准备被调用的挂载到 window 对象上的方法名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">waitingToCall</span>(<span class="params">ms, name = <span class="string">&#x27;waiting&#x27;</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> timeout = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">reject</span>(<span class="string">&#x27;等待超时&#x27;</span>)</span><br><span class="line">    &#125;, ms)</span><br><span class="line">    <span class="variable language_">window</span>[name] = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">clearTimeout</span>(timeout)</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">waitingToCall</span>(<span class="number">3000</span>, <span class="string">&#x27;waiting&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;完成&#x27;</span>))</span><br><span class="line">  .<span class="keyword">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err))</span><br></pre></td></tr></table></figure>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2018/12/11/others/rxliuliBlog/Java/MybatisPlus-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%A8%E5%B1%80%E6%93%8D%E4%BD%9C-exists-%E4%B8%80%E7%9B%B4%E8%BF%94%E5%9B%9E-null/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/12/11/others/rxliuliBlog/Java/MybatisPlus-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%A8%E5%B1%80%E6%93%8D%E4%BD%9C-exists-%E4%B8%80%E7%9B%B4%E8%BF%94%E5%9B%9E-null/" class="post-title-link" itemprop="url">MybatisPlus 自定义全局操作 exists 一直返回 null</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-11 19:26:18" itemprop="dateCreated datePublished" datetime="2018-12-11T19:26:18+08:00">2018-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2018-12-12 00:00:00" itemprop="dateModified" datetime="2018-12-12T00:00:00+08:00">2018-12-12</time>
    </span>


  
    <span id="/2018/12/11/others/rxliuliBlog/Java/MybatisPlus-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%A8%E5%B1%80%E6%93%8D%E4%BD%9C-exists-%E4%B8%80%E7%9B%B4%E8%BF%94%E5%9B%9E-null/" class="post-meta-item leancloud_visitors" data-flag-title="MybatisPlus 自定义全局操作 exists 一直返回 null" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="MybatisPlus 自定义全局操作 exists 一直返回 null" href="/2018/12/11/others/rxliuliBlog/Java/MybatisPlus-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%A8%E5%B1%80%E6%93%8D%E4%BD%9C-exists-%E4%B8%80%E7%9B%B4%E8%BF%94%E5%9B%9E-null/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::7d18227fb67d161dd16ba91e2c16e517" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>该仓库为博客记录示例，如果需要可以前往博客查看内容 <a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/5bd9a558/">MybatisPlus 自定义全局操作 exists 一直返回 null</a></p>
</blockquote>
<h1 id="MybatisPlus-自定义全局操作-exists-一直返回-null"><a href="#MybatisPlus-自定义全局操作-exists-一直返回-null" class="headerlink" title="MybatisPlus 自定义全局操作 exists 一直返回 null"></a>MybatisPlus 自定义全局操作 exists 一直返回 null</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>为 <code>mybatis-plus</code> 自定义了一个全局操作，然后就一直返回 <code>null</code>。。。</p>
<p>在自定义 sql 注入器类的时候，突然发现 <code>existsById()</code> 一直都在抛空指针异常，就去看了一下结果发现一直返回 <code>null</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rxliuli.example.mybatisplussqlinjector.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.entity.TableInfo;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.mapper.AutoSqlInjector;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.builder.MapperBuilderAssistant;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.SqlSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义 sql 注入器</span></span><br><span class="line"><span class="comment"> * 注: 此处不能声明为 Bean, 因为回和 MybatisPlus 自己的 SqlInjector 冲突</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSqlInjector</span> <span class="keyword">extends</span> <span class="title class_">AutoSqlInjector</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 id 确定数据是否存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SQL_EXISTS_BY_ID</span> <span class="operator">=</span> <span class="string">&quot;select exists(select 0 from %s where id = #&#123;id&#125;);&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inject</span><span class="params">(Configuration configuration, MapperBuilderAssistant builderAssistant, Class&lt;?&gt; mapperClass, Class&lt;?&gt; modelClass, TableInfo table)</span> &#123;</span><br><span class="line">        existsById(mapperClass, modelClass, table);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">existsById</span><span class="params">(Class&lt;?&gt; mapperClass, Class&lt;?&gt; modelClass, TableInfo table)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> String.format(SQL_EXISTS_BY_ID, table.getTableName());</span><br><span class="line">        <span class="keyword">final</span> <span class="type">SqlSource</span> <span class="variable">sqlSource</span> <span class="operator">=</span> languageDriver.createSqlSource(configuration, sql, modelClass);</span><br><span class="line">        <span class="built_in">this</span>.addSelectMappedStatement(mapperClass, <span class="string">&quot;existsById&quot;</span>, sqlSource, modelClass, table);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义的 <code>BaseDao</code> 基类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rxliuli.example.mybatisplussqlinjector.common.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> rxliuli</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BaseDao</span>&lt;T <span class="keyword">extends</span> <span class="title class_">Serializable</span>&gt; <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 id 查询数据是否存在</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 数据 id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 数据是否存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Boolean <span class="title function_">existsById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rxliuli.example.mybatisplussqlinjector.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rxliuli.example.mybatisplussqlinjector.entity.User;</span><br><span class="line"><span class="keyword">import</span> common.test.BaseDaoAndServiceTest;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.assertj.core.api.Assertions.assertThat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDaoTest</span> <span class="keyword">extends</span> <span class="title class_">BaseDaoAndServiceTest</span>&lt;UserDao&gt; &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">existsById</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">res</span> <span class="operator">=</span> base.existsById(<span class="number">1L</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;res: &#123;&#125;&quot;</span>, res);</span><br><span class="line">        assertThat(res)</span><br><span class="line">                .isTrue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">selectById</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> base.selectById(<span class="number">1L</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;user: &#123;&#125;&quot;</span>, user);</span><br><span class="line">        assertThat(user)</span><br><span class="line">                .isNotNull();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果</p>
<p><img src="https://img.rxliuli.com/20181211202332.png" alt="测试结果"></p>
<p>然而，当我把全局注入的 sql 操作放到 xml 文件时</p>
<p>Dao 和对应的 xml 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rxliuli.example.mybatisplussqlinjector.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rxliuli.example.mybatisplussqlinjector.common.dao.BaseDao;</span><br><span class="line"><span class="keyword">import</span> com.rxliuli.example.mybatisplussqlinjector.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDao</span> <span class="keyword">extends</span> <span class="title class_">BaseDao</span>&lt;User&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Boolean <span class="title function_">existsById</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.rxliuli.example.mybatisplussqlinjector.dao.UserDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;existsById&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Boolean&quot;</span>&gt;</span></span><br><span class="line">        select exists(select 0</span><br><span class="line">                      from user</span><br><span class="line">                      where id = #&#123;id&#125;);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>现在，一切又能正常运行了，这其中到底发生了什么呢？</p>
<p><img src="https://img.rxliuli.com/20181211202834.png" alt="测试正常运行"></p>
<blockquote>
<p>目前该问题已经在 <a target="_blank" rel="noopener" href="https://github.com/baomidou/mybatis-plus">官方 GitHub</a> 上提出了一个 <a target="_blank" rel="noopener" href="https://github.com/baomidou/mybatis-plus/issues/694">issue</a></p>
</blockquote>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>好吧，开发人员说是要在使用 <code>addSelectMappedStatement()</code> 时对返回值进行界定，之前一直查的都是表数据确实没注意到还需要对返回值类型进行界定呢</p>
<p>修改的地方其实只有一处</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rxliuli.example.mybatisplussqlinjector.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.entity.TableInfo;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.mapper.AutoSqlInjector;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.builder.MapperBuilderAssistant;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.mapping.SqlSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义 sql 注入器</span></span><br><span class="line"><span class="comment"> * 注: 此处不能声明为 Bean, 因为回和 MybatisPlus 自己的 SqlInjector 冲突</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSqlInjector</span> <span class="keyword">extends</span> <span class="title class_">AutoSqlInjector</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 id 确定数据是否存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SQL_EXISTS_BY_ID</span> <span class="operator">=</span> <span class="string">&quot;select exists(select 0 from %s where id = #&#123;id&#125;);&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">inject</span><span class="params">(Configuration configuration, MapperBuilderAssistant builderAssistant, Class&lt;?&gt; mapperClass, Class&lt;?&gt; modelClass, TableInfo table)</span> &#123;</span><br><span class="line">        existsById(mapperClass, modelClass, table);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">existsById</span><span class="params">(Class&lt;?&gt; mapperClass, Class&lt;?&gt; modelClass, TableInfo table)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> String.format(SQL_EXISTS_BY_ID, table.getTableName());</span><br><span class="line">        <span class="keyword">final</span> <span class="type">SqlSource</span> <span class="variable">sqlSource</span> <span class="operator">=</span> languageDriver.createSqlSource(configuration, sql, modelClass);</span><br><span class="line">        <span class="comment">// 注：在此处界定返回值类型</span></span><br><span class="line">        <span class="built_in">this</span>.addSelectMappedStatement(mapperClass, <span class="string">&quot;existsById&quot;</span>, sqlSource, Boolean.class, table);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>代码已经上传到 <a target="_blank" rel="noopener" href="https://github.com/rxliuli/mybatis-plus-sql-injector-example">GitHub</a></p>
</blockquote>
<p>虽然只是个不起眼的小错误，不过这里还是记录一下吧，毕竟坑只要踩过一次就够了 ┐(￣ヮ￣)┌</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2018/12/10/others/rxliuliBlog/JavaScript/Vue-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E7%80%91%E5%B8%83%E6%B5%81%E7%BB%84%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/12/10/others/rxliuliBlog/JavaScript/Vue-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E7%80%91%E5%B8%83%E6%B5%81%E7%BB%84%E4%BB%B6/" class="post-title-link" itemprop="url">Vue 实现一个简单的瀑布流组件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-12-10 17:16:13" itemprop="dateCreated datePublished" datetime="2018-12-10T17:16:13+08:00">2018-12-10</time>
    </span>


  
    <span id="/2018/12/10/others/rxliuliBlog/JavaScript/Vue-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E7%80%91%E5%B8%83%E6%B5%81%E7%BB%84%E4%BB%B6/" class="post-meta-item leancloud_visitors" data-flag-title="Vue 实现一个简单的瀑布流组件" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="Vue 实现一个简单的瀑布流组件" href="/2018/12/10/others/rxliuliBlog/JavaScript/Vue-%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E7%80%91%E5%B8%83%E6%B5%81%E7%BB%84%E4%BB%B6/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::874aa881dfebf73e19323ed257a5d7ab" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Vue-实现一个简单的瀑布流组件"><a href="#Vue-实现一个简单的瀑布流组件" class="headerlink" title="Vue 实现一个简单的瀑布流组件"></a>Vue 实现一个简单的瀑布流组件</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>在用 Vue 写前端的时候，需要实现无限滚动翻页的功能。因为用到的地方很多，于是便想着抽出一个通用组件。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><blockquote>
<p>实现源码放到了 <a target="_blank" rel="noopener" href="https://github.com/rxliuli/vue-waterfalls-flow">GitHub</a>，<a target="_blank" rel="noopener" href="https://vue-waterfalls-flow.rxliuli.com/">Demo 演示</a> 想直接看源码&#x2F;效果的人可以直接去看</p>
</blockquote>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><ol>
<li>定义一个 vuejs 容器组件</li>
<li>抽离出公共的属性（加载一页数据的函数&#x2F;每个元素的模板）</li>
<li>在父容器中遍历每个元素并绑定到传入的模板上</li>
<li>监听滚动事件，如果不是最后一页就加载下一页</li>
<li>重新渲染集合元素</li>
</ol>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>定义模板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">自定义瀑布流组件</span><br><span class="line">使用方法如下：</span><br><span class="line">&lt;rx-waterfalls-flow :load=&quot;load&quot;&gt;</span><br><span class="line">    &lt;!-- 这里 slotProps 绑定的便是子组件的数据，通过 slotProps 可以访问到子组件绑定到模板上的数据，当然，更简单的方法是使用 ES6 的解构 --&gt;</span><br><span class="line">    &lt;template slot-scope=&quot;&#123;item&#125;&quot;&gt;</span><br><span class="line">  &lt;!-- 在模板里面便可以使用集合中的元素 item 了 --&gt;</span><br><span class="line">  &lt;li :key=&quot;item.id&quot;&gt;</span><br><span class="line">    &#123;&#123;item.text&#125;&#125;</span><br><span class="line">  &lt;/li&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">  &lt;/rx-waterfalls-flow&gt;</span><br><span class="line"> */</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=&quot;rx-waterfalls-flow-container&quot;&gt;</span><br><span class="line">    &lt;slot</span><br><span class="line">      v-for=&quot;item in items&quot;</span><br><span class="line">      :item=&quot;item&quot;</span><br><span class="line">    /&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  props: &#123;</span><br><span class="line">    load: &#123;</span><br><span class="line">      type: Function,</span><br><span class="line">      default: function () &#123;</span><br><span class="line">        throw new Error(&#x27;你需要为 RxWaterfallsFlow 组件定义分页加载的参数&#x27;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  data: () =&gt; (&#123;</span><br><span class="line">    items: [],</span><br><span class="line">    page: &#123;</span><br><span class="line">      total: 0,</span><br><span class="line">      size: 10,</span><br><span class="line">      pages: 10,</span><br><span class="line">      current: 1,</span><br><span class="line">      records: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;),</span><br><span class="line">  methods: &#123;</span><br><span class="line">    async loadPage (current, size) &#123;</span><br><span class="line">      this.page = await this.load(current, size)</span><br><span class="line">      this.items.push(...this.page.records)</span><br><span class="line">      this.page.records = []</span><br><span class="line">    &#125;,</span><br><span class="line">    /**</span><br><span class="line">     * 初始化方法，加载第一页的数据，加载监听器</span><br><span class="line">     */</span><br><span class="line">    async init () &#123;</span><br><span class="line">      this.loadPage()</span><br><span class="line">      // 绑定窗口滚动事件</span><br><span class="line">      // 获得文档高度和滚动高度</span><br><span class="line">      // 计算是否已经到底了</span><br><span class="line">      // 到底的话就加载下一页的数据，否则忽略</span><br><span class="line">      const otherOnscrollFn = document.onscroll ? document.onscroll : function () &#123; &#125;</span><br><span class="line">      document.onscroll = () =&gt; &#123;</span><br><span class="line">        otherOnscrollFn()</span><br><span class="line">        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop</span><br><span class="line">        const clientHeight = document.documentElement.clientHeight</span><br><span class="line">        const scrollHeight = document.documentElement.scrollHeight</span><br><span class="line">        // console.log(`已滚动的高度：$&#123;scrollTop&#125;, 滚动条高度：$&#123;scrollHeight&#125;, $&#123;clientHeight&#125;`)</span><br><span class="line">        // 向下滚动时判断判断是否正在向上滚动，是的话就清除定时器，停在当前位置</span><br><span class="line">        if (scrollHeight - scrollTop - clientHeight &lt;= 0 &amp;&amp; this.page.current &lt; this.page.pages) &#123;</span><br><span class="line">          this.loadPage(this.page.current + 1, this.page.size)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  mounted () &#123;</span><br><span class="line">    this.init()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">/* 容器宽度要占 100% */</span><br><span class="line">#rx-waterfalls-flow-container &#123;</span><br><span class="line">  width: 100%;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>使用起来就很简单了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;rx-waterfalls-flow :load=&quot;load&quot;&gt;</span><br><span class="line">    &lt;!-- 这里 slotProps 绑定的便是子组件的数据，通过 slotProps 可以访问到子组件绑定到模板上的数据，当然，更简单的方法是使用 ES6 的解构 --&gt;</span><br><span class="line">    &lt;!-- 这里面的是你自定义每个元素显示的内容 --&gt;</span><br><span class="line">    &lt;template slot-scope=&quot;&#123;item&#125;&quot;&gt;</span><br><span class="line">      &lt;!-- 在模板里面便可以使用集合中的元素 item 了 --&gt;</span><br><span class="line">      &lt;li</span><br><span class="line">        class=&quot;item-style&quot;</span><br><span class="line">        :key=&quot;item.id&quot;</span><br><span class="line">      &gt;</span><br><span class="line">        &#123;&#123;item.text&#125;&#125;</span><br><span class="line">      &lt;/li&gt;</span><br><span class="line">    &lt;/template&gt;</span><br><span class="line">  &lt;/rx-waterfalls-flow&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">// 引入瀑布流组件</span><br><span class="line">import RxWaterfallsFlow from &#x27;@/components/common/RxWaterfallsFlow&#x27;</span><br><span class="line">import _ from &#x27;lodash&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  components: &#123;</span><br><span class="line">    RxWaterfallsFlow</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    // 使用 Promise 封装 setTimeout，模拟 ajax 的异步造成的延迟</span><br><span class="line">    await: ms =&gt; new Promise(resolve =&gt; setTimeout(resolve, ms)),</span><br><span class="line">    load: (page =&gt; &#123;</span><br><span class="line">      // 该方法用于模拟 ajax 数据加载</span><br><span class="line">      return async function () &#123;</span><br><span class="line">        await this.await(1000)</span><br><span class="line">        console.log(`加载了第 $&#123;page.current&#125; 页，共 $&#123;page.pages&#125; 页`)</span><br><span class="line">        // 使用 lodash 模拟数据</span><br><span class="line">        page.records = _.range(</span><br><span class="line">          (page.current - 1) * page.size + 1,</span><br><span class="line">          (++page.current - 1) * page.size + 1</span><br><span class="line">        )</span><br><span class="line">          .map(i =&gt; (&#123;</span><br><span class="line">            id: i,</span><br><span class="line">            text: `第 $&#123;i&#125; 行内容`</span><br><span class="line">          &#125;))</span><br><span class="line">        return page</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)(&#123;</span><br><span class="line">      current: 1,</span><br><span class="line">      size: 10,</span><br><span class="line">      pages: 100,</span><br><span class="line">      total: this.current * this.pages,</span><br><span class="line">      records: []</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">li &#123;</span><br><span class="line">  width: 500px;</span><br><span class="line">  height: 200px;</span><br><span class="line">  line-height: 200px;</span><br><span class="line">  background-color: aqua;</span><br><span class="line">  margin: 10px auto;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<h3 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h3><p>目前这个简单的瀑布流公用组件还有着相当多的缺陷，却是要等到后面再进行改进了呢</p>
<ul>
<li>没有 DOM 回收机制，会造成 DOM 树越来越大，网页就会变得越来越卡（Twitter 就是这样）</li>
<li>没有一键回到顶部的功能，毕竟翻了太久的话回到顶部很麻烦呢</li>
<li>自定义属性还是不够，例如一页的数据的条数，最大页数什么的</li>
</ul>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/24/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><span class="page-number current">25</span><a class="page-number" href="/page/26/">26</a><span class="space">&hellip;</span><a class="page-number" href="/page/33/">33</a><a class="extend next" rel="next" href="/page/26/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ftq</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">1.5m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">22:57</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.1.0/lib/anime.min.js"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




<script src="/js/third-party/sakuraPlus.js"></script>
<script src="/js/third-party/fireworks.js"></script>
<script src="/js/third-party/mouse_slide.js"></script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"6NuBzi5VSiFfQE2sYbymtv9t-gzGzoHsz","app_key":"stH9SzRt55d1wnwQD7LcoaQR","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<script class="next-config" data-name="changyan" type="application/json">{"enable":true,"appid":"cyw21b1ST","appkey":"045a89927c13c0e33a82c736b468fe51"}</script>
<script src="/js/third-party/comments/changyan.js"></script>

</body>
</html>
