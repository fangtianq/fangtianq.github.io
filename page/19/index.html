<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"fangtianq.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"changyan","storage":false,"lazyload":false,"nav":null,"activeClass":"changyan"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="有志者事竟成">
<meta property="og:type" content="website">
<meta property="og:title" content="越努力，越幸运！">
<meta property="og:url" content="https://fangtianq.github.io/page/19/index.html">
<meta property="og:site_name" content="越努力，越幸运！">
<meta property="og:description" content="有志者事竟成">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ftq">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://fangtianq.github.io/page/19/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/19/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>越努力，越幸运！</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">越努力，越幸运！</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Where there is a will, there is a way!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">56</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">21</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">314</span></a></li><li class="menu-item menu-item-留言版"><a href="/guestbook/" rel="section"><i class="comments fa-fw"></i>留言版</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li><li class="menu-item menu-item-friendlink"><a href="/friendlink/" rel="section"><i class="link fa-fw"></i>友链</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ftq"
      src="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
  <p class="site-author-name" itemprop="name">ftq</p>
  <div class="site-description" itemprop="description">有志者事竟成</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">314</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">56</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/fangtianq" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;fangtianq" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://gitee.com/fangtianq" title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;fangtianq" rel="noopener" target="_blank"><i class="github fa-fw"></i>Gitee</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://fangtianq.github.io/" title="GitHub.io → https:&#x2F;&#x2F;fangtianq.github.io&#x2F;"><i class="github fa-fw"></i>GitHub.io</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://fangtianq.gitee.io/" title="Gitee.io → https:&#x2F;&#x2F;fangtianq.gitee.io&#x2F;" rel="noopener" target="_blank"><i class="github fa-fw"></i>Gitee.io</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://leetcode-cn.com/" title="https:&#x2F;&#x2F;leetcode-cn.com&#x2F;" rel="noopener" target="_blank">力扣网</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="http://rap2.taobao.org/" title="http:&#x2F;&#x2F;rap2.taobao.org&#x2F;" rel="noopener" target="_blank">RAP2接口管理平台</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/06/20/others/rxliuliBlog/Essay/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E6%97%A0%E6%B3%95%E7%BB%B4%E6%8A%A4%E7%9A%84%E4%BB%A3%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/20/others/rxliuliBlog/Essay/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E6%97%A0%E6%B3%95%E7%BB%B4%E6%8A%A4%E7%9A%84%E4%BB%A3%E7%A0%81/" class="post-title-link" itemprop="url">如何编写无法维护的代码</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2019-06-20 08:40:53 / 修改时间：00:00:00" itemprop="dateCreated datePublished" datetime="2019-06-20T08:40:53+08:00">2019-06-20</time>
    </span>


  
    <span id="/2019/06/20/others/rxliuliBlog/Essay/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E6%97%A0%E6%B3%95%E7%BB%B4%E6%8A%A4%E7%9A%84%E4%BB%A3%E7%A0%81/" class="post-meta-item leancloud_visitors" data-flag-title="如何编写无法维护的代码" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="如何编写无法维护的代码" href="/2019/06/20/others/rxliuliBlog/Essay/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E6%97%A0%E6%B3%95%E7%BB%B4%E6%8A%A4%E7%9A%84%E4%BB%A3%E7%A0%81/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::29a533ce98aa1756df63a21181d95c31" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>17k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>16 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="如何编写无法维护的代码"><a href="#如何编写无法维护的代码" class="headerlink" title="如何编写无法维护的代码"></a>如何编写无法维护的代码</h1><blockquote>
<p>屁股决定脑袋</p>
</blockquote>
<h2 id="让自己稳拿铁饭碗；"><a href="#让自己稳拿铁饭碗；" class="headerlink" title="让自己稳拿铁饭碗；-)"></a>让自己稳拿铁饭碗；-)</h2><blockquote>
<p>转自 <a target="_blank" rel="noopener" href="https://coderlmn.github.io/frontEndCourse/unmaintainable.html?hmsr=toutiao.io">https://coderlmn.github.io/frontEndCourse/unmaintainable.html?hmsr=toutiao.io</a>，这里仅修复了部分错别字，优化了代码显示。<br><strong>–Roedy Green</strong>（老码农翻译，略有删节）</p>
</blockquote>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote>
<p>永远不要（把自己遇到的问题）归因于（他人的）恶意，这恰恰说明了（你自己的）无能。– 拿破仑</p>
</blockquote>
<p>为了造福大众，在 Java 编程领域创造就业机会，兄弟我在此传授大师们的秘籍。这些大师写的代码极其难以维护，后继者就是想对它做最简单的修改都需要花上数年时间。而且，如果你能对照秘籍潜心修炼，你甚至可以给自己弄个铁饭碗，因为除了你之外，没人能维护你写的代码。再而且，如果你能练就秘籍中的<strong>全部</strong>招式，那么连你自己都无法维护你的代码了！</p>
<p>你不想练功过度走火入魔吧。那就不要让你的代码<strong>一眼看去</strong>就完全无法维护，只要它<strong>实质上是</strong>那样就行了。否则，你的代码就有被重写或重构的风险！</p>
<h2 id="总体原则"><a href="#总体原则" class="headerlink" title="总体原则"></a>总体原则</h2><blockquote>
<p><em>Quidquid latine dictum sit, altum sonatur.</em><br>(随便用拉丁文写点啥都会显得高大上。)</p>
</blockquote>
<p>想挫败维护代码的程序员，你必须先明白他的思维方式。他接手了你的庞大程序，没有时间把它全部读一遍，更别说理解它了。他无非是想快速找到修改代码的位置、改代码、编译，然后就能交差，并希望他的修改不会出现意外的副作用。</p>
<p>他查看你的代码不过是管中窥豹，一次只能看到一小段而已。你要确保他永远看不到全貌。要尽量和让他难以找到他想找的代码。但更重要的是，要让他不能有把握<strong>忽略</strong>任何东西。</p>
<p>程序员都被编程惯例洗脑了，还为此自鸣得意。每一次你处心积虑地违背编程惯例，都会迫使他必须用放大镜去仔细阅读你的每一行代码。</p>
<p>你可能会觉得每个语言特性都可以用来让代码难以维护，其实不然。你必须精心地误用它们才行。</p>
<h2 id="命名"><a href="#命名" class="headerlink" title="命名"></a>命名</h2><blockquote>
<p>“当我使用一个单词的时候” Humpty Dumpty 曾经用一种轻蔑的口气说，” 它就是我想表达的意思，不多也不少。“<br>- Lewis Carroll – 《爱丽丝魔镜之旅》， 第 6 章</p>
</blockquote>
<p>编写无法维护代码的技巧的重中之重是变量和方法命名的艺术。如何命名是和编译器无关的。这就让你有巨大的自由度去利用它们迷惑维护代码的程序员。</p>
<h3 id="妙用宝宝起名大全"><a href="#妙用宝宝起名大全" class="headerlink" title="妙用宝宝起名大全"></a>妙用宝宝起名大全</h3><p>买本宝宝起名大全，你就永远不缺变量名了。比如 <code>Fred</code> 就是个好名字，而且键盘输入它也省事。如果你就想找一些容易输入的变量名，可以试试 <code>adsf</code> 或者 <code>aoeu</code> 之类。</p>
<h3 id="单字母变量名"><a href="#单字母变量名" class="headerlink" title="单字母变量名"></a>单字母变量名</h3><p>如果你给变量起名为 a,b,c，用简单的文本编辑器就没法搜索它们的引用。而且，没人能猜到它们的含义。</p>
<h3 id="创造性的拼写错误"><a href="#创造性的拼写错误" class="headerlink" title="创造性的拼写错误"></a>创造性的拼写错误</h3><p>如果你必须使用描述性的变量和函数名，那就把它们都拼错。还可以把某些函数和变量名拼错，再把其他的拼对 (例如 SetPintleOpening 和 SetPintalClosing) ，我们就能有效地将 grep 或 IDE 搜索技术玩弄于股掌之上。这招超级管用。还可以混淆不同语言（比如 colour – 英国英语，和 color – 美国英语)。</p>
<h3 id="抽象"><a href="#抽象" class="headerlink" title="抽象"></a>抽象</h3><p>在命名函数和变量的时候，充分利用抽象单词，例如 it, everything, data, handle, stuff, do, routine, perform 和数字，例如 e.g. <code>routineX48</code>, <code>PerformDataFunction</code>, <code>DoIt</code>, <code>HandleStuff</code> 还有 <code>do_args_method。</code></p>
<h3 id="首字母大写的缩写"><a href="#首字母大写的缩写" class="headerlink" title="首字母大写的缩写"></a>首字母大写的缩写</h3><p>用首字母大写缩写（比如 GNU 代表 GNU’s Not Unix) 使代码简洁难懂。真正的汉子 (无论男女) 从来不说明这种缩写的含义，他们生下来就懂。</p>
<h3 id="辞典大轮换"><a href="#辞典大轮换" class="headerlink" title="辞典大轮换"></a>辞典大轮换</h3><p>为了打破沉闷的编程气氛，你可以用一本辞典来查找尽量多的同义词。例如 display, show, present。在注释里含糊其辞地暗示这些命名之间有细微的差别，其实根本没有。不过，如果有两个命名相似的函数真的有重大差别，那倒是一定要确保它们用相同的单词来命名 (例如，对于 “写入文件”, “在纸上书写” 和 “屏幕显示” 都用 print 来命名)。 在任何情况下都不要屈服于编写明确的项目词汇表这种无理要求。你可以辩解说，这种要求是一种不专业的行为，它违反了结构化设计的 _信息隐藏原则_。</p>
<h3 id="首字母大写"><a href="#首字母大写" class="headerlink" title="首字母大写"></a>首字母大写</h3><p>随机地把单词中间某个音节的首字母大写。例如 <code>ComputeReSult()</code>。</p>
<h3 id="重用命名"><a href="#重用命名" class="headerlink" title="重用命名"></a>重用命名</h3><p>在语言规则允许的地方，尽量把类、构造器、方法、成员变量、参数和局部变量都命名成一样。更高级的技巧是在 {} 块中重用局部变量。这样做的目的是迫使维护代码的程序员认真检查每个示例的范围。特别是在 Java 代码中，可以把普通方法伪装成构造器。</p>
<h3 id="使用非英语字母"><a href="#使用非英语字母" class="headerlink" title="使用非英语字母"></a>使用非英语字母</h3><p>在命名中偷偷使用不易察觉的非英语字母，例如</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef <span class="keyword">struct</span> &#123; <span class="built_in">int</span> i; &#125; ínt;</span><br></pre></td></tr></table></figure>

<p>看上去没啥不对是吧？嘿嘿嘿… 这里的第二个 ínt 的 <code>í</code> 实际上是东北欧字母，并不是英语中的 <code>i</code>。在简单的文本编辑器里，想看出这一点点区别几乎是不可能的。</p>
<h3 id="巧妙利用编译器对于命名长度的限制"><a href="#巧妙利用编译器对于命名长度的限制" class="headerlink" title="巧妙利用编译器对于命名长度的限制"></a>巧妙利用编译器对于命名长度的限制</h3><p>如果编译器只区分命名的前几位，比如前 8 位，那么就把后面的字母写得不一样。比如，其实是同一个变量，有时候写成 <code>var_unit_update()</code>，有时候又写成 <code>var_unit_setup()</code>，看起来是两个不同的函数调用。而在编译的时候，它们其实是同一个变量 <code>var_unit</code>。</p>
<h3 id="下划线，一位真正的朋友"><a href="#下划线，一位真正的朋友" class="headerlink" title="下划线，一位真正的朋友"></a>下划线，一位真正的朋友</h3><p>可以拿 _ 和 __ 作为标示符。</p>
<h3 id="混合多语言"><a href="#混合多语言" class="headerlink" title="混合多语言"></a>混合多语言</h3><p>随机地混用两种语言（人类语言或计算机语言都行）。如果老板要求使用他指定的语言，你就告诉他你用自己的语言更有利于组织你的思路，万一这招不管用，就去控诉这是语言歧视，并威胁起诉老板要求巨额精神损失赔偿。</p>
<h3 id="扩展-ASCII-字符"><a href="#扩展-ASCII-字符" class="headerlink" title="扩展 ASCII 字符"></a>扩展 ASCII 字符</h3><p>扩展 ASCII 字符用于变量命名是完全合法的，包括 ß, Ð, 和 ñ 等。在简单的文本编辑器里，除了拷贝&#x2F;粘贴，基本上没法输入。</p>
<h3 id="其他语言的命名"><a href="#其他语言的命名" class="headerlink" title="其他语言的命名"></a>其他语言的命名</h3><p>使用外语字典作为变量名的来源。例如，可以用德语单词 <em>punkt</em> 代替 _point_。除非维护代码的程序员也像你一样熟练掌握了德语。不然他就只能尽情地在代码中享受异域风情了。</p>
<h3 id="数学命名"><a href="#数学命名" class="headerlink" title="数学命名"></a>数学命名</h3><p>用数学操作符的单词来命名变量。例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">openParen = (slash + asterix) / equals;</span><br><span class="line">(左圆括号 = (斜杠 + 星号)/ 等号；)</span><br></pre></td></tr></table></figure>

<h3 id="令人眩晕的命名"><a href="#令人眩晕的命名" class="headerlink" title="令人眩晕的命名"></a>令人眩晕的命名</h3><p>用带有完全不相关的感情色彩的单词来命名变量。例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">marypoppins = (superman + starship) / god;</span><br><span class="line">(欢乐满人间 = (超人 + 星河战队)/ 上帝；)</span><br></pre></td></tr></table></figure>

<p>这一招可以让阅读代码的人陷入迷惑之中，因为他们在试图想清楚这些命名的逻辑时，会不自觉地联系到不同的感情场景里而无法自拔。</p>
<h3 id="何时使用-i"><a href="#何时使用-i" class="headerlink" title="何时使用 i"></a>何时使用 i</h3><p>永远不要把 <code>i</code> 用作最内层的循环变量。 用什么命名都行，就是别用 <code>i</code>。把 <code>i</code> 用在其他地方就随便了，用作非整数变量尤其好。</p>
<h3 id="惯例-–-明修栈道，暗度陈仓"><a href="#惯例-–-明修栈道，暗度陈仓" class="headerlink" title="惯例 – 明修栈道，暗度陈仓"></a>惯例 – 明修栈道，暗度陈仓</h3><p>忽视 <a target="_blank" rel="noopener" href="http://java.sun.com/docs/codeconv/">Java 编码惯例</a>，Sun 就是这样做的。幸运的是，你违反了它编译器也不会打小报告。这一招的目的是搞出一些在某些特殊情况下有细微差别的名字来。如果你被强迫遵循驼峰法命名，你还是可以在某些模棱两可的情况下颠覆它。例如， <em>inputFilename</em> 和 <em>inputfileName</em> 两个命名都可以合法使用。在此基础上自己发明一套复杂到变态的命名惯例，然后就可以痛扁其他人，说他们违反了惯例。</p>
<h3 id="小写的-l-看上去很像数字-1"><a href="#小写的-l-看上去很像数字-1" class="headerlink" title="小写的 l 看上去很像数字 1"></a>小写的 l 看上去很像数字 1</h3><p>用小写字母 l 标识 long 常数。例如 10l 更容易被误认为是 101 而不是 10L 。 禁用所有能让人准确区分 uvw wW gq9 2z 5s il17|!j oO08 &#96;’” ;,. m nn rn {[()]} 的字体。要做个有创造力的人。</p>
<h3 id="把全局命名重用为私有"><a href="#把全局命名重用为私有" class="headerlink" title="把全局命名重用为私有"></a>把全局命名重用为私有</h3><p>在 A 模块里声明一个全局数组，然后在 B 模块的头文件里在声明一个同名的私有数组，这样看起来你在 B 模块里引用的是那个全局数组，其实却不是。不要在注释里提到这个重复的情况。</p>
<h3 id="误导性的命名"><a href="#误导性的命名" class="headerlink" title="误导性的命名"></a>误导性的命名</h3><p>让每个方法都和它的名字蕴含的功能有一些差异。例如，一个叫 <code>isValid(x)</code> 的方法在判断完参数 x 的合法性之后，还顺带着把它转换成二进制并保存到数据库里。</p>
<h2 id="伪装"><a href="#伪装" class="headerlink" title="伪装"></a>伪装</h2><blockquote>
<p>当一个 bug 需要越长的时间才会暴露，它就越难被发现。<br>- Roedy Green（本文作者）</p>
</blockquote>
<p>编写无法维护代码的另一大秘诀就是伪装的艺术，即隐藏它或者让它看起来像其他东西。很多招式有赖于这样一个事实：编译器比肉眼或文本编辑器更有分辨能力。下面是一些伪装的最佳招式。</p>
<h3 id="把代码伪装成注释，反之亦然"><a href="#把代码伪装成注释，反之亦然" class="headerlink" title="把代码伪装成注释，反之亦然"></a>把代码伪装成注释，反之亦然</h3><p>下面包括了一些被注释掉的代码，但是一眼看去却像是正常代码。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(j=<span class="number">0</span>; j&lt;array_len; j+ =<span class="number">8</span>)</span><br><span class="line">  &#123;</span><br><span class="line">  total += array[j+<span class="number">0</span> ];</span><br><span class="line">  total += array[j+<span class="number">1</span> ];</span><br><span class="line">  total += array[j+<span class="number">2</span> ]; <span class="comment">/* Main body of</span></span><br><span class="line"><span class="comment">  total += array[j+3]; * loop is unrolled</span></span><br><span class="line"><span class="comment">  total += array[j+4]; * for greater speed.</span></span><br><span class="line"><span class="comment">  total += array[j+5]; */</span></span><br><span class="line">  total += array[j+<span class="number">6</span> ];</span><br><span class="line">  total += array[j+<span class="number">7</span> ];</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>如果不是用绿色标出来，你能注意到这三行代码被注释掉了么？</p>
<h3 id="用连接符隐藏变量"><a href="#用连接符隐藏变量" class="headerlink" title="用连接符隐藏变量"></a>用连接符隐藏变量</h3><p>对于下面的定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> local_var xy_z</span></span><br></pre></td></tr></table></figure>

<p>可以把 “xy_z” 打散到两行里：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> local_var xy\</span></span><br><span class="line"><span class="meta">_z <span class="comment">// local_var OK</span></span></span><br></pre></td></tr></table></figure>

<p>这样全局搜索 xy_z 的操作在这个文件里就一无所获了。 对于 C 预处理器来说，第一行最后的 “&quot; 表示继续拼接下一行的内容。</p>
<h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><blockquote>
<p>任何傻瓜都能说真话，而要把谎编圆则需要相当的智慧。<br>- Samuel Butler (1835 - 1902)</p>
<p>不正确的文档往往比没有文档还糟糕。<br>- Bertrand Meyer</p>
</blockquote>
<p>既然计算机是忽略注释和文档的，你就可以在里边堂而皇之地编织弥天大谎，让可怜的维护代码的程序员彻底迷失。</p>
<h3 id="在注释中撒谎"><a href="#在注释中撒谎" class="headerlink" title="在注释中撒谎"></a>在注释中撒谎</h3><p>实际上你不需要主动地撒谎，只要没有及时保持注释和代码更新的一致性就可以了。</p>
<h3 id="只记录显而易见的东西"><a href="#只记录显而易见的东西" class="headerlink" title="只记录显而易见的东西"></a>只记录显而易见的东西</h3><p>往代码里掺进去类似于 <code>/* 给 i 加 1 */</code> 这样的注释，但是永远不要记录包或者方法的整体设计这样的干货。</p>
<h3 id="记录-How-而不是-Why"><a href="#记录-How-而不是-Why" class="headerlink" title="记录 How 而不是 Why"></a>记录 How 而不是 Why</h3><p>只解释一个程序功能的细节，而不是它要完成的任务是什么。这样的话，如果出现了一个 bug，修复者就搞不清这里的代码应有的功能。</p>
<h3 id="该写的别写"><a href="#该写的别写" class="headerlink" title="该写的别写"></a>该写的别写</h3><p>比如你在开发一套航班预定系统，那就要精心设计，让它在增加另一个航空公司的时候至少有 25 处代码需要修改。永远不要在文档里说明要修改的位置。后来的开发人员要想修改你的代码门都没有，除非他们能把每一行代码都读懂。</p>
<h3 id="计量单位"><a href="#计量单位" class="headerlink" title="计量单位"></a>计量单位</h3><p>永远不要在文档中说明任何变量、输入、输出或参数的计量单位，如英尺、米、加仑等。计量单位对数豆子不是太重要，但在工程领域就相当重要了。同理，永远不要说明任何转换常量的计量单位，或者是它的取值如何获得。要想让代码更乱的话，你还可以在注释里写上错误的计量单位，这是赤裸裸的欺骗，但是非常有效。如果你想做一个恶贯满盈的人，不妨自己发明一套计量单位，用自己或某个小人物的名字命名这套计量单位，但不要给出定义。万一有人挑刺儿，你就告诉他们，你这么做是为了把浮点数运算凑成整数运算而进行的转换。</p>
<h3 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h3><p>永远不要记录代码中的坑。如果你怀疑某个类里可能有 bug，天知地知你知就好。如果你想到了重构或重写代码的思路，看在老天爷的份上，千万别写出来。切记电影《小鹿斑比》里那句台词 “如果你不能说好听的话，那就什么也不要说。”。万一这段代码的原作者看到你的注释怎么办？万一老板看到了怎么办？万一客户看到了怎么办？搞不好最后你自己被解雇了。一句” 这里需要修改 “的匿名注释就好多了，尤其是当看不清这句注释指的是哪里需要修改的情况下。切记难得糊涂四个字，这样大家都不会感觉受到了批评。</p>
<h3 id="说明变量"><a href="#说明变量" class="headerlink" title="说明变量"></a>说明变量</h3><p>永远不要 对变量声明加注释。有关变量使用的方式、边界值、合法值、小数点后的位数、计量单位、显示格式、数据录入规则等等，后继者完全可以自己从程序代码中去理解和整理嘛。如果老板强迫你写注释，就把方法体代码混进去，但绝对不要对变量声明写注释，即使是临时变量！</p>
<h3 id="在注释里挑拨离间"><a href="#在注释里挑拨离间" class="headerlink" title="在注释里挑拨离间"></a>在注释里挑拨离间</h3><p>为了阻挠任何雇佣外部维护承包商的倾向，可以在代码中散布针对其他同行软件公司的攻击和抹黑，特别是可能接替你工作的其中任何一家。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 优化后的内层循环</span></span><br><span class="line"><span class="comment">这套技巧对于 SSI 软件服务公司的那帮蠢材来说太高深了，他们只会</span></span><br><span class="line"><span class="comment">用 &lt;math.h&gt; 里的笨例程，消耗 50 倍的内存和处理时间。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">clever_SSInc</span></span><br><span class="line">    &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>可能的话，除了注释之外，这些攻击抹黑的内容也要掺到代码里的重要部分，这样如果管理层想清理掉这些攻击性的言论然后发给外部承包商去维护，就会破坏代码结构。</p>
<h2 id="程序设计"><a href="#程序设计" class="headerlink" title="程序设计"></a>程序设计</h2><blockquote>
<p>编写无法维护代码的基本规则就是：在尽可能多的地方，以尽可能多的方式表述每一个事实。<br>- Roedy Green<br>编写可维护代码的关键因素是只在一个地方表述应用里的一个事实。如果你的想法变了，你也只在一个地方修改，这样就能保证整个程序正常工作。所以，编写无法维护代码的关键因素就是反复地表述同一个事实，在尽可能多的地方，以尽可能多的方式进行。令人高兴的是，像 Java 这样的语言让编写这种无法维护代码变得非常容易。例如，改变一个被引用很多的变量的类型几乎是不可能的，因为所有造型和转换功能都会出错，而且关联的临时变量的类型也不合适了。而且，如果变量值要在屏幕上显示，那么所有相关的显示和数据录入代码都必须一一找到并手工进行修改。类似的还有很多，比如由 C 和 Java 组成的 Algol 语言系列，Abundance 甚至 Smalltalk 对于数组等结构的处理，都是大有可为的。</p>
</blockquote>
<h3 id="Java-类型"><a href="#Java-类型" class="headerlink" title="Java 类型"></a>Java 类型</h3><p>Java 的类型机制是上帝的礼物。你可以问心无愧地使用它，因为 Java 语言本身就需要它。每次你从一个 Collection 里获取一个对象，你都必须把它造型为原始类型。这样这个变量的类型就必须在无数地方表述。如果后来类型变了，所有的造型都要修改才能匹配。如果倒霉的维护代码的程序员没有找全（或者修改太多），编译器能不能检测到也不好说。类似的，如果变量类型从 <code>short</code> 变成 <code>int</code>，所有匹配的造型也都要从 <code>(short)</code>改成 <code>(int)</code>。</p>
<h3 id="利用-Java-的冗余"><a href="#利用-Java-的冗余" class="headerlink" title="利用 Java 的冗余"></a>利用 Java 的冗余</h3><p>Java 要求你给每个变量的类型写两次表述。 Java 程序员已经习惯了这种冗余，他们不会注意到你的两次表述有细微的差别，例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Bubblegum</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bubblegom</span>();</span><br></pre></td></tr></table></figure>

<p>不幸的是 ++ 操作符的盛行让下面这种伪冗余代码得手的难度变大了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swimmer = swimner + <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="永远不做校验"><a href="#永远不做校验" class="headerlink" title="永远不做校验"></a>永远不做校验</h3><p>永远不要对输入数据做任何的正确性或差异性检查。这样能表现你对公司设备的绝对信任，以及你是一位信任所有项目伙伴和系统管理员的团队合作者。总是返回合理的值，即使数据输入有问题或者错误。</p>
<h3 id="有礼貌，无断言"><a href="#有礼貌，无断言" class="headerlink" title="有礼貌，无断言"></a>有礼貌，无断言</h3><p>避免使用 assert() 机制，因为它可能把三天的 debug 盛宴变成 10 分钟的快餐。</p>
<h3 id="避免封装"><a href="#避免封装" class="headerlink" title="避免封装"></a>避免封装</h3><p>为了提高效率，不要使用封装。方法的调用者需要所有能得到的外部信息，以便了解方法的内部是如何工作的。</p>
<h3 id="复制粘贴修改"><a href="#复制粘贴修改" class="headerlink" title="复制粘贴修改"></a>复制粘贴修改</h3><p>以效率的名义，使用 复制 + 粘贴 + 修改。这样比写成小型可复用模块效率高得多。在用代码行数衡量你的进度的小作坊里，这招尤其管用。</p>
<h3 id="使用静态数组"><a href="#使用静态数组" class="headerlink" title="使用静态数组"></a>使用静态数组</h3><p>如果一个库里的模块需要一个数组来存放图片，就定义一个静态数组。没人会有比 512 X 512 更大的图片，所以固定大小的数组就可以了。为了最佳精度，就把它定义成 double 类型的数组。</p>
<h3 id="傻瓜接口"><a href="#傻瓜接口" class="headerlink" title="傻瓜接口"></a>傻瓜接口</h3><p>编写一个名为 “WrittenByMe” 之类的空接口，然后让你的所有类都实现它。然后给所有你用到的 Java 内置类编写包装类。这里的思想是确保你程序里的每个对象都实现这个接口。最后，编写所有的方法，让它们的参数和返回类型都是这个 WrittenByMe。这样就几乎不可能搞清楚某个方法的功能是什么，并且所有类型都需要好玩的造型方法。更出格的玩法是，让每个团队成员编写它们自己的接口 (例如 WrittenByJoe)，程序员用到的任何类都要实现他自己的接口。这样你就可以在大量无意义接口中随便找一个来引用对象了。</p>
<h3 id="巨型监听器"><a href="#巨型监听器" class="headerlink" title="巨型监听器"></a>巨型监听器</h3><p>永远不要为每个组件创建分开的监听器。对所有按钮总是用同一个监听器，只要用大量的 if…else 来判断是哪一个按钮被点击就行了。</p>
<p>好事成堆 TM<br>狂野地使用封装和 OO 思想。例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">myPanel.add( getMyButton() );</span><br><span class="line"><span class="keyword">private</span> JButton <span class="title function_">getMyButton</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">return</span> myButton;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这段很可能看起来不怎么好笑。别担心，只是时候未到而已。</p>
<h3 id="友好的朋友"><a href="#友好的朋友" class="headerlink" title="友好的朋友"></a>友好的朋友</h3><p>在 C++ 里尽量多使用 friend 声明。再把创建类的指针传递给已创建类。现在你不用浪费时间去考虑接口了。另外，你应该用上关键字 private 和 protected 来表明你的类封装得很好。</p>
<h3 id="使用三维数组"><a href="#使用三维数组" class="headerlink" title="使用三维数组"></a>使用三维数组</h3><p>大量使用它们。用扭曲的方式在数组之间移动数据，比如，用 arrayA 里的行去填充 arrayB 的列。这么做的时候，不管三七二十一再加上 1 的偏移值，这样很灵。让维护代码的程序员抓狂去吧。</p>
<h3 id="混合与匹配"><a href="#混合与匹配" class="headerlink" title="混合与匹配"></a>混合与匹配</h3><p>存取方法和公共变量神马的都要给他用上。这样的话，你无需调用存取器的开销就可以修改一个对象的变量，还能宣称这个类是个 “Java Bean”。对于那些试图添加日志函数来找出改变值的源头的维护代码的程序员，用这一招来迷惑他尤其有效。</p>
<h3 id="没有秘密"><a href="#没有秘密" class="headerlink" title="没有秘密"></a>没有秘密</h3><p>把每个方法和变量都声明为 public。毕竟某个人某天可能会需要用到它。一旦方法被声明为 public 了，就很难缩回去。对不？这样任何它覆盖到的代码都很难修改了。它还有个令人愉快的副作用，就是让你看不清类的作用是什么。如果老板质问你是不是疯了，你就告诉他你遵循的是经典的透明接口原则。</p>
<h3 id="全堆一块"><a href="#全堆一块" class="headerlink" title="全堆一块"></a>全堆一块</h3><p>把你所有的没用的和过时的方法和变量都留在代码里。毕竟说起来，既然你在 1976 年用过一次，谁知道你啥时候会需要再用到呢？当然程序是改了，但它也可能会改回来嘛，你 “不想要重新发明轮子”（领导们都会喜欢这样的口气）。如果你还原封不动地留着这些方法和变量的注释，而且注释写得又高深莫测，甭管维护代码的是谁，恐怕都不敢对它轻举妄动。</p>
<h3 id="就是-Final"><a href="#就是-Final" class="headerlink" title="就是 Final"></a>就是 Final</h3><p>把你所有的叶子类都声明为 final。毕竟说起来，你在项目里的活儿都干完了，显然不会有其他人会通过扩展你的类来改进你的代码。这种情况甚至可能有安全漏洞。 java.lang.String 被定义成 final 也许就是这个原因吧？如果项目组其他程序员有意见，告诉他们这样做能够提高运行速度。</p>
<h3 id="避免布局"><a href="#避免布局" class="headerlink" title="避免布局"></a>避免布局</h3><p>永远不要用到布局。当维护代码的程序员想增加一个字段，他必须手工调整屏幕上显示所有内容的绝对坐标值。如果老板强迫你使用布局，那就写一个巨型的 GridBagLayout 并在里面用绝对坐标进行硬编码。</p>
<h3 id="全局变量，怎么强调都不过分"><a href="#全局变量，怎么强调都不过分" class="headerlink" title="全局变量，怎么强调都不过分"></a>全局变量，怎么强调都不过分</h3><p>如果上帝不愿意我们使用全局变量，他就不会发明出这个东西。不要让上帝失望，尽量多使用全局变量。每个函数最起码都要使用和设置其中的两个，即使没有理由也要这么做。毕竟，任何优秀的维护代码的程序员都会很快搞清楚这是一种侦探工作测试，有利于让他们从笨蛋中脱颖而出。</p>
<h3 id="再一次说说全局变量"><a href="#再一次说说全局变量" class="headerlink" title="再一次说说全局变量"></a>再一次说说全局变量</h3><p>全局变量让你可以省去在函数里描述参数的麻烦。充分利用这一点。在全局变量中选那么几个来表示对其他全局变量进行操作的类型。</p>
<h3 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h3><p>永远不要用局部变量。在你感觉想要用的时候，把它改成一个实例或者静态变量，并无私地和其他方法分享它。这样做的好处是，你以后在其他方法里写类似声明的时候会节省时间。C++ 程序员可以百尺竿头更进一步，把所有变量都弄成全局的。</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>配置文件通常是以 关键字 &#x3D; 值 的形式出现。在加载时这些值被放入 Java 变量中。最明显的迷惑技术就是把有细微差别的名字用于关键字和 Java 变量。甚至可以在配置文件里定义运行时根本不会改变的常量。参数文件变量和简单变量比，维护它的代码量起码是后者的 5 倍。</p>
<h3 id="子类"><a href="#子类" class="headerlink" title="子类"></a>子类</h3><p>对于编写无法维护代码的任务来说，面向对象编程的思想简直是天赐之宝。如果你有一个类，里边有 10 个属性（成员 &#x2F; 方法），可以考虑写一个基类，里面只有一个属性，然后产生 9 层的子类，每层增加一个属性。等你访问到最终的子类时，你才能得到全部 10 个属性。如果可能，把每个类的声明都放在不同的文件里。</p>
<h2 id="编码迷局"><a href="#编码迷局" class="headerlink" title="编码迷局"></a>编码迷局</h2><h3 id="迷惑-C"><a href="#迷惑-C" class="headerlink" title="迷惑 C"></a>迷惑 C</h3><p>从互联网上的各种混乱 C 语言竞赛中学习，追随大师们的脚步。</p>
<h3 id="追求极致"><a href="#追求极致" class="headerlink" title="追求极致"></a>追求极致</h3><p>总是追求用最迷惑的方式来做普通的任务。例如，要用数组来把整数转换为相应的字符串，可以这么做：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *p;</span><br><span class="line"><span class="keyword">switch</span> (n)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    p = <span class="string">&quot;one&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span>)</span><br><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">    p = <span class="string">&quot;two&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span>)</span><br><span class="line"><span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">    p = <span class="string">&quot;three&quot;</span>;</span><br><span class="line">    printf(<span class="string">&quot;%s&quot;</span>, p);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="一致性的小淘气"><a href="#一致性的小淘气" class="headerlink" title="一致性的小淘气"></a>一致性的小淘气</h3><p>当你需要一个字符常量的时候，可以用多种不同格式： ‘ ‘, 32, 0x20, 040。在 C 或 Java 里 10 和 010 是不同的数（0 开头的表示 16 进制），你也可以充分利用这个特性。</p>
<h3 id="造型"><a href="#造型" class="headerlink" title="造型"></a>造型</h3><p>把所有数据都以 void * 形式传递，然后再造型为合适的结构。不用结构而是通过位移字节数来造型也很好玩。</p>
<h3 id="嵌套-Switch"><a href="#嵌套-Switch" class="headerlink" title="嵌套 Switch"></a>嵌套 Switch</h3><p>Switch 里边还有 Switch，这种嵌套方式是人类大脑难以破解的。</p>
<h3 id="利用隐式转化"><a href="#利用隐式转化" class="headerlink" title="利用隐式转化"></a>利用隐式转化</h3><p>牢记编程语言中所有的隐式转化细节。充分利用它们。数组的索引要用浮点变量，循环计数器用字符，对数字执行字符串函数调用。不管怎么说，所有这些操作都是合法的，它们无非是让源代码更简洁而已。任何尝试理解它们的维护者都会对你感激不尽，因为他们必须阅读和学习整个关于隐式数据类型转化的章节，而这个章节很可能是他们来维护你的代码之前完全忽略了的。</p>
<h3 id="分号"><a href="#分号" class="headerlink" title="分号"></a>分号</h3><p>在所有语法允许的地方都加上分号，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(a);</span><br><span class="line"><span class="keyword">else</span>;</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="type">int</span> d;</span><br><span class="line">    d = c;</span><br><span class="line">    &#125;</span><br><span class="line">    ;</span><br></pre></td></tr></table></figure>

<h3 id="使用八进制数"><a href="#使用八进制数" class="headerlink" title="使用八进制数"></a>使用八进制数</h3><p>把八进制数混到十进制数列表里，就像这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">array = <span class="keyword">new</span> <span class="title class_">int</span> []</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="number">111</span>,</span><br><span class="line">    <span class="number">120</span>,</span><br><span class="line">    <span class="number">013</span>,</span><br><span class="line">    <span class="number">121</span>,</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<h3 id="嵌套"><a href="#嵌套" class="headerlink" title="嵌套"></a>嵌套</h3><p>尽可能深地嵌套。优秀的程序员能在一行代码里写 10 层 ()，在一个方法里写 20 层 {}。</p>
<h3 id="C-数组"><a href="#C-数组" class="headerlink" title="C 数组"></a>C 数组</h3><p>C 编译器会把 <code>myArray[i]</code> 转换成 <code>_(myArray + i)</code>，它等同于 <code>_(i + myArray)</code> 也等同于 <code>i[myArray]</code>。 高手都知道怎么用好这个招。可以用下面的函数来产生索引，这样就把代码搞乱了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">myfunc</span><span class="params">(<span class="type">int</span> q, <span class="type">int</span> p)</span> &#123; <span class="keyword">return</span> p%q; &#125;</span><br><span class="line">...</span><br><span class="line">myfunc(<span class="number">6291</span>, <span class="number">8</span>)[Array];</span><br></pre></td></tr></table></figure>

<p>遗憾的是，这一招只能在本地 C 类里用，Java 还不行。</p>
<h3 id="放长线钓大鱼"><a href="#放长线钓大鱼" class="headerlink" title="放长线钓大鱼"></a>放长线钓大鱼</h3><p>一行代码里堆的东西越多越好。这样可以省下临时变量的开销，去掉换行和空格还可以缩短源文件大小。记住，要去掉运算符两边的空格。优秀的程序员总是能突破某些编辑器对于 255 个字符行宽的限制。</p>
<h3 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h3><p>我这里要向你传授一个编程中鲜为人知的秘诀。异常是个讨厌的东西。良好的代码永远不会出错，所以异常实际上是不必要的。不要把时间浪费在这上面。子类异常是给那些知道自己代码会出错的低能儿用的。在整个应用里，你只用在 main () 里放一个 try&#x2F;catch，里边直接调用 System.exit() 就行了。在每个方法头要贴上标准的抛出集合定义，到底会不会抛出异常你就不用管了。</p>
<h3 id="使用异常的时机"><a href="#使用异常的时机" class="headerlink" title="使用异常的时机"></a>使用异常的时机</h3><p>在非异常条件下才要使用异常。比如终止循环就可以用 <code>ArrayIndexOutOfBoundsException</code>。还可以从异常里的方法返回标准的结果。</p>
<h3 id="狂热奔放地使用线程"><a href="#狂热奔放地使用线程" class="headerlink" title="狂热奔放地使用线程"></a>狂热奔放地使用线程</h3><p>如题。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>在程序里留些 bug，让后继的维护代码的程序员能做点有意思的事。精心设计的 bug 是无迹可寻的，而且谁也不知道它啥时候会冒出来。要做到这一点，最简单的办法的就是不要测试代码。</p>
<h3 id="永不测试"><a href="#永不测试" class="headerlink" title="永不测试"></a>永不测试</h3><p>永远不要测试负责处理错误、当机或操作系故障的任何代码。反正这些代码永远也不会执行，只会拖累你的测试。还有，你怎么可能测试处理磁盘错误、文件读取错误、操作系统崩溃这些类型的事件呢？为啥你要用特别不稳定的计算机或者用测试脚手架来模拟这样的环境？现代化的硬件永远不会崩溃，谁还愿意写一些仅仅用于测试的代码？这一点也不好玩。如果用户抱怨，你就怪到操作系统或者硬件头上。他们永远不会知道真相的。</p>
<h3 id="永远不要做性能测试"><a href="#永远不要做性能测试" class="headerlink" title="永远不要做性能测试"></a>永远不要做性能测试</h3><p>嘿，如果软件运行不够快，只要告诉客户买个更快的机器就行了。如果你真的做了性能测试，你可能会发现一个瓶颈，这会导致修改算法，然后导致整个产品要重新设计。谁想要这种结果？而且，在客户那边发现性能问题意味着你可以免费到外地旅游。你只要备好护照和最新照片就行了。</p>
<h3 id="永远不要写任何测试用例"><a href="#永远不要写任何测试用例" class="headerlink" title="永远不要写任何测试用例"></a>永远不要写任何测试用例</h3><p>永远不要做代码覆盖率或路径覆盖率测试。自动化测试是给那些窝囊废用的。搞清楚哪些特性占到你的例程使用率的 90%，然后把 90% 的测试用在这些路径上。毕竟说起来，这种方法可能只测试到了大约你代码的 60%，这样你就节省了 40% 的测试工作。这能帮助你赶上项目后端的进度。等到有人发现所有这些漂亮的 “市场特性” 不能正常工作的时候，你早就跑路了。一些有名的大软件公司就是这样测试代码的，所以你也应该这样做。如果因为某种原因你还没走，那就接着看下一节。</p>
<h3 id="测试是给懦夫用的"><a href="#测试是给懦夫用的" class="headerlink" title="测试是给懦夫用的"></a>测试是给懦夫用的</h3><p>勇敢的程序员会跳过这个步骤。太多程序员害怕他们的老板，害怕丢掉工作，害怕客户的投诉邮件，害怕遭到起诉。这种恐惧心理麻痹了行动，降低了生产率。有科学研究成果表明，取消测试阶段意味着经理有把握能提前确定交付时间，这对于规划流程显然是有利的。消除了恐惧心理，创新和实验之花就随之绽放。程序员的角色是生产代码，调试工作完全可以由技术支持和遗留代码维护组通力合作来进行。</p>
<p>如果我们对自己的编程能力有充分信心，那么测试就没有必要了。如果我们逻辑地看待这个问题，随便一个傻瓜都能认识到测试根本都不是为了解决技术问题，相反，它是一种感性的信心问题。针对这种缺乏信心的问题，更有效的解决办法就是完全取消测试，送我们的程序员去参加自信心培训课程。毕竟说起来，如果我们选择做测试，那么我们就要测试每个程序的变更，但其实我们只需要送程序员去一次建立自信的培训课就行了。很显然这么做的成本收益是相当可观的。</p>
<h2 id="编程语言的选择"><a href="#编程语言的选择" class="headerlink" title="编程语言的选择"></a>编程语言的选择</h2><p>计算机语言正在逐步进化，变得更加傻瓜化。使用最新的语言是不人性的。尽可能坚持使用你会用的最老的语言，先考虑用穿孔纸带，不行就用汇编，再不行用 FORTRAN 或者 COBOL，再不行就用 C 还有 BASIC，实在不行再用 C++。</p>
<h3 id="FORTRAN"><a href="#FORTRAN" class="headerlink" title="FØRTRAN"></a>FØRTRAN</h3><p>用 FORTRAN 写所有的代码。如果老板问你为啥，你可以回答说有很多它非常有用的库，你用了可以节约时间。不过，用 FORTRAN 写出可维护代码的概率是 0，所以，要达到不可维护代码编程指南里的要求就容易多了。</p>
<h3 id="用-ASM"><a href="#用-ASM" class="headerlink" title="用 ASM"></a>用 ASM</h3><p>把所有的通用工具函数都转成汇编程序。</p>
<h3 id="用-QBASIC"><a href="#用-QBASIC" class="headerlink" title="用 QBASIC"></a>用 QBASIC</h3><p>所有重要的库函数都要用 QBASIC 写，然后再写个汇编的封包程序来处理 large 到 medium 的内存模型映射。</p>
<h3 id="内联汇编"><a href="#内联汇编" class="headerlink" title="内联汇编"></a>内联汇编</h3><p>在你的代码里混杂一些内联的汇编程序，这样很好玩。这年头几乎没人懂汇编程序了。只要放几行汇编代码就能让维护代码的程序员望而却步。</p>
<h3 id="宏汇编调用-C"><a href="#宏汇编调用-C" class="headerlink" title="宏汇编调用 C"></a>宏汇编调用 C</h3><p>如果你有个汇编模块被 C 调用，那就尽可能经常从汇编模块再去调用 C，即使只是出于微不足道的用途，另外要充分利用 goto, bcc 和其他炫目的汇编秘籍。</p>
<h2 id="与他人共事之道"><a href="#与他人共事之道" class="headerlink" title="与他人共事之道"></a>与他人共事之道</h2><h3 id="老板才是真行家"><a href="#老板才是真行家" class="headerlink" title="老板才是真行家"></a>老板才是真行家</h3><p>如果你的老板认为他 20 年的 FORTRAN 编程经验对于现代软件开发具有很高的指导价值，你务必严格采纳他的所有建议。投桃报李，你的老板也会信任你。这会对你的职业发展有利。你还会从他那里学到很多搞乱程序代码的新方法。</p>
<h3 id="颠覆技术支持"><a href="#颠覆技术支持" class="headerlink" title="颠覆技术支持"></a>颠覆技术支持</h3><p>确保代码中到处是 bug 的有效方法是永远不要让维护代码的程序员知道它们。这需要颠覆技术支持工作。永远不接电话。使用自动语音答复 “感谢拨打技术支持热线。需要人工服务请按 1，或在嘀声后留言。”，请求帮助的电子邮件必须忽略，不要给它分配服务追踪号。对任何问题的标准答复是 “我估计你的账户被锁定了，有权限帮你恢复的人现在不在。”</p>
<h3 id="沉默是金"><a href="#沉默是金" class="headerlink" title="沉默是金"></a>沉默是金</h3><p>永远不要对下一个危机保持警觉。如果你预见到某个问题可能会在一个固定时间爆发，摧毁西半球的全部生命，不要公开讨论它。不要告诉朋友、同事或其他你认识的有本事的人。在任何情况下都不要发表任何可能暗示到这种新的威胁的内容。只发送一篇正常优先级的、语焉不详的备忘录给管理层，保护自己免遭秋后算账。如果可能的话，把这篇稀里糊涂的信息作为另外一个更紧急的业务问题的附件。这样就可以心安理得地休息了，你知道将来你被强制提前退休之后一段时间，他们又会求着你回来，并给你对数级增长的时薪！</p>
<h3 id="每月一书俱乐部"><a href="#每月一书俱乐部" class="headerlink" title="每月一书俱乐部"></a>每月一书俱乐部</h3><p>加入一个计算机每月一书俱乐部。选择那些看上去忙着写书不可能有时间真的去写代码的作者。去书店里找一些有很多图表但是没有代码例子的书。浏览一下这些书，从中学会一些迂腐拗口的术语，用它们就能唬住那些自以为是的维护代码的程序员。你的代码肯定会给他留下深刻印象。如果人们连你写的术语都理解不了，他们一定会认为你非常聪明，你的算法非常深奥。不要在你的算法说明里作任何朴素的类比。</p>
<h2 id="自立门户"><a href="#自立门户" class="headerlink" title="自立门户"></a>自立门户</h2><p>你一直想写系统级的代码。现在机会来了。忽略标准库， <a target="_blank" rel="noopener" href="http://www.roll-your-own.com/">编写你自己的标准</a>，这将会是你简历中的一个亮点。</p>
<h3 id="推出你自己的-BNF-范式"><a href="#推出你自己的-BNF-范式" class="headerlink" title="推出你自己的 BNF 范式"></a>推出你自己的 BNF 范式</h3><p>总是用你自创的、独一无二的、无文档的 BNF 范式记录你的命令语法。永远不要提供一套带注解的例子（合法命令和非法命令之类）来解释你的语法体系。那样会显得完全缺乏学术严谨性。确保没有明显的方式来区分终结符和中间符号。永远不要用字体、颜色、大小写和其他任何视觉提示帮助读者分辨它们。在你的 BNF 范式用和命令语言本身完全一样的标点符号，这样读者就永远无法分清一段 (…), […], {…} 或 “…” 到底是你在命令行里真正输入的，还是想提示在你的 BNF 范式里哪个语法元素是必需的、可重复的、或可选的。不管怎么样，如果他们太笨，搞不清你的 BNF 范式的变化，就没资格使用你的程序。</p>
<h3 id="推出你自己的内存分配"><a href="#推出你自己的内存分配" class="headerlink" title="推出你自己的内存分配"></a>推出你自己的内存分配</h3><p>地球人儿都知道，调试动态存储是复杂和费时的。与其逐个类去确认它没有内存溢出，还不如自创一套存储分配机制呢。其实它无非是从一大片内存中 malloc 一块空间而已。用不着释放内存，让用户定期重启动系统，这样不就清除了堆么。重启之后系统需要追踪的就那么一点东西，比起解决所有的内存泄露简单得不知道到哪里去了！而且，只要用户记得定期重启系统，他们也永远不会遇到堆空间不足的问题。一旦系统被部署，你很难想象他们还能改变这个策略。</p>
<h2 id="其他杂七杂八的招"><a href="#其他杂七杂八的招" class="headerlink" title="其他杂七杂八的招"></a>其他杂七杂八的招</h2><blockquote>
<p><em>如果你给某人一段程序，你会让他困惑一天；如果你教他们如何编程，你会让他困惑一辈子。</em>– Anonymous</p>
</blockquote>
<h3 id="1-不要重编译"><a href="#1-不要重编译" class="headerlink" title="1. 不要重编译"></a>1. 不要重编译</h3><p>让我们从一条可能是有史以来最友好的技巧开始：把代码编译成可执行文件。如果它能用，就在源代码里做一两个微小的改动 – 每个模块都照此办理。<strong>但是不要费劲巴拉地再编译一次了。</strong> 你可以留着等以后有空而且需要调试的时候再说。多年以后，等可怜的维护代码的程序员更改了代码之后发现出错了，他会有一种错觉，觉得这些肯定是他自己最近修改的。这样你就能让他毫无头绪地忙碌很长时间。</p>
<h3 id="2-挫败调试工具"><a href="#2-挫败调试工具" class="headerlink" title="2. 挫败调试工具"></a>2. 挫败调试工具</h3><p>对于试图用行调试工具追踪来看懂你的代码的人，简单的一招就能让他狼狈不堪，那就是把每一行代码都写得很长。特别要把 then 语句 和 if 语句放在同一行里。他们无法设置断点。他们也无法分清在看的分支是哪个 if 里的。</p>
<h3 id="3-公制和美制"><a href="#3-公制和美制" class="headerlink" title="3. 公制和美制"></a>3. 公制和美制</h3><p>在工程方面有两种编码方式。一种是把所有输入都转换为公制（米制）计量单位，然后在输出的时候自己换算回各种民用计量单位。另一种是从头到尾都保持各种计量单位混合在一起。总是选择第二种方式，这就是美国之道！</p>
<h3 id="4-持续改进"><a href="#4-持续改进" class="headerlink" title="4. 持续改进"></a>4. 持续改进</h3><p>要持续不懈地改进。要常常对你的代码做出 “改进”，并强迫用户经常升级 – 毕竟没人愿意用一个过时的版本嘛。即便他们觉得他们对现有的程序满意了，想想看，如果他们看到你又 “完善 “了它，他们会多么开心啊！不要告诉任何人版本之间的差别，除非你被逼无奈 – 毕竟，为什么要告诉他们本来永远也不会注意到的一些 bug 呢？</p>
<h3 id="5-”-关于-“"><a href="#5-”-关于-“" class="headerlink" title="5. ” 关于 “"></a>5. ” 关于 “</h3><p>” 关于 “一栏应该只包含程序名、程序员姓名和一份用法律用语写的版权声明。理想情况下，它还应该链接到几 MB 的代码，产生有趣的动画效果。但是，里边永远不要包含程序用途的描述、它的版本号、或最新代码修改日期、或获取更新的网站地址、或作者的 email 地址等。这样，所有的用户很快就会运行在不同的版本上，在安装 N+1 版之前就试图安装 N+2 版。</p>
<h3 id="6-变更"><a href="#6-变更" class="headerlink" title="6. 变更"></a>6. 变更</h3><p>在两个版本之间，你能做的变更自然是多多益善。你不会希望用户年复一年地面对同一套老的接口或用户界面，这样会很无聊。最后，如果你能在用户不注意的情况下做出这些变更，那就更好了 – 这会让他们保持警惕，戒骄戒躁。</p>
<h3 id="7-无需技能"><a href="#7-无需技能" class="headerlink" title="7. 无需技能"></a>7. 无需技能</h3><p>写无法维护代码不需要多高的技能。喊破嗓子不如甩开膀子，不管三七二十一开始写代码就行了。记住，管理层还在按代码行数考核生产率，即使以后这些代码里的大部分都得删掉。</p>
<h3 id="8-只带一把锤子"><a href="#8-只带一把锤子" class="headerlink" title="8. 只带一把锤子"></a>8. 只带一把锤子</h3><p>一招鲜吃遍天，轻装前进。如果你手头只有一把锤子，那么所有的问题都是钉子。</p>
<h3 id="9-规范体系"><a href="#9-规范体系" class="headerlink" title="9. 规范体系"></a>9. 规范体系</h3><p>有可能的话，忽略当前你的项目所用语言和环境中被普罗大众所接受的编程规范。比如，编写基于 MFC 的应用时，就坚持使用 STL 编码风格。</p>
<h3 id="10-翻转通常的-True-False-惯例"><a href="#10-翻转通常的-True-False-惯例" class="headerlink" title="10. 翻转通常的 True False 惯例"></a>10. 翻转通常的 True False 惯例</h3><p>把常用的 true 和 false 的定义反过来用。这一招听起来平淡无奇，但是往往收获奇效。你可以先藏好下面的定义：</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define TRUE <span class="number">0</span></span><br><span class="line">#define FALSE <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>把这个定义深深地藏在代码中某个没人会再去看的文件里不易被发现的地方，然后让程序做下面这样的比较</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (var == TRUE)</span><br><span class="line"><span class="keyword">if</span> (var != FALSE)</span><br></pre></td></tr></table></figure>

<p>某些人肯定会迫不及待地跳出来 “修正” 这种明显的冗余，并且在其他地方照着常规去使用变量 var：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (var)</span><br></pre></td></tr></table></figure>

<p>还有一招是为 <code>TRUE</code> 和 <code>FALSE</code> 赋予相同的值，虽然大部分人可能会看穿这种骗局。给它们分别赋值 1 和 2 或者 -1 和 0 是让他们瞎忙乎的方式里更精巧的，而且这样做看起来也不失对他们的尊重。你在 Java 里也可以用这一招，定义一个叫 <code>TRUE</code> 的静态常量。在这种情况下，其他程序员更有可能怀疑你干的不是好事，因为 Java 里已经有了内建的标识符 <code>true</code>。</p>
<h3 id="11-第三方库"><a href="#11-第三方库" class="headerlink" title="11. 第三方库"></a>11. 第三方库</h3><p>在你的项目里引入功能强大的第三方库，然后不要用它们。潜规则就是这样，虽然你对这些好的工具仍然一无所知，却还是可以在你简历的 “其他工具” 一节中写上这些没用过的库。</p>
<h3 id="12-不要用库"><a href="#12-不要用库" class="headerlink" title="12. 不要用库"></a>12. 不要用库</h3><p>假装不知道有些库已经直接在你的开发工具中引入了。如果你用 VC++ 编程，忽略 MFC 或 STL 的存在，手工编写所有字符串和数组的实现；这样有助于保持你的指针技术，并自动阻止任何扩展代码功能的企图。</p>
<h3 id="13-创建一套-Build-顺序"><a href="#13-创建一套-Build-顺序" class="headerlink" title="13. 创建一套 Build 顺序"></a>13. 创建一套 Build 顺序</h3><p>把这套顺序规则做得非常晦涩，让维护者根本无法编译任何他的修改代码。秘密保留 SmartJ ，它会让 <code>make</code> 脚本形同废物。类似地，偷偷地定义一个 <code>javac</code> 类，让它和编译程序同名。说到大招，那就是编写和维护一个定制的小程序，在程序里找到需要编译的文件，然后通过直接调用 <code>sun.tools.javac.Main</code> 编译类来进行编译。</p>
<h3 id="14-Make-的更多玩法"><a href="#14-Make-的更多玩法" class="headerlink" title="14. Make 的更多玩法"></a>14. Make 的更多玩法</h3><p>用一个 makefile-generated-batch-file 批处理文件从多个目录复制源文件，文件之间的覆盖规则在文档中是没有的。这样，无需任何炫酷的源代码控制系统，就能实现代码分支，并阻止你的后继者弄清哪个版本的 DoUsefulWork () 才是他需要修改的那个。</p>
<h3 id="15-搜集编码规范"><a href="#15-搜集编码规范" class="headerlink" title="15. 搜集编码规范"></a>15. 搜集编码规范</h3><p>尽可能搜集所有关于编写可维护代码的建议，例如 <a target="_blank" rel="noopener" href="http://www.squarebox.co.uk/javatips.html">SquareBox 的建议</a> ，然后明目张胆地违反它们。</p>
<h3 id="16-规避公司的编码规则"><a href="#16-规避公司的编码规则" class="headerlink" title="16. 规避公司的编码规则"></a>16. 规避公司的编码规则</h3><p>某些公司有严格的规定，不允许使用数字标识符，你必须使用预先命名的常量。要挫败这种规定背后的意图太容易了。比如，一位聪明的 C++ 程序员是这么写的：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> K_ONE 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> K_TWO 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> K_THOUSAND 999</span></span><br></pre></td></tr></table></figure>

<h3 id="17-编译器警告"><a href="#17-编译器警告" class="headerlink" title="17. 编译器警告"></a>17. 编译器警告</h3><p>一定要保留一些编译器警告。在 make 里使用 “-” 前缀强制执行，忽视任何编译器报告的错误。这样，即使维护代码的程序员不小心在你的源代码里造成了一个语法错误，make 工具还是会重新把整个包 build 一遍，甚至可能会成功！而任何程序员要是手工编译你的代码，看到屏幕上冒出一堆其实无关紧要的警告，他们肯定会觉得是自己搞坏了代码。同样，他们一定会感谢你让他们有找错的机会。学有余力的同学可以做点手脚让编译器在打开编译错误诊断工具时就没法编译你的程序。当然了，编译器也许能做一些脚本边界检查，但是真正的程序员是不用这些特性的，所以你也不该用。既然你用自己的宝贵时间就能找到这些精巧的 bug，何必还多此一举让编译器来检查错误呢？</p>
<h3 id="18-把-bug-修复和升级混在一起"><a href="#18-把-bug-修复和升级混在一起" class="headerlink" title="18. 把 bug 修复和升级混在一起"></a>18. 把 bug 修复和升级混在一起</h3><p>永远不要推出什么 “bug 修复 “ 版本。一定要把 bug 修复和数据库结构变更、复杂的用户界面修改，还有管理界面重写等混在一起。那样的话，升级就变成一件非常困难的事情，人们会慢慢习惯 bug 的存在并开始称他们为特性。那些真心希望改变这些” 特性 “的人们就会有动力升级到新版本。这样从长期来说可以节省你的维护工作量，并从你的客户那里获得更多收入。</p>
<h3 id="19-在你的产品发布每个新版本的时候都改变文件结构"><a href="#19-在你的产品发布每个新版本的时候都改变文件结构" class="headerlink" title="19. 在你的产品发布每个新版本的时候都改变文件结构"></a>19. 在你的产品发布每个新版本的时候都改变文件结构</h3><p>没错，你的客户会要求向上兼容，那就去做吧。不过一定要确保向下是不兼容的。这样可以阻止客户从新版本回退，再配合一套合理的 bug 修复规则（见上一条），就可以确保每次新版本发布后，客户都会留在新版本。学有余力的话，还可以想办法让旧版本压根无法识别新版本产生的文件。那样的话，老版本系统不但无法读取新文件，甚至会否认这些文件是自己的应用系统产生的！温馨提示：PC 上的 Word 文字处理软件就典型地精于此道。</p>
<h3 id="20-抵消-Bug"><a href="#20-抵消-Bug" class="headerlink" title="20. 抵消 Bug"></a>20. 抵消 Bug</h3><p>不用费劲去代码里找 bug 的根源。只要在更高级的例程里加入一些抵销它的代码就行了。这是一种很棒的智力测验，类似于玩 3D 棋，而且能让将来的代码维护者忙乎很长时间都想不明白问题到底出在哪里：是产生数据的低层例程，还是莫名其妙改了一堆东西的高层代码。这一招对天生需要多回合执行的编译器也很好用。你可以在较早的回合完全避免修复问题，让较晚的回合变得更加复杂。如果运气好，你永远都不用和编译器前端打交道。学有余力的话，在后端做点手脚，一旦前端产生的是正确的数据，就让后端报错。</p>
<h3 id="21-使用旋转锁"><a href="#21-使用旋转锁" class="headerlink" title="21. 使用旋转锁"></a>21. 使用旋转锁</h3><p>不要用真正的同步原语，多种多样的旋转锁更好 – 反复休眠然后测试一个 (non-volatile 的) 全局变量，直到它符合你的条件为止。相比系统对象，旋转锁使用简便，” 通用 “性强，” 灵活 “多变，实为居家旅行必备。</p>
<h3 id="22-随意安插-sync-代码"><a href="#22-随意安插-sync-代码" class="headerlink" title="22. 随意安插 sync 代码"></a>22. 随意安插 sync 代码</h3><p>把某些系统同步原语安插到一些用不着它们的地方。本人曾经在一段不可能会有第二个线程的代码中看到一个临界区（critical section）代码。本人当时就质问写这段代码的程序员，他居然理直气壮地说这么写是为了表明这段代码是很” 关键 “（也是 critical）的！</p>
<h3 id="23-优雅降级"><a href="#23-优雅降级" class="headerlink" title="23. 优雅降级"></a>23. 优雅降级</h3><p>如果你的系统包含了一套 NT 设备驱动，就让应用程序负责给驱动分配 I&#x2F;O 缓冲区，然后在任何交易过程中对内存中的驱动加锁，并在交易完成后释放或解锁。这样一旦应用非正常终止，I&#x2F;O 缓存又没有被解锁，NT 服务器就会当机。但是在客户现场不太可能会有人知道怎么弄好设备驱动，所以他们就没有选择（只能请你去免费旅游了）。</p>
<h3 id="24-定制脚本语言"><a href="#24-定制脚本语言" class="headerlink" title="24. 定制脚本语言"></a>24. 定制脚本语言</h3><p>在你的 C&#x2F;S 应用里嵌入一个在运行时按字节编译的脚本命令语言。</p>
<h3 id="25-依赖于编译器的代码"><a href="#25-依赖于编译器的代码" class="headerlink" title="25. 依赖于编译器的代码"></a>25. 依赖于编译器的代码</h3><p>如果你发现在你的编译器或解释器里有个 bug，一定要确保这个 bug 的存在对于你的代码正常工作是至关重要的。毕竟你又不会使用其他的编译器，其他任何人也不允许！</p>
<h3 id="26-一个货真价实的例子"><a href="#26-一个货真价实的例子" class="headerlink" title="26. 一个货真价实的例子"></a>26. 一个货真价实的例子</h3><p>下面是一位大师编写的真实例子。让我们来瞻仰一下他在这样短短几行 C 函数里展示的高超技巧。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span>* <span class="title function_">Realocate</span><span class="params">(<span class="type">void</span>*buf, <span class="type">int</span> os, <span class="type">int</span> ns)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span>*temp;</span><br><span class="line">    temp = <span class="built_in">malloc</span>(os);</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="type">void</span>*)temp, (<span class="type">void</span>*)buf, os);</span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line">    buf = <span class="built_in">malloc</span>(ns);</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, ns);</span><br><span class="line">    <span class="built_in">memcpy</span>((<span class="type">void</span>*)buf, (<span class="type">void</span>*)temp, ns);</span><br><span class="line">    <span class="keyword">return</span> buf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>重新发明了标准库里已有的简单函数。</li>
<li><em>Realocate</em> 这个单词拼写错误。所以说，永远不要低估创造性拼写的威力。</li>
<li>无缘无故地给输入缓冲区产生一个临时的副本。</li>
<li>无缘无故地造型。 memcpy () 里有 (void*)，这样即使我们的指针已经(void*) 了也要再造型一次。另外这样可以传递任何东西作为参数，加 10 分。</li>
<li>永远不必费力去释放临时内存空间。这样会导致缓慢的内存泄露，一开始看来，要程序运行一段时间才行。</li>
<li>把用不着的东西也从缓冲区里拷贝出来，以防万一。这样只会在 Unix 上产 core dump，Windows 就不会。</li>
<li>很显然，os 和 ns 的含义分别是”old size”和”new size”。</li>
<li>给 buf 分配内存之后，memset 初始化它为 0。不要使用 calloc ()，因为某些人会重写 ANSI 规范，这样将来保不齐 calloc () 往 buf 里填的就不是 0 了。（虽然我们复制过去的数据量和 buf 的大小是一样的，不需要初始化，不过这也无所谓啦）</li>
</ul>
<h3 id="27-如何修复-“unused-variable”-错误"><a href="#27-如何修复-“unused-variable”-错误" class="headerlink" title="27. 如何修复 “unused variable” 错误"></a>27. 如何修复 “unused variable” 错误</h3><p>如果你的编译器冒出了 “unused local variable” 警告，不要去掉那个变量。相反，要找个聪明的办法把它用起来。我最喜欢的方法是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = i;</span><br></pre></td></tr></table></figure>

<h3 id="28-大小很关键"><a href="#28-大小很关键" class="headerlink" title="28. 大小很关键"></a>28. 大小很关键</h3><p>差点忘了说了，函数是越大越好。跳转和 GOTO 语句越多越好。那样的话，想做任何修改都需要分析很多场景。这会让维护代码的程序员陷入千头万绪之中。如果函数真的体型庞大的话，对于维护代码的程序员就是哥斯拉怪兽了，它会在他搞清楚情况之前就残酷无情地将他们踩翻在地。</p>
<h3 id="29-一张图片顶-1000-句话，一个函数就是-1000-行"><a href="#29-一张图片顶-1000-句话，一个函数就是-1000-行" class="headerlink" title="29. 一张图片顶 1000 句话，一个函数就是 1000 行"></a>29. 一张图片顶 1000 句话，一个函数就是 1000 行</h3><p>把每个方法体写的尽可能的长 – 最好是你写的任何方法或函数都没有少于 1000 行代码的，而且里边深度嵌套，这是必须的。</p>
<h3 id="30-少个文件"><a href="#30-少个文件" class="headerlink" title="30. 少个文件"></a>30. 少个文件</h3><p>一定要保证一个或多个关键文件是找不到的。利用 includes 里边再 includes 就能做到这一点。例如，在你的 main 模块里，你写上：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdcode.h&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>Stdcode.h 是有的。但是在 stdcode.h 里，还有个引用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;a:\\refcode.h&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>然后，refcode.h 就没地方能找到了。</p>
<h3 id="31-到处可写，无处可读"><a href="#31-到处可写，无处可读" class="headerlink" title="31. 到处可写，无处可读"></a>31. 到处可写，无处可读</h3><p>至少要把一个变量弄成这样：到处被设置，但是几乎没有哪里用到它。不幸的是，现代编译器通常会阻止你做相反的事：到处读，没处写。不过你在 C 或 C++ 里还是可以这样做的。</p>
<blockquote>
<p><strong>原始博文发布于：</strong> <a target="_blank" rel="noopener" href="http://mindprod.com/unmain.html">Roedy Green’s Mindproducts</a>。</p>
</blockquote>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/06/14/others/rxliuliBlog/JavaScript/JavaScript-%E4%B8%AD%E7%9A%84-ES6-Proxy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/14/others/rxliuliBlog/JavaScript/JavaScript-%E4%B8%AD%E7%9A%84-ES6-Proxy/" class="post-title-link" itemprop="url">JavaScript 中的 ES6 Proxy</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-14 13:19:35" itemprop="dateCreated datePublished" datetime="2019-06-14T13:19:35+08:00">2019-06-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-06-16 00:00:00" itemprop="dateModified" datetime="2019-06-16T00:00:00+08:00">2019-06-16</time>
    </span>


  
    <span id="/2019/06/14/others/rxliuliBlog/JavaScript/JavaScript-%E4%B8%AD%E7%9A%84-ES6-Proxy/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript 中的 ES6 Proxy" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript 中的 ES6 Proxy" href="/2019/06/14/others/rxliuliBlog/JavaScript/JavaScript-%E4%B8%AD%E7%9A%84-ES6-Proxy/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::d6d0e8aeaf60d53af5a7de348ee96140" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaScript-中的-ES6-Proxy"><a href="#JavaScript-中的-ES6-Proxy" class="headerlink" title="JavaScript 中的 ES6 Proxy"></a>JavaScript 中的 ES6 Proxy</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><blockquote>
<p>就算只是扮演，也会成为真实的自我的一部分。对人类的精神来说，真实和虚假其实并没有明显的界限。入戏太深不是一件好事，但对于你来说并不成立，因为戏中的你才是真正符合你的身份的你。如今的你是真实的，就算一开始你只是在模仿着这种形象，现在的你也已经成为了这种形象。无论如何，你也不可能再回到过去了。</p>
</blockquote>
<p><code>Proxy</code> 代理，在 JavaScript 似乎很陌生，却又在生活中无处不在。或许有人在学习 ES6 的时候有所涉猎，但却并未真正了解它的使用场景，平时在写业务代码时也不会用到这个特性。</p>
<p>相比于文绉绉的定义内容，想必我们更希望了解它的使用场景，使其在真正的生产环境发挥强大的作用，而不仅仅是作为一个新的特性 – <strong>然后，实际中完全没有用到！</strong></p>
<ul>
<li>为函数添加特定的功能</li>
<li>代理对象的访问</li>
<li>作为胶水桥接不同结构的对象</li>
<li>监视对象的变化</li>
<li>还有更多。。。</li>
</ul>
<p>如果你还没有了解过 <code>Proxy</code> 特性，可以先去 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy">MDN Proxy</a> 上查看基本概念及使用。</p>
<h2 id="为函数添加特定的功能"><a href="#为函数添加特定的功能" class="headerlink" title="为函数添加特定的功能"></a>为函数添加特定的功能</h2><p>下面是一个为异步函数自动添加超时功能的高阶函数，我们来看一下它有什么问题</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为异步函数添加自动超时功能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeout 超时时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> action 异步函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 包装后的异步函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">asyncTimeout</span>(<span class="params">timeout, action</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>([</span><br><span class="line">      <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(action, <span class="variable language_">this</span>, args),</span><br><span class="line">      <span class="title function_">wait</span>(timeout).<span class="title function_">then</span>(<span class="title class_">Promise</span>.<span class="property">reject</span>),</span><br><span class="line">    ])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>一般而言</strong>，上面的代码足以胜任，但问题就在这里，不一般的情况 – 函数上面包含<strong>自定义属性</strong>呢？<br>众所周知，JavaScript 中的函数是一等公民，即函数可以被传递，被返回，以及，被添加属性！</p>
<p>例如下面这个简单的函数 <code>get</code>，其上有着 <code>_name</code> 这个属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">get</span> = <span class="keyword">async</span> i =&gt; i</span><br><span class="line">get.<span class="property">_name</span> = <span class="string">&#x27;get&#x27;</span></span><br></pre></td></tr></table></figure>

<p>一旦使用上面的 <code>asyncTimeout</code> 函数包裹之后，问题便会出现，返回的函数中 <code>_name</code> 属性不见了。这是当然的，毕竟实际上返回的是一个匿名函数。那么，如何才能让返回的函数能够拥有传入函数参数上的所有自定义属性呢？<br>一种方式是复制参数函数上的所有属性，但这点实现起来其实并不容易，真的不容易，不信你可以看看 Lodash 的 clone 函数。那么，有没有一种更简单的方式呢？答案就是 <code>Proxy</code>，它可以代理对象的指定操作，除此之外，其他的一切都指向原对象。<br>下面是 <code>Proxy</code> 实现的 <code>asyncTimeout</code> 函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为异步函数添加自动超时功能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeout 超时时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> action 异步函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 包装后的异步函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">asyncTimeout</span>(<span class="params">timeout, action</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(action, &#123;</span><br><span class="line">    <span class="title function_">apply</span>(<span class="params">_, _this, args</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>([</span><br><span class="line">        <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(_, _this, args),</span><br><span class="line">        <span class="title function_">wait</span>(timeout).<span class="title function_">then</span>(<span class="title class_">Promise</span>.<span class="property">reject</span>),</span><br><span class="line">      ])</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试一下，是可以正常调用与访问其上的属性的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">1</span>))</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(get.<span class="property">_name</span>)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>好了，这便是吾辈最常用的一种方式了 – <strong>封装高阶函数，为函数添加某些功能</strong>。</p>
<h2 id="代理对象的访问"><a href="#代理对象的访问" class="headerlink" title="代理对象的访问"></a>代理对象的访问</h2><p>下面是一段代码，用以在页面上展示从后台获取的数据，如果字段没有值则默认展示 <code>&#39;&#39;</code></p>
<p>模拟一个获取列表的异步请求</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">list</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 此处仅为构造列表</span></span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">&#123; id, name, age, sex, address &#125; = &#123;&#125;</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">id</span> = id</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">age</span> = age</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">sex</span> = sex</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">address</span> = address</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Person</span>(&#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">&#x27;琉璃&#x27;</span> &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Person</span>(&#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">age</span>: <span class="number">17</span> &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Person</span>(&#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">sex</span>: <span class="literal">false</span> &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Person</span>(&#123; <span class="attr">id</span>: <span class="number">4</span>, <span class="attr">address</span>: <span class="string">&#x27;幻想乡&#x27;</span> &#125;),</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>尝试直接通过解构为属性赋予默认值，并在默认值实现这个功能</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 为所有为赋值属性都赋予默认值 &#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> persons = (<span class="keyword">await</span> <span class="title function_">list</span>()).<span class="title function_">map</span>(</span><br><span class="line">    <span class="function">(<span class="params">&#123; id = <span class="string">&#x27;&#x27;</span>, name = <span class="string">&#x27;&#x27;</span>, age = <span class="string">&#x27;&#x27;</span>, sex = <span class="string">&#x27;&#x27;</span>, address = <span class="string">&#x27;&#x27;</span> &#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">      id,</span><br><span class="line">      name,</span><br><span class="line">      age,</span><br><span class="line">      sex,</span><br><span class="line">      address,</span><br><span class="line">    &#125;),</span><br><span class="line">  )</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(persons)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>下面让我们写得更通用一些</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">warp</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> result = obj</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> k <span class="keyword">of</span> <span class="title class_">Reflect</span>.<span class="title function_">ownKeys</span>(obj)) &#123;</span><br><span class="line">    <span class="keyword">const</span> v = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(obj, k)</span><br><span class="line">    result[k] = v === <span class="literal">undefined</span> ? <span class="string">&#x27;&#x27;</span> : v</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 为所有为赋值属性都赋予默认值 &#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> persons = (<span class="keyword">await</span> <span class="title function_">list</span>()).<span class="title function_">map</span>(warp)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(persons)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>暂且先看一下这里的 <code>warp</code> 函数有什么问题？</p>
<hr>
<p>这里是答案的分割线</p>
<hr>
<ul>
<li>所有属性需要预定义，不能运行时决定</li>
<li>没有指向原对象，后续的修改会造成麻烦</li>
</ul>
<p>吾辈先解释一下这两个问题</p>
<ol>
<li>所有属性需要预定义，不能运行时决定<br>如果调用了 <code>list[0].a</code> 会发生什么呢？是的，依旧会是 <code>undefined</code>，因为 <code>Reflect.ownKeys</code> 也不能找到没有定义的属性（<code>真*undefined</code>），因此导致访问未定义的属性仍然会是 <code>undefined</code> 而非期望的默认值。</li>
<li>没有指向原对象，后续的修改会造成麻烦<br>如果我们此时修改对象的一个属性，那么会影响到原本的属性么？不会，因为 <code>warp</code> 返回的对象已经是全新的了，和原对象没有什么联系。所以，当你修改时当然不会影响到原对象。<br>Pass: 我们当然可以直接修改原对象，但这很明显不太符合我们的期望：显示时展示默认值 <code>&#39;&#39;</code> – 这并不意味着我们愿意在其他操作时需要 <code>&#39;&#39;</code>，否则我们还要再转换一遍。（例如发送编辑后的数据到后台）</li>
</ol>
<p>这个时候 <code>Proxy</code> 也可以派上用场，使用 <code>Proxy</code> 实现 <code>warp</code> 函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">warp</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">_, k</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> v = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, k)</span><br><span class="line">      <span class="keyword">if</span> (v !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> v</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，上面的那两个问题都解决了！</p>
<blockquote>
<p>注: 知名的 GitHub 库 <a target="_blank" rel="noopener" href="https://github.com/immerjs/immer">immer</a> 就使用了该特性实现了不可变状态树。</p>
</blockquote>
<h2 id="作为胶水桥接不同结构的对象"><a href="#作为胶水桥接不同结构的对象" class="headerlink" title="作为胶水桥接不同结构的对象"></a>作为胶水桥接不同结构的对象</h2><p>通过上面的例子我们可以知道，即便是未定义的属性，<code>Proxy</code> 也能进行代理。这意味着，我们可以通过 <code>Proxy</code> 抹平相似对象之间结构的差异，以相同的方式处理类似的对象。</p>
<blockquote>
<p>Pass: 不同公司的项目中的同一个实体的结构不一定完全相同，但基本上类似，只是字段名不同罢了。所以使用 <code>Proxy</code> 实现胶水桥接不同结构的对象方便我们在不同公司使用我们的工具库！<br>嘛，开个玩笑，其实在同一个公司中不同的实体也会有类似的结构，也会需要相同的操作，最常见的应该是树结构数据。例如下面的菜单实体和系统权限实体就很相似，也需要相同的操作 – <strong>树 &lt;&#x3D;&gt; 列表 相互转换</strong>。</p>
</blockquote>
<p>思考一下如何在同一个函数中处理这两种树节点结构</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统菜单</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SysMenu</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构造函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; id 菜单 id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; name 显示的名称</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; parent 父级菜单 id</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">id, name, parent</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = id</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = parent</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统权限</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SysPermission</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构造函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; uid 系统唯一 uuid</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; label 显示的菜单名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; parentId 父级权限 uid</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">uid, label, parentId</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">uid</span> = uid</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">label</span> = label</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parentId</span> = parentId</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面让我们使用 <code>Proxy</code> 来抹平访问它们之间的差异</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sysMenuProxy = &#123; <span class="attr">parentId</span>: <span class="string">&#x27;parent&#x27;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> sysMenu = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="keyword">new</span> <span class="title class_">SysMenu</span>(<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>), &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">_, k</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Reflect</span>.<span class="title function_">has</span>(sysMenuProxy, k)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, <span class="title class_">Reflect</span>.<span class="title function_">get</span>(sysMenuProxy, k))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, k)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sysMenu.<span class="property">id</span>, sysMenu.<span class="property">name</span>, sysMenu.<span class="property">parentId</span>) <span class="comment">// 1 &#x27;rx&#x27; 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sysPermissionProxy = &#123; <span class="attr">id</span>: <span class="string">&#x27;uid&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;label&#x27;</span> &#125;</span><br><span class="line"><span class="keyword">const</span> sysPermission = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="keyword">new</span> <span class="title class_">SysPermission</span>(<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>), &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">_, k</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Reflect</span>.<span class="title function_">has</span>(sysPermissionProxy, k)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, <span class="title class_">Reflect</span>.<span class="title function_">get</span>(sysPermissionProxy, k))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, k)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sysPermission.<span class="property">id</span>, sysPermission.<span class="property">name</span>, sysPermission.<span class="property">parentId</span>) <span class="comment">// 1 &#x27;rx&#x27; 0</span></span><br></pre></td></tr></table></figure>

<p>看起来似乎有点繁琐，让我们封装一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 桥接对象不存在的字段</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; map 代理的字段映射 Map</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Function</span>&#125; 转换一个对象为代理对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bridge</span>(<span class="params">map</span>) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 为对象添加代理的函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; obj 任何对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">Proxy</span>&#125; 代理后的对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, &#123;</span><br><span class="line">      <span class="title function_">get</span>(<span class="params">target, k</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果遇到被代理的属性则返回真实的属性</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Reflect</span>.<span class="title function_">has</span>(map, k)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, <span class="title class_">Reflect</span>.<span class="title function_">get</span>(map, k))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, k)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">set</span>(<span class="params">target, k, v</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果遇到被代理的属性则设置真实的属性</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Reflect</span>.<span class="title function_">has</span>(map, k)) &#123;</span><br><span class="line">          <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, <span class="title class_">Reflect</span>.<span class="title function_">get</span>(map, k), v)</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, k, v)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，我们可以用更简单的方式来做代理了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sysMenu = <span class="title function_">bridge</span>(&#123;</span><br><span class="line">  <span class="attr">parentId</span>: <span class="string">&#x27;parent&#x27;</span>,</span><br><span class="line">&#125;)(<span class="keyword">new</span> <span class="title class_">SysMenu</span>(<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sysMenu.<span class="property">id</span>, sysMenu.<span class="property">name</span>, sysMenu.<span class="property">parentId</span>) <span class="comment">// 1 &#x27;rx&#x27; 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sysPermission = <span class="title function_">bridge</span>(&#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="string">&#x27;uid&#x27;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;label&#x27;</span>,</span><br><span class="line">&#125;)(<span class="keyword">new</span> <span class="title class_">SysPermission</span>(<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sysPermission.<span class="property">id</span>, sysPermission.<span class="property">name</span>, sysPermission.<span class="property">parentId</span>) <span class="comment">// 1 &#x27;rx&#x27; 0</span></span><br></pre></td></tr></table></figure>

<p>如果想看 JavaScirpt 如何处理树结构数据话，可以参考吾辈的 <a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/bb943156/">JavaScript 处理树数据结构</a></p>
<h2 id="监视对象的变化"><a href="#监视对象的变化" class="headerlink" title="监视对象的变化"></a>监视对象的变化</h2><p>接下来，我们想想，平时是否有需要监视对象的变化，然后进行某些处理呢？</p>
<p>例如监视用户复选框选中项列表的变化并更新对应的需要发送到后台的 <code>id</code> 拼接字符串。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟页面的复选框列表</span></span><br><span class="line"><span class="keyword">const</span> hobbyMap = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">1</span>, <span class="string">&#x27;小说&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">2</span>, <span class="string">&#x27;动画&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">3</span>, <span class="string">&#x27;电影&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">4</span>, <span class="string">&#x27;游戏&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="comment">// 保存兴趣 id 的列表</span></span><br><span class="line">  <span class="attr">hobbySet</span>: <span class="keyword">new</span> <span class="title class_">Set</span>(),</span><br><span class="line">  <span class="comment">// 发送到后台的兴趣 id 拼接后的字符串，以都好进行分割</span></span><br><span class="line">  <span class="attr">hobby</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onClick</span>(<span class="params">id</span>) &#123;</span><br><span class="line">  user.<span class="property">hobbySet</span>.<span class="title function_">has</span>(id) ? user.<span class="property">hobbySet</span>.<span class="title function_">delete</span>(id) : user.<span class="property">hobbySet</span>.<span class="title function_">add</span>(id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟两次点击</span></span><br><span class="line"><span class="title function_">onClick</span>(<span class="number">1</span>)</span><br><span class="line"><span class="title function_">onClick</span>(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">hobby</span>) <span class="comment">// &#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>下面使用 <code>Proxy</code> 来完成 <code>hobbySet</code> 属性改变后 <code>hobby</code> 自动更新的操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 深度监听指定对象属性的变化</span></span><br><span class="line"><span class="comment"> * 注：指定对象不能是原始类型，即不可变类型，而且对象本身的引用不能改变，最好使用 const 进行声明</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> object 需要监视的对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> callback 当代理对象发生改变时的回调函数，回调函数有三个参数，分别是对象，修改的 key，修改的 v</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 返回源对象的一个代理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">watchObject</span>(<span class="params">object, callback</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> handler = &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">_, k</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 注意: 这里很关键，它为对象的字段也添加了代理</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(v, <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, k))</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, k)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">_, k, v</span>) &#123;</span><br><span class="line">      <span class="title function_">callback</span>(_, k, v)</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">set</span>(_, k, v)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(object, handler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟页面的复选框列表</span></span><br><span class="line"><span class="keyword">const</span> hobbyMap = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">1</span>, <span class="string">&#x27;小说&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">2</span>, <span class="string">&#x27;动画&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">3</span>, <span class="string">&#x27;电影&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">4</span>, <span class="string">&#x27;游戏&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="comment">// 保存兴趣 id 的列表</span></span><br><span class="line">  <span class="attr">hobbySet</span>: <span class="keyword">new</span> <span class="title class_">Set</span>(),</span><br><span class="line">  <span class="comment">// 发送到后台的兴趣 id 拼接后的字符串，以都好进行分割</span></span><br><span class="line">  <span class="attr">hobby</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> proxy = <span class="title function_">watchObject</span>(user, <span class="function">(<span class="params">_, k, v</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (k === <span class="string">&#x27;hobbySet&#x27;</span>) &#123;</span><br><span class="line">    _.<span class="property">hobby</span> = [..._.<span class="property">hobbySet</span>].<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onClick</span>(<span class="params">id</span>) &#123;</span><br><span class="line">  proxy.<span class="property">hobbySet</span> = proxy.<span class="property">hobbySet</span>.<span class="title function_">has</span>(id)</span><br><span class="line">    ? proxy.<span class="property">hobbySet</span>.<span class="title function_">delete</span>(id)</span><br><span class="line">    : proxy.<span class="property">hobbySet</span>.<span class="title function_">add</span>(id)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 模拟两次点击</span></span><br><span class="line"><span class="title function_">onClick</span>(<span class="number">1</span>)</span><br><span class="line"><span class="title function_">onClick</span>(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在，user.hobby 的值将会自动更新</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">hobby</span>) <span class="comment">// 1,2</span></span><br></pre></td></tr></table></figure>

<p>当然，这里实现的 <code>watchObject</code> 函数还非常非常非常简陋，如果有需要可以进行更深度&#x2F;强大的监听，可以尝试自行实现一下啦！</p>
<h2 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h2><p>说完了这些 <code>Proxy</code> 的使用场景，下面稍微来说一下它的缺点</p>
<ul>
<li><p>运行环境必须要 ES6 支持<br>这是一个不大不小的问题，现代的浏览器基本上都支持 ES6，但如果泥萌公司技术栈非常老旧的话（例如支持 IE6），还是安心吃土吧 #笑 #这种公司不离职等着老死</p>
</li>
<li><p>不能直接代理一些需要 this 的对象<br>这个问题就比较麻烦了，任何需要 this 的对象，代理之后的行为可能会发生变化。例如 <code>Set</code> 对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="keyword">new</span> <span class="title class_">Set</span>([]), &#123;&#125;)</span><br><span class="line">proxy.<span class="title function_">add</span>(<span class="number">1</span>) <span class="comment">// Method Set.prototype.add called on incompatible receiver [object Object]</span></span><br></pre></td></tr></table></figure>

<p>是不是很奇怪，解决方案是把所有的 <code>get</code> 操作属性值为 <code>function</code> 的函数都手动绑定 <code>this</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="keyword">new</span> <span class="title class_">Set</span>([]), &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">_, k</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> v = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, k)</span><br><span class="line">    <span class="comment">// 遇到 Function 都手动绑定一下 this</span></span><br><span class="line">    <span class="keyword">if</span> (v <span class="keyword">instanceof</span> <span class="title class_">Function</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> v.<span class="title function_">bind</span>(_)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> v</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line">proxy.<span class="title function_">add</span>(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>Proxy</code> 是个很强大的特性，能够让我们实现一些曾经难以实现的功能（所以这就是你不支持 ES5 的理由？#打），就连 Vue3+ 都开始使用 <code>Proxy</code> 实现了，你还有什么理由在乎上古时期的 IE 而不用呢？（ｖ＾＿＾）ｖ</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/06/12/others/rxliuliBlog/JavaScript/JavaScript-%E5%BC%82%E6%AD%A5%E6%97%B6%E5%BA%8F%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/12/others/rxliuliBlog/JavaScript/JavaScript-%E5%BC%82%E6%AD%A5%E6%97%B6%E5%BA%8F%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">JavaScript 异步时序问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-12 18:10:19" itemprop="dateCreated datePublished" datetime="2019-06-12T18:10:19+08:00">2019-06-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-06-13 00:00:00" itemprop="dateModified" datetime="2019-06-13T00:00:00+08:00">2019-06-13</time>
    </span>


  
    <span id="/2019/06/12/others/rxliuliBlog/JavaScript/JavaScript-%E5%BC%82%E6%AD%A5%E6%97%B6%E5%BA%8F%E9%97%AE%E9%A2%98/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript 异步时序问题" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript 异步时序问题" href="/2019/06/12/others/rxliuliBlog/JavaScript/JavaScript-%E5%BC%82%E6%AD%A5%E6%97%B6%E5%BA%8F%E9%97%AE%E9%A2%98/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::5c08384bc1dab59fa8f57fa6ef24ff50" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaScript-异步时序问题"><a href="#JavaScript-异步时序问题" class="headerlink" title="JavaScript 异步时序问题"></a>JavaScript 异步时序问题</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><blockquote>
<p>死后我们必升天堂，因为活时我们已在地狱。</p>
</blockquote>
<p>不知你是否遇到过，向后台发送了多次异步请求，结果最后显示的数据却并不正确 – 是旧的数据。</p>
<p>具体情况:</p>
<ol>
<li>用户触发事件，发送了第 1 次请求</li>
<li>用户触发事件，发送了第 2 次请求</li>
<li>第 2 次请求成功，更新页面上的数据</li>
<li>第 1 次请求成功，更新页面上的数据</li>
</ol>
<p>嗯？是不是感觉到异常了？这便是多次异步请求时会遇到的异步回调顺序与调用顺序不同的问题。</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><ul>
<li>为什么会出现这种问题？</li>
<li>出现这种问题怎么解决？</li>
</ul>
<h3 id="为什么会出现这种问题？"><a href="#为什么会出现这种问题？" class="headerlink" title="为什么会出现这种问题？"></a>为什么会出现这种问题？</h3><p>JavaScript 随处可见异步，但实际上并不是那么好控制。用户与 UI 交互，触发事件及其对应的处理函数，函数执行异步操作（网络请求），<strong>异步操作得到结果的时间（顺序）是不确定的</strong>，所以响应到 UI 上的时间就不确定，<strong>如果触发事件的频率较高&#x2F;异步操作的时间过长</strong>，就会造成前面的异步操作结果覆盖后面的异步操作结果。</p>
<p>关键点</p>
<ul>
<li>异步操作得到结果的时间（顺序）是不确定的</li>
<li>如果触发事件的频率较高&#x2F;异步操作的时间过长</li>
</ul>
<h3 id="出现这种问题怎么解决？"><a href="#出现这种问题怎么解决？" class="headerlink" title="出现这种问题怎么解决？"></a>出现这种问题怎么解决？</h3><p>既然关键点由两个要素组成，那么，只要破坏了任意一个即可。</p>
<ul>
<li>手动控制异步返回结果的顺序</li>
<li>降低触发频率并限制异步超时时间</li>
</ul>
<h2 id="手动控制返回结果的顺序"><a href="#手动控制返回结果的顺序" class="headerlink" title="手动控制返回结果的顺序"></a>手动控制返回结果的顺序</h2><p>根据对异步操作结果处理情况的不同也有三种不同的思路</p>
<ol>
<li>后面异步操作得到结果后<strong>等待</strong>前面的异步操作返回结果</li>
<li>后面异步操作得到结果后<strong>放弃</strong>前面的异步操作返回结果</li>
<li>依次处理每一个异步操作，等待上一个异步操作完成之后再执行下一个</li>
</ol>
<p>这里先引入一个公共的 <code>wait</code> 函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 等待指定的时间/等待指定表达式成立</span></span><br><span class="line"><span class="comment"> * 如果未指定等待条件则立刻执行</span></span><br><span class="line"><span class="comment"> * 注: 此实现在 nodejs 10- 会存在宏任务与微任务的问题，切记 async-await 本质上还是 Promise 的语法糖，实际上并非真正的同步函数！！！即便在浏览器，也不要依赖于这种特性。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> param 等待时间/等待条件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> Promise 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">wait</span>(<span class="params">param</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(resolve, param)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">param</span>()) &#123;</span><br><span class="line">          <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">          <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="number">100</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-后面异步操作得到结果后等待前面的异步操作返回结果"><a href="#1-后面异步操作得到结果后等待前面的异步操作返回结果" class="headerlink" title="1. 后面异步操作得到结果后等待前面的异步操作返回结果"></a>1. 后面异步操作得到结果后<strong>等待</strong>前面的异步操作返回结果</h3><ol>
<li>为每一次的异步调用都声称一个唯一 id</li>
<li>使用列表记录所有的异步 id</li>
<li>在真正调用异步操作后，添加一个唯一 id</li>
<li>判断上一个正在执行的异步操作是否完成</li>
<li>如果未完成等待上一个异步操作完成，否则直接跳过</li>
<li>从列表中删除掉当前的 id</li>
<li>最后等待异步操作然后返回结果</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将一个异步函数包装为具有时序的异步函数</span></span><br><span class="line"><span class="comment"> * 注: 该函数会按照调用顺序依次返回结果，后面的调用的结果需要等待前面的，所以如果不关心过时的结果，请使用 &#123;<span class="doctag">@link</span> switchMap&#125; 函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fn 一个普通的异步函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 包装后的函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mergeMap</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="comment">// 当前执行的异步操作 id</span></span><br><span class="line">  <span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 所执行的异步操作 id 列表</span></span><br><span class="line">  <span class="keyword">const</span> ids = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(fn, &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">apply</span>(<span class="params">_, _this, args</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> prom = <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(_, _this, args)</span><br><span class="line">      <span class="keyword">const</span> temp = id</span><br><span class="line">      ids.<span class="title function_">add</span>(temp)</span><br><span class="line">      id++</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="function">() =&gt;</span> !ids.<span class="title function_">has</span>(temp - <span class="number">1</span>))</span><br><span class="line">      ids.<span class="title function_">delete</span>(temp)</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> prom</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://codepen.io/rxliuli/pen/orXpEY">测试一下</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 模拟一个异步请求，接受参数并返回它，然后等待指定的时间</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">ms</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">wait</span>(ms)</span><br><span class="line">    <span class="keyword">return</span> ms</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">mergeMap</span>(get)</span><br><span class="line">  <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> sum = <span class="number">0</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">30</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">20</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">10</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">  ])</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(last)</span><br><span class="line">  <span class="comment">// 实际上确实执行了 3 次，结果也确实为 3 次调用参数之和</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(sum)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="2-后面异步操作得到结果后放弃前面的异步操作返回结果"><a href="#2-后面异步操作得到结果后放弃前面的异步操作返回结果" class="headerlink" title="2. 后面异步操作得到结果后放弃前面的异步操作返回结果"></a>2. 后面异步操作得到结果后<strong>放弃</strong>前面的异步操作返回结果</h3><ol>
<li>为每一次的异步调用都声称一个唯一 id</li>
<li>记录最新得到异步操作结果的 id</li>
<li>记录最新得到的异步操作结果</li>
<li>执行并等待返回结果</li>
<li>判断本次异步调用后面是否已经有调用出现结果了<ol>
<li>是的话就直接返回后面的异步调用结果</li>
<li>否则将本地异步调用 id 及其结果最为[最后的]</li>
<li>返回这次的异步调用结果</li>
</ol>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将一个异步函数包装为具有时序的异步函数</span></span><br><span class="line"><span class="comment"> * 注: 该函数会丢弃过期的异步操作结果，这样的话性能会稍稍提高（主要是响应比较快的结果会立刻生效而不必等待前面的响应结果）</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fn 一个普通的异步函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 包装后的函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">switchMap</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="comment">// 当前执行的异步操作 id</span></span><br><span class="line">  <span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 最后一次异步操作的 id，小于这个的操作结果会被丢弃</span></span><br><span class="line">  <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 缓存最后一次异步操作的结果</span></span><br><span class="line">  <span class="keyword">let</span> cache</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(fn, &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">apply</span>(<span class="params">_, _this, args</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> temp = id</span><br><span class="line">      id++</span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(_, _this, args)</span><br><span class="line">      <span class="keyword">if</span> (temp &lt; last) &#123;</span><br><span class="line">        <span class="keyword">return</span> cache</span><br><span class="line">      &#125;</span><br><span class="line">      cache = res</span><br><span class="line">      last = temp</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://codepen.io/rxliuli/pen/BgNJbq">测试一下</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 模拟一个异步请求，接受参数并返回它，然后等待指定的时间</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">ms</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">wait</span>(ms)</span><br><span class="line">    <span class="keyword">return</span> ms</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">switchMap</span>(get)</span><br><span class="line">  <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> sum = <span class="number">0</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">30</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">20</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">10</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">  ])</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(last)</span><br><span class="line">  <span class="comment">// 实际上确实执行了 3 次，然而结果并不是 3 次调用参数之和，因为前两次的结果均被抛弃，实际上返回了最后一次发送请求的结果</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(sum)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="3-依次处理每一个异步操作，等待上一个异步操作完成之后再执行下一个"><a href="#3-依次处理每一个异步操作，等待上一个异步操作完成之后再执行下一个" class="headerlink" title="3. 依次处理每一个异步操作，等待上一个异步操作完成之后再执行下一个"></a>3. 依次处理每一个异步操作，等待上一个异步操作完成之后再执行下一个</h3><ol>
<li>为每一次的异步调用都声称一个唯一 id</li>
<li>使用列表记录所有的异步 id</li>
<li>向列表中添加一个唯一 id</li>
<li>判断上一个正在执行的异步操作是否完成</li>
<li>如果未完成等待上一个异步操作完成，否则直接跳过</li>
<li>真正调用异步操作</li>
<li>从列表中删除掉当前的 id</li>
<li>最后等待异步操作然后返回结果</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将一个异步函数包装为具有时序的异步函数</span></span><br><span class="line"><span class="comment"> * 注: 该函数会按照调用顺序依次返回结果，后面的执行的调用（不是调用结果）需要等待前面的，此函数适用于异步函数的内里执行也必须保证顺序时使用，否则请使用 &#123;<span class="doctag">@link</span> mergeMap&#125; 函数</span></span><br><span class="line"><span class="comment"> * 注: 该函数其实相当于调用 &#123;<span class="doctag">@code</span> asyncLimiting(fn, &#123;limit: 1&#125;)&#125; 函数</span></span><br><span class="line"><span class="comment"> * 例如即时保存文档到服务器，当然要等待上一次的请求结束才能请求下一次，不然数据库保存的数据就存在谬误了</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fn 一个普通的异步函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 包装后的函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">concatMap</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="comment">// 当前执行的异步操作 id</span></span><br><span class="line">  <span class="keyword">let</span> id = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 所执行的异步操作 id 列表</span></span><br><span class="line">  <span class="keyword">const</span> ids = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(fn, &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">apply</span>(<span class="params">_, _this, args</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> temp = id</span><br><span class="line">      ids.<span class="title function_">add</span>(temp)</span><br><span class="line">      id++</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="function">() =&gt;</span> !ids.<span class="title function_">has</span>(temp - <span class="number">1</span>))</span><br><span class="line">      <span class="keyword">const</span> prom = <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(_, _this, args)</span><br><span class="line">      ids.<span class="title function_">delete</span>(temp)</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> prom</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://codepen.io/rxliuli/pen/xoGYxq">测试一下</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 模拟一个异步请求，接受参数并返回它，然后等待指定的时间</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">ms</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">wait</span>(ms)</span><br><span class="line">    <span class="keyword">return</span> ms</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">concatMap</span>(get)</span><br><span class="line">  <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> sum = <span class="number">0</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">30</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">20</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">10</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">  ])</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(last)</span><br><span class="line">  <span class="comment">// 实际上确实执行了 3 次，然而结果并不是 3 次调用参数之和，因为前两次的结果均被抛弃，实际上返回了最后一次发送请求的结果</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(sum)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>虽然三个函数看似效果都差不多，但还是有所不同的。</p>
<ol>
<li>是否允许异步操作并发？否: <code>concatMap</code>, 是: 到下一步</li>
<li>是否需要处理旧的的结果？否: <code>switchMap</code>, 是: <code>mergeMap</code></li>
</ol>
<h2 id="降低触发频率并限制异步超时时间"><a href="#降低触发频率并限制异步超时时间" class="headerlink" title="降低触发频率并限制异步超时时间"></a>降低触发频率并限制异步超时时间</h2><p>思考一下第二种解决方式，本质上其实是 <strong>限流 + 自动超时</strong>，首先实现这两个函数。</p>
<ul>
<li>限流: 限制函数调用的频率，如果调用的频率过快则不会真正执行调用而是返回旧值</li>
<li>自动超时: 如果到了超时时间，即便函数还未得到结果，也会自动超时并抛出错误</li>
</ul>
<p>下面来分别实现它们</p>
<h3 id="限流实现"><a href="#限流实现" class="headerlink" title="限流实现"></a>限流实现</h3><blockquote>
<p>具体实现思路可见: <a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/1a8df23d/">JavaScript 防抖和节流</a></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 函数节流</span></span><br><span class="line"><span class="comment"> * 节流 (throttle) 让一个函数不要执行的太频繁，减少执行过快的调用，叫节流</span></span><br><span class="line"><span class="comment"> * 类似于上面而又不同于上面的函数去抖, 包装后函数在上一次操作执行过去了最小间隔时间后会直接执行, 否则会忽略该次操作</span></span><br><span class="line"><span class="comment"> * 与上面函数去抖的明显区别在连续操作时会按照最小间隔时间循环执行操作, 而非仅执行最后一次操作</span></span><br><span class="line"><span class="comment"> * 注: 该函数第一次调用一定会执行，不需要担心第一次拿不到缓存值，后面的连续调用都会拿到上一次的缓存值</span></span><br><span class="line"><span class="comment"> * 注: 返回函数结果的高阶函数需要使用 &#123;<span class="doctag">@link</span> Proxy&#125; 实现，以避免原函数原型链上的信息丢失</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; delay 最小间隔时间，单位为 ms</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; action 真正需要执行的操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">Function</span>&#125; 包装后有节流功能的函数。该函数是异步的，与需要包装的函数 &#123;<span class="doctag">@link</span> action&#125; 是否异步没有太大关联</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">throttle</span> = (<span class="params">delay, action</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> result</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(action, &#123;</span><br><span class="line">    <span class="title function_">apply</span>(<span class="params">target, thisArg, args</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> curr = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">        <span class="keyword">if</span> (curr - last &gt; delay) &#123;</span><br><span class="line">          result = <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(target, thisArg, args)</span><br><span class="line">          last = curr</span><br><span class="line">          <span class="title function_">resolve</span>(result)</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">resolve</span>(result)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自动超时"><a href="#自动超时" class="headerlink" title="自动超时"></a>自动超时</h3><blockquote>
<p>注: <code>asyncTimeout</code> 函数实际上只是为了避免一种情况，异步请求时间超过节流函数最小间隔时间导致结果返回顺序错乱。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为异步函数添加自动超时功能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeout 超时时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> action 异步函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 包装后的异步函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">asyncTimeout</span>(<span class="params">timeout, action</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(action, &#123;</span><br><span class="line">    <span class="title function_">apply</span>(<span class="params">_, _this, args</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>([</span><br><span class="line">        <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(_, _this, args),</span><br><span class="line">        <span class="title function_">wait</span>(timeout).<span class="title function_">then</span>(<span class="title class_">Promise</span>.<span class="property">reject</span>),</span><br><span class="line">      ])</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="结合使用"><a href="#结合使用" class="headerlink" title="结合使用"></a>结合使用</h3><p><a target="_blank" rel="noopener" href="https://codepen.io/pen/?editors=1112">测试一下</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 模拟一个异步请求，接受参数并返回它，然后等待指定的时间</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">ms</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">wait</span>(ms)</span><br><span class="line">    <span class="keyword">return</span> ms</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> time = <span class="number">100</span></span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">asyncTimeout</span>(time, <span class="title function_">throttle</span>(time, get))</span><br><span class="line">  <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> sum = <span class="number">0</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">30</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">20</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="title function_">fn</span>(<span class="number">10</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      last = res</span><br><span class="line">      sum += res</span><br><span class="line">    &#125;),</span><br><span class="line">  ])</span><br><span class="line">  <span class="comment">// last 结果为 10，和 switchMap 的不同点在于会保留最小间隔期间的第一次，而抛弃掉后面的异步结果，和 switchMap 正好相反！</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(last)</span><br><span class="line">  <span class="comment">// 实际上确实执行了 3 次，结果也确实为第一次次调用参数的 3 倍</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(sum)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>起初吾辈因为好奇实现了这种方式，但原以为会和 <code>concatMap</code> 类似的函数却变成了现在这样 – 更像倒置的 <code>switchMap</code> 了。不过由此看来这种方式的可行性并不大，毕竟，没人需要旧的数据。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>其实第一种实现方式属于 <a target="_blank" rel="noopener" href="https://github.com/ReactiveX/rxjs">rxjs</a> 早就已经走过的道路，目前被 Angular 大量采用（类比于 React 中的 Redux）。但 rxjs 实在太强大也太复杂了，对于吾辈而言，仅仅需要一只香蕉，而不需要拿着香蕉的大猩猩，以及其所处的整个森林（此处原本是被人吐槽面向对象编程的隐含环境，这里吾辈稍微藉此吐槽一下动不动就上库的开发者）。</p>
<blockquote>
<p>可以看到吾辈在这里大量使用了 <code>Proxy</code>，那么，原因是什么呢？这个疑问就留到下次再说吧！</p>
</blockquote>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/06/10/others/rxliuliBlog/JavaScript/JavaScript-%E8%A7%84%E8%8C%83%E6%95%B4%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/10/others/rxliuliBlog/JavaScript/JavaScript-%E8%A7%84%E8%8C%83%E6%95%B4%E7%90%86/" class="post-title-link" itemprop="url">JavaScript 规范整理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-10 12:56:43" itemprop="dateCreated datePublished" datetime="2019-06-10T12:56:43+08:00">2019-06-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-06-13 00:00:00" itemprop="dateModified" datetime="2019-06-13T00:00:00+08:00">2019-06-13</time>
    </span>


  
    <span id="/2019/06/10/others/rxliuliBlog/JavaScript/JavaScript-%E8%A7%84%E8%8C%83%E6%95%B4%E7%90%86/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript 规范整理" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript 规范整理" href="/2019/06/10/others/rxliuliBlog/JavaScript/JavaScript-%E8%A7%84%E8%8C%83%E6%95%B4%E7%90%86/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::de8cfac42bc6861f328bb50586bfa476" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaScript-规范整理"><a href="#JavaScript-规范整理" class="headerlink" title="JavaScript 规范整理"></a>JavaScript 规范整理</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><blockquote>
<p>圣人走过的道路，荆棘遍布，火焰片片焚烧……</p>
</blockquote>
<p>日常 <code>review</code> 代码时看到一些奇怪的代码，这里记录一下重构方案以及原因。</p>
<h2 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h2><h3 id="不要使用拼音命名"><a href="#不要使用拼音命名" class="headerlink" title="不要使用拼音命名"></a>不要使用拼音命名</h3><p>如果不熟悉英语，可以使用 <a target="_blank" rel="noopener" href="https://unbug.github.io/codelf/">Codelf</a> 或者 <a target="_blank" rel="noopener" href="https://translate.google.com/">Google 翻译</a>，避免使用拼音命名。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里是用户状态</span></span><br><span class="line"><span class="keyword">const</span> yongHuZhuangTai = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userStatus = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="函数中的变量"><a href="#函数中的变量" class="headerlink" title="函数中的变量"></a>函数中的变量</h3><p>js 中普通变量使用 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Camel_case">小写开头驼峰命名法</a>，而非不区分大小写，或使用下划线命名等等。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用户操作日志备注</span></span><br><span class="line"><span class="keyword">const</span> useroperatinglogremark = <span class="string">&#x27;新增用户&#x27;</span></span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userOperatingLogRemark = <span class="string">&#x27;新增用户&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="内部变量"><a href="#内部变量" class="headerlink" title="内部变量"></a>内部变量</h3><p>如果需要不想让使用者使用的属性（能够看到），需要使用下划线开头。例如 <code>_value</code>，代表内部的值，外部不应该直接访问（实际上可以做到）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DateFormat</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">fmt</span>) &#123;</span><br><span class="line">    <span class="comment">// 不想让外部使用</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_fmt</span> = fmt</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">format</span>(<span class="params">date</span>) &#123;</span><br><span class="line">    <span class="comment">// 具体格式化代码</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">parse</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="comment">// 具体解析代码</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不要使用无意义的前缀命名"><a href="#不要使用无意义的前缀命名" class="headerlink" title="不要使用无意义的前缀命名"></a>不要使用无意义的前缀命名</h3><p>如果一个对象的变量名已经很好的标识了该对象，那么内部的属性就不能使用对象名作为前缀！</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 活跃的日志信息</span></span><br><span class="line"><span class="keyword">const</span> activeLog = &#123;</span><br><span class="line">  <span class="attr">activeUserId</span>: <span class="string">&#x27;rx&#x27;</span>,</span><br><span class="line">  <span class="attr">activeTime</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> activeLog = &#123;</span><br><span class="line">  <span class="attr">userId</span>: <span class="string">&#x27;rx&#x27;</span>,</span><br><span class="line">  <span class="attr">time</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ES6"><a href="#ES6" class="headerlink" title="ES6"></a>ES6</h2><h3 id="优先使用-const-x2F-let"><a href="#优先使用-const-x2F-let" class="headerlink" title="优先使用 const&#x2F;let"></a>优先使用 const&#x2F;let</h3><p>一般情况下，使用 <code>const/let</code> 声明变量，而不是使用 <code>var</code>。因为使用 <code>var</code> 声明的变量会存在变量提升。</p>
<p>示例代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 使用 var 声明的变量（初始值为 undefined）</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i)</span><br><span class="line">  i = <span class="number">1</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i)</span><br><span class="line">  <span class="comment">// 此时使用 var 声明的变量 i 相当于在 function 顶部声明，然后在此处进行了赋值操作</span></span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 const 声明的变量（抛出异常 k is not defined）</span></span><br><span class="line">  <span class="comment">// console.log(k)</span></span><br><span class="line">  k = <span class="number">1</span></span><br><span class="line">  <span class="keyword">const</span> k = <span class="number">0</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>关于可以参考 <a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/acfc2875/">let 与 var 在 for 循环中的区别</a></p>
<h3 id="使用新的函数声明方式"><a href="#使用新的函数声明方式" class="headerlink" title="使用新的函数声明方式"></a>使用新的函数声明方式</h3><p>ES6 推出了一种更简洁的函数声明方式，不需要在写 <code>function</code>，只要 <strong>名字 + ()</strong> 即可在 <code>class</code> 或 <code>Object</code> 中声明函数。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;rx&#x27;</span>,</span><br><span class="line">  <span class="attr">hello</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello&#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> user = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;rx&#x27;</span>,</span><br><span class="line">  <span class="title function_">hello</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello&#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="优先使用箭头函数而非-function"><a href="#优先使用箭头函数而非-function" class="headerlink" title="优先使用箭头函数而非 function"></a>优先使用箭头函数而非 function</h3><p>优先使用 <strong>箭头函数</strong> 而不是使用传统的函数，尤其是使用 <strong>匿名函数</strong> 时，更应如此。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sum = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">  <span class="comment">// 过滤出偶数</span></span><br><span class="line">  .<span class="title function_">filter</span>(<span class="keyword">function</span>(<span class="params">i</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> i % <span class="number">2</span> === <span class="number">0</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 将偶数翻倍</span></span><br><span class="line">  .<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">i</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> i * <span class="number">2</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 计算总和</span></span><br><span class="line">  .<span class="title function_">reduce</span>(<span class="keyword">function</span>(<span class="params">res, i</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (res += i)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sum)</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sum = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">  <span class="comment">// 过滤出偶数</span></span><br><span class="line">  .<span class="title function_">filter</span>(<span class="function"><span class="params">i</span> =&gt;</span> i % <span class="number">2</span> === <span class="number">0</span>)</span><br><span class="line">  <span class="comment">// 将偶数翻倍</span></span><br><span class="line">  .<span class="title function_">map</span>(<span class="function"><span class="params">i</span> =&gt;</span> i * <span class="number">2</span>)</span><br><span class="line">  <span class="comment">// 计算总和</span></span><br><span class="line">  .<span class="title function_">reduce</span>(<span class="function">(<span class="params">res, i</span>) =&gt;</span> (res += i))</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sum)</span><br></pre></td></tr></table></figure>

<h3 id="不要使用-if-判断再赋予默认值"><a href="#不要使用-if-判断再赋予默认值" class="headerlink" title="不要使用 if 判断再赋予默认值"></a>不要使用 if 判断再赋予默认值</h3><p>如果函数需要对参数做默认值处理，请不要使用 <code>if</code> 判空之后再修改参数，而是使用 ES6 的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Functions/Default_parameters">默认参数</a> 和 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment">解构赋值</a>。</p>
<p>主要优点</p>
<ul>
<li>减少代码，JavaScript 是动态语言，维护起来较为麻烦，代码越少，错误越少</li>
<li>清晰明了，可以让人一眼就能看出这个参数的默认值，而不需要关心函数内部的逻辑</li>
<li>IDE 大多对此进行了支持，代码提示时便会告诉我们参数是可选的并且有默认值</li>
</ul>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 格式化日期</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Date</span>&#125; [date] 日期对象。默认为当前时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">String</span>&#125; 格式化日期字符串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">formatDate</span>(<span class="params">date</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (date === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    date = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;date.getFullYear()&#125;</span>-<span class="subst">$&#123;date.getMonth() + <span class="number">1</span>&#125;</span>-<span class="subst">$&#123;date.getDate()&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">formatDate</span>(<span class="params">date = <span class="keyword">new</span> <span class="built_in">Date</span>()</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;date.getFullYear()&#125;</span>-<span class="subst">$&#123;date.getMonth() + <span class="number">1</span>&#125;</span>-<span class="subst">$&#123;date.getDate()&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里如果展开来讲实在太多，请参考 <a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/5985b64e/">JavaScript 善用解构赋值</a></p>
<h3 id="优先使用-Map-做键值对映射而非传统的对象"><a href="#优先使用-Map-做键值对映射而非传统的对象" class="headerlink" title="优先使用 Map 做键值对映射而非传统的对象"></a>优先使用 Map 做键值对映射而非传统的对象</h3><p>如果需要 <strong>键值映射</strong>，不要使用一般的对象，而是用 ES6 的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Map">Map</a>。它不仅可以使用 <strong>任意类型的键</strong>，另外 Map 本身也是 <strong>有序</strong> 的哦</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="number">2</span>: <span class="string">&#x27;琉璃&#x27;</span>,</span><br><span class="line">  <span class="number">1</span>: <span class="string">&#x27;rx&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;1&#x27;</span>: <span class="string">&#x27;liuli&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 结果为 true，因为属性 1 实际上会被转换为 &#x27;1&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj[<span class="number">1</span>] === obj[<span class="string">&#x27;1&#x27;</span>])</span><br><span class="line"><span class="comment">// 结果为 [ &#x27;1&#x27;, &#x27;2&#x27;]，因为是按照属性字符串排序的</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">keys</span>(obj))</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">2</span>, <span class="string">&#x27;琉璃&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;liuli&#x27;</span>)</span><br><span class="line"><span class="comment">// 结果为 false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(map.<span class="title function_">get</span>(<span class="number">1</span>) === map.<span class="title function_">get</span>(<span class="string">&#x27;1&#x27;</span>))</span><br><span class="line"><span class="comment">// 结果为 [ 2, 1, &#x27;1&#x27; ]，因为是按照插入顺序排序的</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Array</span>.<span class="title function_">from</span>(map.<span class="title function_">keys</span>()))</span><br></pre></td></tr></table></figure>

<h3 id="优先使用模板字符串拼接多个字符串变量"><a href="#优先使用模板字符串拼接多个字符串变量" class="headerlink" title="优先使用模板字符串拼接多个字符串变量"></a>优先使用模板字符串拼接多个字符串变量</h3><p>如果需要拼接多个对象以及字符串时，不要使用 <code>+</code> 进行拼接，使用 es6 的 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/template_strings">模板字符串</a> 会更好一点。一般而言，如果需要拼接的变量超过 3 个，那么就应该使用模板字符串了。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params">name, age, sex</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;name: &#x27;</span> + name + <span class="string">&#x27;, age: &#x27;</span> + age + <span class="string">&#x27;, sex: &#x27;</span> + sex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params">name, age, sex</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`name: <span class="subst">$&#123;name&#125;</span>, age: <span class="subst">$&#123;age&#125;</span>, sex: <span class="subst">$&#123;sex&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="当独立参数超过-3-个时使用对象参数并解构"><a href="#当独立参数超过-3-个时使用对象参数并解构" class="headerlink" title="当独立参数超过 3 个时使用对象参数并解构"></a>当独立参数超过 3 个时使用对象参数并解构</h3><p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params">name, age, sex</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`name: <span class="subst">$&#123;name&#125;</span>, age: <span class="subst">$&#123;age&#125;</span>, sex: <span class="subst">$&#123;sex&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hello</span>(<span class="params">&#123; name, age, sex &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`name: <span class="subst">$&#123;name&#125;</span>, age: <span class="subst">$&#123;age&#125;</span>, sex: <span class="subst">$&#123;sex&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不要写多余的-await"><a href="#不要写多余的-await" class="headerlink" title="不要写多余的 await"></a>不要写多余的 await</h3><p>如果 <code>await</code> 是不必要的（在返回语句时，那么就不要用 <code>async</code> 标识函数），这是没有必要的 – 除非，你需要在这个函数内异步操作完成后有其他操作。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!useranme) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;用户名不能为空&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!password) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;密码不能为空&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 真正发起登录请求</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> userApi.<span class="title function_">login</span>(user)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = (<span class="params">&#123; username, password &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!useranme) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;用户名不能为空&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!password) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;密码不能为空&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 真正发起登录请求</span></span><br><span class="line">  <span class="keyword">return</span> userApi.<span class="title function_">login</span>(user)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不要使用-x3D-x3D-进行比较"><a href="#不要使用-x3D-x3D-进行比较" class="headerlink" title="不要使用 &#x3D;&#x3D; 进行比较"></a>不要使用 &#x3D;&#x3D; 进行比较</h3><p>在 js 中使用 <code>==</code> 比较相当危险，你永远不知道 js 到底是按照什么类型比较的，因为 js 会做各种隐式转换。而如果使用 <code>===</code> 比较，则会同时比较 <strong>值</strong> 和 <strong>类型</strong> 是否都相同，避免了各种不确定的问题。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span> == <span class="literal">true</span>) <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span> == <span class="string">&#x27;1&#x27;</span>) <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span> == <span class="literal">true</span>) <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;0&#x27;</span> == <span class="literal">true</span>) <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>([] == []) <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>扪心自问，你真的知道上面为什么会出现这种结果么？即便知道，对于其他人而言仍然是难以预测的，所以抛弃掉 <code>==</code> 吧，学会使用更好的 <code>===</code> 最好</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span> == <span class="literal">true</span>) <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span> == <span class="string">&#x27;1&#x27;</span>) <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span> == <span class="literal">true</span>) <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;0&#x27;</span> == <span class="literal">true</span>) <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>([] == []) <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<h3 id="使用计算属性名替代使用方括号表示法赋值"><a href="#使用计算属性名替代使用方括号表示法赋值" class="headerlink" title="使用计算属性名替代使用方括号表示法赋值"></a>使用计算属性名替代使用方括号表示法赋值</h3><p>目前而言已经有了 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Object_initializer#%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E5%90%8D">计算属性名</a> 用以在初始化时计算属性名，所以不需要再先声明对象再使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Property_Accessors#%E6%96%B9%E6%8B%AC%E5%8F%B7%E8%A1%A8%E7%A4%BA%E6%B3%95">方括号表示法</a> 进行赋值了。</p>
<p>ES5 写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  <span class="string">&#x27;user.username&#x27;</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">state[<span class="title class_">Date</span>.<span class="title function_">now</span>()] = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(state)</span><br></pre></td></tr></table></figure>

<p>ES6 写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  <span class="string">&#x27;user.username&#x27;</span>() &#123;&#125;,</span><br><span class="line">  [<span class="title class_">Date</span>.<span class="title function_">now</span>()]: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(state)</span><br></pre></td></tr></table></figure>

<h3 id="简单的选项列表优先使用-Map-而非数组"><a href="#简单的选项列表优先使用-Map-而非数组" class="headerlink" title="简单的选项列表优先使用 Map 而非数组"></a>简单的选项列表优先使用 Map 而非数组</h3><p>对于复选框，想必很多人相当熟悉。下面使用 js 模拟一个复选框</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> item = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">role</span>: [<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>],</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> options = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">roleid</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="attr">label</span>: <span class="string">&#x27;黄金糕&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">roleid</span>: <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">    <span class="attr">label</span>: <span class="string">&#x27;双皮奶&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">roleid</span>: <span class="string">&#x27;3&#x27;</span>,</span><br><span class="line">    <span class="attr">label</span>: <span class="string">&#x27;蚵仔煎&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>现在的需求是根据 <code>role</code> 计算显示值 <code>name</code> 的值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">item.<span class="property">name</span> = item.<span class="property">role</span></span><br><span class="line">  .<span class="title function_">map</span>(<span class="function"><span class="params">role</span> =&gt;</span> options.<span class="title function_">find</span>(<span class="function"><span class="params">op</span> =&gt;</span> op.<span class="property">roleid</span> === role))</span><br><span class="line">  .<span class="title function_">filter</span>(<span class="function"><span class="params">s</span> =&gt;</span> s)</span><br><span class="line">  .<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>但实际上这里应该使用 <code>Map</code> 替代数组，因为数组的 <code>find</code> 其实非常低效，也需要进行遍历，使用 <code>Map</code> 的实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> item = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">role</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> options = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">1</span>, <span class="string">&#x27;黄金糕&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">2</span>, <span class="string">&#x27;双皮奶&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">3</span>, <span class="string">&#x27;蚵仔煎&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">calcName</span>(<span class="params">role</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> role</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function"><span class="params">k</span> =&gt;</span> options.<span class="title function_">get</span>(k))</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="function"><span class="params">s</span> =&gt;</span> s)</span><br><span class="line">    .<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">item.<span class="property">name</span> = <span class="title function_">calcName</span>(item.<span class="property">role</span>)</span><br></pre></td></tr></table></figure>

<p>可以看到，获取时使用了 <code>Map#get</code>，在效率上应该是极好的。</p>
<blockquote>
<p>附: 该问题来自 <a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000019426996">https://segmentfault.com/q/1010000019426996</a></p>
</blockquote>
<h3 id="存放-id-标识列表使用-Set-而非数组"><a href="#存放-id-标识列表使用-Set-而非数组" class="headerlink" title="存放 id 标识列表使用 Set 而非数组"></a>存放 id 标识列表使用 Set 而非数组</h3><p>还是上面的例子，当你需要存取当前选中复选框的值 <code>role</code> 使用数组时，有可能遇到 id 重复的问题，实际上导致每次添加前需要使用 <code>Array#includes</code> 判断是否已存在。这里可以使用 <code>Set</code> 从数据结构层面避免掉可能重复的问题。</p>
<p>修改后的实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> item = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">role</span>: <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="number">1</span>, <span class="number">2</span>]),</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> options = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">1</span>, <span class="string">&#x27;黄金糕&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">2</span>, <span class="string">&#x27;双皮奶&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="number">3</span>, <span class="string">&#x27;蚵仔煎&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">calcName</span>(<span class="params">role</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(role)</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function"><span class="params">k</span> =&gt;</span> options.<span class="title function_">get</span>(k))</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="function"><span class="params">s</span> =&gt;</span> s)</span><br><span class="line">    .<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">item.<span class="property">name</span> = <span class="title function_">calcName</span>(item.<span class="property">role</span>)</span><br></pre></td></tr></table></figure>

<p>先判断是否存在执行某些操作也非常方便，可以使用 <code>Set#has</code> 进行判断，当然时间复杂度时 O1。</p>
<h2 id="逻辑代码"><a href="#逻辑代码" class="headerlink" title="逻辑代码"></a>逻辑代码</h2><h3 id="不要判断一个-Boolean-值并以此返回-Boolean-值"><a href="#不要判断一个-Boolean-值并以此返回-Boolean-值" class="headerlink" title="不要判断一个 Boolean 值并以此返回 Boolean 值"></a>不要判断一个 Boolean 值并以此返回 Boolean 值</h3><p>不要在得到一个 <code>Boolean</code> 的值后使用 <code>if-else</code> 进行判断，然后根据结果返回 <code>true</code> 或 <code>false</code>，这真的显得非常非常蠢！</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> res = username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br><span class="line">  <span class="keyword">if</span> (res) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt;</span><br><span class="line">  username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="不要使用多余的变量"><a href="#不要使用多余的变量" class="headerlink" title="不要使用多余的变量"></a>不要使用多余的变量</h3><p>如果一个表达式立刻被使用并且只会被使用一次，那就不要使用变量声明，直接在需要的地方使用好了。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> res = username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不要使用嵌套-if"><a href="#不要使用嵌套-if" class="headerlink" title="不要使用嵌套 if"></a>不要使用嵌套 if</h3><p>不要使用多级的 <code>if</code> 嵌套，这会让代码变得丑陋且难以调试，应当优先使用 <strong>提前 return</strong> 的策略。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt;</span><br><span class="line">  username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">submit</span>(<span class="params">user</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = user</span><br><span class="line">  <span class="keyword">if</span> (username) &#123;</span><br><span class="line">    <span class="keyword">if</span> (password) &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">login</span>(user)</span><br><span class="line">      <span class="keyword">if</span> (res) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;登录成功，即将跳转到首页&#x27;</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;登录失败，请检查用户名和密码&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;用户密码不能为空&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;用户名不能为空&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt;</span><br><span class="line">  username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">submit</span>(<span class="params">user</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = user</span><br><span class="line">  <span class="keyword">if</span> (!username) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;用户名不能为空&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!password) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;用户密码不能为空&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">login</span>(user)</span><br><span class="line">  <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;登录失败，请检查用户名和密码&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;登录成功，即将跳转到首页&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不要先声明空对象然后一个个追加属性"><a href="#不要先声明空对象然后一个个追加属性" class="headerlink" title="不要先声明空对象然后一个个追加属性"></a>不要先声明空对象然后一个个追加属性</h3><p>有时候会碰到这种情况，先声明一个空对象，然后在下面一个个追加属性，为什么创建对象与初始化不放到一起做呢？</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt;</span><br><span class="line">  username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">submit</span>(<span class="params">username, password</span>) &#123;</span><br><span class="line">  <span class="comment">// 数据格式校验处理。。。</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> user = &#123;&#125;</span><br><span class="line">  user.<span class="property">username</span> = username.<span class="title function_">trim</span>()</span><br><span class="line">  user.<span class="property">password</span> = password.<span class="title function_">trim</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">login</span>(user)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 后续的错误处理。。。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟登录异步请求</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">login</span> = <span class="keyword">async</span> (<span class="params">&#123; username, password &#125;</span>) =&gt;</span><br><span class="line">  username === <span class="string">&#x27;rx&#x27;</span> &amp;&amp; password === <span class="string">&#x27;rx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">submit</span>(<span class="params">username, password</span>) &#123;</span><br><span class="line">  <span class="comment">// 数据格式校验处理。。。</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> user = &#123;</span><br><span class="line">    <span class="attr">username</span>: username.<span class="title function_">trim</span>(),</span><br><span class="line">    <span class="attr">password</span>: password.<span class="title function_">trim</span>(),</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">login</span>(user)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 后续的错误处理。。。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="不要使用无意义的函数包裹"><a href="#不要使用无意义的函数包裹" class="headerlink" title="不要使用无意义的函数包裹"></a>不要使用无意义的函数包裹</h3><p>使用函数时，如果你想包裹的函数和原来函数的参数&#x2F;返回值相同，那就直接应该使用函数作为参数，而非在包裹一层。给人的感觉就像是大夏天穿着棉袄吃雪糕 – 多此一举！</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否是偶数的函数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isEven</span> = i =&gt; i % <span class="number">2</span> === <span class="number">0</span></span><br><span class="line"><span class="comment">//过滤出所有偶数</span></span><br><span class="line"><span class="keyword">const</span> res = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>].<span class="title function_">filter</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="title function_">isEven</span>(i))</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否是偶数的函数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isEven</span> = i =&gt; i % <span class="number">2</span> === <span class="number">0</span></span><br><span class="line"><span class="comment">//过滤出所有偶数</span></span><br><span class="line"><span class="keyword">const</span> res = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>].<span class="title function_">filter</span>(isEven)</span><br></pre></td></tr></table></figure>

<h3 id="不要使用三元运算符进行复杂的计算"><a href="#不要使用三元运算符进行复杂的计算" class="headerlink" title="不要使用三元运算符进行复杂的计算"></a>不要使用三元运算符进行复杂的计算</h3><p>三元运算符适合于替代简单的 <code>if-else</code> 的情况，如果碰到较为复杂的情况，请使用 <code>if + return</code> 或者解构&#x2F;默认参数的方式解决。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">formatUser</span>(<span class="params">user</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> user === <span class="literal">undefined</span></span><br><span class="line">    ? <span class="string">&#x27;username: noname, password: blank&#x27;</span></span><br><span class="line">    : <span class="string">&#x27;username: &#x27;</span> +</span><br><span class="line">        (user.<span class="property">username</span> === <span class="literal">undefined</span> ? <span class="string">&#x27;noname&#x27;</span> : user.<span class="property">username</span>) +</span><br><span class="line">        <span class="string">&#x27;, password: &#x27;</span> +</span><br><span class="line">        (user.<span class="property">password</span> === <span class="literal">undefined</span> ? <span class="string">&#x27;blank&#x27;</span> : user.<span class="property">password</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到上面的代码就感觉到一股烂代码的味道扑面而来，这实在是太糟糕了！实际上只需要两行代码就好了！</p>
<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">formatUser</span>(<span class="params">&#123; username = <span class="string">&#x27;noname&#x27;</span>, password = <span class="string">&#x27;blank&#x27;</span> &#125; = &#123;&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`username: <span class="subst">$&#123;username&#125;</span>, password: <span class="subst">$&#123;password&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="如果变量有所关联则使用对象而非多个单独的变量"><a href="#如果变量有所关联则使用对象而非多个单独的变量" class="headerlink" title="如果变量有所关联则使用对象而非多个单独的变量"></a>如果变量有所关联则使用对象而非多个单独的变量</h3><p>如果变量有所关联，例如一个表单，存储的时候不要使用单独的变量，将之存储到一个表单变量中更好。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> username = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#username&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> password = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#password&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> remeberMe = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#remeberMe&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一些校验。。。</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">validate</span>(username, password, remeberMe)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 请求后台</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> userLogin.<span class="title function_">login</span>(username, password, remeberMe)</span><br><span class="line">  <span class="comment">// 后处理。。。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">login</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> user = &#123;</span><br><span class="line">    username : <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#username&#x27;</span>),</span><br><span class="line">    password : <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#password&#x27;</span>),</span><br><span class="line">    remeberMe : <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#remeberMe&#x27;</span>),</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 一些校验。。。</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">validate</span>(user)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 请求后台</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> userLogin.<span class="title function_">login</span>(user)</span><br><span class="line">  <span class="comment">// 后处理。。。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="应该尽量解决编辑器警告"><a href="#应该尽量解决编辑器警告" class="headerlink" title="应该尽量解决编辑器警告"></a>应该尽量解决编辑器警告</h3><p>如果编辑器对我们的代码发出警告，那么一般都是我们代码出现了问题（一般开发人员的能力并不足以比肩编辑器 #MS 那些 dalao 的能力）。所以，如果出现了警告，应该先去解决它 – 如果你确认发生了错误，则通过注释&#x2F;配置禁用它！</p>
<h3 id="使用类型定义参数对象"><a href="#使用类型定义参数对象" class="headerlink" title="使用类型定义参数对象"></a>使用类型定义参数对象</h3><p>如果一个函数需要一个对象参数，最好专门定义一个类型，并在注释上说明，便于在使用时 IDE 进行提示，而不需要去查找文档手册。</p>
<p>错误示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 格式化用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; user 格式化的用户对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">formatUser</span>(<span class="params">user</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = user || &#123;&#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`user, username: <span class="subst">$&#123;username&#125;</span>, password: <span class="subst">$&#123;password&#125;</span>`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 此处别人并不知道 User 里面到底有什么属性，只能去查看文档</span></span><br><span class="line"><span class="keyword">const</span> str = <span class="title function_">formatUser</span>(&#123; <span class="attr">username</span>: <span class="string">&#x27;rx&#x27;</span>, <span class="attr">password</span>: <span class="string">&#x27;123456&#x27;</span> &#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str)</span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">username, password</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">username</span> = username</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">password</span> = password</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 格式化用户</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">User</span>&#125; user 格式化的用户对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">formatUser</span>(<span class="params">user</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = user || &#123;&#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`user, username: <span class="subst">$&#123;username&#125;</span>, password: <span class="subst">$&#123;password&#125;</span>`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> str = <span class="title function_">formatUser</span>(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&#x27;rx&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str)</span><br></pre></td></tr></table></figure>

<h3 id="尽量扁平化代码"><a href="#尽量扁平化代码" class="headerlink" title="尽量扁平化代码"></a>尽量扁平化代码</h3><p>尽量将 <code>a</code> 调用 <code>b</code>, <code>b</code> 调用 <code>c</code>，然后 <code>b</code> 调用 <code>d</code>，优化为依次调用 <code>a, b, c, d</code>。</p>
<blockquote>
<p>注意: 这里使用的是<strong>尽量</strong>而非<strong>不要</strong>，深层嵌套不可避免，但在局部上，应该采取扁平化的策略，<strong>提前 return</strong> 避免嵌套 if-else 是个很好的例子。</p>
</blockquote>
<h3 id="自执行函数前面必须加分号"><a href="#自执行函数前面必须加分号" class="headerlink" title="自执行函数前面必须加分号"></a>自执行函数前面必须加分号</h3><p>如果我们需要使用自执行函数，则开头必须加上 <code>;</code> 以避免可能出现的歧义。</p>
<p>错误示例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> returnItself(o) &#123;</span><br><span class="line">  <span class="built_in">return</span> o</span><br><span class="line">&#125;</span><br><span class="line">returnItself(() =&gt; console.log(1))</span><br><span class="line">(() =&gt; &#123;</span><br><span class="line">  console.log(2)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>上面这段代码是有问题的，因为后面的自执行函数会被认为是上一句的 <code>returnItself</code> 返回函数的参数，最后的括号会被认为又是一次调用，将会抛出错误</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">returnItself</span>(...)(...) is not a <span class="keyword">function</span></span><br></pre></td></tr></table></figure>

<p>正确示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">returnItself</span>(<span class="params">o</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> o</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">returnItself</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>))</span><br><span class="line">;(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>使用分号可以明确告诉 JavaScript 这是一行新的代码，上面的代码已经到此为止了。</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/05/27/others/rxliuliBlog/Tool/Windows/%E4%BC%98%E5%8C%96-Google-Chrome-%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/27/others/rxliuliBlog/Tool/Windows/%E4%BC%98%E5%8C%96-Google-Chrome-%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/" class="post-title-link" itemprop="url">优化 Google Chrome 的使用体验</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-27 18:29:11" itemprop="dateCreated datePublished" datetime="2019-05-27T18:29:11+08:00">2019-05-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-12-09 00:00:00" itemprop="dateModified" datetime="2019-12-09T00:00:00+08:00">2019-12-09</time>
    </span>


  
    <span id="/2019/05/27/others/rxliuliBlog/Tool/Windows/%E4%BC%98%E5%8C%96-Google-Chrome-%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/" class="post-meta-item leancloud_visitors" data-flag-title="优化 Google Chrome 的使用体验" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="优化 Google Chrome 的使用体验" href="/2019/05/27/others/rxliuliBlog/Tool/Windows/%E4%BC%98%E5%8C%96-Google-Chrome-%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BD%93%E9%AA%8C/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::5d073eaae8d1346ea0d6f081c2ac2a8c" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="优化-Google-Chrome-的使用体验"><a href="#优化-Google-Chrome-的使用体验" class="headerlink" title="优化 Google Chrome 的使用体验"></a>优化 Google Chrome 的使用体验</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>假若我没有看见光明，我本可以忍受黑暗。</p>
</blockquote>
<p>下面是吾辈在使用 Chrome 遇到的一些不舒服的地方，以及对应的解决方法。一切皆是为了一个目标：<strong>提高浏览器的使用体验！</strong></p>
<h2 id="字体"><a href="#字体" class="headerlink" title="字体"></a>字体</h2><p>在之前吾辈也未曾对字体有过什么注意，直到后来听闻 MacOS 的字体显示比 Windows 上好很多，去看了一下确实如此。想要有一个好看的字体，字体本身极为重要，这里吾辈目前在使用，也很推荐的字体是 <a target="_blank" rel="noopener" href="https://github.com/be5invis/Sarasa-Gothic">Sarasa Gothic</a>。支持 <strong>简中&#x2F;繁中&#x2F;英&#x2F;日</strong> 四种语言，虽然体积稍微庞大，但效果却是相当不错。</p>
<p>Windows 字体预览</p>
<p><img src="https://img.rxliuli.com/20190527190659.png" alt="更纱黑体"></p>
<blockquote>
<p>这里也推荐作为编程字体，毕竟程序中同时存在中英文，而一个同时支持中英文的等宽字体实在难得。</p>
</blockquote>
<h2 id="设置网页默认字体"><a href="#设置网页默认字体" class="headerlink" title="设置网页默认字体"></a>设置网页默认字体</h2><p>安装完了字体，然而 Chrome 默认并不会使用它，我们还需要 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/stylus/clngdbkpkpeebahjckkjfobafhncgmne">Stylus</a> 进行指定。</p>
<p><img src="https://img.rxliuli.com/20190527221308.png" alt="添加 UserCSS"></p>
<p>添加一个新的样式，内容只需要设置所有元素使用的字体为 <strong>Sarasa Mono CL</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 全局字体设置 */</span></span><br><span class="line">* &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">&#x27;Sarasa Mono CL&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 强制指定 input 框中的字体 */</span></span><br><span class="line"><span class="selector-tag">input</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">&#x27;Sarasa Mono CL&#x27;</span> <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时候查看一下字体效果</p>
<p><img src="https://img.rxliuli.com/20190527221458.png" alt="效果"></p>
<h2 id="夜间模式"><a href="#夜间模式" class="headerlink" title="夜间模式"></a>夜间模式</h2><p>如果你像吾辈一样，喜欢暗色的主题，可以使用插件 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/dark-reader/eimadpbcbfnmbkopoojfekhnkhdbieeh">Dark Reader</a>，它能够让网页默认使用暗色模式，看起来和编辑器保持一致：并且，看起来很 <strong>Geek</strong>！</p>
<p><img src="https://img.rxliuli.com/20190531203702.png" alt="暗色模式"></p>
<p>看起来标题栏很违和？安装一个 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/morpheon-dark/mafbdhjdkjnoafhfelkjpchpaepjknad">Dark 主题</a> 试试看。<br>现在，是不是变得很和谐了呢？</p>
<p><img src="https://img.rxliuli.com/20190531225833.png" alt="暗色标题栏"></p>
<h2 id="广告过滤"><a href="#广告过滤" class="headerlink" title="广告过滤"></a>广告过滤</h2><p>目前而言，浏览网站时，没有一个广告过滤插件的话，广告的数量将是难以置信的庞大，而且讨人厌！<br>吾辈目前在 Chrome 上仅推荐 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/ublock-origin/cjpalhdlnbpafiamejdnhcphjbkeiagm">uBlock Origin</a>，开源免费，不推荐 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/adblock-plus-free-ad-bloc/cfhdojbkjhnklbpkdaibdccddilifddb">Adblock Plus</a> 与 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/ublock/epcnnfbjfcgphgdmggkamkmgojdagdnn">Ublock</a>。前者将广告拦截做成了生意（参见 <a target="_blank" rel="noopener" href="https://36kr.com/p/5052897">向来以屏蔽互联网广告为己任的 AdBlock Plus，为什么卖起广告了？</a>），后者则是接手开发者的自私接受捐款导致原作者 Fork 并开发了新版本 Ublock Origin（参见 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-hans/UBlock_Origin">Wiki uBlock Origin 历史</a>）。</p>
<p>虽然吾辈基本上日常 Google，不过为了比较这里来看一下未进行广告过滤前的百度搜索结果</p>
<p>搜索<strong>购物</strong>，天啊，第一页全都是<strong>广告</strong>，百度真的丧心病狂。。。</p>
<blockquote>
<p>注意每个搜索结果下面的小字 <strong>广告</strong></p>
</blockquote>
<p><img src="https://img.rxliuli.com/20190531210354.png" alt="百度的广告"></p>
<p>使用插件后的效果</p>
<p><img src="https://img.rxliuli.com/20190531210454.png" alt="过滤后的百度搜索"></p>
<p>嗯，清爽了许多呢 ~ o(*￣ ▽ ￣*)o</p>
<p>这里对比一下 Google 的搜索结果，可以明显看出来百度的广告的数量之多。。。</p>
<p><img src="https://img.rxliuli.com/20190531210759.png" alt="对比的 Google 搜索结果"></p>
<h2 id="自动翻页"><a href="#自动翻页" class="headerlink" title="自动翻页"></a>自动翻页</h2><p>如果你也觉得搜索结果需要翻页好麻烦，那么 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/uautopagerize/kdplapeciagkkjoignnkfpbfkebcfbpb">uAutoPagerize</a> 可以一样可以帮到你！</p>
<blockquote>
<p>相比于 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/autopagerize/igiofjhpmpihnifddepnpngfjhkfenbp">AutoPagerize</a> 万年不更新，uAutoPagerize 仍在积极维护中！</p>
</blockquote>
<p>下面是使用了 uAutoPagerize 后的 Google 搜索结果，会在滚动到接近底部时，自动获取下一页的内容并拼接到最后！</p>
<p><img src="https://img.rxliuli.com/20191114123652.png" alt="使用 uAutoPagerize"></p>
<p>当然，它也支持百度哦</p>
<h2 id="屏蔽-Google-搜索结果"><a href="#屏蔽-Google-搜索结果" class="headerlink" title="屏蔽 Google 搜索结果"></a>屏蔽 Google 搜索结果</h2><p>当你搜索中文技术相关的内容时，一定会遇到一个令人厌恶的社区 – CSDN 博客。里面的内容基本上都是复制粘贴，甚至作者都并未真实尝试过就发出来了，实在是太烂了！<br>所以，使用 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo">Tampermonkey</a> 油猴插件 + 油猴脚本便可以轻松屏蔽掉它们。</p>
<blockquote>
<p>吾辈并不否认 CSDN 有很多有趣的作者，但是啊，相比于这个平台的大多数人，他们实在太少了，简直如同大海捞针一般。<br><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh/Greasemonkey">油猴脚本</a>: 是一段可以在某个网页自动运行的 JavaScript 脚本，事实上，抛开 Tampermonkey 这个运行容器不说，油猴脚本就是彻头彻尾的 JavaScript 代码，任何了解过 Web 开发的人应该都能写一个简单的油猴脚本。如果你打算尝试玩玩油猴脚本，可以参考吾辈踩过的坑 <a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/75bbc83f/">Greasemonkey 踩坑之路</a></p>
</blockquote>
<p>你需要先安装 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo">Tampermonkey</a> 插件，然后在 <a target="_blank" rel="noopener" href="https://greasyfork.org/zh-CN/">Greasy Fork</a> 安装脚本 <a target="_blank" rel="noopener" href="https://greasyfork.org/zh-CN/scripts/1682">Google Hit Hider by Domain</a>。</p>
<p>然后在 Google 搜索 <a target="_blank" rel="noopener" href="https://www.google.com/search?q=js+%E6%95%B0%E7%BB%84%E5%8E%BB%E9%87%8D">js 数组去重</a>，可以看到包含了几个的 CSDN 博客的结果</p>
<p><img src="https://img.rxliuli.com/20190531213523.png" alt="CSND 博客搜索结果"></p>
<p>现在，让我们从 Google 搜索中屏蔽 blog.csdn.net 这个域名</p>
<p><img src="https://img.rxliuli.com/20190531214002.png" alt="Block 操作"></p>
<p>屏蔽后的搜索结果，CSDN Blog 那些垃圾博客不见了，心情大好！</p>
<p><img src="https://img.rxliuli.com/20190531214650.png" alt="屏蔽后的结果"></p>
<h2 id="冻结后台标签页"><a href="#冻结后台标签页" class="headerlink" title="冻结后台标签页"></a>冻结后台标签页</h2><p>你是否也曾因为 Chrome 开了太多标签页而占用了庞大的内存？那么 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/the-great-suspender/klbibkeccnjlkjkiokjodocebajanakg">The Great Suspender</a> 就是最好的帮手，它能自动冻结后台一段时间没有访问的标签页，以便于释放系统内存。并且，当你再次访问时，标签页将会自动重新加载。如果你也经常开了很多个标签页忘记关闭了，那么它可以帮助你自动管理他们。</p>
<p>下面演示多个标签页被冻结的效果</p>
<p><img src="https://img.rxliuli.com/20190531220652.png" alt="冻结的标签页"></p>
<h2 id="下载增强"><a href="#下载增强" class="headerlink" title="下载增强"></a>下载增强</h2><p>你使用 Chrome 下载过资料么？是否也对 Chrome 单线程下载并且在下载完成后强制检查资源安全性感到不满？那么 <a target="_blank" rel="noopener" href="https://www.freedownloadmanager.org/zh/">FDM</a> 应该是 Windows 上比较好的选择下载工具了，你可以下载并安装到 PC 上，然后安装 Chrome 插件 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/free-download-manager/ahmpjcflkgiildlgicmcieglgoilbfdp">Free Download Manager</a> 即可将所有 Chrome 中的下载请求交给 FDM，并且，它携带着 Cookie，所以即使是有权限校验的下载也能够胜任。</p>
<p>FDM 的优势</p>
<ul>
<li>多线程下载</li>
<li>断点续传</li>
<li>支持 BT</li>
<li>自动分类</li>
<li>下载限速</li>
<li>国际化</li>
<li>自由免费</li>
</ul>
<p>所以，如果经常下载资料的话推荐入坑 FDM，这里放一张首页</p>
<p><img src="https://img.rxliuli.com/20190531221709.png" alt="FDM 首页"></p>
<h2 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h2><p>使用浏览器，一些高频操作的快捷键也是必不可少的。</p>
<ul>
<li><code>CS-T</code>: 重新打开上一个关闭的标签页</li>
<li><code>中键/C-左键</code>: 强制在新标签页打开链接</li>
<li><code>中键(浏览器标签上)</code>: 关闭这个标签页</li>
<li><code>A-左键</code>: 选择链接中的文字（不会触发拖动链接）</li>
<li><code>S-滚轮</code>: 水平移动滚动条</li>
<li><code>空格</code>: 翻到下一页</li>
<li><code>F12</code>: 开启&#x2F;关闭开发者工具</li>
<li><code>C-R</code>: 重新加载当前页面</li>
<li><code>CS-R</code>: 硬性重新加载</li>
<li><code>CS-N</code>: 打开隐私标签页</li>
<li><code>C-T</code>: 打开新的标签页</li>
<li><code>C-W</code>: 关闭当前标签页</li>
</ul>
<h2 id="GitHub-优化"><a href="#GitHub-优化" class="headerlink" title="GitHub 优化"></a>GitHub 优化</h2><p>众所周知，GitHub 作为最大的开源平台，平时访问的频率是相当高的，这里吾辈推荐一些插件&#x2F;UserCSS 以增强使用体验。</p>
<h3 id="树结构浏览代码"><a href="#树结构浏览代码" class="headerlink" title="树结构浏览代码"></a>树结构浏览代码</h3><p>GitHub 浏览代码侧边栏没有一个文件栏实在难受，所以这里推荐 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/gitako-github-file-tree/giljefjcheohhamkjphiebfjnlphnokk">Gitako</a>   这个插件。它能够为 GitHub 添加一个侧边栏，极大的方便了在线代码浏览。</p>
<blockquote>
<p>相比于 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/octotree/bkhaagjahfmjljalopjnoealnfndnagc">Octotree</a>，Gitako 的性能更好，而且是完全免费的。</p>
</blockquote>
<p><img src="https://img.rxliuli.com/20191114123238.png" alt="Gitako 侧边文件夹"></p>
<h3 id="立体化-GitHub-用户活动"><a href="#立体化-GitHub-用户活动" class="headerlink" title="立体化 GitHub 用户活动"></a>立体化 GitHub 用户活动</h3><p>当你查看一个 GitHub 用户的活动概览时，总是平面方块未免有些无聊，而且以颜色深浅区分也尚不明了。</p>
<p><img src="https://img.rxliuli.com/20190531223619.png" alt="GitHub 用户活动平面图"></p>
<p>所以，你可以使用 <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/isometric-contributions/mjoedlfflcchnleknnceiplgaeoegien">Isometric Contributions</a> 插件，让活动变得更有趣一点，变成更直观的 3D 柱状图。</p>
<p><img src="https://img.rxliuli.com/20190531223909.png" alt="GitHub 用户活动 3D 图"></p>
<h3 id="统计仓库大小"><a href="#统计仓库大小" class="headerlink" title="统计仓库大小"></a>统计仓库大小</h3><p>或许你也有 clone 之前先知道仓库大小的习惯，这在网络稍差的环境中尤为重要，例如 TypeScript 的仓库大小超过 1G，如果没有准备的话直接下载很容易炸！</p>
<blockquote>
<p>GitHub 下载仓库时并不会给出下载的百分比，所以什么时候下载完成是个玄学。。。</p>
</blockquote>
<p><img src="https://img.rxliuli.com/20190531224452.png" alt="统计仓库大小"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Chrome 有很多可以优化体验的地方，这里也只是吾辈所接触到的一部分罢了，欢迎在下面留言补充！</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/05/23/others/rxliuliBlog/JavaScript/JavaScript-TypeScript-%E8%BF%81%E7%A7%BB%E4%BD%93%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/23/others/rxliuliBlog/JavaScript/JavaScript-TypeScript-%E8%BF%81%E7%A7%BB%E4%BD%93%E9%AA%8C/" class="post-title-link" itemprop="url">JavaScript => TypeScript 迁移体验</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-23 20:22:36" itemprop="dateCreated datePublished" datetime="2019-05-23T20:22:36+08:00">2019-05-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-06-28 00:00:00" itemprop="dateModified" datetime="2019-06-28T00:00:00+08:00">2019-06-28</time>
    </span>


  
    <span id="/2019/05/23/others/rxliuliBlog/JavaScript/JavaScript-TypeScript-%E8%BF%81%E7%A7%BB%E4%BD%93%E9%AA%8C/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript => TypeScript 迁移体验" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript => TypeScript 迁移体验" href="/2019/05/23/others/rxliuliBlog/JavaScript/JavaScript-TypeScript-%E8%BF%81%E7%A7%BB%E4%BD%93%E9%AA%8C/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::1638afb8689c45a2b0e2c900783eb902" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaScript-x3D-gt-TypeScript-迁移体验"><a href="#JavaScript-x3D-gt-TypeScript-迁移体验" class="headerlink" title="JavaScript &#x3D;&gt; TypeScript 迁移体验"></a>JavaScript &#x3D;&gt; TypeScript 迁移体验</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>如果你使用 JavaScript 没出现什么问题，那吾辈就不推荐你迁移到 TypeScript！</p>
</blockquote>
<ul>
<li><code>JavaScript</code> 不能无缝迁移到 <code>TypeScript</code>！</li>
<li><code>JavaScript</code> 不能无缝迁移到 <code>TypeScript</code>！</li>
<li><code>JavaScript</code> 不能无缝迁移到 <code>TypeScript</code>！</li>
</ul>
<p>重要的话说三遍，TypeScript 是 JavaScript 的超集，所以有很多人认为（并宣称）JavaScript 可以很容易迁移到 TypeScript，甚至是无缝迁移的！<br>导致了 JavaScript 开发者满心欢喜的入坑了 TypeScript（包括吾辈），然后掉进了坑里，甚至差点爬不出来。。。</p>
<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><ul>
<li>问: 为什么吾辈用 JavaScript 用的好好的，偏偏自找麻烦去入坑了 TypeScript 了呢？</li>
<li>答: JavaScript 因为一些固有问题和主流编辑器 VSCode 支持不力，导致代码写起来会感觉很不方便</li>
<li>问: 具体谈谈</li>
<li>答: 有很多令人不满意的地方，这里只谈几点:<ul>
<li>JavaScript 没有类型，所以写 JSDoc 感觉很麻烦，但不写又不太好。然而，JavaScript 代码写的太顺利的话就可能忘记加上 JSDoc，之后代码就很难维护。</li>
<li>VSCode 支持不好，这点或许才是最重要的: VSCode 使用 TypeScript 编写，并基于 TypeScript 实现的语法提示功能，虽然也支持根据 JSDoc 的注释进行提示，然而当你去做一个开源项目，并将之发布到 npm 之后，情况发生了变化。。。当一个用户使用 npm&#x2F;yarn 安装了你的项目之后，发现并没有任何代码提示，如此你会怎么做？</li>
<li>复杂的类型很难使用 JSDoc 表达出来并清晰地告诉调用者，例如高阶函数。</li>
<li>等等。。。。</li>
</ul>
</li>
</ul>
<p>是的，TypeScript 确实解决了以上的一些问题，却同时带入了另外一些问题。</p>
<ul>
<li>TypeScript 有类型了，然而即便有类型推导，还是要加很多类型，而且有时候 TypeScript 和我们的想法不同的时候还要用 <code>!</code>&#x2F;<code>(t as unkonwn) as R</code> 这种 <strong>hack 技巧</strong>。</li>
<li>VSCode 天生支持 TypeScript，但 TypeScript 的 API Doc 生成工具实在谈不上多好，例如 <a target="_blank" rel="noopener" href="https://typedoc.org/">typedoc</a> 相比于 <a target="_blank" rel="noopener" href="https://esdoc.org/">ESDoc</a> 不过是个半吊子。。。</li>
<li>事实上，即便使用 TypeScript 写的项目，只要使用者没有在 <code>jsconfig.json</code> 中进行配置的话，提示仍然默认不存在</li>
<li>TypeScript 的类型系统是把双刃剑，实在太复杂了，当然有理由认为是为了兼容 JavaScript。然而在 TypeScript 想要正确的表达类型也是一件相当困难的事情。</li>
</ul>
<h2 id="类型系统踩坑"><a href="#类型系统踩坑" class="headerlink" title="类型系统踩坑"></a>类型系统踩坑</h2><h3 id="如何声明参数与返回值类型相同？"><a href="#如何声明参数与返回值类型相同？" class="headerlink" title="如何声明参数与返回值类型相同？"></a>如何声明参数与返回值类型相同？</h3><p>例如一个函数接受一个参数，并返回一个完全相同类型的返回值。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">returnItself</span>(<span class="params">obj: <span class="built_in">any</span></span>): <span class="built_in">any</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假使这样写的话，类型系统就不会发挥作用了，调用函数的结果将是 <code>any</code>，意味着类型系统将没有效果。</p>
<p>例如下面的代码会被 ts 认为是错误</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这段代码并不会有提示</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">returnItself</span>(<span class="string">&#x27;abc&#x27;</span>).<span class="property">length</span>)</span><br></pre></td></tr></table></figure>

<p>需要写成</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> returnItself&lt;T = <span class="built_in">any</span>&gt;(<span class="attr">obj</span>: T): T &#123;</span><br><span class="line">  <span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里主要声明了参数和返回值是同一类型，默认为 any，但具体取决于参数的不同而使得返回值也不同，返回值不会丢失类型信息。</p>
<h3 id="如何声明参数与返回值类型有关联？"><a href="#如何声明参数与返回值类型有关联？" class="headerlink" title="如何声明参数与返回值类型有关联？"></a>如何声明参数与返回值类型有关联？</h3><p>例如一个计算函数执行时间的函数 <code>timing</code>，接受一个函数参数，有可能是同步&#x2F;异步的，所以要根据函数的返回值确定 <code>timing</code> 的返回值为 <code>number/Promise&lt;number&gt;</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params"></span></span><br><span class="line"><span class="params">  fn: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span> | <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">number</span> | <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> begin = performance.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">fn</span>()</span><br><span class="line">  <span class="keyword">if</span> (!(result <span class="keyword">instanceof</span> <span class="title class_">Promise</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> performance.<span class="title function_">now</span>() - begin</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result.<span class="title function_">then</span>(<span class="function">() =&gt;</span> performance.<span class="title function_">now</span>() - begin)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然而在使用时你会发现返回值类型不太对，因为 <code>timing</code> 的返回值是 <code>number | Promise&lt;number&gt;</code> 这种复合类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里会提示类型错误</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">res</span>: <span class="built_in">number</span> = <span class="title function_">timing</span>(<span class="function">() =&gt;</span> <span class="title function_">sleep</span>(<span class="number">100</span>))</span><br><span class="line"><span class="title function_">expect</span>(res).<span class="title function_">toBeGreaterThan</span>(<span class="number">99</span>)</span><br></pre></td></tr></table></figure>

<p>解决方案有二</p>
<ol>
<li>使用函数声明重载</li>
<li>使用类型判断</li>
</ol>
<h4 id="使用函数声明重载"><a href="#使用函数声明重载" class="headerlink" title="使用函数声明重载"></a>使用函数声明重载</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params">fn: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params">fn: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span></span>): <span class="built_in">number</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params"></span></span><br><span class="line"><span class="params">  fn: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span> | <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">number</span> | <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> begin = performance.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">fn</span>()</span><br><span class="line">  <span class="keyword">if</span> (!(result <span class="keyword">instanceof</span> <span class="title class_">Promise</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> performance.<span class="title function_">now</span>() - begin</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result.<span class="title function_">then</span>(<span class="function">() =&gt;</span> performance.<span class="title function_">now</span>() - begin)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>感觉函数声明顺序有点奇怪是因为 <code>Promise&lt;any&gt;</code> 属于 <code>any</code> 的子类，而函数声明重载必须由具体到宽泛。当然，我们有方法可以在 <code>any</code> 中排除掉 <code>Promise&lt;any&gt;</code>，这样顺序就对了！</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params"></span></span><br><span class="line"><span class="params">  fn: (...args: <span class="built_in">any</span>[]) =&gt; Exclude&lt;<span class="built_in">any</span>, <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;&gt;,</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">number</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params">fn: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params"></span></span><br><span class="line"><span class="params">  fn: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span> | <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">number</span> | <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> begin = performance.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">fn</span>()</span><br><span class="line">  <span class="keyword">if</span> (!(result <span class="keyword">instanceof</span> <span class="title class_">Promise</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> performance.<span class="title function_">now</span>() - begin</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result.<span class="title function_">then</span>(<span class="function">() =&gt;</span> performance.<span class="title function_">now</span>() - begin)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用类型判断"><a href="#使用类型判断" class="headerlink" title="使用类型判断"></a>使用类型判断</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">timing</span>(<span class="params"></span></span><br><span class="line"><span class="params">  fn: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">any</span> | <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt;,</span></span><br><span class="line"><span class="params">  <span class="comment">// 函数返回类型是 Promise 的话，则返回 Promise&lt;number&gt;，否则返回 number</span></span></span><br><span class="line"><span class="params"></span>): R <span class="keyword">extends</span> <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt; ? <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; : <span class="built_in">number</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> begin = performance.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">const</span> result = <span class="title function_">fn</span>()</span><br><span class="line">  <span class="keyword">if</span> (!(result <span class="keyword">instanceof</span> <span class="title class_">Promise</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> (performance.<span class="title function_">now</span>() - begin) <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result.<span class="title function_">then</span>(<span class="function">() =&gt;</span> performance.<span class="title function_">now</span>() - begin) <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>可以看出来，第一种方式的优点在于可以很精细的控制每个不同参数对应的返回值，并且，可以处理特别复杂的情况，缺点则是如果写 doc 文档的话需要为每个声明都写上，即便，它们有大部分注释是相同的。<br>而第二种方式，则在代码量上有所减少，而且不必使用函数声明重载。缺点则是无法应对特别复杂的情况，另外一点就是使用了 <code>any</code>，可能会造成<strong>重构火葬场</strong>。</p>
<h3 id="TypeScript-类型系统就是认为吾辈错了怎么办？"><a href="#TypeScript-类型系统就是认为吾辈错了怎么办？" class="headerlink" title="TypeScript 类型系统就是认为吾辈错了怎么办？"></a>TypeScript 类型系统就是认为吾辈错了怎么办？</h3><p>有时候，明明自己知道是正确的，但 TypeScript 偏偏认为你写错了。思考以下功能如何实现？</p>
<p>将 Array 转换为 Map，接受三个参数</p>
<ol>
<li>需要转换的数组</li>
<li>将数组元素转换为 Map key 的函数</li>
<li>将数组元素转换为 Map value 的函数，可选，默认为数组元素</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> returnItself&lt;T = <span class="built_in">any</span>&gt;(<span class="attr">obj</span>: T): T &#123;</span><br><span class="line">  <span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">ArrayCallback</span>&lt;T, R&gt; = <span class="function">(<span class="params">item: T, index: <span class="built_in">number</span>, arr: T[]</span>) =&gt;</span> R</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> arrayToMap&lt;T, K, V&gt;(</span><br><span class="line">  <span class="attr">arr</span>: T[],</span><br><span class="line">  <span class="attr">kFn</span>: <span class="title class_">ArrayCallback</span>&lt;T, K&gt;,</span><br><span class="line">  <span class="attr">vFn</span>: <span class="title class_">ArrayCallback</span>&lt;T, V&gt; = returnItself,</span><br><span class="line">): <span class="title class_">Map</span>&lt;K, V&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> arr.<span class="title function_">reduce</span>(</span><br><span class="line">    <span class="function">(<span class="params">res, item, index, arr</span>) =&gt;</span></span><br><span class="line">      res.<span class="title function_">set</span>(<span class="title function_">kFn</span>(item, index, arr), <span class="title function_">vFn</span>(item, index, arr)),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Map</span>&lt;K, V&gt;(),</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可能有以上代码，然而实际上 <code>returnItself</code> 无法直接赋值给 <code>ArrayCallback&lt;T, V&gt;</code>。当然，我们知道，这一定是可以赋值的，但 TypeScript 却无法编译通过！</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> arrayToMap&lt;T, K, V&gt;(</span><br><span class="line">  <span class="attr">arr</span>: T[],</span><br><span class="line">  <span class="attr">kFn</span>: <span class="title class_">ArrayCallback</span>&lt;T, K&gt;,</span><br><span class="line">  <span class="comment">// 是的，这里添加 as any 就好了</span></span><br><span class="line">  <span class="attr">vFn</span>: <span class="title class_">ArrayCallback</span>&lt;T, V&gt; = returnItself <span class="keyword">as</span> <span class="built_in">any</span>,</span><br><span class="line">): <span class="title class_">Map</span>&lt;K, V&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> arr.<span class="title function_">reduce</span>(</span><br><span class="line">    <span class="function">(<span class="params">res, item, index, arr</span>) =&gt;</span></span><br><span class="line">      res.<span class="title function_">set</span>(<span class="title function_">kFn</span>(item, index, arr), <span class="title function_">vFn</span>(item, index, arr)),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Map</span>&lt;K, V&gt;(),</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者，如果 <code>returnItself</code> 用的比较多的话（例如吾辈），可以使用另一种方式</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改 returnItself 的返回值</span></span><br><span class="line"><span class="keyword">function</span> returnItself&lt;T, R = T&gt;(<span class="attr">obj</span>: T): R &#123;</span><br><span class="line">  <span class="keyword">return</span> obj <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">ArrayCallback</span>&lt;T, R&gt; = <span class="function">(<span class="params">item: T, index: <span class="built_in">number</span>, arr: T[]</span>) =&gt;</span> R</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> arrayToMap&lt;T, K, V&gt;(</span><br><span class="line">  <span class="attr">arr</span>: T[],</span><br><span class="line">  <span class="attr">kFn</span>: <span class="title class_">ArrayCallback</span>&lt;T, K&gt;,</span><br><span class="line">  <span class="attr">vFn</span>: <span class="title class_">ArrayCallback</span>&lt;T, V&gt; = returnItself,</span><br><span class="line">): <span class="title class_">Map</span>&lt;K, V&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> arr.<span class="title function_">reduce</span>(</span><br><span class="line">    <span class="function">(<span class="params">res, item, index, arr</span>) =&gt;</span></span><br><span class="line">      res.<span class="title function_">set</span>(<span class="title function_">kFn</span>(item, index, arr), <span class="title function_">vFn</span>(item, index, arr)),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Map</span>&lt;K, V&gt;(),</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="如何强制调用非空时对象上的函数？"><a href="#如何强制调用非空时对象上的函数？" class="headerlink" title="如何强制调用非空时对象上的函数？"></a>如何强制调用非空时对象上的函数？</h3><p>当有时候你得到一个对象可能为空时，无法直接调用其上的函数，会提示函数不存在。<br>例如下面从数组中查询字符串，然后获取长度，在 TypeScript 中便会报错，因为 str 的类型为 string&#x2F;undefined。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="keyword">const</span> str = arr.<span class="title function_">find</span>(<span class="function"><span class="params">s</span> =&gt;</span> s === <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str.<span class="property">length</span>)</span><br></pre></td></tr></table></figure>

<p>之前使用 JavaScript 从未遇到过这种事情，事实上确实有可能为空，但 JavaScript 太过于动态，并不会提示错误，而 TypeScript 就会提示这种低级错误，因为类型系统。<br>但是啊，凡事都有例外，当吾辈确实想调用 string 上的函数时报错真的是有点讨厌，那么有什么办法呢？</p>
<ol>
<li><p>使用 <code>!</code> 强制调用</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="keyword">const</span> str = arr.<span class="title function_">find</span>(<span class="function"><span class="params">s</span> =&gt;</span> s === <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str!.<span class="property">length</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <code>(str as any)</code> 转换为 any 类型之后再随意调用任何函数</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="keyword">const</span> str = arr.<span class="title function_">find</span>(<span class="function"><span class="params">s</span> =&gt;</span> s === <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>((str <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">length</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用注释 <code>// @ts-ignore</code> 忽略错误（非常强力，少用）</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]</span><br><span class="line"><span class="keyword">const</span> str = arr.<span class="title function_">find</span>(<span class="function"><span class="params">s</span> =&gt;</span> s === <span class="string">&#x27;b&#x27;</span>)</span><br><span class="line"><span class="comment">// @ts-ignore</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str.<span class="property">length</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<p>注意: 三种方式推荐程度逐渐降低，因为后两种实际上都会忽略类型系统，导致编写代码没有提示！</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>截至目前为止，吾辈已经着手使用 TypeScript 重构工具函数库 <a target="_blank" rel="noopener" href="https://github.com/rxliuli/rx-util">rx-util</a> 两周了，基本上打包配置，文档生成，类型定义基本上算是大致完成，感觉之后的公共项目大概都会用 TypeScript 实现了，毕竟前端主流开发工具 VSCode 对其的支持真的很好，而且 TypeScript 的接口这种概念真的太有用了！</p>
<h2 id="一些吐槽"><a href="#一些吐槽" class="headerlink" title="一些吐槽"></a>一些吐槽</h2><p>使用了有一段时间了，这里不得不再次声明一下，TypeScript 的类型系统复杂度超乎想象，如果你没有准备好在生产系统中使用，那就最好不要使用。缺少关于类型系统（尤其是原生类型，例如 <code>PromiseLike</code> 居然没有人讲过）的说明，使得 TypeScript 的类型系统很多时候看起来都只是为了<strong>好玩</strong>而已。而且稍微复杂一点的情况思考如何设计类型的时间将会超过具体的代码实现，使用它请务必再三慎重考虑！</p>
<p>TypeScript 的类型系统为了兼容 JavaScript 缺陷实在太大了。</p>
<blockquote>
<p>参见某个知乎用户的话:</p>
</blockquote>
<ol>
<li><p>ts 写不出一个合并对象的方法</p>
<p>下面是一个 js 合并对象的方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">extend</span>(<span class="params">dest, ...sources</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">assign</span>(dest, ...sources)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这么一个简单的方法，ts 写不出不丢失类型信息的实现。</p>
<p>下面贴的是 typescript 源码中对 Object.assign 的声明，我相信都能看出有多傻：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">assign&lt;T, U&gt;(<span class="attr">target</span>: T, <span class="attr">source</span>: U): T &amp; U;</span><br><span class="line">assign&lt;T, U, V&gt;(<span class="attr">target</span>: T, <span class="attr">source1</span>: U, <span class="attr">source2</span>: V): T &amp; U &amp; V;</span><br><span class="line">assign&lt;T, U, V, W&gt;(<span class="attr">target</span>: T, <span class="attr">source1</span>: U, <span class="attr">source2</span>: V, <span class="attr">source3</span>: W): T &amp; U &amp; &amp; W;</span><br><span class="line"><span class="title function_">assign</span>(<span class="attr">target</span>: <span class="built_in">object</span>, ...<span class="attr">sources</span>: <span class="built_in">any</span>[]): <span class="built_in">any</span>;</span><br></pre></td></tr></table></figure>

<p>按这个实现，多于 4 个参数就直接丢掉类型信息了，建议 ts 至少把 A-Z 都作为泛型量用上…</p>
</li>
<li><p>一些很明显的类型推断却推断不出来</p>
<p>用 assert 方法做参数检查是很常用的做法，一个简单的 assert 方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">assert</span>(<span class="params">condition, msg</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (condition) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后看这样一段代码：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">p: <span class="built_in">number</span> | <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="title function_">assert</span>(<span class="keyword">typeof</span> p === <span class="string">&#x27;number&#x27;</span>, <span class="string">&#x27;p is a number&#x27;</span>)</span><br><span class="line">  p.<span class="property">length</span> <span class="comment">// 这里报错，ts 竟然不知道到这一步 p 必定是 string 类型</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/05/22/others/rxliuliBlog/JavaScript/JavaScript-%E5%A4%84%E7%90%86%E6%A0%91%E7%BB%93%E6%9E%84%E6%95%B0%E6%8D%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/22/others/rxliuliBlog/JavaScript/JavaScript-%E5%A4%84%E7%90%86%E6%A0%91%E7%BB%93%E6%9E%84%E6%95%B0%E6%8D%AE/" class="post-title-link" itemprop="url">JavaScript 处理树数据结构</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-23 00:00:00" itemprop="dateCreated datePublished" datetime="2019-05-23T00:00:00+08:00">2019-05-23</time>
    </span>


  
    <span id="/2019/05/22/others/rxliuliBlog/JavaScript/JavaScript-%E5%A4%84%E7%90%86%E6%A0%91%E7%BB%93%E6%9E%84%E6%95%B0%E6%8D%AE/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript 处理树数据结构" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript 处理树数据结构" href="/2019/05/22/others/rxliuliBlog/JavaScript/JavaScript-%E5%A4%84%E7%90%86%E6%A0%91%E7%BB%93%E6%9E%84%E6%95%B0%E6%8D%AE/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::a8fe5d44cd22599ac9465f7d95f862bf" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaScript-处理树结构数据"><a href="#JavaScript-处理树结构数据" class="headerlink" title="JavaScript 处理树结构数据"></a>JavaScript 处理树结构数据</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>即便在前端，也有很多时候需要操作 <strong>树结构</strong> 的情况，最典型的场景莫过于 _无限级分类_。之前吾辈曾经遇到过这种场景，但当时没有多想直接手撕 JavaScript 列表转树了，并没有想到进行封装。后来遇到的场景多了，想到如何封装树结构操作，但考虑到不同场景的树节点结构的不同，就没有继续进行下去了。</p>
<p>直到吾辈开始经常运用了 ES6 <code>Proxy</code> 之后，吾辈想到了新的解决方案！</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><ul>
<li>问: 之前为什么停止封装树结构操作了？</li>
<li>答: 因为不同的树结构节点可能有不同的结构，例如某个项目的树节点父节点 id 字段是 <code>parent</code>，而另一个项目则是 <code>parentId</code></li>
<li>问: <code>Proxy</code> 如何解决这个问题呢？</li>
<li>答: <code>Proxy</code> 可以拦截对象的操作，当访问对象不存在的字段时，<code>Proxy</code> 能将之代理到已经存在的字段上</li>
<li>问: 这点意味着什么？</li>
<li>答: 它意味着 <code>Proxy</code> 能够抹平不同的树节点结构之间的差异！</li>
<li>问: 我还是不太明白 <code>Proxy</code> 怎么用，能举个具体的例子么？</li>
<li>答: 当然可以，我现在就让你看看 <code>Proxy</code> 的能力</li>
</ul>
<p>下面思考一下如何在同一个函数中处理这两种树节点结构</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统菜单</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SysMenu</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构造函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; id 菜单 id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; name 显示的名称</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; parent 父级菜单 id</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">id, name, parent</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = id</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = parent</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系统权限</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SysPermission</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构造函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; uid 系统唯一 uuid</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; label 显示的菜单名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; parentId 父级权限 uid</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">uid, label, parentId</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">uid</span> = uid</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">label</span> = label</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parentId</span> = parentId</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面让我们使用 <code>Proxy</code> 来抹平访问它们之间的差异</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sysMenuMap = <span class="keyword">new</span> <span class="title class_">Map</span>().<span class="title function_">set</span>(<span class="string">&#x27;parentId&#x27;</span>, <span class="string">&#x27;parent&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> sysMenu = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="keyword">new</span> <span class="title class_">SysMenu</span>(<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>), &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">_, k</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (sysMenuMap.<span class="title function_">has</span>(k)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, sysMenuMap.<span class="title function_">get</span>(k))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, k)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sysMenu.<span class="property">id</span>, sysMenu.<span class="property">name</span>, sysMenu.<span class="property">parentId</span>) <span class="comment">// 1 &#x27;rx&#x27; 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sysPermissionMap = <span class="keyword">new</span> <span class="title class_">Map</span>().<span class="title function_">set</span>(<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;uid&#x27;</span>).<span class="title function_">set</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;label&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> sysPermission = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="keyword">new</span> <span class="title class_">SysPermission</span>(<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>), &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">_, k</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (sysPermissionMap.<span class="title function_">has</span>(k)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, sysPermissionMap.<span class="title function_">get</span>(k))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(_, k)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sysPermission.<span class="property">id</span>, sysPermission.<span class="property">name</span>, sysPermission.<span class="property">parentId</span>) <span class="comment">// 1 &#x27;rx&#x27; 0</span></span><br></pre></td></tr></table></figure>

<h2 id="定义桥接函数"><a href="#定义桥接函数" class="headerlink" title="定义桥接函数"></a>定义桥接函数</h2><p>现在，差异确实抹平了，我们可以通过访问相同的属性来获取到不同结构对象的值！然而，每个对象都写一次代理终究有点麻烦，所以我们实现一个通用函数用以包装。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 桥接对象不存在的字段</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; map 代理的字段映射 Map</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Function</span>&#125; 转换一个对象为代理对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">bridge</span>(<span class="params">map</span>) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 为对象添加代理的函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; obj 任何对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">Proxy</span>&#125; 代理后的对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, &#123;</span><br><span class="line">      <span class="title function_">get</span>(<span class="params">target, k</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Reflect</span>.<span class="title function_">has</span>(map, k)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, <span class="title class_">Reflect</span>.<span class="title function_">get</span>(map, k))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, k)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">set</span>(<span class="params">target, k, v</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Reflect</span>.<span class="title function_">has</span>(map, k)) &#123;</span><br><span class="line">          <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, <span class="title class_">Reflect</span>.<span class="title function_">get</span>(map, k), v)</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, k, v)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，我们可以用更简单的方式来做代理了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sysMenu = <span class="title function_">bridge</span>(&#123;</span><br><span class="line">  <span class="attr">parentId</span>: <span class="string">&#x27;parent&#x27;</span>,</span><br><span class="line">&#125;)(<span class="keyword">new</span> <span class="title class_">SysMenu</span>(<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sysMenu.<span class="property">id</span>, sysMenu.<span class="property">name</span>, sysMenu.<span class="property">parentId</span>) <span class="comment">// 1 &#x27;rx&#x27; 0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sysPermission = <span class="title function_">bridge</span>(&#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="string">&#x27;uid&#x27;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;label&#x27;</span>,</span><br><span class="line">&#125;)(<span class="keyword">new</span> <span class="title class_">SysPermission</span>(<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(sysPermission.<span class="property">id</span>, sysPermission.<span class="property">name</span>, sysPermission.<span class="property">parentId</span>) <span class="comment">// 1 &#x27;rx&#x27; 0</span></span><br></pre></td></tr></table></figure>

<h2 id="定义标准树结构"><a href="#定义标准树结构" class="headerlink" title="定义标准树结构"></a>定义标准树结构</h2><p>想要抹平差异，我们至少还需要一个标准的树结构，告诉别人我们需要什么样的树节点数据结构，以便于在之后处理树节点的函数中统一使用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基本的 Node 节点结构定义接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@interface</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">INode</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 构造函数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; [options] 可选项参数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; [options.id] 树结点的 id 属性名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; [options.parentId] 树结点的父节点 id 属性名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; [options.child] 树结点的子节点数组属性名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; [options.path] 树结点的全路径属性名</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Array.&lt;Object&gt;</span>&#125; [options.args] 其他参数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">&#123; id, parentId, child, path, ...args &#125; = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@field</span> 树结点的 id 属性名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = id</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@field</span> 树结点的父节点 id 属性名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parentId</span> = parentId</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@field</span> 树结点的子节点数组属性名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">child</span> = child</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@field</span> 树结点的全路径属性名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">path</span> = path</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现列表转树"><a href="#实现列表转树" class="headerlink" title="实现列表转树"></a>实现列表转树</h2><p>列表转树，除了递归之外，也可以使用循环实现，这里便以循环为示例。</p>
<p>思路</p>
<ol>
<li>在外层遍历子节点</li>
<li>如果是根节点，就添加到根节点中并不在找其父节点。</li>
<li>否则在内层循环中找该节点的父节点，找到之后将子节点追加到父节点的子节点列表中，然后结束本次内层循环。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将列表转换为树节点</span></span><br><span class="line"><span class="comment"> * 注：该函数默认树的根节点只有一个，如果有多个，则返回一个数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Array.&lt;Object&gt;</span>&#125; list 树节点列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; [options] 其他选项</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; [options.isRoot] 判断节点是否为根节点。默认根节点的父节点为空</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; [options.bridge=returnItself] 桥接函数，默认返回自身</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Object|Array.&lt;String&gt;</span>&#125; 树节点，或是树节点列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">listToTree</span>(<span class="params"></span></span><br><span class="line"><span class="params">  list,</span></span><br><span class="line"><span class="params">  &#123; isRoot = node =&gt; !node.parentId, bridge = returnItself &#125; = &#123;&#125;,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> res = list.<span class="title function_">reduce</span>(<span class="function">(<span class="params">root, _sub</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isRoot</span>(sub)) &#123;</span><br><span class="line">      root.<span class="title function_">push</span>(sub)</span><br><span class="line">      <span class="keyword">return</span> root</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> sub = <span class="title function_">bridge</span>(_sub)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> _parent <span class="keyword">of</span> list) &#123;</span><br><span class="line">      <span class="keyword">const</span> parent = <span class="title function_">bridge</span>(_parent)</span><br><span class="line">      <span class="keyword">if</span> (sub.<span class="property">parentId</span> === parent.<span class="property">id</span>) &#123;</span><br><span class="line">        parent.<span class="property">child</span> = parent.<span class="property">child</span> || []</span><br><span class="line">        parent.<span class="property">child</span>.<span class="title function_">push</span>(sub)</span><br><span class="line">        <span class="keyword">return</span> root</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line">  &#125;, [])</span><br><span class="line">  <span class="comment">// 根据顶级节点的数量决定如何返回</span></span><br><span class="line">  <span class="keyword">const</span> len = res.<span class="property">length</span></span><br><span class="line">  <span class="keyword">if</span> (len === <span class="number">0</span>) <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  <span class="keyword">if</span> (len === <span class="number">1</span>) <span class="keyword">return</span> res[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="抽取通用的树结构遍历逻辑"><a href="#抽取通用的树结构遍历逻辑" class="headerlink" title="抽取通用的树结构遍历逻辑"></a>抽取通用的树结构遍历逻辑</h2><p>首先，明确一点，树结构的完全遍历是通用的，大致实现基本如下</p>
<ol>
<li>遍历顶级树节点</li>
<li>遍历树节点的子节点列表</li>
<li>递归调用函数并传入子节点</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回第一个参数的函数</span></span><br><span class="line"><span class="comment"> * 注：一般可以当作返回参数自身的函数，如果你只关注第一个参数的话</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; obj 任何对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Object</span>&#125; 传入的第一个参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">returnItself</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遍历并映射一棵树的每个节点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; root 树节点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; [options] 其他选项</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; [options.before=returnItself] 遍历子节点之前的操作。默认返回自身</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; [options.after=returnItself] 遍历子节点之后的操作。默认返回自身</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; [options.paramFn=(node, args) =&gt; []] 递归的参数生成函数。默认返回一个空数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">INode</span>&#125; 递归遍历后的树节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">treeMapping</span>(<span class="params"></span></span><br><span class="line"><span class="params">  root,</span></span><br><span class="line"><span class="params">  &#123;</span></span><br><span class="line"><span class="params">    before = returnItself,</span></span><br><span class="line"><span class="params">    after = returnItself,</span></span><br><span class="line"><span class="params">    paramFn = (node, ...args) =&gt; [],</span></span><br><span class="line"><span class="params">  &#125; = &#123;&#125;,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 遍历一颗完整的树</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">INode</span>&#125; node 要遍历的树节点</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span>  &#123;<span class="type">...Object</span>&#125; [args] 每次递归遍历时的参数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">_treeMapping</span>(<span class="params">node, ...args</span>) &#123;</span><br><span class="line">    <span class="comment">// 之前的操作</span></span><br><span class="line">    <span class="keyword">let</span> _node = <span class="title function_">before</span>(node, ...args)</span><br><span class="line">    <span class="keyword">const</span> childs = _node.<span class="property">child</span></span><br><span class="line">    <span class="keyword">if</span> (arrayValidator.<span class="title function_">isEmpty</span>(childs)) &#123;</span><br><span class="line">      <span class="keyword">return</span> _node</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 产生一个参数</span></span><br><span class="line">    <span class="keyword">const</span> len = childs.<span class="property">length</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">      childs[i] = <span class="title function_">_treeMapping</span>(childs[i], ...<span class="title function_">paramFn</span>(_node, ...args))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 之后的操作</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">after</span>(_node, ...args)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">_treeMapping</span>(root)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>treeMapping</code> 遍历树并打印</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tree = &#123;</span><br><span class="line">  <span class="attr">uid</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">childrens</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">uid</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">parent</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">childrens</span>: [&#123; <span class="attr">uid</span>: <span class="number">3</span>, <span class="attr">parent</span>: <span class="number">2</span> &#125;, &#123; <span class="attr">uid</span>: <span class="number">4</span>, <span class="attr">parent</span>: <span class="number">2</span> &#125;],</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">uid</span>: <span class="number">5</span>,</span><br><span class="line">      <span class="attr">parent</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">childrens</span>: [&#123; <span class="attr">uid</span>: <span class="number">6</span>, <span class="attr">parent</span>: <span class="number">5</span> &#125;, &#123; <span class="attr">uid</span>: <span class="number">7</span>, <span class="attr">parent</span>: <span class="number">5</span> &#125;],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 桥接函数</span></span><br><span class="line"><span class="keyword">const</span> bridge = <span class="title function_">bridge</span>(&#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="string">&#x27;uid&#x27;</span>,</span><br><span class="line">  <span class="attr">parentId</span>: <span class="string">&#x27;parent&#x27;</span>,</span><br><span class="line">  <span class="attr">child</span>: <span class="string">&#x27;childrens&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title function_">treeMapping</span>(tree, &#123;</span><br><span class="line">  <span class="comment">// 进行桥接抹平差异</span></span><br><span class="line">  <span class="attr">before</span>: bridge,</span><br><span class="line">  <span class="comment">// 之后打印每一个</span></span><br><span class="line">  <span class="title function_">after</span>(<span class="params">node</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(node)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="实现树转列表"><a href="#实现树转列表" class="headerlink" title="实现树转列表"></a>实现树转列表</h2><p>当然，我们亦可使用 <code>treeMapping</code> 简单的实现 <code>treeToList</code>，当然，这里考虑了是否计算全路径，毕竟还是要考虑性能的！</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将树节点转为树节点列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; root 树节点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; [options] 其他选项</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Boolean</span>&#125; [options.calcPath=false] 是否计算节点全路径，默认为 false</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; [options.bridge=returnItself] 桥接函数，默认返回自身</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Array.&lt;Object&gt;</span>&#125; 树节点列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">treeToList</span>(<span class="params"></span></span><br><span class="line"><span class="params">  root,</span></span><br><span class="line"><span class="params">  &#123; calcPath = <span class="literal">false</span>, bridge = returnItself &#125; = &#123;&#125;,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> res = []</span><br><span class="line">  <span class="title function_">treeMapping</span>(root, &#123;</span><br><span class="line">    <span class="title function_">before</span>(<span class="params">_node, parentPath</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> node = <span class="title function_">bridge</span>(_node)</span><br><span class="line">      <span class="comment">// 是否计算全路径</span></span><br><span class="line">      <span class="keyword">if</span> (calcPath) &#123;</span><br><span class="line">        node.<span class="property">path</span> = (parentPath ? parentPath + <span class="string">&#x27;,&#x27;</span> : <span class="string">&#x27;&#x27;</span>) + node.<span class="property">id</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 此时追加到数组中</span></span><br><span class="line">      res.<span class="title function_">push</span>(node)</span><br><span class="line">      <span class="keyword">return</span> node</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">paramFn</span>: <span class="function"><span class="params">node</span> =&gt;</span> (calcPath ? [node.<span class="property">path</span>] : []),</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，我们可以转换任意树结构为列表了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tree = &#123;</span><br><span class="line">  <span class="attr">uid</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">childrens</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">uid</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">parent</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">childrens</span>: [&#123; <span class="attr">uid</span>: <span class="number">3</span>, <span class="attr">parent</span>: <span class="number">2</span> &#125;, &#123; <span class="attr">uid</span>: <span class="number">4</span>, <span class="attr">parent</span>: <span class="number">2</span> &#125;],</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">uid</span>: <span class="number">5</span>,</span><br><span class="line">      <span class="attr">parent</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">childrens</span>: [&#123; <span class="attr">uid</span>: <span class="number">6</span>, <span class="attr">parent</span>: <span class="number">5</span> &#125;, &#123; <span class="attr">uid</span>: <span class="number">7</span>, <span class="attr">parent</span>: <span class="number">5</span> &#125;],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> fn = <span class="title function_">bridge</span>(&#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="string">&#x27;uid&#x27;</span>,</span><br><span class="line">  <span class="attr">parentId</span>: <span class="string">&#x27;parent&#x27;</span>,</span><br><span class="line">  <span class="attr">child</span>: <span class="string">&#x27;childrens&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> list = <span class="title function_">treeToList</span>(tree, &#123;</span><br><span class="line">  <span class="attr">bridge</span>: fn,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(list)</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>那么，JavaScript 中处理树结构数据就到这里了。当然，树结构数据还有其他的更多操作尚未实现，例如常见的查询子节点列表，节点过滤，最短路径查找等等。但目前列表与树的转换才是最常用的，而且其他操作基本上也是基于它们做的，所以这里也便点到为止了。</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/05/15/others/rxliuliBlog/JavaScript/JavaScript-%E5%BE%AE%E4%BB%BB%E5%8A%A1-%E5%AE%8F%E4%BB%BB%E5%8A%A1%E8%B8%A9%E5%9D%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/15/others/rxliuliBlog/JavaScript/JavaScript-%E5%BE%AE%E4%BB%BB%E5%8A%A1-%E5%AE%8F%E4%BB%BB%E5%8A%A1%E8%B8%A9%E5%9D%91/" class="post-title-link" itemprop="url">JavaScript 微任务/宏任务踩坑</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-15 09:15:37" itemprop="dateCreated datePublished" datetime="2019-05-15T09:15:37+08:00">2019-05-15</time>
    </span>


  
    <span id="/2019/05/15/others/rxliuliBlog/JavaScript/JavaScript-%E5%BE%AE%E4%BB%BB%E5%8A%A1-%E5%AE%8F%E4%BB%BB%E5%8A%A1%E8%B8%A9%E5%9D%91/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript 微任务/宏任务踩坑" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript 微任务/宏任务踩坑" href="/2019/05/15/others/rxliuliBlog/JavaScript/JavaScript-%E5%BE%AE%E4%BB%BB%E5%8A%A1-%E5%AE%8F%E4%BB%BB%E5%8A%A1%E8%B8%A9%E5%9D%91/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::fbe6c31a79319d470bec1cad6ee22ba9" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaScript-微任务-x2F-宏任务踩坑"><a href="#JavaScript-微任务-x2F-宏任务踩坑" class="headerlink" title="JavaScript 微任务&#x2F;宏任务踩坑"></a>JavaScript 微任务&#x2F;宏任务踩坑</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000019181961">SegmentFault</a></p>
</blockquote>
<p>在使用 <code>async-await</code> 时，吾辈总是习惯把它们当作同步，终于，现在踩到坑里去了。<br>使用 <code>setTimeout</code> 和 <code>setInterval</code> 实现的基于 <code>Promise</code> 的 <code>wait</code> 函数，然而测试边界情况的时候却发现了一些问题！</p>
<p>实现代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 等待指定的时间/等待指定表达式成立</span></span><br><span class="line"><span class="comment"> * 如果未指定等待条件则立刻执行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number|Function</span>&#125; [param] 等待时间/等待条件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise</span>&#125; Promise 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">wait</span> = param =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(resolve, param)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">param</span>()) &#123;</span><br><span class="line">          <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">          <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="number">100</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 标识当前是否有异步函数 add 在运行了</span></span><br><span class="line">  <span class="keyword">let</span> taskIsRun = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">add</span> = <span class="keyword">async</span> (<span class="params">_v, i</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 如果已经有运行的 add 函数，则等待</span></span><br><span class="line">    <span class="keyword">if</span> (taskIsRun) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断前: &#x27;</span>)</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !taskIsRun</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      taskIsRun = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun)</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">100</span>)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 执行后: &#x27;</span>)</span><br><span class="line">      taskIsRun = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">    <span class="title class_">Array</span>(<span class="number">10</span>)</span><br><span class="line">      .<span class="title function_">fill</span>(<span class="number">0</span>)</span><br><span class="line">      .<span class="title function_">map</span>(add),</span><br><span class="line">  )</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>() - start)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>那么，先不要往下看，猜一下最后打印的大概会是多少呢？</p>
<p>实际执行结果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">0 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">1 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">2 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">3 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">4 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">5 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">6 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">7 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">8 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">9 判断前:  ​​​​​at ​​​i + <span class="string">&#x27; 判断前: &#x27;</span>​​​ ​src/module/function/wait.js:29:6​</span><br><span class="line"></span><br><span class="line">0 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">1 判断后: <span class="literal">false</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">1 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">// 这儿的 1 执行前，结果 2 就已经判断通过并准备执行了？？？发生了什么？</span><br><span class="line"></span><br><span class="line">2 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">2 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">3 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">3 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">4 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">4 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">5 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">5 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">6 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">6 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">7 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">7 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">8 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">8 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">9 判断后: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:33:6​</span><br><span class="line"></span><br><span class="line">9 执行前: <span class="literal">true</span> ​​​​​at ​​​i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun​​​ ​src/module/function/wait.js:37:6​</span><br><span class="line"></span><br><span class="line">1 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">2 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">3 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">4 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">5 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">6 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">7 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">8 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">9 执行后:  ​​​​​at ​​​i + <span class="string">&#x27; 执行后: &#x27;</span>​​​ ​src/module/function/wait.js:40:6​</span><br><span class="line"></span><br><span class="line">307 ​​​​​at ​​​Date.now() - start​​​ ​src/module/function/wait.js:52:2​</span><br></pre></td></tr></table></figure>

<p>可以看到，很神奇的是 _判断后 &#x3D;&gt; 执行前 &#x3D;&gt; 判断后…&#x3D;&gt; 执行后…_，并不是预想中的 <em>判断后 &#x3D;&gt; 执行前 &#x3D;&gt; 执行后…</em> 的循环，所以，到底发生了什么呢？</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>这个问题卡了吾辈两天之久，直到吾辈在 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/56126223/js-asynchronous-concurrent-locks-are-not-in-effect?noredirect=1#comment98896413_56126223">StackOverflow</a> 提出的另一个相关的问题被外国友人回答了，瞬间吾辈就想起了 – <strong>async-await 本质上还是异步</strong>。</p>
<p>是的，为什么会出现 <code>wait</code> 一直在执行而后面的 <code>taskIsRun = true</code> 却并没有执行？因为 JavaScript 中的 <code>async-await</code> 虽然可以写出来很像同步代码的异步代码，但实际上还是异步的，原理还是基于 <code>Promise</code>。</p>
<p>我们改造一下代码，将之使用原生 <code>Promise</code> 实现一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 等待指定的时间/等待指定表达式成立</span></span><br><span class="line"><span class="comment"> * 如果未指定等待条件则立刻执行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number|Function</span>&#125; [param] 等待时间/等待条件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise</span>&#125; Promise 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">wait</span> = param =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(resolve, param)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">param</span>()) &#123;</span><br><span class="line">          <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">          <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="number">100</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">;(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 标识当前是否有异步函数 add 在运行了</span></span><br><span class="line">  <span class="keyword">let</span> taskIsRun = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">add</span> = (<span class="params">_v, i</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 如果已经有运行的 add 函数，则等待</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (taskIsRun) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断前: &#x27;</span>)</span><br><span class="line">          <span class="comment">// 关键在于这里，实际上执行完成之后并不会到下一个 then，而是继续另一个 wait 的判断</span></span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">wait</span>(<span class="function">() =&gt;</span> !taskIsRun).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        taskIsRun = <span class="literal">true</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun)</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">wait</span>(<span class="number">100</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 执行后: &#x27;</span>)</span><br><span class="line">        taskIsRun = <span class="literal">false</span></span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">    <span class="title class_">Array</span>(<span class="number">10</span>)</span><br><span class="line">      .<span class="title function_">fill</span>(<span class="number">0</span>)</span><br><span class="line">      .<span class="title function_">map</span>(add),</span><br><span class="line">  ).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>() - start))</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>这个时候就可以看出来了，判断逻辑是处在一个 <code>then</code> 后继里面的。那么，执行完 <code>console.log(i + &#39; 判断后: &#39; + taskIsRun)</code> 之后，就一定会继续执行下面的 <code>then</code> 函数么？并不，这时候 <code>wait</code> 函数内部实现中的 <code>setInterval</code> 还在运转，实际上 <code>nodejs</code> 并不会优先继续 <code>then</code> 这种 <code>microtask</code>（微任务），而是会继续进行 <code>setInterval</code> 这种 <code>macrotask</code>（宏任务）。这是 nodejs 与浏览器实现不一致的地方，吾辈将这些代码复制到浏览器上，确实可以正常执行并得到预期的结果。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://juejin.im/entry/58d4df3b5c497d0057eb99ff">微任务与宏任务参考</a></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (taskIsRun) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断前: &#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">wait</span>(<span class="function">() =&gt;</span> !taskIsRun).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当然，nodejs 11 修复了这个问题，参考 <a target="_blank" rel="noopener" href="https://github.com/nodejs/node/pull/22842">https://github.com/nodejs/node/pull/22842</a>。然而目前 NodeJS LTS 为 10，最新版本为 12，这个问题可能还要持续一段时间。</p>
</blockquote>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>那么，难道吾辈就必须等到 NodeJS LTS 最新版之后才能用 wait 么？或者说，吾辈就必须依赖于浏览器的 <code>microtask/macrotask</code> 么？并不，吾辈对之手动进行了处理即可！</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 等待指定的时间/等待指定表达式成立</span></span><br><span class="line"><span class="comment"> * 如果未指定等待条件则立刻执行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number|Function</span>&#125; [param] 等待时间/等待条件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type">Promise</span>&#125; Promise 对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">wait</span> = param =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(resolve, param)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> param === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> timer = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">param</span>()) &#123;</span><br><span class="line">          <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">          <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="number">100</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 标识当前是否有异步函数 add 在运行了</span></span><br><span class="line">  <span class="keyword">let</span> taskIsRun = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">add</span> = <span class="keyword">async</span> (<span class="params">_v, i</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 如果已经有运行的 add 函数，则等待</span></span><br><span class="line">    <span class="keyword">if</span> (taskIsRun) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断前: &#x27;</span>)</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> result = !taskIsRun</span><br><span class="line">        <span class="comment">// 关键在于这里</span></span><br><span class="line">        <span class="keyword">if</span> (result) &#123;</span><br><span class="line">          taskIsRun = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 判断后: &#x27;</span> + taskIsRun)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      taskIsRun = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 执行前: &#x27;</span> + taskIsRun)</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">100</span>)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(i + <span class="string">&#x27; 执行后: &#x27;</span>)</span><br><span class="line">      taskIsRun = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">    <span class="title class_">Array</span>(<span class="number">10</span>)</span><br><span class="line">      .<span class="title function_">fill</span>(<span class="number">0</span>)</span><br><span class="line">      .<span class="title function_">map</span>(add),</span><br><span class="line">  )</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>() - start)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>吾辈在 <code>wait</code> 函数中，即 <code>setInterval</code> 循环调用的函数中对 <code>taskIsRun</code> 进行了修改，而不是在 <code>wait</code> 后面，即 <code>then</code> 之后的 <code>microtask</code> 中进行修改，结果便一切如同吾辈所期待的一样了！</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/05/09/others/rxliuliBlog/JavaScript/JavaScript-%E9%98%B2%E6%8A%96%E5%92%8C%E8%8A%82%E6%B5%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/09/others/rxliuliBlog/JavaScript/JavaScript-%E9%98%B2%E6%8A%96%E5%92%8C%E8%8A%82%E6%B5%81/" class="post-title-link" itemprop="url">JavaScript 防抖和节流</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-09 11:29:51" itemprop="dateCreated datePublished" datetime="2019-05-09T11:29:51+08:00">2019-05-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2019-05-15 00:00:00" itemprop="dateModified" datetime="2019-05-15T00:00:00+08:00">2019-05-15</time>
    </span>


  
    <span id="/2019/05/09/others/rxliuliBlog/JavaScript/JavaScript-%E9%98%B2%E6%8A%96%E5%92%8C%E8%8A%82%E6%B5%81/" class="post-meta-item leancloud_visitors" data-flag-title="JavaScript 防抖和节流" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="JavaScript 防抖和节流" href="/2019/05/09/others/rxliuliBlog/JavaScript/JavaScript-%E9%98%B2%E6%8A%96%E5%92%8C%E8%8A%82%E6%B5%81/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::073f69b517521fe286bc0dc34bea9cfb" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="JavaScript-防抖和节流"><a href="#JavaScript-防抖和节流" class="headerlink" title="JavaScript 防抖和节流"></a>JavaScript 防抖和节流</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>网络上已经存在了大量的有关 <strong>防抖</strong> 和 <strong>节流</strong> 的文章，为何吾辈还要再写一篇呢？事实上，防抖和节流，吾辈在使用中发现了一些奇怪的问题，并经过了数次的修改，这里主要分享一下吾辈遇到的问题以及是如何解决的。</p>
<h3 id="为什么要用防抖和节流？"><a href="#为什么要用防抖和节流？" class="headerlink" title="为什么要用防抖和节流？"></a>为什么要用防抖和节流？</h3><p>因为某些函数触发&#x2F;调用的频率过快，吾辈需要手动去限制其执行的频率。例如常见的监听滚动条的事件，如果没有防抖处理的话，并且，每次函数执行花费的时间超过了触发的间隔时间的话 – 页面就会卡顿。</p>
<h2 id="演进"><a href="#演进" class="headerlink" title="演进"></a>演进</h2><h3 id="初始实现"><a href="#初始实现" class="headerlink" title="初始实现"></a>初始实现</h3><p>我们先实现一个简单的去抖函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">delay, action</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> tId</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (tId) <span class="built_in">clearTimeout</span>(tId)</span><br><span class="line">    tId = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">action</span>(...args)</span><br><span class="line">    &#125;, delay)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 Promise 简单封装 setTimeout，下同</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">wait</span> = ms =&gt; <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, ms))</span><br><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> num = <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">add</span> = (<span class="params"></span>) =&gt; ++num</span><br><span class="line"></span><br><span class="line">  <span class="title function_">add</span>()</span><br><span class="line">  <span class="title function_">add</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(num) <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">debounce</span>(<span class="number">10</span>, add)</span><br><span class="line">  <span class="title function_">fn</span>()</span><br><span class="line">  <span class="title function_">fn</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(num) <span class="comment">// 2</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">20</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(num) <span class="comment">// 3</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>好了，看来基本的效果是实现了的。包装过的函数 <code>fn</code> 调用了两次，却并没有立刻执行，而是等待时间间隔过去之后才最终执行了一次。</p>
<h3 id="this-怎么办？"><a href="#this-怎么办？" class="headerlink" title="this 怎么办？"></a>this 怎么办？</h3><p>然而，上面的实现有一个致命的问题，没有处理 <code>this</code>！当你用在原生的事件处理时或许还不觉得，然而，当你使用了 ES6 <code>class</code> 这类对 <code>this</code> 敏感的代码时，就一定会遇到 <code>this</code> 带来的问题。</p>
<p>例如下面使用 <code>class</code> 来声明一个计数器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">i</span> = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">i</span>++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可能想在 <code>constructor</code> 中添加新的属性 <code>fn</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">i</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fn</span> = <span class="title function_">debounce</span>(<span class="number">10</span>, <span class="variable language_">this</span>.<span class="property">add</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">i</span>++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但很遗憾，这里的 <code>this</code> 绑定是有问题的，执行以下代码试试看</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> counter = <span class="keyword">new</span> <span class="title class_">Counter</span>()</span><br><span class="line">counter.<span class="title function_">fn</span>() <span class="comment">// Cannot read property &#x27;i&#x27; of undefined</span></span><br></pre></td></tr></table></figure>

<p>会抛出异常 <code>Cannot read property &#39;i&#39; of undefined</code>，究其原因就是 <code>this</code> 没有绑定，我们可以手动绑定 this <code>.bind(this)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">i</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fn</span> = <span class="title function_">debounce</span>(<span class="number">10</span>, <span class="variable language_">this</span>.<span class="property">add</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">i</span>++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但更好的方式是修改 <code>debounce</code>，使其能够自动绑定 <code>this</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">delay, action</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> tId</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (tId) <span class="built_in">clearTimeout</span>(tId)</span><br><span class="line">    tId = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      action.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">    &#125;, delay)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，代码将如同预期的运行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">i</span> = <span class="number">0</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">fn</span> = <span class="title function_">debounce</span>(<span class="number">10</span>, <span class="variable language_">this</span>.<span class="property">add</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">i</span>++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> counter = <span class="keyword">new</span> <span class="title class_">Counter</span>()</span><br><span class="line">  counter.<span class="title function_">add</span>()</span><br><span class="line">  counter.<span class="title function_">add</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="property">i</span>) <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">  counter.<span class="title function_">fn</span>()</span><br><span class="line">  counter.<span class="title function_">fn</span>()</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="property">i</span>) <span class="comment">// 2</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">20</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="property">i</span>) <span class="comment">// 3</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="返回值呢？"><a href="#返回值呢？" class="headerlink" title="返回值呢？"></a>返回值呢？</h3><p>不知道你有没有发现，现在使用 <code>debounce</code> 包装的函数都没有返回值，是完全只有副作用的函数。然而，吾辈还是遇到了需要返回值的场景。<br>例如：<em>输入停止后，使用 Ajax 请求后台数据判断是否已存在相同的数据。</em></p>
<p>修改 <code>debounce</code> 成会缓存上一次执行结果并且有初始结果参数的实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">delay, action, init = <span class="literal">undefined</span></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> flag</span><br><span class="line">  <span class="keyword">let</span> result = init</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (flag) <span class="built_in">clearTimeout</span>(flag)</span><br><span class="line">    flag = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      result = action.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">    &#125;, delay)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用代码变成了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Counter</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">i</span> = <span class="number">0</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">fn</span> = <span class="title function_">debounce</span>(<span class="number">10</span>, <span class="variable language_">this</span>.<span class="property">add</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> ++<span class="variable language_">this</span>.<span class="property">i</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> counter = <span class="keyword">new</span> <span class="title class_">Counter</span>()</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="title function_">add</span>()) <span class="comment">// 1</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="title function_">add</span>()) <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="title function_">fn</span>()) <span class="comment">// 0</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="title function_">fn</span>()) <span class="comment">// 0</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">20</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="title function_">fn</span>()) <span class="comment">// 3</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>看起来很完美？然而，没有考虑到异步函数是个大失败！</p>
<p>尝试以下测试代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">get</span> = <span class="keyword">async</span> i =&gt; i</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">1</span>))</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">2</span>))</span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">debounce</span>(<span class="number">10</span>, get, <span class="number">0</span>)</span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">3</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i)) <span class="comment">// fn(...).then is not a function</span></span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">4</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i))</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">20</span>)</span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">5</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i))</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>会抛出异常 <code>fn(...).then is not a function</code>，因为我们包装过后的函数是同步的，第一次返回的值并不是 <code>Promise</code> 类型。</p>
<p>除非我们修改默认值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">get</span> = <span class="keyword">async</span> i =&gt; i</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">1</span>))</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">2</span>))</span><br><span class="line">  <span class="comment">// 注意，修改默认值为 Promise</span></span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">debounce</span>(<span class="number">10</span>, get, <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="title function_">resolve</span>(<span class="number">0</span>)))</span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">3</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i)) <span class="comment">// 0</span></span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">4</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i)) <span class="comment">// 0</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">20</span>)</span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">5</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i)) <span class="comment">// 4</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="支持有返回值的异步函数"><a href="#支持有返回值的异步函数" class="headerlink" title="支持有返回值的异步函数"></a>支持有返回值的异步函数</h3><p>支持异步有两种思路</p>
<ol>
<li>将异步函数包装为同步函数</li>
<li>将包装后的函数异步化</li>
</ol>
<p>第一种思路实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">delay, action, init = <span class="literal">undefined</span></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> flag</span><br><span class="line">  <span class="keyword">let</span> result = init</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (flag) <span class="built_in">clearTimeout</span>(flag)</span><br><span class="line">    flag = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> temp = action.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">      <span class="keyword">if</span> (temp <span class="keyword">instanceof</span> <span class="title class_">Promise</span>) &#123;</span><br><span class="line">        temp.<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> (result = res))</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = temp</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, delay)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用方式和同步函数完全一样，当然，是支持异步函数的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">get</span> = <span class="keyword">async</span> i =&gt; i</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">1</span>))</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">2</span>))</span><br><span class="line">  <span class="comment">// 注意，修改默认值为 Promise</span></span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">debounce</span>(<span class="number">10</span>, get, <span class="number">0</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">fn</span>(<span class="number">3</span>)) <span class="comment">// 0</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">fn</span>(<span class="number">4</span>)) <span class="comment">// 0</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">20</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">fn</span>(<span class="number">5</span>)) <span class="comment">// 4</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>第二种思路实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">debounce</span> = (<span class="params">delay, action, init = <span class="literal">undefined</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> flag</span><br><span class="line">  <span class="keyword">let</span> result = init</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (flag) <span class="built_in">clearTimeout</span>(flag)</span><br><span class="line">      flag = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        result = action.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">        <span class="title function_">resolve</span>(result)</span><br><span class="line">      &#125;, delay)</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(result)</span><br><span class="line">      &#125;, delay)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用方式支持异步的方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">get</span> = <span class="keyword">async</span> i =&gt; i</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">1</span>))</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">await</span> <span class="title function_">get</span>(<span class="number">2</span>))</span><br><span class="line">  <span class="comment">// 注意，修改默认值为 Promise</span></span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">debounce</span>(<span class="number">10</span>, get, <span class="number">0</span>)</span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">3</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i)) <span class="comment">// 0</span></span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">4</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i)) <span class="comment">// 4</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">wait</span>(<span class="number">20</span>)</span><br><span class="line">  <span class="title function_">fn</span>(<span class="number">5</span>).<span class="title function_">then</span>(<span class="function"><span class="params">i</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(i)) <span class="comment">// 5</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>可以看到，第一种思路带来的问题是返回值永远会是 <strong>旧的</strong> 返回值，第二种思路主要问题是将同步函数也给包装成了异步。利弊权衡之下，吾辈觉得第二种思路更加正确一些，毕竟使用场景本身不太可能必须是同步的操作。而且，原本 <code>setTimeout</code> 也是异步的，只是不需要返回值的时候并未意识到这点。</p>
<h3 id="避免原函数信息丢失"><a href="#避免原函数信息丢失" class="headerlink" title="避免原函数信息丢失"></a>避免原函数信息丢失</h3><p>后来，有人提出了一个问题，如果函数上面携带其他信息，例如类似于 <code>jQuery</code> 的 <code>$</code>，既是一个函数，但也同时含有其他属性，如果使用 <code>debounce</code> 就找不到了呀</p>
<p>一开始吾辈立刻想到了复制函数上面的所有可遍历属性，然后想起了 ES6 的 <code>Proxy</code> 特性 – 这实在是太<strong>魔法</strong>了。使用 Proxy 解决这个问题将异常的简单 – 因为除了调用函数，其他的一切操作仍然指向原函数！</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">debounce</span> = (<span class="params">delay, action, init = <span class="literal">undefined</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> flag</span><br><span class="line">  <span class="keyword">let</span> result = init</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(action, &#123;</span><br><span class="line">    <span class="title function_">apply</span>(<span class="params">target, thisArg, args</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (flag) <span class="built_in">clearTimeout</span>(flag)</span><br><span class="line">        flag = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">resolve</span>((result = <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(target, thisArg, args)))</span><br><span class="line">        &#125;, delay)</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">resolve</span>(result)</span><br><span class="line">        &#125;, delay)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试一下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">;(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">get</span> = <span class="keyword">async</span> i =&gt; i</span><br><span class="line">  get.<span class="property">rx</span> = <span class="string">&#x27;rx&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(get.<span class="property">rx</span>) <span class="comment">// rx</span></span><br><span class="line">  <span class="keyword">const</span> fn = <span class="title function_">debounce</span>(<span class="number">10</span>, get, <span class="number">0</span>)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(fn.<span class="property">rx</span>) <span class="comment">// rx</span></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<h3 id="实现节流"><a href="#实现节流" class="headerlink" title="实现节流"></a>实现节流</h3><p>以这种思路实现一个节流函数 <code>throttle</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 函数节流</span></span><br><span class="line"><span class="comment"> * 节流 (throttle) 让一个函数不要执行的太频繁，减少执行过快的调用，叫节流</span></span><br><span class="line"><span class="comment"> * 类似于上面而又不同于上面的函数去抖, 包装后函数在上一次操作执行过去了最小间隔时间后会直接执行, 否则会忽略该次操作</span></span><br><span class="line"><span class="comment"> * 与上面函数去抖的明显区别在连续操作时会按照最小间隔时间循环执行操作, 而非仅执行最后一次操作</span></span><br><span class="line"><span class="comment"> * 注: 该函数第一次调用一定会执行，不需要担心第一次拿不到缓存值，后面的连续调用都会拿到上一次的缓存值</span></span><br><span class="line"><span class="comment"> * 注: 返回函数结果的高阶函数需要使用 &#123;<span class="doctag">@link</span> Proxy&#125; 实现，以避免原函数原型链上的信息丢失</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Number</span>&#125; delay 最小间隔时间，单位为 ms</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; action 真正需要执行的操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">Function</span>&#125; 包装后有节流功能的函数。该函数是异步的，与需要包装的函数 &#123;<span class="doctag">@link</span> action&#125; 是否异步没有太大关联</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">throttle</span> = (<span class="params">delay, action</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> last = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> result</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(action, &#123;</span><br><span class="line">    <span class="title function_">apply</span>(<span class="params">target, thisArg, args</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> curr = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">        <span class="keyword">if</span> (curr - last &gt; delay) &#123;</span><br><span class="line">          result = <span class="title class_">Reflect</span>.<span class="title function_">apply</span>(target, thisArg, args)</span><br><span class="line">          last = curr</span><br><span class="line">          <span class="title function_">resolve</span>(result)</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">resolve</span>(result)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>嘛，实际上这里的防抖和节流仍然是简单的实现，其他的像 <strong>取消防抖</strong>&#x2F;<strong>强制刷新缓存</strong> 等功能尚未实现。当然，对于吾辈而言功能已然足够了，也被放到了公共的函数库 <a target="_blank" rel="noopener" href="https://rx-util.rxliuli.com/">rx-util</a> 中。</p>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://fangtianq.github.io/2019/04/11/others/rxliuliBlog/JavaScript/layui-layer-load-%E5%BC%B9%E7%AA%97%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%E7%9A%84%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars2.githubusercontent.com/u/12722882?s=460&u=60d32bd6a1b3d81f0e2dcfc9390b86c797573fbe&v=4">
      <meta itemprop="name" content="ftq">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="越努力，越幸运！">
      <meta itemprop="description" content="有志者事竟成">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 越努力，越幸运！">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/11/others/rxliuliBlog/JavaScript/layui-layer-load-%E5%BC%B9%E7%AA%97%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%E7%9A%84%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">layui-layer load 弹窗自动关闭的问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-12 00:00:00" itemprop="dateCreated datePublished" datetime="2019-04-12T00:00:00+08:00">2019-04-12</time>
    </span>


  
    <span id="/2019/04/11/others/rxliuliBlog/JavaScript/layui-layer-load-%E5%BC%B9%E7%AA%97%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%E7%9A%84%E9%97%AE%E9%A2%98/" class="post-meta-item leancloud_visitors" data-flag-title="layui-layer load 弹窗自动关闭的问题" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="leancloud-visitors-count"></span>
    </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    <a title="layui-layer load 弹窗自动关闭的问题" href="/2019/04/11/others/rxliuliBlog/JavaScript/layui-layer-load-%E5%BC%B9%E7%AA%97%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%E7%9A%84%E9%97%AE%E9%A2%98/#SOHUCS" itemprop="discussionUrl">
      <span id="sourceId::7e4fe4f6bca0df2ea36504e8c1338ef0" class="cy_cmt_count" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="layui-layer-load-弹窗自动关闭的问题"><a href="#layui-layer-load-弹窗自动关闭的问题" class="headerlink" title="layui-layer load 弹窗自动关闭的问题"></a>layui-layer load 弹窗自动关闭的问题</h1><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>项目中的 Ajax 加载时的 loading 框有时候会关闭了弹窗之后很久页面上的数据才加载出来，而且这个问题是随机出现的，有些页面存在，有些页面则正常。</p>
<p>最小复现代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/rx-util@1.6.3/dist/rx-util.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/jquery@3.4.0/dist/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/layui-layer@1.0.9/dist/layer.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/**</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * 加载遮罩框</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       *</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * <span class="doctag">@returns</span> &#123;<span class="type">Function</span>&#125; 一个关闭遮罩框的函数</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">function</span> <span class="title function_">load</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> id = layer.<span class="title function_">load</span>(<span class="number">1</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">          layer.<span class="title function_">close</span>(id)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/**</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * 模拟 ajax 异步请求</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">time</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> close = <span class="title function_">load</span>()</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;request start: &#x27;</span>, time)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">await</span> rx.<span class="title function_">wait</span>(time)</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">close</span>()</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;request end: &#x27;</span>, time)</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      ;(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">request</span>(<span class="number">5000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第二个请求加载完成了&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">request</span>(<span class="number">1000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第一个请求加载完成了&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">      &#125;)()</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>控制台打印</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request start:  5000</span><br><span class="line">request start:  1000</span><br><span class="line">request end:  1000</span><br><span class="line">第一个请求加载完成了</span><br><span class="line">request end:  5000</span><br><span class="line">第二个请求加载完成了</span><br></pre></td></tr></table></figure>

<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>本来吾辈猜测是 vuejs 页面渲染的锅，认为 vuejs 的生命周期函数 <code>mouted</code> 执行时 DOM 还没加载完全的缘故。<br>所以把 <code>load</code> 异步化，等待 document 加载完毕才会真正执行。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/rx-util@1.6.3/dist/rx-util.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/jquery@3.4.0/dist/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/layui-layer@1.0.9/dist/layer.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/**</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * 加载遮罩框</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       *</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * <span class="doctag">@returns</span> &#123;<span class="type">Function</span>&#125; 一个关闭遮罩框的函数</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">load</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">await</span> rx.<span class="title function_">wait</span>(<span class="function">() =&gt;</span> <span class="variable language_">document</span>.<span class="property">readyState</span> === <span class="string">&#x27;complete&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> id = layer.<span class="title function_">load</span>(<span class="number">1</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="keyword">async</span> () =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">await</span> rx.<span class="title function_">wait</span>(<span class="function">() =&gt;</span> <span class="variable language_">document</span>.<span class="property">readyState</span> === <span class="string">&#x27;complete&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">          layer.<span class="title function_">close</span>(id)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/**</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * 模拟 ajax 异步请求</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">time</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> close = <span class="keyword">await</span> <span class="title function_">load</span>()</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;request start: &#x27;</span>, time)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">await</span> rx.<span class="title function_">wait</span>(time)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">await</span> <span class="title function_">close</span>()</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;request end: &#x27;</span>, time)</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      ;(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">request</span>(<span class="number">5000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第二个请求加载完成了&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">request</span>(<span class="number">1000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第一个请求加载完成了&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">      &#125;)()</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>控制台打印</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request start:  5000</span><br><span class="line">request start:  1000</span><br><span class="line">request end:  1000</span><br><span class="line">第一个请求加载完成了</span><br><span class="line">request end:  5000</span><br><span class="line">第二个请求加载完成了</span><br></pre></td></tr></table></figure>

<p>然而实际上却并不是这个问题。。。</p>
<p>经过某位网友提醒，layer 源码中默认只允许一个活动的 <code>load</code> 弹窗。瞬间吾辈都不知道要怎么吐槽了，单例模式避免无谓的内存浪费是正常的，然而新的 <code>load</code> 函数却会关闭之前的 <code>load</code> 这种操作真的是很厉害了呢</p>
<p>例如下面这段代码，无论调用多少次 <code>layer.close(id1)</code>，页面上的 <code>loading</code> 都不会关闭。。。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> id1 = layer.<span class="title function_">load</span>()</span><br><span class="line"><span class="keyword">const</span> id2 = layer.<span class="title function_">load</span>()</span><br><span class="line">layer.<span class="title function_">close</span>(id1)</span><br><span class="line">layer.<span class="title function_">close</span>(id1)</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">layer.<span class="title function_">close</span>(id1)</span><br><span class="line">layer.<span class="title function_">close</span>(id1)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里吾辈可以想象到，layer 认为先加载的 <code>load()</code> 就应该先被 <code>close()</code>，而没有考虑到复杂异步的情况。</p>
</blockquote>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>既然 layer 的 <code>load</code> 本身存在缺陷，那么却是只能自己对 <code>load</code> 和 <code>close</code> 功能做控制了<br>基本思路</p>
<ol>
<li><code>layer.load</code> 每次都会关闭掉之前的弹窗，那么就记录最后一次的弹窗 id，在真正需要关闭的时候 close 掉就好了</li>
<li><code>layer.load</code> 关闭是直接关闭弹窗，如果是最后一个就会出现弹窗消失但数据没加载完全的问题，那么关闭这儿要判断当前是否还有活动的弹窗，只有在没有的情况下才真正关闭</li>
</ol>
<p>修改后的代码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/rx-util@1.6.3/dist/rx-util.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/jquery@3.4.0/dist/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/layui-layer@1.0.9/dist/layer.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/**</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * 加载遮罩框</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       *</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * <span class="doctag">@returns</span> &#123;<span class="type">Function</span>&#125; 一个关闭遮罩框的函数</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> load = (<span class="function">(<span class="params">num, lastId</span>) =&gt;</span> <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        lastId = layer.<span class="title function_">load</span>(<span class="number">1</span>)</span></span><br><span class="line"><span class="language-javascript">        num++</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">          num--</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">if</span> (num &lt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            num = <span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">          &#125;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">if</span> (num &gt; <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;弹窗没有真正关闭哦&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span></span></span><br><span class="line"><span class="language-javascript">          &#125;</span></span><br><span class="line"><span class="language-javascript">          layer.<span class="title function_">close</span>(lastId)</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;弹窗真的关闭啦&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;)(<span class="number">0</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/**</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       * 模拟 ajax 异步请求</span></span></span><br><span class="line"><span class="comment"><span class="language-javascript">       */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">time</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> close = <span class="keyword">await</span> <span class="title function_">load</span>()</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;request start: &#x27;</span>, time)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">await</span> rx.<span class="title function_">wait</span>(time)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">await</span> <span class="title function_">close</span>()</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;request end: &#x27;</span>, time)</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      ;(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">request</span>(<span class="number">5000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第二个请求加载完成了&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">request</span>(<span class="number">1000</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第一个请求加载完成了&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">      &#125;)()</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>控制台打印</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">request start:  5000</span><br><span class="line">request start:  1000</span><br><span class="line">弹窗没有真正关闭哦</span><br><span class="line">request end:  1000</span><br><span class="line">第一个请求加载完成了</span><br><span class="line">弹窗真的关闭啦</span><br><span class="line">request end:  5000</span><br><span class="line">第二个请求加载完成了</span><br></pre></td></tr></table></figure>

      
    </div>


    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/18/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><span class="page-number current">19</span><a class="page-number" href="/page/20/">20</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/20/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ftq</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">1.5m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">22:55</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


  <script class="next-config" data-name="leancloud_visitors" type="application/json">{"enable":true,"app_id":"6NuBzi5VSiFfQE2sYbymtv9t-gzGzoHsz","app_key":"stH9SzRt55d1wnwQD7LcoaQR","server_url":null,"security":false}</script>
  <script src="/js/third-party/statistics/lean-analytics.js"></script>


<script class="next-config" data-name="changyan" type="application/json">{"enable":true,"appid":"cyw21b1ST","appkey":"045a89927c13c0e33a82c736b468fe51"}</script>
<script src="/js/third-party/comments/changyan.js"></script>

</body>
</html>
