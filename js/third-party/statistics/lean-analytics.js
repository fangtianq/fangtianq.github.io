(function(){const e=e=>{e=encodeURI(e);return document.getElementById(e).querySelector(".leancloud-visitors-count")};const t=t=>{const o=document.querySelector(".leancloud_visitors");const n=decodeURI(o.id);const s=o.dataset.flagTitle;t("get",`/classes/Counter?where=${encodeURIComponent(JSON.stringify({url:n}))}`).then((e=>e.json())).then((({results:o})=>{if(o.length>0){const s=o[0];e(n).innerText=s.time+1;t("put","/classes/Counter/"+s.objectId,{time:{__op:"Increment",amount:1}}).catch((e=>{console.error("Failed to save visitor count",e)}))}else if(CONFIG.leancloud_visitors.security){e(n).innerText="Counter not initialized! More info at console err msg.";console.error("ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.")}else{t("post","/classes/Counter",{title:s,url:n,time:1}).then((e=>e.json())).then((()=>{e(n).innerText=1})).catch((e=>{console.error("Failed to create",e)}))}})).catch((e=>{console.error("LeanCloud Counter Error",e)}))};const o=t=>{const o=document.querySelectorAll(".leancloud_visitors");const n=[...o].map((e=>decodeURI(e.id)));t("get",`/classes/Counter?where=${encodeURIComponent(JSON.stringify({url:{$in:n}}))}`).then((e=>e.json())).then((({results:t})=>{for(const o of n){const n=t.find((e=>e.url===o));e(o).innerText=n?n.time:0}})).catch((e=>{console.error("LeanCloud Counter Error",e)}))};const{app_id:n,app_key:s,server_url:r}=CONFIG.leancloud_visitors;const c=e=>{const r=(t,o,r)=>fetch(`${e}/1.1${o}`,{method:t,headers:{"X-LC-Id":n,"X-LC-Key":s,"Content-Type":"application/json"},body:JSON.stringify(r)});if(CONFIG.page.isPost){if(CONFIG.hostname!==location.hostname)return;t(r)}else if(document.querySelectorAll(".post-title-link").length>=1){o(r)}};const l=n.slice(-9)==="-MdYXbMMI"?`https://${n.slice(0,8).toLowerCase()}.api.lncldglobal.com`:r;document.addEventListener("page:loaded",(()=>{if(l){c(l)}else{fetch(`https://app-router.leancloud.cn/2/route?appId=${n}`).then((e=>e.json())).then((({api_server:e})=>{c(`https://${e}`)}))}}))})();